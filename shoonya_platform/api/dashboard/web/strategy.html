<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategy Command Center | Shoonya Platform</title>
    <link rel="stylesheet" href="/dashboard/web/styles/common.css">
    <link rel="stylesheet" href="/dashboard/web/shared/layout.css">
    <script src="/dashboard/web/shared/layout.js" defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap');

        :root {
            --primary: #66e4ff;
            --primary-dark: #23b6ff;
            --success: #4ade80;
            --warning: #fbcb5c;
            --danger: #fb7185;
            --panel: rgba(13, 18, 41, 0.8);
            --panel-2: rgba(6, 10, 26, 0.95);
            --border: rgba(255, 255, 255, 0.08);
            --text: #f8fbff;
            --muted: rgba(248, 251, 255, 0.65);
            --accent-blue: rgba(102, 228, 255, 0.18);
            --accent-green: rgba(74, 222, 128, 0.18);
            --accent-red: rgba(251, 113, 133, 0.18);
            --shadow-soft: 0 20px 45px rgba(3, 5, 20, 0.5);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: 'Space Grotesk', 'IBM Plex Sans', sans-serif;
            background: radial-gradient(circle at top, #0f1a3c 0%, #050815 55%, #020308 100%);
            color: var(--text);
            letter-spacing: 0.1px;
        }

        main {
            padding: 32px clamp(16px, 4vw, 48px) 64px;
            max-width: 1680px;
            margin: 0 auto;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 24px;
            margin-bottom: 32px;
        }

        .page-title {
            font-size: clamp(32px, 3vw, 48px);
            font-weight: 700;
            margin: 4px 0;
        }

        .eyebrow {
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 4px;
            color: var(--muted);
            margin-bottom: 4px;
        }

        .page-actions {
            display: flex;
            gap: 12px;
        }

        button {
            font-family: inherit;
        }

        .ghost-btn,
        .primary-btn {
            border: 1px solid transparent;
            border-radius: 999px;
            padding: 10px 24px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease, color 0.2s ease;
        }

        .ghost-btn {
            background: transparent;
            border-color: rgba(255, 255, 255, 0.3);
            color: var(--text);
        }

        .ghost-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .primary-btn {
            background: linear-gradient(120deg, var(--primary), var(--primary-dark));
            color: #04060f;
            box-shadow: 0 10px 20px rgba(35, 182, 255, 0.35);
        }

        .primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 18px 26px rgba(35, 182, 255, 0.45);
        }

        .monitor-stack {
            display: grid;
            gap: 18px;
            margin-bottom: 32px;
        }

        .monitor-card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 24px;
            box-shadow: var(--shadow-soft);
            backdrop-filter: blur(20px);
        }

        .monitor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 18px;
        }

        .card-headline {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-headline h3 {
            margin: 0;
            font-size: 18px;
        }

        .orphan-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .orphan-leg {
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 14px;
            padding: 14px;
            background: rgba(255, 255, 255, 0.02);
            display: grid;
            grid-template-columns: 1.5fr repeat(3, 1fr) 0.8fr;
            gap: 12px;
            align-items: center;
        }

        .orphan-leg strong {
            font-size: 14px;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .badge-danger {
            background: var(--accent-red);
            color: var(--danger);
        }

        .badge-neutral {
            background: rgba(255, 255, 255, 0.08);
            color: var(--muted);
        }

        .greek-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .greek-pill {
            border-radius: 18px;
            padding: 14px 16px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(255, 255, 255, 0.02);
        }

        .greek-pill label {
            display: block;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--muted);
            margin-bottom: 6px;
        }

        .greek-pill span {
            font-size: 20px;
            font-weight: 600;
            font-family: 'IBM Plex Mono', monospace;
        }

        .strategy-monitor-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            margin-top: 8px;
        }

        .strategy-monitor-table th,
        .strategy-monitor-table td {
            padding: 12px 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .strategy-monitor-table th {
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 1px;
            color: var(--muted);
        }

        .control-panel {
            background: var(--panel-2);
            border-radius: 28px;
            padding: 28px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-soft);
        }

        .control-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 24px;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .chip {
            border-radius: 999px;
            padding: 6px 14px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(255, 255, 255, 0.02);
            font-size: 12px;
            color: var(--muted);
            cursor: pointer;
            transition: border 0.2s ease, color 0.2s ease;
        }

        .chip.active {
            border-color: var(--primary);
            color: var(--primary);
        }

        .strategy-board {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 18px;
        }

        .strategy-card {
            position: relative;
            border-radius: 22px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(1, 4, 18, 0.85);
            overflow: hidden;
        }

        .strategy-card.running::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 22px;
            padding: 1px;
            background: linear-gradient(135deg, rgba(74, 222, 128, 0.3), transparent);
            -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
            -webkit-mask-composite: xor;
            mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
            mask-composite: exclude;
            pointer-events: none;
        }

        .strategy-card h4 {
            margin: 0;
            font-size: 18px;
        }

        .meta-row {
            display: flex;
            gap: 18px;
            flex-wrap: wrap;
            margin: 12px 0;
            font-size: 12px;
            color: var(--muted);
        }

        .action-row {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            flex: 1;
            border-radius: 12px;
            padding: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            font-size: 13px;
            transition: opacity 0.2s ease;
        }

        .action-start {
            background: var(--accent-green);
            color: var(--success);
        }

        .action-pause {
            background: rgba(251, 203, 92, 0.2);
            color: var(--warning);
        }

        .action-stop {
            background: rgba(251, 113, 133, 0.2);
            color: var(--danger);
        }

        .action-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .lock-overlay {
            position: absolute;
            inset: 0;
            background: rgba(2, 5, 13, 0.85);
            display: flex;
            flex-direction: column;
            gap: 6px;
            justify-content: center;
            align-items: center;
            color: var(--muted);
            font-size: 12px;
            letter-spacing: 1px;
        }

        .lock-overlay span {
            font-size: 28px;
        }

        .builder-overlay {
            position: fixed;
            inset: 0;
            background: rgba(2, 4, 13, 0.85);
            backdrop-filter: blur(18px);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 40px 20px;
            overflow-y: auto;
            transition: opacity 0.3s ease;
            z-index: 999;
        }

        .builder-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .builder-shell {
            width: min(1400px, 100%);
            background: rgba(1, 2, 10, 0.95);
            border-radius: 32px;
            border: 1px solid rgba(102, 228, 255, 0.2);
            box-shadow: 0 40px 120px rgba(1, 2, 10, 0.9);
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }

        .builder-head {
            padding: 28px 32px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-btn {
            border: none;
            background: rgba(255, 255, 255, 0.06);
            color: var(--text);
            border-radius: 999px;
            width: 42px;
            height: 42px;
            font-size: 22px;
            cursor: pointer;
        }

        .builder-scroll {
            padding: 0 32px 32px;
            overflow-y: auto;
            flex: 1;
        }

        .section-block {
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 24px;
            padding: 24px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.01);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }

        .section-title {
            margin: 0;
            font-size: 18px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
        }

        label {
            font-size: 12px;
            text-transform: uppercase;
            color: var(--muted);
            letter-spacing: 1px;
            margin-bottom: 6px;
            display: inline-block;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px 12px;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(255, 255, 255, 0.04);
            color: var(--text);
            font-size: 14px;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(102, 228, 255, 0.12);
        }

        .leg-collection {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .leg-card {
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 18px;
            padding: 18px;
            background: rgba(255, 255, 255, 0.02);
        }

        .leg-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .leg-label {
            font-size: 16px;
            font-weight: 600;
        }

        .icon-btn {
            border: none;
            background: transparent;
            color: var(--muted);
            font-size: 18px;
            cursor: pointer;
        }

        .leg-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
        }

        .condition-list,
        .trigger-list,
        .combined-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 12px;
        }

        .condition-row,
        .combined-row,
        .trigger-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
        }

        .mini-btn {
            border-radius: 10px;
            border: 1px dashed rgba(255, 255, 255, 0.2);
            padding: 8px 12px;
            background: transparent;
            color: var(--muted);
            font-size: 12px;
            cursor: pointer;
        }

        .builder-alert {
            margin-bottom: 18px;
            border-radius: 16px;
            padding: 12px 16px;
            display: none;
        }

        .builder-alert.show {
            display: block;
        }

        .alert-success {
            background: var(--accent-green);
            color: var(--success);
        }

        .alert-error {
            background: var(--accent-red);
            color: var(--danger);
        }

        .save-row {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 18px;
        }

        .save-row button {
            min-width: 160px;
        }

        .empty-copy {
            text-align: center;
            color: var(--muted);
            padding: 20px;
            border: 1px dashed rgba(255, 255, 255, 0.08);
            border-radius: 18px;
        }

        @media (max-width: 900px) {
            .page-header,
            .control-head {
                flex-direction: column;
                align-items: flex-start;
            }

            .orphan-leg {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }

            .builder-shell {
                border-radius: 24px;
            }
        }
    </style>
</head>
<body data-page="strategy">
    <div id="app-header"></div>

    <main>
        <header class="page-header">
            <div>
                <p class="eyebrow">Shoonya Strategy Ops</p>
                <h1 class="page-title">Strategy Command Center</h1>
                <p>Construct intent-driven strategies, track every greek in real time, and command execution flows from one cockpit.</p>
            </div>
            <div class="page-actions">
                <button class="ghost-btn" id="refreshNow">Manual Refresh</button>
                <button class="primary-btn" id="launchBuilder">+ Create Strategy</button>
            </div>
        </header>

        <section class="monitor-stack">
            <div class="monitor-card">
                <div class="card-headline">
                    <div>
                        <p class="eyebrow">Live Health</p>
                        <h3>Orphan Legs Watch</h3>
                    </div>
                    <span class="badge badge-danger" id="orphanCount">0 ORPHANS</span>
                </div>
                <div id="orphanLegs" class="orphan-list"></div>
            </div>

            <div class="monitor-card">
                <div class="card-headline">
                    <div>
                        <p class="eyebrow">Combined Greks</p>
                        <h3>Strategy Monitor</h3>
                    </div>
                    <span class="badge badge-neutral" id="strategyPulse">SYNCING...</span>
                </div>
                <div class="greek-grid" id="combinedGreeks"></div>
                <table class="strategy-monitor-table">
                    <thead>
                        <tr>
                            <th>Strategy</th>
                            <th>Status</th>
                            <th>Î” / Î“</th>
                            <th>Î˜ / Î½</th>
                            <th>OI / VOL</th>
                            <th>PnL</th>
                        </tr>
                    </thead>
                    <tbody id="strategyMonitor"></tbody>
                </table>
            </div>
        </section>

        <section class="control-panel">
            <div class="control-head">
                <div>
                    <p class="eyebrow">Strategy Control Widget</p>
                    <h2 style="margin: 4px 0 0;">Execution & Overrides</h2>
                </div>
                <div class="filter-group">
                    <div class="chip active" data-filter="ALL">All</div>
                    <div class="chip" data-filter="RUNNING">Running</div>
                    <div class="chip" data-filter="PAUSED">Paused</div>
                    <div class="chip" data-filter="IDLE">Idle</div>
                </div>
            </div>
            <div id="strategyBoard" class="strategy-board"></div>
        </section>
    </main>

    <div id="builderOverlay" class="builder-overlay hidden">
        <div class="builder-shell">
            <div class="builder-head">
                <div>
                    <p class="eyebrow" style="margin-bottom: 8px;">Strategy Constructor</p>
                    <h2 style="margin: 0;">Create Advanced Intent</h2>
                    <small style="color: var(--muted);">Entry Â· Adjustment Â· Exit Â· Risk stitched with leg-level logic</small>
                </div>
                <button class="close-btn" id="closeBuilder" aria-label="Close builder">Ã—</button>
            </div>
            <div class="builder-scroll">
                <div id="builderFlash" class="builder-alert"></div>
                <form id="builderForm">
                    <div class="section-block">
                        <div class="section-header">
                            <h3 class="section-title">Identity & Schedule</h3>
                        </div>
                        <div class="form-grid">
                            <div>
                                <label for="strategyName">Strategy Name</label>
                                <input id="strategyName" name="strategyName" placeholder="DNSS NIFTY Weekly" required>
                            </div>
                            <div>
                                <label for="strategyId">Strategy ID</label>
                                <input id="strategyId" name="strategyId" placeholder="DNSS_NIFTY_WEEKLY">
                            </div>
                            <div>
                                <label for="strategyType">Template</label>
                                <select id="strategyType" name="strategyType">
                                    <option value="DNSS">Delta Neutral (DNSS)</option>
                                    <option value="IRON_CONDOR">Iron Condor</option>
                                    <option value="FLY">Butterfly</option>
                                    <option value="CUSTOM">Custom</option>
                                </select>
                            </div>
                            <div>
                                <label for="underlying">Underlying</label>
                                <select id="underlying" name="underlying">
                                    <option value="NIFTY">NIFTY</option>
                                    <option value="BANKNIFTY">BANKNIFTY</option>
                                    <option value="FINNIFTY">FINNIFTY</option>
                                </select>
                            </div>
                            <div>
                                <label for="frequency">Frequency</label>
                                <select id="frequency" name="frequency" required>
                                    <option value="">Select</option>
                                    <option value="INTRADAY">Intraday</option>
                                    <option value="DAILY">Daily</option>
                                    <option value="WEEKLY">Weekly</option>
                                    <option value="MANUAL">Manual</option>
                                </select>
                            </div>
                            <div>
                                <label for="entryTime">Entry Window</label>
                                <input type="time" id="entryTime" name="entryTime" value="09:20">
                            </div>
                            <div>
                                <label for="exitTime">Exit Window</label>
                                <input type="time" id="exitTime" name="exitTime" value="15:15">
                            </div>
                            <div>
                                <label for="notes">Operator Notes</label>
                                <textarea id="notes" name="notes" placeholder="Why we are running this intent..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="section-block">
                        <div class="section-header">
                            <h3 class="section-title">Risk Management</h3>
                        </div>
                        <div class="form-grid">
                            <div>
                                <label for="targetProfit">Target Profit (â‚¹)</label>
                                <input type="number" id="targetProfit" name="targetProfit" placeholder="5000">
                            </div>
                            <div>
                                <label for="stopLoss">Stop Loss (â‚¹)</label>
                                <input type="number" id="stopLoss" name="stopLoss" placeholder="3000">
                            </div>
                            <div>
                                <label for="maxDrawdown">Max Drawdown (â‚¹)</label>
                                <input type="number" id="maxDrawdown" name="maxDrawdown" placeholder="1500">
                            </div>
                            <div>
                                <label for="maxPositions">Max Positions</label>
                                <input type="number" id="maxPositions" name="maxPositions" value="1" min="1">
                            </div>
                            <div>
                                <label for="exposureLimit">Exposure Limit (Lots)</label>
                                <input type="number" id="exposureLimit" name="exposureLimit" value="2" min="1">
                            </div>
                            <div>
                                <label for="hedgePreference">Hedge Preference</label>
                                <select id="hedgePreference" name="hedgePreference">
                                    <option value="NONE">None</option>
                                    <option value="FUTURE">Futures</option>
                                    <option value="OPTIONS">Options</option>
                                    <option value="BOTH">Blended</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="entrySection" class="section-block" data-section="entry">
                        <div class="section-header">
                            <h3 class="section-title">Entry Builder</h3>
                            <button class="mini-btn" type="button" onclick="addLeg('entry')">+ Add Leg</button>
                        </div>
                        <div id="entryLegs" class="leg-collection"></div>
                        <div class="section-header" style="margin-top: 24px;">
                            <h4 style="margin:0;">Entry Combined Parameters</h4>
                            <button class="mini-btn" type="button" onclick="addCombinedRule('entry')">+ Combined Rule</button>
                        </div>
                        <div id="entryCombined" class="combined-list"></div>
                    </div>

                    <div id="adjustmentSection" class="section-block" data-section="adjustment">
                        <div class="section-header">
                            <h3 class="section-title">Adjustment Builder</h3>
                            <button class="mini-btn" type="button" onclick="addLeg('adjustment')">+ Add Leg</button>
                        </div>
                        <div id="adjustmentLegs" class="leg-collection"></div>
                        <div class="section-header" style="margin-top: 24px;">
                            <h4 style="margin:0;">Adjustment Combined Parameters</h4>
                            <button class="mini-btn" type="button" onclick="addCombinedRule('adjustment')">+ Combined Rule</button>
                        </div>
                        <div id="adjustmentCombined" class="combined-list"></div>
                    </div>

                    <div id="exitSection" class="section-block" data-section="exit">
                        <div class="section-header">
                            <h3 class="section-title">Exit Builder</h3>
                            <button class="mini-btn" type="button" onclick="addLeg('exit')">+ Add Leg</button>
                        </div>
                        <div id="exitLegs" class="leg-collection"></div>
                        <div class="section-header" style="margin-top: 24px;">
                            <h4 style="margin:0;">Exit Combined Parameters</h4>
                            <button class="mini-btn" type="button" onclick="addCombinedRule('exit')">+ Combined Rule</button>
                        </div>
                        <div id="exitCombined" class="combined-list"></div>
                    </div>

                    <div class="save-row">
                        <button type="button" class="ghost-btn" id="resetBuilder">Reset</button>
                        <button type="submit" class="primary-btn">Save Strategy</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const builderOverlay = document.getElementById('builderOverlay');
        const launchBuilderBtn = document.getElementById('launchBuilder');
        const closeBuilderBtn = document.getElementById('closeBuilder');
        const builderForm = document.getElementById('builderForm');
        const builderFlash = document.getElementById('builderFlash');
        const strategyBoardEl = document.getElementById('strategyBoard');
        const orphanLegsEl = document.getElementById('orphanLegs');
        const orphanCountEl = document.getElementById('orphanCount');
        const combinedGreeksEl = document.getElementById('combinedGreeks');
        const strategyMonitorEl = document.getElementById('strategyMonitor');
        const strategyPulseEl = document.getElementById('strategyPulse');
        const refreshNowBtn = document.getElementById('refreshNow');
        const filterChips = document.querySelectorAll('.chip');

        const optionChainFields = [
            { value: 'instrument', label: 'Instrument' },
            { value: 'expiry', label: 'Expiry' },
            { value: 'strike', label: 'Strike' },
            { value: 'option_type', label: 'Option Type' },
            { value: 'time_to_expiry', label: 'Time to Expiry' },
            { value: 'bid_price', label: 'Bid Price' },
            { value: 'ask_price', label: 'Ask Price' },
            { value: 'last_price', label: 'Last Traded Price' },
            { value: 'volume', label: 'Volume' },
            { value: 'open_interest', label: 'Open Interest' },
            { value: 'iv', label: 'Implied Vol' },
            { value: 'delta', label: 'Delta' },
            { value: 'gamma', label: 'Gamma' },
            { value: 'theta', label: 'Theta' },
            { value: 'vega', label: 'Vega' },
            { value: 'rho', label: 'Rho' },
            { value: 'ltp_change', label: 'LTP Change' },
            { value: 'time', label: 'Time' }
        ];

        const operators = ['>=', '<=', '==', '!=', 'BETWEEN', 'CROSSES_ABOVE', 'CROSSES_BELOW'];
        const triggerActions = ['ALERT', 'HEDGE', 'ROLL', 'CLOSE', 'SCALE_IN', 'SCALE_OUT'];

        const builderState = {
            legs: {
                entry: [],
                adjustment: [],
                exit: []
            },
            combined: {
                entry: [],
                adjustment: [],
                exit: []
            }
        };

        function uid(prefix = 'leg') {
            return `${prefix}-${crypto.randomUUID()}`;
        }

        function renderLegs(section) {
            const container = document.getElementById(`${section}Legs`);
            const legs = builderState.legs[section];
            if (!container) return;

            if (!legs.length) {
                container.innerHTML = '<div class="empty-copy">No legs defined. Add a leg to start wiring option-chain conditions.</div>';
                return;
            }

            container.innerHTML = legs.map(leg => {
                const conditionRows = leg.conditions.map(cond => `
                    <div class="condition-row" data-cond="${cond.id}">
                        ${renderFieldSelect(section, leg.id, cond.id, cond.field)}
                        ${renderOperatorSelect(section, leg.id, cond.id, cond.operator)}
                        <input placeholder="Value" value="${cond.value ?? ''}" oninput="updateCondition('${section}','${leg.id}','${cond.id}','value', this.value)">
                        <select onchange="updateCondition('${section}','${leg.id}','${cond.id}','timeframe', this.value)">
                            <option value="LIVE" ${cond.timeframe === 'LIVE' ? 'selected' : ''}>Live</option>
                            <option value="1M">1 Min</option>
                            <option value="5M">5 Min</option>
                            <option value="15M">15 Min</option>
                        </select>
                        <button type="button" class="icon-btn" onclick="removeCondition('${section}','${leg.id}','${cond.id}')">Ã—</button>
                    </div>
                `).join('');

                const triggerRows = leg.triggers.map(trigger => `
                    <div class="trigger-row" data-trigger="${trigger.id}">
                        <select onchange="updateTrigger('${section}','${leg.id}','${trigger.id}','metric', this.value)">
                            ${['delta','gamma','theta','vega','price','pnl'].map(metric => `<option value="${metric}" ${trigger.metric === metric ? 'selected' : ''}>${metric.toUpperCase()}</option>`).join('')}
                        </select>
                        ${renderOperatorSelect(section, leg.id, trigger.id, trigger.operator, 'trigger')}
                        <input placeholder="Value" value="${trigger.value ?? ''}" oninput="updateTrigger('${section}','${leg.id}','${trigger.id}','value', this.value)">
                        <select onchange="updateTrigger('${section}','${leg.id}','${trigger.id}','action', this.value)">
                            ${triggerActions.map(act => `<option value="${act}" ${trigger.action === act ? 'selected' : ''}>${act.replace('_', ' ')}</option>`).join('')}
                        </select>
                        <button type="button" class="icon-btn" onclick="removeTrigger('${section}','${leg.id}','${trigger.id}')">Ã—</button>
                    </div>
                `).join('');

                return `
                    <div class="leg-card" data-leg="${leg.id}">
                        <div class="leg-header">
                            <input value="${leg.label}" oninput="updateLeg('${section}','${leg.id}','label', this.value)">
                            <div>
                                <span class="badge badge-neutral">${section.toUpperCase()}</span>
                                <button type="button" class="icon-btn" onclick="removeLeg('${section}','${leg.id}')">Ã—</button>
                            </div>
                        </div>
                        <div class="leg-grid">
                            <div>
                                <label>Side</label>
                                <select onchange="updateLeg('${section}','${leg.id}','side', this.value)">
                                    <option value="BUY" ${leg.side === 'BUY' ? 'selected' : ''}>Buy</option>
                                    <option value="SELL" ${leg.side === 'SELL' ? 'selected' : ''}>Sell</option>
                                </select>
                            </div>
                            <div>
                                <label>Option Type</label>
                                <select onchange="updateLeg('${section}','${leg.id}','optionType', this.value)">
                                    <option value="CE" ${leg.optionType === 'CE' ? 'selected' : ''}>Call (CE)</option>
                                    <option value="PE" ${leg.optionType === 'PE' ? 'selected' : ''}>Put (PE)</option>
                                </select>
                            </div>
                            <div>
                                <label>Expiry</label>
                                <select onchange="updateLeg('${section}','${leg.id}','expiryType', this.value)">
                                    <option value="CURRENT" ${leg.expiryType === 'CURRENT' ? 'selected' : ''}>Current Week</option>
                                    <option value="NEXT" ${leg.expiryType === 'NEXT' ? 'selected' : ''}>Next Week</option>
                                    <option value="MONTHLY" ${leg.expiryType === 'MONTHLY' ? 'selected' : ''}>Monthly</option>
                                </select>
                            </div>
                            <div>
                                <label>Quantity</label>
                                <input type="number" value="${leg.quantity}" min="1" onchange="updateLeg('${section}','${leg.id}','quantity', parseInt(this.value, 10) || 1)">
                            </div>
                        </div>
                        <div class="condition-list" style="margin-top:16px;">
                            <div class="section-header" style="margin:0 0 8px;">
                                <h4 style="margin:0; font-size:14px;">Leg Conditions</h4>
                                <button class="mini-btn" type="button" onclick="addCondition('${section}','${leg.id}')">+ Condition</button>
                            </div>
                            ${conditionRows || '<div class="empty-copy" style="padding:12px;">No conditions yet.</div>'}
                        </div>
                        <div class="trigger-list" style="margin-top:16px;">
                            <div class="section-header" style="margin:0 0 8px;">
                                <h4 style="margin:0; font-size:14px;">Leg Parameter Triggers</h4>
                                <button class="mini-btn" type="button" onclick="addTrigger('${section}','${leg.id}')">+ Trigger</button>
                            </div>
                            ${triggerRows || '<div class="empty-copy" style="padding:12px;">No parameter triggers configured.</div>'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderCombined(section) {
            const container = document.getElementById(`${section}Combined`);
            const rules = builderState.combined[section];
            if (!container) return;
            if (!rules.length) {
                container.innerHTML = '<div class="empty-copy">Define combined greek/vol/oi conditions to orchestrate section level actions.</div>';
                return;
            }

            container.innerHTML = rules.map(rule => `
                <div class="combined-row" data-rule="${rule.id}">
                    <select onchange="updateCombinedRule('${section}','${rule.id}','metric', this.value)">
                        ${['delta','gamma','theta','vega','oi','volume','price'].map(metric => `<option value="${metric}" ${rule.metric === metric ? 'selected' : ''}>${metric.toUpperCase()}</option>`).join('')}
                    </select>
                    ${renderOperatorSelect(section, rule.id, rule.id, rule.operator, 'combined')}
                    <input placeholder="Value" value="${rule.value ?? ''}" oninput="updateCombinedRule('${section}','${rule.id}','value', this.value)">
                    <select onchange="updateCombinedRule('${section}','${rule.id}','action', this.value)">
                        ${['ENTRY','ADJUST','EXIT','ALERT'].map(action => `<option value="${action}" ${rule.action === action ? 'selected' : ''}>${action}</option>`).join('')}
                    </select>
                    <button type="button" class="icon-btn" onclick="removeCombinedRule('${section}','${rule.id}')">Ã—</button>
                </div>
            `).join('');
        }

        function renderFieldSelect(section, legId, condId, selected) {
            return `<select onchange="updateCondition('${section}','${legId}','${condId}','field', this.value)">
                ${optionChainFields.map(field => `<option value="${field.value}" ${field.value === selected ? 'selected' : ''}>${field.label}</option>`).join('')}
            </select>`;
        }

        function renderOperatorSelect(section, legId, condId, selected, type = 'condition') {
            return `<select onchange="${type === 'condition' ? `updateCondition('${section}','${legId}','${condId}','operator', this.value)` : type === 'trigger' ? `updateTrigger('${section}','${legId}','${condId}','operator', this.value)` : `updateCombinedRule('${section}','${condId}','operator', this.value)`}">
                ${operators.map(op => `<option value="${op}" ${op === selected ? 'selected' : ''}>${op.replace('_', ' ')}</option>`).join('')}
            </select>`;
        }

        function addLeg(section) {
            builderState.legs[section].push({
                id: uid(section),
                label: `${section.charAt(0).toUpperCase() + section.slice(1)} Leg ${builderState.legs[section].length + 1}`,
                side: 'SELL',
                optionType: 'CE',
                expiryType: 'CURRENT',
                quantity: 1,
                conditions: [],
                triggers: []
            });
            renderLegs(section);
        }

        function removeLeg(section, legId) {
            builderState.legs[section] = builderState.legs[section].filter(leg => leg.id !== legId);
            renderLegs(section);
        }

        function updateLeg(section, legId, field, value) {
            const leg = builderState.legs[section].find(l => l.id === legId);
            if (!leg) return;
            leg[field] = value;
        }

        function addCondition(section, legId) {
            const leg = builderState.legs[section].find(l => l.id === legId);
            if (!leg) return;
            leg.conditions.push({
                id: uid('cond'),
                field: 'last_price',
                operator: '>=',
                value: '',
                timeframe: 'LIVE'
            });
            renderLegs(section);
        }

        function updateCondition(section, legId, condId, field, value) {
            const leg = builderState.legs[section].find(l => l.id === legId);
            if (!leg) return;
            const condition = leg.conditions.find(c => c.id === condId);
            if (!condition) return;
            condition[field] = value;
        }

        function removeCondition(section, legId, condId) {
            const leg = builderState.legs[section].find(l => l.id === legId);
            if (!leg) return;
            leg.conditions = leg.conditions.filter(c => c.id !== condId);
            renderLegs(section);
        }

        function addTrigger(section, legId) {
            const leg = builderState.legs[section].find(l => l.id === legId);
            if (!leg) return;
            leg.triggers.push({
                id: uid('trigger'),
                metric: 'delta',
                operator: '>=',
                value: '',
                action: 'ALERT'
            });
            renderLegs(section);
        }

        function updateTrigger(section, legId, triggerId, field, value) {
            const leg = builderState.legs[section].find(l => l.id === legId);
            if (!leg) return;
            const trigger = leg.triggers.find(t => t.id === triggerId);
            if (!trigger) return;
            trigger[field] = value;
        }

        function removeTrigger(section, legId, triggerId) {
            const leg = builderState.legs[section].find(l => l.id === legId);
            if (!leg) return;
            leg.triggers = leg.triggers.filter(t => t.id !== triggerId);
            renderLegs(section);
        }

        function addCombinedRule(section) {
            builderState.combined[section].push({
                id: uid('combined'),
                metric: 'delta',
                operator: '>=',
                value: '',
                action: 'ENTRY'
            });
            renderCombined(section);
        }

        function updateCombinedRule(section, ruleId, field, value) {
            const rule = builderState.combined[section].find(r => r.id === ruleId);
            if (!rule) return;
            rule[field] = value;
        }

        function removeCombinedRule(section, ruleId) {
            builderState.combined[section] = builderState.combined[section].filter(r => r.id !== ruleId);
            renderCombined(section);
        }

        function resetBuilder() {
            builderForm.reset();
            ['entry','adjustment','exit'].forEach(section => {
                builderState.legs[section] = [];
                builderState.combined[section] = [];
                renderLegs(section);
                renderCombined(section);
            });
            builderFlash.className = 'builder-alert';
            builderFlash.textContent = '';
        }

        document.getElementById('resetBuilder').addEventListener('click', resetBuilder);

        function openBuilder() {
            builderOverlay.classList.remove('hidden');
            if (!builderState.legs.entry.length) {
                addLeg('entry');
            }
            renderLegs('adjustment');
            renderLegs('exit');
            ['entry','adjustment','exit'].forEach(renderCombined);
        }

        function closeBuilder() {
            builderOverlay.classList.add('hidden');
        }

        launchBuilderBtn.addEventListener('click', openBuilder);
        closeBuilderBtn.addEventListener('click', closeBuilder);
        builderOverlay.addEventListener('click', (event) => {
            if (event.target === builderOverlay) closeBuilder();
        });
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') closeBuilder();
        });

        builderForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const formData = new FormData(builderForm);
            const name = formData.get('strategyName')?.trim();
            const id = (formData.get('strategyId')?.trim() || name || '').toUpperCase().replace(/\s+/g, '_');

            if (!name) {
                flashBuilder('Strategy name required', true);
                return;
            }

            if (!builderState.legs.entry.length) {
                flashBuilder('Add at least one entry leg', true);
                return;
            }

            const payload = {
                name,
                id,
                identity: {
                    template: formData.get('strategyType'),
                    underlying: formData.get('underlying'),
                    frequency: formData.get('frequency'),
                    entry_time: formData.get('entryTime'),
                    exit_time: formData.get('exitTime'),
                    notes: formData.get('notes')
                },
                entry: {
                    legs: builderState.legs.entry,
                    combined_rules: builderState.combined.entry
                },
                adjustment: {
                    legs: builderState.legs.adjustment,
                    combined_rules: builderState.combined.adjustment
                },
                exit: {
                    legs: builderState.legs.exit,
                    combined_rules: builderState.combined.exit
                },
                rms: {
                    target_profit: Number(formData.get('targetProfit')) || 0,
                    stop_loss: Number(formData.get('stopLoss')) || 0,
                    max_drawdown: Number(formData.get('maxDrawdown')) || 0,
                    max_positions: Number(formData.get('maxPositions')) || 1,
                    exposure_limit: Number(formData.get('exposureLimit')) || 0,
                    hedge_preference: formData.get('hedgePreference')
                },
                storage_path: 'shoonya_platform/strategies/saved_configs'
            };

            try {
                const res = await fetch('/dashboard/strategy/config/save-all', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    credentials: 'include'
                });

                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({}));
                    throw new Error(errorData.detail || res.statusText);
                }

                flashBuilder('Strategy saved into saved_configs', false);
                loadStrategies();
                setTimeout(() => {
                    closeBuilder();
                    resetBuilder();
                }, 600);
            } catch (error) {
                flashBuilder(error.message, true);
            }
        });

        function flashBuilder(message, isError) {
            builderFlash.textContent = message;
            builderFlash.className = `builder-alert show ${isError ? 'alert-error' : 'alert-success'}`;
        }

        async function loadStrategies() {
            try {
                const res = await fetch('/dashboard/strategy/configs', { credentials: 'include' });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                const configs = data.configs || [];
                renderStrategyCards(configs);
            } catch (error) {
                console.error('Strategy load failed', error);
                strategyBoardEl.innerHTML = '<div class="empty-copy">Unable to load strategies right now.</div>';
            }
        }

        function renderStrategyCards(strategies) {
            if (!strategies.length) {
                strategyBoardEl.innerHTML = '<div class="empty-copy" style="grid-column: 1 / -1;">No strategies saved. Use "+ Create Strategy" to build one.</div>';
                return;
            }

            const filter = document.querySelector('.chip.active')?.dataset.filter || 'ALL';
            const filtered = filter === 'ALL' ? strategies : strategies.filter(s => (s.status || 'IDLE') === filter);

            strategyBoardEl.innerHTML = filtered.map(strategy => {
                const identity = strategy.identity || {};
                const status = strategy.status || 'IDLE';
                const running = status === 'RUNNING';
                return `
                    <div class="strategy-card ${running ? 'running' : ''}">
                        ${running ? '<div class="lock-overlay"><span>ðŸ”’</span>RUNNING</div>' : ''}
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <h4>${strategy.name}</h4>
                            <span class="badge ${running ? 'badge-danger' : 'badge-neutral'}">${status}</span>
                        </div>
                        <div class="meta-row">
                            <span>${identity.underlying || 'NIFTY'}</span>
                            <span>Freq: ${identity.frequency || 'MANUAL'}</span>
                            <span>Entry ${identity.entry_time || '--:--'} / Exit ${identity.exit_time || '--:--'}</span>
                        </div>
                        <div class="action-row">
                            <button class="action-btn action-start" ${running ? 'style="visibility:hidden;"' : ''} onclick="startStrategy('${strategy.name}')">Start</button>
                            <button class="action-btn action-pause" ${running ? '' : 'disabled'} onclick="pauseStrategy('${strategy.name}')">Pause</button>
                            <button class="action-btn action-stop" ${running ? '' : 'disabled'} onclick="stopStrategy('${strategy.name}')">Stop</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function loadMonitorData() {
            try {
                strategyPulseEl.textContent = 'SYNCING...';
                // Endpoint: /dashboard/monitoring/strategy-positions returns {legs_detailed, strategy_positions}
                const res = await fetch('/dashboard/monitoring/strategy-positions', { credentials: 'include' });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                
                // Transform backend response to frontend format
                const transformed = {
                    orphan_legs: data.legs_detailed || [],
                    strategies: (data.strategy_positions || []).map(s => ({
                        name: s.strategy_name,
                        legs: s.legs || [],
                        combined_delta: s.combined_delta || 0,
                        combined_gamma: s.combined_gamma || 0,
                        combined_theta: s.combined_theta || 0,
                        combined_vega: s.combined_vega || 0,
                        total_pnl: (s.total_unrealized_pnl || 0) + (s.total_realized_pnl || 0),
                    }))
                };
                
                renderOrphans(transformed.orphan_legs || []);
                renderMonitorTable(transformed.strategies || []);
                renderCombinedGreeks(transformed.strategies || []);
                strategyPulseEl.textContent = `UPDATED ${new Date().toLocaleTimeString()}`;
            } catch (error) {
                console.error('Monitor load failed', error);
                strategyPulseEl.textContent = 'STALE';
                orphanLegsEl.innerHTML = '<div class="empty-copy">No orphan leg data.</div>';
                combinedGreeksEl.innerHTML = '';
                strategyMonitorEl.innerHTML = '<tr><td colspan="6" style="text-align:center;">Monitor data unavailable</td></tr>';
            }
        }

        function renderOrphans(orphanLegs) {
            orphanCountEl.textContent = `${orphanLegs.length} ORPHANS`;
            if (!orphanLegs.length) {
                orphanLegsEl.innerHTML = '<div class="empty-copy">No orphan legs detected. Book is clean.</div>';
                return;
            }

            orphanLegsEl.innerHTML = orphanLegs.map(leg => `
                <div class="orphan-leg">
                    <div>
                        <strong>${leg.leg_id || leg.id}</strong>
                        <div style="font-size:12px;color:var(--muted);">${leg.instrument || 'NIFTY'} ${leg.option_type || ''} ${leg.strike || ''}</div>
                    </div>
                    <div>Î” ${Number(leg.delta || 0).toFixed(2)}</div>
                    <div>Î½ ${Number(leg.vega || 0).toFixed(2)}</div>
                    <div>OI ${Number(leg.open_interest || 0)}</div>
                    <span class="badge badge-danger">${leg.status || 'ORPHAN'}</span>
                </div>
            `).join('');
        }

        function renderCombinedGreeks(greeks) {
            const metrics = ['delta','gamma','theta','vega'];
            combinedGreeksEl.innerHTML = metrics.map(metric => `
                <div class="greek-pill">
                    <label>${metric}</label>
                    <span>${Number(greeks[metric] || 0).toFixed(2)}</span>
                </div>
            `).join('');
        }

        function renderMonitorTable(strategies) {
            if (!strategies.length) {
                strategyMonitorEl.innerHTML = '<tr><td colspan="6" style="text-align:center;">No strategies live</td></tr>';
                return;
            }

            strategyMonitorEl.innerHTML = strategies.map(strategy => {
                const greek = strategy.greeks || {};
                const metrics = `${Number(greek.delta || 0).toFixed(2)} / ${Number(greek.gamma || 0).toFixed(2)}`;
                const thetaVega = `${Number(greek.theta || 0).toFixed(2)} / ${Number(greek.vega || 0).toFixed(2)}`;
                const oiVol = `${strategy.open_interest || 0} / ${strategy.volume || 0}`;
                const pnl = Number(strategy.pnl || 0).toLocaleString('en-IN', { style: 'currency', currency: 'INR' });
                return `
                    <tr>
                        <td>${strategy.name}</td>
                        <td>${strategy.status || 'IDLE'}</td>
                        <td>${metrics}</td>
                        <td>${thetaVega}</td>
                        <td>${oiVol}</td>
                        <td>${pnl}</td>
                    </tr>
                `;
            }).join('');
        }

        async function sendIntent(strategyName, action) {
            try {
                const res = await fetch('/dashboard/intent/strategy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ strategy_name: strategyName, action }),
                    credentials: 'include'
                });
                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({}));
                    throw new Error(errorData.detail || res.statusText);
                }
                await loadStrategies();
            } catch (error) {
                console.error('Intent failed', error);
                alert(`Intent failed: ${error.message}`);
            }
        }

        async function startStrategy(name) {
            await sendIntent(name, 'ENTRY');
        }

        async function pauseStrategy(name) {
            // PAUSE mapped to ADJUST action (strategy parameter modification)
            // Execution layer implements as advisory/no-op to pause new entries
            await sendIntent(name, 'ADJUST');
        }

        async function stopStrategy(name) {
            await sendIntent(name, 'EXIT');
        }

        refreshNowBtn.addEventListener('click', () => {
            loadStrategies();
            loadMonitorData();
        });

        filterChips.forEach(chip => {
            chip.addEventListener('click', () => {
                filterChips.forEach(c => c.classList.remove('active'));
                chip.classList.add('active');
                loadStrategies();
            });
        });

        loadStrategies();
        loadMonitorData();
        setInterval(loadStrategies, 7000);
        setInterval(loadMonitorData, 5000);
    </script>
</body>
</html>
