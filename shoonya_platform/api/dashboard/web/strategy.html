<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Strategy Management | Shoonya Platform</title>
<link rel="stylesheet" href="/dashboard/web/styles/common.css">
<link rel="stylesheet" href="/dashboard/web/shared/layout.css">
<script src="/dashboard/web/shared/layout.js" defer></script>
<style>
/* Tab Navigation */
.tab-nav{display:flex;gap:0;border-bottom:1px solid var(--border);margin-bottom:var(--spacing-lg);overflow-x:auto;background:var(--panel-2);padding:0 var(--spacing-md)}
.tab-nav button{padding:12px 16px;border:none;background:transparent;cursor:pointer;border-bottom:3px solid transparent;color:var(--muted);font-weight:500;transition:all .2s;white-space:nowrap}
.tab-nav button.active{color:var(--primary);border-bottom-color:var(--primary)}
.tab-nav button:hover{color:var(--text)}

/* Tab Content */
.tab-content{display:none}
.tab-content.active{display:block}

/* Builder Layout */
.strat-layout{display:grid;grid-template-columns:360px 1fr;gap:var(--spacing-lg);align-items:start}
@media(max-width:1100px){.strat-layout{grid-template-columns:1fr}}

/* Sidebar */
.strat-sidebar .card{position:sticky;top:96px;max-height:calc(100vh - 110px);overflow-y:auto}
.strat-list{display:flex;flex-direction:column;gap:8px;padding:8px}
.strat-card{background:var(--panel-2);border:1px solid var(--border);border-radius:var(--radius-md);padding:12px;cursor:pointer;transition:var(--transition)}
.strat-card:hover{border-color:var(--primary)}
.strat-card.active{border-color:var(--primary);background:rgba(59,130,246,.06)}
.sc-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:2px}
.sc-name{font-weight:600;font-size:13px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:180px}
.sc-id{font-size:10px;color:var(--muted);font-family:monospace;margin-bottom:4px}
.sc-meta{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:6px}
.sc-desc{font-size:10px;color:var(--muted);margin-bottom:6px;line-height:1.3;display:-webkit-box;-webkit-line-clamp:2;line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.sc-row{display:flex;gap:5px;flex-wrap:wrap}
.sc-row button{padding:3px 8px;font-size:10px;border-radius:4px}
.sc-actions{display:flex;gap:4px;margin-top:6px}
.sc-actions button{padding:2px 7px;font-size:10px;border-radius:4px;background:transparent;border:1px solid var(--border);color:var(--muted)}
.sc-actions button:hover{color:var(--text);border-color:var(--text)}

.sp{display:inline-block;padding:2px 8px;border-radius:10px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.3px}
.sp.idle{background:rgba(255,255,255,.06);color:var(--muted)}
.sp.running{background:rgba(34,197,94,.12);color:#22c55e}
.sp.paused{background:rgba(234,179,8,.12);color:#eab308}
.sp.stopped{background:rgba(239,68,68,.12);color:#ef4444}

/* Builder Tabs */
.btabs{display:flex;gap:0;border-bottom:1px solid var(--border);margin-bottom:var(--spacing-lg);overflow-x:auto}
.btab{padding:10px 14px;font-size:12px;font-weight:500;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;transition:var(--transition);white-space:nowrap;user-select:none}
.btab:hover{color:var(--text)}
.btab.active{color:var(--primary);border-bottom-color:var(--primary)}
.btab .n{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:50%;font-size:9px;font-weight:700;background:var(--border);color:var(--muted);margin-right:4px}
.btab.active .n{background:var(--primary);color:#fff}
.btab.done .n{background:#22c55e;color:#fff}
.bpane{display:none}.bpane.active{display:block}

/* Sections */
.sec-hdr{font-size:13px;font-weight:600;color:var(--text-secondary);margin:16px 0 8px;padding-bottom:4px;border-bottom:1px dotted var(--border)}
.sec-hdr:first-child{margin-top:0}

/* Monitoring Table */
.mon-table{width:100%;border-collapse:collapse;font-size:11px}
.mon-table th{background:var(--panel-2);padding:8px;text-align:left;font-weight:600;border-bottom:1px solid var(--border)}
.mon-table td{padding:8px;border-bottom:1px solid var(--border)}
.mon-table tr:hover{background:var(--panel-2)}

.stat-box{background:var(--panel-2);border:1px solid var(--border);border-radius:var(--radius-md);padding:12px;margin-bottom:8px}
.stat-box .label{font-size:11px;color:var(--muted);margin-bottom:4px}
.stat-box .value{font-size:18px;font-weight:700;color:var(--primary)}

/* Rules */
.rule-card{background:var(--panel-2);border:1px solid var(--border);border-radius:var(--radius-md);padding:12px;margin-bottom:8px}
.rule-card .rule-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.rule-card .rule-type{display:inline-block;padding:2px 8px;background:var(--primary);color:#fff;border-radius:4px;font-size:10px;font-weight:600}
.rule-card .rule-condition{font-size:11px;color:var(--text);margin-bottom:4px;font-family:monospace}

/* Modal */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:15000;display:none;align-items:center;justify-content:center}
.modal-bg.show{display:flex}
.modal{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius-lg);padding:24px;min-width:340px;max-width:600px;max-height:80vh;overflow-y:auto}
.modal h3{margin:0 0 12px;font-size:16px}
.mf{margin-bottom:12px}
.mactions{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}

/* Toast */
.toast{position:fixed;bottom:24px;right:24px;z-index:20000;padding:12px 20px;border-radius:var(--radius-md);font-size:13px;font-weight:500;transform:translateY(100px);opacity:0;transition:all .3s ease;pointer-events:none}
.toast.show{transform:translateY(0);opacity:1}
.toast.ok{background:#166534;color:#bbf7d0;border:1px solid #22c55e}
.toast.err{background:#7f1d1d;color:#fecaca;border:1px solid #ef4444}

.empty-state{text-align:center;padding:28px 14px;color:var(--muted);font-size:12px}
.factions{display:flex;gap:8px;justify-content:flex-end;padding-top:var(--spacing-md);border-top:1px solid var(--border);margin-top:var(--spacing-md)}

.day-grid{display:flex;gap:4px;flex-wrap:wrap}
.day-grid label{display:flex;align-items:center;gap:3px;font-size:11px;background:var(--panel-2);padding:3px 8px;border-radius:4px;cursor:pointer;border:1px solid var(--border)}
.day-grid label:has(input:checked){border-color:var(--primary);background:rgba(59,130,246,.08)}
.day-grid input{width:auto;margin:0}

.btn-ghost{background:transparent;border:1px solid transparent;padding:4px 10px;font-size:11px}
.btn-ghost:hover{border-color:var(--border)}
.btn-ghost-danger{background:transparent;color:var(--danger);border:1px solid transparent;padding:4px 10px;font-size:11px}
.btn-ghost-danger:hover{border-color:var(--danger);background:rgba(239,68,68,.08)}

/* Forms */
.field{display:flex;flex-direction:column;gap:4px}
.field label{font-size:12px;font-weight:500;color:var(--text);}
.field input,.field select,.field textarea{padding:8px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--panel-2);color:var(--text);font-size:12px}
.field input:focus,.field select:focus,.field textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 2px rgba(59,130,246,.1)}

.row{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:var(--spacing-md);margin-bottom:var(--spacing-md)}

/* Summary Grid */
.sum-sec{margin-bottom:16px}
.sum-sec h4{font-size:12px;font-weight:600;color:var(--primary);margin-bottom:6px;padding-bottom:4px;border-bottom:1px solid var(--border)}
.sum-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:4px}
.sum-item{display:flex;justify-content:space-between;padding:4px 8px;background:var(--panel-2);border-radius:var(--radius-sm);font-size:11px}
.sum-item .l{color:var(--muted)}.sum-item .v{color:var(--text);font-weight:600;text-align:right;max-width:140px;overflow:hidden;text-overflow:ellipsis}

/* Greeks Badge */
.greek{display:inline-block;padding:4px 8px;border-radius:4px;font-size:10px;font-weight:600;margin:2px;background:var(--panel-2);font-family:monospace}
.greek.short{color:#ef4444}
.greek.long{color:#22c55e}
.greek.neutral{color:var(--muted)}

.loading{text-align:center;padding:20px;color:var(--muted)}
.loading::after{content:' ‚ü≥';animation:spin 2s linear infinite}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
</style>
</head>
<body data-page="strategy">
<div id="app-header"></div>
<main>
<div class="page-header">
  <h1>Strategy Management</h1>
  <p class="muted">Build, execute, monitor, and manage trading strategies with advanced position control</p>
</div>

<!-- Tab Navigation -->
<div class="tab-nav">
  <button class="active" onclick="APP.switchTab('builder')" style="padding:12px 16px;cursor:pointer;color:var(--primary);border-bottom-color:var(--primary)">
    üìã Strategy Builder
  </button>
  <button onclick="APP.switchTab('monitor')" style="padding:12px 16px;cursor:pointer">
    üìä Monitor & Control
  </button>
  <button onclick="APP.switchTab('recovery')" style="padding:12px 16px;cursor:pointer">
    ‚Ü©Ô∏è Recovery/Resume
  </button>
  <button onclick="APP.switchTab('orphan')" style="padding:12px 16px;cursor:pointer">
    üëª Orphan Positions
  </button>
</div>

<!-- ‚ïê‚ïê‚ïê TAB 1: STRATEGY BUILDER ‚ïê‚ïê‚ïê -->
<div id="tab-builder" class="tab-content active">
<div class="strat-layout">
<!-- LEFT SIDEBAR: Strategy List -->
<div class="strat-sidebar">
<div class="card">
    <div class="card-header"><h3 class="card-title">My Strategies</h3><button class="btn-primary btn-sm" onclick="S.reset()">+ New</button></div>
    <div class="card-body" style="padding:0"><div id="sList" class="strat-list"><div class="empty-state">No saved strategies</div></div></div>
</div>
</div>

<!-- RIGHT BUILDER -->
<div>
<div class="card">
<div class="card-header">
    <h3 class="card-title" id="bTitle">New Strategy</h3>
    <div id="bActs" class="flex gap-sm" style="display:none">
        <button class="btn-ghost" onclick="S.exportJSON()" title="Download JSON">Export</button>
        <button class="btn-ghost-danger" onclick="S.delCur()">Delete</button>
    </div>
</div>
<div class="card-body" style="padding-top:0">

<!-- Builder Tabs -->
<div class="btabs" id="bTabs">
    <div class="btab active" onclick="S.go(0)"><span class="n">1</span>Identity</div>
    <div class="btab" onclick="S.go(1)"><span class="n">2</span>Entry</div>
    <div class="btab" onclick="S.go(2)"><span class="n">3</span>Adjust</div>
    <div class="btab" onclick="S.go(3)"><span class="n">4</span>Exit</div>
    <div class="btab" onclick="S.go(4)"><span class="n">5</span>Risk</div>
    <div class="btab" onclick="S.go(5)"><span class="n">6</span>Summary</div>
</div>

<!-- Identity -->
<div class="bpane active" id="p0">
    <div class="sec-hdr">Strategy Identity</div>
    <div class="row">
        <div class="field"><label>Strategy Name *</label><input id="fName" placeholder="e.g. NIFTY Short Strangle Weekly" maxlength="80"></div>
        <div class="field"><label>Strategy ID (auto)</label><input id="fId" readonly style="opacity:.55"></div>
    </div>
    <div class="row">
        <div class="field"><label>Description</label><textarea id="fDesc" rows="2" placeholder="Brief description..."></textarea></div>
    </div>
    <div class="row">
        <div class="field"><label>Tags (comma separated)</label><input id="fTags" placeholder="nifty, strangle, weekly, delta-neutral"></div>
    </div>

    <div class="sec-hdr">Instrument Configuration</div>
    <div class="row">
        <div class="field"><label>Strategy Type *</label>
            <select id="fStratType" onchange="S.typeChg()">
                <option value="custom">Custom / Manual</option>
                <option value="dnss">Delta Neutral Short Strangle</option>
                <option value="short_straddle">Short Straddle</option>
                <option value="iron_condor">Iron Condor</option>
                <option value="butterfly">Butterfly Spread</option>
            </select>
        </div>
        <div class="field"><label>Exchange *</label><select id="fExchange"><option value="NFO">NFO</option><option value="BFO">BFO</option></select></div>
    </div>
    <div class="row">
        <div class="field"><label>Underlying *</label><input id="fUnderlying" list="dlUnderlying" value="NIFTY"><datalist id="dlUnderlying"><option value="NIFTY"><option value="BANKNIFTY"><option value="FINNIFTY"></datalist></div>
        <div class="field"><label>Instrument Type</label><select id="fInstType"><option value="OPTIDX">OPTIDX</option><option value="OPTSTK">OPTSTK</option></select></div>
    </div>
    <div class="row">
        <div class="field"><label>Expiry Mode</label><select id="fExpMode"><option value="weekly_current">Weekly Current</option><option value="monthly_current">Monthly Current</option></select></div>
        <div class="field"><label>Product Type</label><select id="fProduct"><option value="NRML">NRML</option><option value="MIS">MIS</option></select></div>
        <div class="field"><label>Order Type</label><select id="fOrdType"><option value="MARKET">MARKET</option><option value="LIMIT">LIMIT</option></select></div>
    </div>

    <div class="factions"><button class="btn-primary" onclick="S.go(1)">Next: Entry Rules ‚Üí</button></div>
</div>

<!-- Entry -->
<div class="bpane" id="p1">
    <div class="sec-hdr">Entry Timing</div>
    <div class="row">
        <div class="field"><label>Entry Time</label><input type="time" id="eTime" value="09:20"></div>
        <div class="field"><label>Entry End Window</label><input type="time" id="eEndTime" value="14:00"></div>
        <div class="field"><label>Entry Delay After Open (sec)</label><input type="number" id="eDelay" min="0" value="0"></div>
    </div>
    <div class="row">
        <div class="field"><label>Active Days</label>
            <div class="day-grid">
                <label><input type="checkbox" id="eMon" checked>Mon</label>
                <label><input type="checkbox" id="eTue" checked>Tue</label>
                <label><input type="checkbox" id="eWed" checked>Wed</label>
                <label><input type="checkbox" id="eThu" checked>Thu</label>
                <label><input type="checkbox" id="eFri" checked>Fri</label>
            </div>
        </div>
    </div>

    <div class="sec-hdr">Entry Conditions</div>
    <div class="row">
        <div class="field"><label>Condition Type</label><select id="eCondType"><option value="time_based">Time Based</option><option value="price_level">Price Level</option></select></div>
        <div class="field"><label>Price Above</label><input type="number" id="ePrAbove" step="10"></div>
        <div class="field"><label>Price Below</label><input type="number" id="ePrBelow" step="10"></div>
    </div>

    <div class="sec-hdr">Position Sizing</div>
    <div class="row">
        <div class="field"><label>Lots *</label><input type="number" id="eLots" min="1" value="1"></div>
        <div class="field"><label>Max Open Positions</label><input type="number" id="eMaxPos" min="1" value="1"></div>
    </div>

    <div id="legFields"></div>

    <div class="factions">
        <button class="btn-secondary" onclick="S.go(0)">&larr; Back</button>
        <button class="btn-primary" onclick="S.go(2)">Next: Adjustment ‚Üí</button>
    </div>
</div>

<!-- Adjustment -->
<div class="bpane" id="p2">
    <div class="sec-hdr">General</div>
    <div class="row">
        <div class="field"><label><input type="checkbox" id="aEnable" checked style="width:auto;margin-right:6px">Enable Auto Adjustments</label></div>
        <div class="field"><label>Check Interval (min)</label><input type="number" id="aInterval" min="1" value="5"></div>
        <div class="field"><label>Max Adj / Day</label><input type="number" id="aMaxDay" min="0" value="5"></div>
    </div>

    <div class="sec-hdr">Delta Adjustment</div>
    <div class="row">
        <div class="field"><label>Delta Trigger</label><input type="number" id="aDeltaTrig" step="0.01" placeholder="e.g. 0.15"></div>
        <div class="field"><label>Target Delta</label><input type="number" id="aTargetDelta" step="0.01" placeholder="e.g. 0.05"></div>
        <div class="field"><label>Delta Mode</label><select id="aDeltaMode"><option value="shift">Shift Strike</option><option value="roll">Roll to ATM</option></select></div>
    </div>

    <div class="sec-hdr">PnL Adjustment</div>
    <div class="row">
        <div class="field"><label>Profit Lock Trigger (‚Çπ)</label><input type="number" id="aProfitLock" step="100"></div>
        <div class="field"><label>Loss Repair Trigger (‚Çπ)</label><input type="number" id="aLossRepair" step="100"></div>
        <div class="field"><label>Trailing Adj Start (‚Çπ)</label><input type="number" id="aTrailStart" step="100"></div>
    </div>

    <div class="factions">
        <button class="btn-secondary" onclick="S.go(1)">&larr; Back</button>
        <button class="btn-primary" onclick="S.go(3)">Next: Exit ‚Üí</button>
    </div>
</div>

<!-- Exit -->
<div class="bpane" id="p3">
    <div class="sec-hdr">Time-Based Exit</div>
    <div class="row">
        <div class="field"><label>Exit Time</label><input type="time" id="xTime" value="15:15"></div>
        <div class="field"><label>Force Exit Before Expiry (min)</label><input type="number" id="xForceExp" min="0" value="10"></div>
    </div>

    <div class="sec-hdr">Profit Target</div>
    <div class="row">
        <div class="field"><label>Target Profit (‚Çπ)</label><input type="number" id="xProfAbs" step="100"></div>
        <div class="field"><label>Target Profit (%)</label><input type="number" id="xProfPct" step="1"></div>
    </div>

    <div class="sec-hdr">Stop Loss</div>
    <div class="row">
        <div class="field"><label>Stop Loss (‚Çπ)</label><input type="number" id="xSlAbs" step="100"></div>
        <div class="field"><label>Stop Loss (%)</label><input type="number" id="xSlPct" step="1"></div>
    </div>

    <div class="sec-hdr">Trailing Stop</div>
    <div class="row">
        <div class="field"><label>Trail Type</label><select id="xTrailType"><option value="none">Disabled</option><option value="fixed_pct">Fixed %</option><option value="step">Step-Up (‚Çπ)</option></select></div>
        <div class="field"><label>Trail Value</label><input type="number" id="xTrailVal" step="1"></div>
    </div>

    <div class="factions">
        <button class="btn-secondary" onclick="S.go(2)">&larr; Back</button>
        <button class="btn-primary" onclick="S.go(4)">Next: Risk ‚Üí</button>
    </div>
</div>

<!-- Risk Management -->
<div class="bpane" id="p4">
    <div class="sec-hdr">Position Limits</div>
    <div class="row">
        <div class="field"><label>Max Position Value (‚Çπ)</label><input type="number" id="rMaxVal" step="10000"></div>
        <div class="field"><label>Max Open Lots</label><input type="number" id="rMaxLots" min="1" value="10"></div>
        <div class="field"><label>Max Margin Used (%)</label><input type="number" id="rMaxMargin" min="0" max="100" value="70"></div>
    </div>

    <div class="sec-hdr">Daily Limits</div>
    <div class="row">
        <div class="field"><label>Daily Loss Limit (‚Çπ)</label><input type="number" id="rDailyLoss" step="1000"></div>
        <div class="field"><label>Daily Profit Target (‚Çπ)</label><input type="number" id="rDailyProfit" step="1000"></div>
        <div class="field"><label>Max Trades / Day</label><input type="number" id="rMaxTrades" min="1" value="10"></div>
    </div>

    <div class="sec-hdr">Greeks Limits</div>
    <div class="row">
        <div class="field"><label>Max Portfolio Delta</label><input type="number" id="rGkDelta" step="0.1"></div>
        <div class="field"><label>Max Portfolio Gamma</label><input type="number" id="rGkGamma" step="0.01"></div>
        <div class="field"><label>Max Portfolio Vega</label><input type="number" id="rGkVega" step="1"></div>
        <div class="field"><label>Max Portfolio Theta</label><input type="number" id="rGkTheta" step="1"></div>
    </div>

    <div class="sec-hdr">Circuit Breaker</div>
    <div class="row">
        <div class="field"><label>Circuit Breaker (‚Çπ)</label><input type="number" id="rCircuit" step="1000"></div>
        <div class="field"><label><input type="checkbox" id="rKillSwitch" style="width:auto;margin-right:6px">Kill Switch (halt all)</label></div>
    </div>

    <div class="factions">
        <button class="btn-secondary" onclick="S.go(3)">&larr; Back</button>
        <button class="btn-primary" onclick="S.go(5)">Review Summary ‚Üí</button>
    </div>
</div>

<!-- Summary -->
<div class="bpane" id="p5">
    <div id="sumContent"></div>
    <div class="factions">
        <button class="btn-secondary" onclick="S.go(4)">&larr; Edit</button>
        <button class="btn-ghost" onclick="S.exportJSON()">Export JSON</button>
        <button class="btn-success" onclick="S.save()" style="min-width:180px">Save Strategy</button>
    </div>
</div>

</div></div></div></div>
</div>

<!-- ‚ïê‚ïê‚ïê TAB 2: MONITORING & CONTROL ‚ïê‚ïê‚ïê -->
<div id="tab-monitor" class="tab-content">
<div class="card">
<div class="card-header"><h3 class="card-title">Strategy Monitoring</h3><button class="btn-sm" onclick="M.refresh()" style="background:transparent;border:1px solid var(--border);cursor:pointer">üîÑ Refresh</button></div>
<div class="card-body">
<div id="monContent" class="loading">Loading strategies...</div>
</div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê TAB 3: RECOVERY/RESUME ‚ïê‚ïê‚ïê -->
<div id="tab-recovery" class="tab-content">
<div class="card">
<div class="card-header"><h3 class="card-title">Strategy Recovery & Resume</h3><p style="margin:0;font-size:11px;color:var(--muted)">Manually resume crashed strategies or map orphan broker positions</p></div>
<div class="card-body">
<div class="row" style="margin-bottom:16px">
    <div class="field"><label>Select Strategy to Resume</label>
        <select id="recStrat" style="padding:8px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--panel-2);color:var(--text)">
            <option value="">-- Choose Strategy --</option>
        </select>
    </div>
    <div><button class="btn-primary" onclick="R.loadForRecovery()" style="margin-top:24px">Load Recovery Options</button></div>
</div>
<div id="recContent"></div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê TAB 4: ORPHAN POSITIONS ‚ïê‚ïê‚ïê -->
<div id="tab-orphan" class="tab-content">
<div style="display:grid;grid-template-columns:1fr 1fr;gap:var(--spacing-lg)">
<!-- Left: List -->
<div class="card">
<div class="card-header"><h3 class="card-title">Orphan Positions</h3><button class="btn-sm" onclick="O.refreshList()" style="background:transparent;border:1px solid var(--border);cursor:pointer">üîÑ Refresh</button></div>
<div class="card-body">
<div id="orphanList" class="loading">Loading...</div>
</div>
</div>

<!-- Right: Rules & Summary -->
<div>
<!-- Rules -->
<div class="card" style="margin-bottom:var(--spacing-lg)">
<div class="card-header"><h3 class="card-title">Management Rules</h3><button class="btn-primary btn-sm" onclick="O.showNewRuleModal()">+ New Rule</button></div>
<div class="card-body">
<div id="rulesList" class="loading">Loading...</div>
</div>
</div>

<!-- Summary -->
<div class="card">
<div class="card-header"><h3 class="card-title">Combined Summary</h3></div>
<div class="card-body">
<div id="orphanSummary"></div>
</div>
</div>
</div>
</div>
</div>

<!-- Modals -->
<div id="toast" class="toast"></div>

<div id="modalBg" class="modal-bg">
<div class="modal">
    <h3 id="modalTitle">Clone Strategy</h3>
    <div id="modalContent"></div>
    <div class="mactions">
        <button class="btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn-primary" id="mBtn" onclick="modalOk()">Clone</button>
    </div>
</div>
</div>

<script>
const API='/dashboard';
const APP={switchTab(t){
    document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));
    document.getElementById('tab-'+t).classList.add('active');
    document.querySelectorAll('.tab-nav button').forEach((b,i)=>{
        b.style.color=b.textContent.indexOf(t.charAt(0))>-1?'var(--primary)':'var(--muted)';
        b.style.borderBottomColor=b.textContent.indexOf(t.charAt(0))>-1?'var(--primary)':'transparent';
    });
    if(t==='monitor'){M.refresh()}
    else if(t==='recovery'){R.loadStrategies()}
    else if(t==='orphan'){O.refreshList();O.refreshRules();O.refreshSummary()}
}};

// Toast
function toast(m,ok){const el=document.getElementById('toast');el.textContent=m;el.className='toast '+(ok!==false?'ok':'err');el.classList.add('show');clearTimeout(el._t);el._t=setTimeout(()=>el.classList.remove('show'),4000)}

// Helpers
const $=id=>document.getElementById(id);
const gv=id=>{const e=$(id);return e?e.value.trim():''};
const gn=id=>{const v=parseFloat(gv(id));return isNaN(v)?null:v};
const gi=id=>{const v=parseInt(gv(id));return isNaN(v)?null:v};
const gc=id=>{const e=$(id);return e?e.checked:false};
const sv=(id,v)=>{const e=$(id);if(e&&v!=null)e.value=v};
const sc=(id,v)=>{const e=$(id);if(e&&v!=null)e.checked=!!v};
const hesc=s=>String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

// ‚ïê‚ïê‚ïê STRATEGY BUILDER ‚ïê‚ïê‚ïê
const S=(function(){
let strategies=[],step=0,editing=null;

function go(n){
    if(n>0&&!$('fName').value.trim()){toast('Strategy name is required',false);n=0}
    const nm=$('fName').value.trim();
    if(nm)$('fId').value=nm.toUpperCase().replace(/[^A-Z0-9]+/g,'_');
    step=n;
    for(let i=0;i<6;i++){const p=$('p'+i);if(p)p.classList.toggle('active',i===n)}
    document.querySelectorAll('#bTabs .btab').forEach((t,i)=>{t.classList.toggle('active',i===n);if(i<n)t.classList.add('done');else if(i>n)t.classList.remove('done')});
    if(n===5)buildSummary();
}

function typeChg(){
    const t=gv('fStratType'),c=$('legFields');let h='';
    if(t==='dnss'||t==='short_straddle'){
        h=`<div class="sec-hdr">${t==='dnss'?'DNSS':'Straddle'} Legs</div><div class="row">
        <div class="field"><label>Target Entry Delta</label><input type="number" id="xTgtDelta" step="0.01" value="0.20"></div>
        <div class="field"><label>CE Offset (pts)</label><input type="number" id="xCeOff" step="50" value="100"></div>
        <div class="field"><label>PE Offset (pts)</label><input type="number" id="xPeOff" step="50" value="100"></div></div>`;
    }else if(t==='iron_condor'){
        h=`<div class="sec-hdr">Iron Condor Legs</div><div class="row">
        <div class="field"><label>Short CE Offset</label><input type="number" id="xSCE" step="50" value="200"></div>
        <div class="field"><label>Long CE Offset</label><input type="number" id="xLCE" step="50" value="300"></div>
        <div class="field"><label>Short PE Offset</label><input type="number" id="xSPE" step="50" value="200"></div>
        <div class="field"><label>Long PE Offset</label><input type="number" id="xLPE" step="50" value="300"></div></div>`;
    }
    c.innerHTML=h;
}

function cIdentity(){return{strategy_type:gv('fStratType'),exchange:gv('fExchange'),underlying:gv('fUnderlying'),instrument_type:gv('fInstType'),expiry_mode:gv('fExpMode'),product_type:gv('fProduct'),order_type:gv('fOrdType')}}

function cEntry(){
    const days=[];['eMon','eTue','eWed','eThu','eFri'].forEach((id,i)=>{if(gc(id))days.push(['mon','tue','wed','thu','fri'][i])});
    const legs={};
    const t=gv('fStratType');
    if(t==='dnss'||t==='short_straddle'){legs.target_entry_delta=gn('xTgtDelta');legs.ce_offset=gi('xCeOff');legs.pe_offset=gi('xPeOff')}
    else if(t==='iron_condor'){legs.short_ce_offset=gi('xSCE');legs.long_ce_offset=gi('xLCE');legs.short_pe_offset=gi('xSPE');legs.long_pe_offset=gi('xLPE')}
    return{timing:{entry_time:gv('eTime'),entry_end_time:gv('eEndTime'),entry_delay_seconds:gi('eDelay'),active_days:days},condition:{type:gv('eCondType'),price_above:gn('ePrAbove'),price_below:gn('ePrBelow')},position:{lots:gi('eLots'),max_open_positions:gi('eMaxPos')},legs:legs}
}

function cAdj(){return{general:{enabled:gc('aEnable'),check_interval_min:gi('aInterval'),max_adj_per_day:gi('aMaxDay')},delta:{trigger:gn('aDeltaTrig'),target:gn('aTargetDelta'),mode:gv('aDeltaMode')},pnl:{profit_lock_trigger:gn('aProfitLock'),loss_repair_trigger:gn('aLossRepair'),trailing_adj_start:gn('aTrailStart')}}}

function cExit(){return{time:{exit_time:gv('xTime'),force_exit_before_expiry_min:gi('xForceExp')},profit:{target_rupees:gn('xProfAbs'),target_pct:gn('xProfPct')},stop_loss:{sl_rupees:gn('xSlAbs'),sl_pct:gn('xSlPct')},trailing:{type:gv('xTrailType'),value:gn('xTrailVal')}}}

function cRms(){return{position:{max_value:gn('rMaxVal'),max_lots:gi('rMaxLots'),max_margin_pct:gi('rMaxMargin')},daily:{loss_limit:gn('rDailyLoss'),profit_target:gn('rDailyProfit'),max_trades:gi('rMaxTrades')},greeks:{max_delta:gn('rGkDelta'),max_gamma:gn('rGkGamma'),max_vega:gn('rGkVega'),max_theta:gn('rGkTheta')},circuit:{amount:gn('rCircuit'),kill_switch:gc('rKillSwitch')}}}

function collectAll(){return{name:$('fName').value.trim(),id:$('fId').value.trim(),description:gv('fDesc'),tags:gv('fTags')?gv('fTags').split(',').map(t=>t.trim()).filter(Boolean):[],identity:cIdentity(),entry:cEntry(),adjustment:cAdj(),exit:cExit(),rms:cRms()}}

function buildSummary(){
    const d=collectAll();let h='';
    const sections=[['Identity',d.identity],['Entry Rules',d.entry],['Adjustment',d.adjustment],['Exit Rules',d.exit],['Risk Mgmt',d.rms]];
    for(const[title,data]of sections){
        h+=`<div class="sum-sec"><h4>${title}</h4><div class="sum-grid">`;
        const flat=(o,p)=>{const r=[];for(const[k,v]of Object.entries(o||{})){if(v&&typeof v==='object'&&!Array.isArray(v))r.push(...flat(v,p?p+'.'+k:k));else r.push([(p?p+'.':'')+k,v])}return r};
        for(const[k,v]of flat(data)){
            const lbl=k.split('.').pop().replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
            const val=v===true?'‚úì':v===false?'‚úó':v==null||v===''?'‚Äî':Array.isArray(v)?v.join(', ')||'‚Äî':String(v);
            h+=`<div class="sum-item"><span class="l">${lbl}</span><span class="v">${val}</span></div>`;
        }
        h+='</div></div>';
    }
    $('sumContent').innerHTML=h;
}

async function save(){
    const p=collectAll();if(!p.name){toast('Name required',false);return}
    try{
        const r=await fetch(`${API}/strategy/config/save-all`,{method:'POST',credentials:'include',headers:{'Content-Type':'application/json'},body:JSON.stringify(p)});
        if(!r.ok)throw new Error((await r.json()).detail||`HTTP ${r.status}`);
        toast(`"${p.name}" saved`);editing=p.name;await loadList();
    }catch(e){toast('Save failed: '+e.message,false)}
}

function exportJSON(){
    const d=collectAll();if(!d.name){toast('Name required',false);return}
    d.schema_version='2.0';d.exported_at=new Date().toISOString();
    const blob=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=(d.id||'strategy')+'.json';a.click();
}

async function delCur(){
    if(!editing||!confirm(`Delete "${editing}"?`))return;
    try{
        const r=await fetch(`${API}/strategy/config/${encodeURIComponent(editing)}`,{method:'DELETE',credentials:'include'});
        if(!r.ok)throw new Error((await r.json()).detail||`HTTP ${r.status}`);
        toast(`"${editing}" deleted`);reset();await loadList();
    }catch(e){toast('Delete failed: '+e.message,false)}
}

function reset(){
    editing=null;$('bTitle').textContent='New Strategy';$('bActs').style.display='none';
    document.querySelectorAll('input[type="text"],input[type="number"],input[type="time"],textarea').forEach(el=>{el.value=el.id==='fUnderlying'?'NIFTY':el.defaultValue||''});
    document.querySelectorAll('select').forEach(el=>el.selectedIndex=0);
    ['eMon','eTue','eWed','eThu','eFri','aEnable','rTrackComb'].forEach(id=>sc(id,true));
    sv('eTime','09:20');sv('eEndTime','14:00');sv('xTime','15:15');sv('eLots','1');sv('eMaxPos','1');
    typeChg();go(0);
}

async function loadList(){
    try{const r=await fetch(`${API}/strategy/configs`,{credentials:'include'});if(!r.ok)return;const d=await r.json();strategies=d.configs||[];renderList()}catch(e){console.error(e)}
}

function renderList(){
    const c=$('sList');
    if(!strategies.length){c.innerHTML='<div class="empty-state">No saved strategies</div>';return}
    c.innerHTML=strategies.map(s=>{
        const st=(s.status||'IDLE').toLowerCase();
        const und=s.identity?.underlying||'';
        return`<div class="strat-card${editing===s.name?' active':''}" onclick="S.load('${hesc(s.name)}')">
            <div class="sc-head"><span class="sc-name">${hesc(s.name)}</span><span class="sp ${st}">${s.status||'IDLE'}</span></div>
            ${und?`<div class="sc-id">${hesc(und)}</div>`:''}
            ${s.description?`<div class="sc-desc">${hesc(s.description)}</div>`:''}
            <div class="sc-row" onclick="event.stopPropagation()">
                <button class="btn-success btn-sm" onclick="S.start('${hesc(s.name)}')" ${st==='running'?'disabled':''}>‚ñ∂</button>
                <button class="btn-warning btn-sm" onclick="S.stop('${hesc(s.name)}')" ${st!=='running'?'disabled':''}>‚èπ</button>
            </div></div>`;
    }).join('');
}

async function load(name){
    try{
        const r=await fetch(`${API}/strategy/config/${encodeURIComponent(name)}`,{credentials:'include'});if(!r.ok)return;
        const d=await r.json();editing=name;$('bTitle').textContent='Edit: '+name;$('bActs').style.display='flex';
        const id=d.identity||{};sv('fName',d.name||name);sv('fId',d.id||'');sv('fDesc',d.description||'');sv('fTags',(d.tags||[]).join(', '));
        sv('fStratType',id.strategy_type);sv('fExchange',id.exchange);sv('fUnderlying',id.underlying||'NIFTY');sv('fInstType',id.instrument_type||'OPTIDX');sv('fExpMode',id.expiry_mode||'weekly_current');
        sv('fProduct',id.product_type||'NRML');sv('fOrdType',id.order_type||'MARKET');typeChg();
        const en=d.entry||{};const et=en.timing||{};const ep=en.position||{};
        sv('eTime',et.entry_time);sv('eEndTime',et.entry_end_time);sv('eDelay',et.entry_delay_seconds);
        ['eMon','eTue','eWed','eThu','eFri'].forEach((id,i)=>sc(id,(et.active_days||[]).includes(['mon','tue','wed','thu','fri'][i])));
        sv('eCondType',en.condition?.type||'time_based');sv('eLots',ep.lots||1);sv('eMaxPos',ep.max_open_positions||1);
        const ad=d.adjustment||{};const ag=ad.general||{};const adl=ad.delta||{};const apn=ad.pnl||{};
        sc('aEnable',ag.enabled!==false);sv('aInterval',ag.check_interval_min||5);sv('aMaxDay',ag.max_adj_per_day||5);
        sv('aDeltaTrig',adl.trigger);sv('aTargetDelta',adl.target);sv('aDeltaMode',adl.mode||'shift');
        sv('aProfitLock',apn.profit_lock_trigger);sv('aLossRepair',apn.loss_repair_trigger);sv('aTrailStart',apn.trailing_adj_start);
        const xt=d.exit||{};const xti=xt.time||{};const xpr=xt.profit||{};const xsl=xt.stop_loss||{};const xtr=xt.trailing||{};
        sv('xTime',xti.exit_time||'15:15');sv('xForceExp',xti.force_exit_before_expiry_min||10);
        sv('xProfAbs',xpr.target_rupees);sv('xProfPct',xpr.target_pct);sv('xSlAbs',xsl.sl_rupees);sv('xSlPct',xsl.sl_pct);
        sv('xTrailType',xtr.type||'none');sv('xTrailVal',xtr.value);
        const rm=d.rms||{};const rp=rm.position||{};const rd=rm.daily||{};const rg=rm.greeks||{};const rc=rm.circuit||{};
        sv('rMaxVal',rp.max_value);sv('rMaxLots',rp.max_lots||10);sv('rMaxMargin',rp.max_margin_pct||70);
        sv('rDailyLoss',rd.loss_limit);sv('rDailyProfit',rd.profit_target);sv('rMaxTrades',rd.max_trades||10);
        sv('rGkDelta',rg.max_delta);sv('rGkGamma',rg.max_gamma);sv('rGkVega',rg.max_vega);sv('rGkTheta',rg.max_theta);
        sv('rCircuit',rc.amount);sc('rKillSwitch',rc.kill_switch);
        go(0);renderList();
    }catch(e){toast('Load failed: '+e.message,false)}
}

async function start(name){if(confirm(`Launch "${name}"?`)){try{const r=await fetch(`${API}/intent/strategy`,{method:'POST',credentials:'include',headers:{'Content-Type':'application/json'},body:JSON.stringify({strategy_name:name,action:'ENTRY'})});if(!r.ok)throw new Error((await r.json()).detail||'Failed');toast(`"${name}" started`);await loadList()}catch(e){toast('Start failed: '+e.message,false)}}}

async function stop(name){if(confirm(`Stop "${name}" and force-exit?`)){try{const r=await fetch(`${API}/intent/strategy`,{method:'POST',credentials:'include',headers:{'Content-Type':'application/json'},body:JSON.stringify({strategy_name:name,action:'FORCE_EXIT'})});if(!r.ok)throw new Error((await r.json()).detail||'Failed');toast(`"${name}" stopped`);await loadList()}catch(e){toast('Stop failed: '+e.message,false)}}}

return{go,typeChg,save,delCur,reset,load,start,stop,exportJSON,loadList};
})();

// ‚ïê‚ïê‚ïê MONITORING ‚ïê‚ïê‚ïê
const M={async refresh(){
    try{
        const r=await fetch(`${API}/monitoring/strategy-positions`,{credentials:'include'});
        if(!r.ok)return $('monContent').innerHTML='<div class="empty-state">No strategies running</div>';
        const d=await r.json();
        if(!d.strategies||!d.strategies.length){$('monContent').innerHTML='<div class="empty-state">No active strategies</div>';return}
        let h='';
        for(const st of d.strategies){
            h+=`<div class="card" style="margin-bottom:var(--spacing-lg)"><div class="card-header"><h4>${st.strategy_name}</h4></div><div class="card-body">`;
            h+=`<table class="mon-table"><thead>
              <tr><th>Symbol</th><th>Qty</th><th>LTP</th><th>PnL</th><th>Delta</th><th>Gamma</th><th>Theta</th><th>Vega</th></tr>
            </thead><tbody>`;
            for(const pos of st.positions||[]){
                const legs=pos.legs||[];
                for(const lg of legs){
                    const pnl=parseFloat(lg.pnl||0);const delta=parseFloat(lg.delta||0);const gamma=parseFloat(lg.gamma||0);
                    h+=`<tr><td>${lg.symbol||'?'}</td><td class="text-right">${lg.qty}</td><td class="text-right">${parseFloat(lg.ltp||0).toFixed(2)}</td>
                      <td class="text-right" style="color:${pnl>=0?'var(--success)':'var(--danger)'}">‚Çπ${pnl.toFixed(0)}</td>
                      <td><span class="greek">${delta.toFixed(3)}</span></td><td><span class="greek">${gamma.toFixed(4)}</span></td>
                      <td class="text-right">${parseFloat(lg.theta||0).toFixed(2)}</td><td class="text-right">${parseFloat(lg.vega||0).toFixed(2)}</td></tr>`;
                }
            }
            h+='</tbody></table>';
            h+=`<div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
              <strong>Strategy PnL:</strong> <span style="color:${(st.total_pnl||0)>=0?'var(--success)':'var(--danger)'}">‚Çπ${(st.total_pnl||0).toFixed(0)}</span>
              | <strong>Delta:</strong> ${(st.combined_greeks?.delta||0).toFixed(3)} | <strong>Theta:</strong> ${(st.combined_greeks?.theta||0).toFixed(2)}</div>`;
            h+='</div></div>';
        }
        $('monContent').innerHTML=h;
    }catch(e){$('monContent').innerHTML=`<div class="empty-state">Error: ${e.message}</div>`}
}};

// ‚ïê‚ïê‚ïê RECOVERY ‚ïê‚ïê‚ïê
const R={strategies:[],async loadStrategies(){
    try{const r=await fetch(`${API}/strategy/configs`,{credentials:'include'});if(!r.ok)return;const d=await r.json();
        this.strategies=d.configs||[];const sel=$('recStrat');sel.innerHTML='<option value="">-- Choose Strategy --</option>';
        for(const s of this.strategies)sel.innerHTML+=`<option value="${hesc(s.name)}">${hesc(s.name)}</option>`;
    }catch(e){console.error(e)}
},async loadForRecovery(){
    const sname=gv('recStrat');if(!sname){toast('Choice a strategy',false);return}
    try{
        const r=await fetch(`${API}/strategy/list-recoverable`,{credentials:'include'});if(!r.ok)return;const d=await r.json();
        let h='<div class="sec-hdr">Available Broker Positions</div>';
        h+=`<table class="mon-table"><thead><tr><th>Symbol</th><th>Qty</th><th>LTP</th><th>Action</th></tr></thead><tbody>`;
        for(const p of d.positions||[]){
            h+=`<tr><td>${p.symbol||'?'}</td><td>${p.netqty}</td><td>${p.ltp}</td><td><button class="btn-sm" onclick="R.mapPosition('${hesc(sname)}','${p.symbol}')">Map</button></td></tr>`;
        }
        h+='</tbody></table>';
        $('recContent').innerHTML=h;
    }catch(e){$('recContent').innerHTML=`<div class="empty-state">Error: ${e.message}</div>`}
},async mapPosition(strate,sym){
    try{
        const r=await fetch(`${API}/strategy/recover-resume`,{method:'POST',credentials:'include',headers:{'Content-Type':'application/json'},body:JSON.stringify({strategy_name:strate,broker_symbol:sym})});
        if(!r.ok)throw new Error((await r.json()).detail||'Failed');toast(`Mapped ${sym} to ${strate}`);R.loadForRecovery();
    }catch(e){toast('Map failed: '+e.message,false)}
}};

// ‚ïê‚ïê‚ïê ORPHAN POSITIONS ‚ïê‚ïê‚ïê
const O={async refreshList(){
    try{
        const r=await fetch(`${API}/orphan-positions`,{credentials:'include'});if(!r.ok)return;const d=await r.json();
        let h='';if(!d.positions||!d.positions.length){h='<div class="empty-state">No orphan positions</div>'}
        else{h=`<table class="mon-table"><thead><tr><th>Symbol</th><th>Qty</th><th>LTP</th><th>PnL</th><th>Delta</th><th>Theta</th></tr></thead><tbody>`;
            for(const p of d.positions){const pnl=parseFloat(p.pnl||0);h+=`<tr><td>${p.symbol}</td><td>${p.netqty}</td><td>${parseFloat(p.ltp||0).toFixed(2)}</td><td style="color:${pnl>=0?'var(--success)':'var(--danger)'}">‚Çπ${pnl.toFixed(0)}</td><td>${parseFloat(p.delta||0).toFixed(3)}</td><td>${parseFloat(p.theta||0).toFixed(2)}</td></tr>`}
            h+='</tbody></table>';
        }
        $('orphanList').innerHTML=h;
    }catch(e){$('orphanList').innerHTML=`<div class="empty-state">Error: ${e.message}</div>`}
},async refreshRules(){
    try{
        const r=await fetch(`${API}/orphan-positions/rules`,{credentials:'include'});if(!r.ok)return;const d=await r.json();
        let h='';if(!d.rules||!d.rules.length){h='<div class="empty-state">No rules</div>'}
        else{
            for(const rul of d.rules){
                const cond=rul.rule_type==='PRICE'?`Price ${rul.target?'target=‚Çπ'+rul.target:''},  ${rul.stoploss?'SL=‚Çπ'+rul.stoploss:''}`:
                          rul.rule_type==='GREEK'?`${rul.delta_target?'ŒîT='+rul.delta_target+' ':''}${rul.theta_target?'ŒòT='+rul.theta_target:''}`:rul.rule_type;
                h+=`<div class="rule-card">
                  <div class="rule-head"><span class="rule-type">${rul.rule_type}</span><button class="btn-ghost-danger btn-sm" onclick="O.delRule('${rul.rule_id}')">√ó</button></div>
                  <div class="rule-condition">${cond}</div>
                  <div style="font-size:10px;color:var(--muted)">Symbols: ${rul.symbols.join(', ')} | Action: ${rul.action}</div>
                </div>`;
            }
        }
        $('rulesList').innerHTML=h;
    }catch(e){$('rulesList').innerHTML=`<div class="empty-state">Error loading rules</div>`}
},async refreshSummary(){
    try{
        const r=await fetch(`${API}/orphan-positions/summary`,{credentials:'include'});if(!r.ok)return;const d=await r.json();
        let h='';if(d.summary){
            h+=`<div class="stat-box"><div class="label">Total Positions</div><div class="value">${d.summary.total_positions||0}</div></div>`;
            h+=`<div class="stat-box"><div class="label">Net PnL</div><div class="value" style="color:${(d.summary.total_pnl||0)>=0?'var(--success)':'var(--danger)'}">‚Çπ${(d.summary.total_pnl||0).toFixed(0)}</div></div>`;
            h+=`<div class="stat-box"><div class="label">Combined Delta</div><div class="value">${(d.summary.combined_delta||0).toFixed(3)}</div></div>`;
            h+=`<div class="stat-box"><div class="label">Combined Theta</div><div class="value">${(d.summary.combined_theta||0).toFixed(2)}</div></div>`;
        }
        $('orphanSummary').innerHTML=h||'<div class="empty-state">No summary</div>';
    }catch(e){$('orphanSummary').innerHTML=`<div class="empty-state">Error</div>`}
},showNewRuleModal(){
    $('modalTitle').textContent='Create Management Rule';
    $('modalContent').innerHTML=`
      <div class="mf"><label>Rule Type</label><select id="ruleType" onchange="this.form.style.display='block'"><option value="">-- Select --</option><option value="PRICE">Price-Based</option><option value="GREEK">Greek-Based</option><option value="COMBINED">Combined</option></select></div>
      <div class="mf"><label>Symbols (comma-separated)</label><input id="ruleSym" placeholder="NIFTY, BANKNIFTY"></div>
      <div id="ruleFields"></div>
    `;
    $('mBtn').textContent='Create Rule';
    $('mBtn').onclick=()=>O.createRule();
    $('modalBg').classList.add('show');
},async createRule(){
    const type=gv('ruleType');const syms=gv('ruleSym').split(',').map(s=>s.trim());if(!type||!syms.length){toast('Required fields',false);return}
    const rule={rule_type:type,symbols:syms,action:'EXIT',is_active:true};
    try{
        const r=await fetch(`${API}/orphan-positions/manage`,{method:'POST',credentials:'include',headers:{'Content-Type':'application/json'},body:JSON.stringify(rule)});
        if(!r.ok)throw new Error((await r.json()).detail||'Failed');toast('Rule created');closeModal();O.refreshRules();
    }catch(e){toast('Create failed: '+e.message,false)}
},async delRule(rid){
    if(!confirm('Delete rule?'))return;try{
        const r=await fetch(`${API}/orphan-positions/rules/${rid}`,{method:'DELETE',credentials:'include'});
        if(!r.ok)throw new Error('Failed');toast('Rule deleted');O.refreshRules();
    }catch(e){toast('Delete failed: '+e.message,false)}
}};

function closeModal(){$('modalBg').classList.remove('show')}

document.addEventListener('DOMContentLoaded',()=>{S.loadList();R.loadStrategies()});
</script>
</body>
</html>
