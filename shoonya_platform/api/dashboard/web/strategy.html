<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategy Management | Shoonya Platform</title>
    <link rel="stylesheet" href="/dashboard/web/styles/common.css">
    <link rel="stylesheet" href="/dashboard/web/shared/layout.css">
    <script src="/dashboard/web/shared/layout.js" defer></script>
    <style>
        /* Top Navigation */
        .main-tabs { display: flex; gap: 0; border-bottom: 3px solid var(--border); margin-bottom: var(--spacing-lg); overflow-x: auto; background: linear-gradient(180deg, var(--panel-2) 0%, var(--panel) 100%); }
        .main-tab { padding: 16px 24px; cursor: pointer; border-bottom: 4px solid transparent; color: var(--muted); font-weight: 600; transition: all .25s; white-space: nowrap; font-size: 14px; }
        .main-tab:hover { color: var(--text); background: var(--panel-2); }
        .main-tab.active { color: var(--primary); border-bottom-color: var(--primary); margin-bottom: -3px; }

        .tab-panel { display: none; }
        .tab-panel.active { display: block; animation: fadeIn 0.2s ease-in; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Builder Tabs */
        .builder-tabs { display: flex; gap: 0; border-bottom: 2px solid var(--border); margin-bottom: var(--spacing-lg); overflow-x: auto; }
        .builder-tab { padding: 12px 16px; font-size: 12px; font-weight: 600; color: var(--muted); cursor: pointer; border-bottom: 3px solid transparent; transition: all .2s; white-space: nowrap; }
        .builder-tab:hover { color: var(--text); background: var(--panel-2); }
        .builder-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .builder-pane { display: none; }
        .builder-pane.active { display: block; }

        /* Strategy Items */
        .strategy-item { 
            background: linear-gradient(135deg, var(--panel-2) 0%, var(--panel) 100%);
            border: 1px solid var(--border); 
            border-radius: var(--radius-md); 
            padding: 16px; 
            margin-bottom: 12px; 
            display: grid; 
            grid-template-columns: 220px 1fr 200px auto; 
            gap: 16px; 
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all .2s;
        }
        .strategy-item:hover { border-color: var(--primary); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .strategy-name { font-weight: 700; color: var(--text); font-size: 14px; }
        .strategy-subtitle { font-size: 10px; color: var(--muted); margin-top: 4px; }
        .strategy-timing { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .strategy-timing select { padding: 6px 10px; font-size: 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--panel); color: var(--text); font-weight: 500; }
        .strategy-actions { display: flex; gap: 6px; align-items: center; }
        .status-pill { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-idle { background: rgba(255,255,255,.08); color: var(--muted); }
        .status-running { background: rgba(34,197,94,.15); color: #22c55e; border: 1px solid #22c55e; }
        .status-paused { background: rgba(234,179,8,.15); color: #eab308; border: 1px solid #eab308; }

        /* Button States */
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-loading { position: relative; }
        .btn-loading::after { content: ''; position: absolute; right: 8px; top: 50%; transform: translateY(-50%); width: 12px; height: 12px; border: 2px solid currentColor; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: translateY(-50%) rotate(360deg); } }

        /* Monitor Sections */
        .monitor-section { margin-bottom: 20px; }
        .section-header { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            padding: 16px; 
            background: linear-gradient(135deg, var(--panel-2) 0%, var(--panel) 100%);
            border: 1px solid var(--border); 
            border-radius: var(--radius-md); 
            cursor: pointer; 
            user-select: none;
            transition: all .2s;
        }
        .section-header:hover { background: var(--panel); border-color: var(--primary); }
        .section-toggle { display: inline-block; width: 16px; text-align: center; transition: transform .3s; font-weight: bold; }
        .section-toggle.open { transform: rotate(90deg); }
        .section-title { font-weight: 700; color: var(--text); flex: 1; font-size: 14px; }
        .section-summary { font-size: 11px; color: var(--muted); display: flex; gap: 12px; flex-wrap: wrap; }
        .section-content { display: none; padding: 16px; background: var(--panel); border: 1px solid var(--border); border-top: none; border-radius: 0 0 var(--radius-md) var(--radius-md); }
        .section-content.open { display: block; }

        /* Info Cards */
        .info-card { background: var(--panel); border-left: 4px solid var(--primary); padding: 12px; border-radius: 4px; font-size: 11px; margin: 12px 0; }
        .info-card strong { color: var(--primary); }

        /* Tables */
        .table-compact { width: 100%; border-collapse: collapse; font-size: 11px; }
        .table-compact th { background: var(--panel-2); padding: 10px; text-align: left; font-weight: 700; border-bottom: 2px solid var(--border); }
        .table-compact td { padding: 8px 10px; border-bottom: 1px solid var(--border); }
        .table-compact tr:hover { background: var(--panel-2); }
        .greek { display: inline-block; padding: 3px 6px; background: var(--panel-2); border-radius: 3px; font-family: monospace; font-size: 10px; font-weight: 600; }

        /* Forms */
        .row { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: var(--spacing-md); margin-bottom: var(--spacing-md); }
        .field { display: flex; flex-direction: column; gap: 6px; }
        label { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; color: var(--text); }
        input, select, textarea { padding: 10px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--panel-2); color: var(--text); font-size: 12px; transition: all .2s; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); background: var(--panel); box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1); }
        .card-footer { display: flex; gap: 12px; justify-content: flex-end; padding-top: var(--spacing-md); border-top: 1px solid var(--border); margin-top: var(--spacing-md); }

        /* Audit Styles */
        .stat-badge { display: inline-block; padding: 4px 8px; background: var(--panel-2); border-radius: 3px; font-size: 10px; font-weight: 600; white-space: nowrap; }
        .text-center { text-align: center; }
        h3 { font-size: 18px; font-weight: 700; margin: 20px 0 12px; }
        h4 { font-size: 13px; font-weight: 700; margin: 16px 0 12px; text-transform: uppercase; letter-spacing: 0.5px; }

        .stat-badge { display: inline-block; padding: 6px 10px; background: var(--panel-2); border-radius: 4px; font-size: 11px; font-weight: 700; margin-right: 8px; margin-bottom: 4px; }
        .summary-box { background: var(--panel); border: 1px solid var(--border); padding: 12px; border-radius: 4px; text-align: center; }
        .summary-label { font-size: 11px; color: var(--muted); font-weight: 600; }
        .summary-value { font-size: 18px; font-weight: 700; color: var(--primary); margin-top: 6px; }
        .summary-2line { display: flex; justify-content: space-between; font-size: 12px; padding: 8px 0; }
        .summary-label-2line { color: var(--muted); font-weight: 500; }
        .summary-value-2line { font-weight: 700; color: var(--text); }
        .result { padding: 16px; border-radius: var(--radius-md); margin-bottom: var(--spacing-lg); display: none; border-left: 4px solid; animation: slideDown 0.3s ease-out; }
        .result.success { background: rgba(34, 197, 94, 0.08); color: #22c55e; border-left-color: #22c55e; }
        .result.error { background: rgba(239, 68, 68, 0.08); color: #ef4444; border-left-color: #ef4444; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .grid { display: grid; gap: var(--spacing-md); }
        .grid.grid-cols-4 { grid-template-columns: repeat(4, 1fr); }
        @media(max-width: 1200px) { .strategy-item { grid-template-columns: 1fr; } }
        @media(max-width: 768px) { .grid.grid-cols-4 { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body data-page="strategy">
    <div id="app-header"></div>

    <main>
        <div class="page-header">
            <h1>Strategy Management</h1>
            <p class="muted">Build, control, monitor and manage trading strategies</p>
        </div>

        <!-- üîç EXECUTION VISIBILITY BANNER -->
        <div id="executionBanner" style="display:none; margin-bottom:20px;">
            <div id="bannerContent" style="background:linear-gradient(135deg,rgba(34,197,94,.15) 0%,rgba(34,197,94,.05) 100%); border:2px solid #22c55e; border-radius:8px; padding:16px; display:flex; align-items:center; gap:16px;">
                <div style="font-size:32px;">‚ö°</div>
                <div style="flex:1;">
                    <div style="font-weight:700; color:#22c55e; font-size:14px;">ACTIVE EXECUTION IN SYSTEM</div>
                    <div id="bannerText" style="font-size:12px; color:var(--text); margin-top:4px; font-family:monospace;"></div>
                </div>
                <button class="btn-sm" onclick="loadExecutionAudit()" style="background:#22c55e; color:black; border:none; padding:8px 16px; font-weight:600; cursor:pointer; border-radius:4px;">View Details</button>
            </div>
        </div>

        <!-- Main Navigation Tabs -->
        <div class="main-tabs">
            <div class="main-tab active" onclick="switchMainTab('builder')">üìã Strategy Builder</div>
            <div class="main-tab" onclick="switchMainTab('control')">üéõÔ∏è Control & Monitor</div>
            <div class="main-tab" onclick="switchMainTab('audit')">üîç Execution Audit</div>
        </div>

        <!-- ‚ïê‚ïê‚ïê TAB 1: STRATEGY BUILDER ‚ïê‚ïê‚ïê -->
        <div id="builder" class="tab-panel active">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Create/Edit Strategy</h3>
                    <div class="flex gap-sm">
                        <button class="btn-primary btn-sm" onclick="resetBuilder()">+ New</button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Configuration Tabs -->
                    <div class="builder-tabs">
                        <div class="builder-tab active" onclick="switchBuilderTab('identity')"><span style="display:inline-flex; align-items:center; gap:4px;"><span style="display:inline-flex; align-items:center; justify-content:center; width:16px; height:16px; border-radius:50%; font-size:9px; font-weight:700; background:var(--primary); color:#fff; margin-right:4px;">1</span>Identity</span></div>
                        <div class="builder-tab" onclick="switchBuilderTab('entry')"><span style="display:inline-flex; align-items:center; gap:4px;"><span style="display:inline-flex; align-items:center; justify-content:center; width:16px; height:16px; border-radius:50%; font-size:9px; font-weight:700; background:var(--border); color:var(--muted); margin-right:4px;">2</span>Entry</span></div>
                        <div class="builder-tab" onclick="switchBuilderTab('adjustment')"><span style="display:inline-flex; align-items:center; gap:4px;"><span style="display:inline-flex; align-items:center; justify-content:center; width:16px; height:16px; border-radius:50%; font-size:9px; font-weight:700; background:var(--border); color:var(--muted); margin-right:4px;">3</span>Adjustment</span></div>
                        <div class="builder-tab" onclick="switchBuilderTab('exit')"><span style="display:inline-flex; align-items:center; gap:4px;"><span style="display:inline-flex; align-items:center; justify-content:center; width:16px; height:16px; border-radius:50%; font-size:9px; font-weight:700; background:var(--border); color:var(--muted); margin-right:4px;">4</span>Exit</span></div>
                        <div class="builder-tab" onclick="switchBuilderTab('risk')"><span style="display:inline-flex; align-items:center; gap:4px;"><span style="display:inline-flex; align-items:center; justify-content:center; width:16px; height:16px; border-radius:50%; font-size:9px; font-weight:700; background:var(--border); color:var(--muted); margin-right:4px;">5</span>Risk</span></div>
                    </div>

                    <!-- IDENTITY PANE -->
                    <div id="identity" class="builder-pane active">
                        <div class="row">
                            <div class="field">
                                <label>Strategy Name *</label>
                                <input type="text" id="stratName" placeholder="e.g., NIFTY Short Strangle Weekly" maxlength="80">
                            </div>
                            <div class="field">
                                <label>Strategy Type *</label>
                                <select id="stratType" onchange="updateStrategyType()">
                                    <option value="custom">Custom Strategy</option>
                                    <option value="dnss">Delta Neutral Straddle/Strangle (DNSS)</option>
                                    <option value="iron_condor">Iron Condor</option>
                                    <option value="butterfly">Butterfly</option>
                                    <option value="short_straddle">Short Straddle</option>
                                    <option value="directional">Directional Spread</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="field">
                                <label>Underlying *</label>
                                <input type="text" id="underlying" placeholder="NIFTY, BANKNIFTY, FINNIFTY" value="NIFTY">
                            </div>
                            <div class="field">
                                <label>Exchange</label>
                                <select id="exchange"><option value="NFO">NFO</option><option value="BFO">BFO</option><option value="MCX">MCX</option></select>
                            </div>
                            <div class="field">
                                <label>Instrument Type</label>
                                <select id="instType"><option value="OPTIDX">OPTIDX</option><option value="OPTSTK">OPTSTK</option><option value="FUTIDX">FUTIDX</option></select>
                            </div>
                            <div class="field">
                                <label>Product Type</label>
                                <select id="product"><option value="NRML">NRML</option><option value="MIS">MIS</option></select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="field">
                                <label>Description</label>
                                <textarea id="description" rows="2" placeholder="Brief description of strategy logic..."></textarea>
                            </div>
                        </div>
                        <div class="card-footer">
                            <button class="btn-primary" onclick="switchBuilderTab('entry')">Next: Entry Rules ‚Üí</button>
                        </div>
                    </div>

                    <!-- ENTRY PANE -->
                    <div id="entry" class="builder-pane">
                        <h4>Entry Timing</h4>
                        <div class="row">
                            <div class="field">
                                <label>Entry Time</label>
                                <input type="time" id="entryTime" value="09:20">
                            </div>
                            <div class="field">
                                <label>Entry End Window</label>
                                <input type="time" id="entryEndTime" value="14:00">
                            </div>
                            <div class="field">
                                <label>Entry Delay (seconds)</label>
                                <input type="number" id="entryDelay" min="0" value="0">
                            </div>
                        </div>

                        <h4>Entry Conditions</h4>
                        <div class="row">
                            <div class="field">
                                <label>Condition Type</label>
                                <select id="entryCondition"><option value="time_based">Time Based</option><option value="price_based">Price Level</option><option value="volatility">Volatility</option></select>
                            </div>
                            <div class="field">
                                <label>Position Size (Lots)</label>
                                <input type="number" id="positionSize" min="1" value="1">
                            </div>
                            <div class="field">
                                <label>Max Positions</label>
                                <input type="number" id="maxPositions" min="1" value="1">
                            </div>
                        </div>

                        <div id="legFields"></div>

                        <div class="card-footer">
                            <button class="btn-secondary" onclick="switchBuilderTab('identity')">‚Üê Back</button>
                            <button class="btn-primary" onclick="switchBuilderTab('adjustment')">Next: Adjustment ‚Üí</button>
                        </div>
                    </div>

                    <!-- ADJUSTMENT PANE -->
                    <div id="adjustment" class="builder-pane">
                        <h4>Delta Adjustment</h4>
                        <div class="row">
                            <div class="field">
                                <label>Enable Auto Adjustments</label>
                                <label><input type="checkbox" id="enableAdj" checked style="width:auto; margin-right:8px;">Enable</label>
                            </div>
                            <div class="field">
                                <label>Delta Trigger</label>
                                <input type="number" id="deltaTrig" step="0.01" placeholder="e.g., 0.15">
                            </div>
                            <div class="field">
                                <label>Target Delta</label>
                                <input type="number" id="deltaTarget" step="0.01" placeholder="e.g., 0.05">
                            </div>
                            <div class="field">
                                <label>Check Interval (min)</label>
                                <input type="number" id="adjInterval" min="1" value="5">
                            </div>
                        </div>

                        <h4>Profit/Loss Adjustment</h4>
                        <div class="row">
                            <div class="field">
                                <label>Profit Lock Trigger (‚Çπ)</label>
                                <input type="number" id="profitLock" step="100">
                            </div>
                            <div class="field">
                                <label>Loss Repair Trigger (‚Çπ)</label>
                                <input type="number" id="lossRepair" step="100">
                            </div>
                            <div class="field">
                                <label>Max Adjustments/Day</label>
                                <input type="number" id="maxAdj" min="0" value="3">
                            </div>
                        </div>

                        <div class="card-footer">
                            <button class="btn-secondary" onclick="switchBuilderTab('entry')">‚Üê Back</button>
                            <button class="btn-primary" onclick="switchBuilderTab('exit')">Next: Exit ‚Üí</button>
                        </div>
                    </div>

                    <!-- EXIT PANE -->
                    <div id="exit" class="builder-pane">
                        <h4>Time-Based Exit</h4>
                        <div class="row">
                            <div class="field">
                                <label>Exit Time</label>
                                <input type="time" id="exitTime" value="15:15">
                            </div>
                            <div class="field">
                                <label>Force Exit Before Expiry (min)</label>
                                <input type="number" id="forceExit" min="0" value="10">
                            </div>
                        </div>

                        <h4>Profit Target</h4>
                        <div class="row">
                            <div class="field">
                                <label>Target Profit (‚Çπ)</label>
                                <input type="number" id="targetProfit" step="100">
                            </div>
                            <div class="field">
                                <label>Target Profit (%)</label>
                                <input type="number" id="targetProfitPct" step="1">
                            </div>
                        </div>

                        <h4>Stop Loss</h4>
                        <div class="row">
                            <div class="field">
                                <label>Stop Loss (‚Çπ)</label>
                                <input type="number" id="stopLoss" step="100">
                            </div>
                            <div class="field">
                                <label>Stop Loss (%)</label>
                                <input type="number" id="stopLossPct" step="1">
                            </div>
                            <div class="field">
                                <label>Trailing Stop (%)</label>
                                <input type="number" id="trailingStop" step="1">
                            </div>
                        </div>

                        <div class="card-footer">
                            <button class="btn-secondary" onclick="switchBuilderTab('adjustment')">‚Üê Back</button>
                            <button class="btn-primary" onclick="switchBuilderTab('risk')">Next: Risk ‚Üí</button>
                        </div>
                    </div>

                    <!-- RISK PANE -->
                    <div id="risk" class="builder-pane">
                        <h4>Position Limits</h4>
                        <div class="row">
                            <div class="field">
                                <label>Max Position Value (‚Çπ)</label>
                                <input type="number" id="maxPosValue" step="10000">
                            </div>
                            <div class="field">
                                <label>Max Margin (%)</label>
                                <input type="number" id="maxMargin" min="0" max="100" value="70">
                            </div>
                            <div class="field">
                                <label>Max Lots/Trade</label>
                                <input type="number" id="maxLots" min="1" value="10">
                            </div>
                        </div>

                        <h4>Daily Limits</h4>
                        <div class="row">
                            <div class="field">
                                <label>Daily Loss Limit (‚Çπ)</label>
                                <input type="number" id="dailyLoss" step="1000">
                            </div>
                            <div class="field">
                                <label>Daily Profit Target (‚Çπ)</label>
                                <input type="number" id="dailyProfit" step="1000">
                            </div>
                            <div class="field">
                                <label>Max Trades/Day</label>
                                <input type="number" id="maxTrades" min="1" value="10">
                            </div>
                        </div>

                        <h4>Circuit Breaker</h4>
                        <div class="row">
                            <div class="field">
                                <label>Circuit Breaker (‚Çπ)</label>
                                <input type="number" id="circuitBreaker" step="1000">
                            </div>
                            <div class="field">
                                <label><input type="checkbox" id="killSwitch" style="width:auto; margin-right:8px;">Kill Switch (halt all)</label>
                            </div>
                        </div>

                        <div class="card-footer">
                            <button class="btn-secondary" onclick="switchBuilderTab('exit')">‚Üê Back</button>
                            <button class="btn-success" onclick="saveStrategy()" style="min-width:150px;">‚úì Save Strategy</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê TAB 2: CONTROL & MONITOR ‚ïê‚ïê‚ïê -->
        <div id="control" class="tab-panel">
            <!-- Strategy Control Section -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Strategy Control & Scheduling</h3>
                    <button class="btn-primary btn-sm" onclick="loadStrategies()" style="margin-left:auto;">üîÑ Refresh</button>
                </div>
                <div class="card-body">
                    <div id="strategyList" style="min-height: 200px;">
                        <div class="muted" style="text-align:center; padding:20px;">Loading strategies...</div>
                    </div>
                </div>
            </div>

            <!-- Strategy Monitor Section -->
            <div class="card" style="margin-top: var(--spacing-lg);">
                <div class="card-header">
                    <h3 class="card-title">Strategy Monitor</h3>
                    <button class="btn-sm" onclick="refreshMonitor()" style="background:transparent; border:1px solid var(--border); cursor:pointer; margin-left:auto;">üîÑ Refresh</button>
                </div>
                <div class="card-body">
                    <!-- Orphan Positions Section -->
                    <div class="monitor-section">
                        <div class="section-header" onclick="toggleSection(event, 'orphanContent')">
                            <span class="section-toggle">‚ñ∂</span>
                            <span class="section-title">üëª Orphan Positions</span>
                            <span class="section-summary" id="orphanBadge">0 positions</span>
                        </div>
                        <div id="orphanContent" class="section-content">
                            <table class="table-compact">
                                <thead>
                                    <tr><th>Symbol</th><th>Qty</th><th>LTP</th><th>PnL</th><th>Œî</th><th>Œì</th><th>Œ∏</th><th>ŒΩ</th></tr>
                                </thead>
                                <tbody id="orphanBody">
                                    <tr><td colspan="8" class="text-center muted">No orphan positions</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Strategy Monitors -->
                    <div id="strategyMonitors"></div>
                </div>
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê TAB 3: EXECUTION AUDIT (100% VISIBILITY) ‚ïê‚ïê‚ïê -->
        <div id="audit" class="tab-panel">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üîç System Execution Audit</h3>
                    <p class="muted" style="margin-top:6px;">Complete visibility of all strategy execution in system - no hidden execution</p>
                </div>

                <!-- Audit Stats -->
                <div id="auditStats" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(180px, 1fr)); gap:12px; margin-bottom:24px;">
                    <div class="info-card" style="border-left:4px solid #22c55e;">
                        <div style="font-size:11px; color:var(--muted);">STRATEGIES RUNNING</div>
                        <div id="stat-running" style="font-size:28px; font-weight:700; color:#22c55e; margin-top:6px;">0</div>
                    </div>
                    <div class="info-card" style="border-left:4px solid #eab308;">
                        <div style="font-size:11px; color:var(--muted);">PAUSED STRATEGIES</div>
                        <div id="stat-paused" style="font-size:28px; font-weight:700; color:#eab308; margin-top:6px;">0</div>
                    </div>
                    <div class="info-card" style="border-left:4px solid #3b82f6;">
                        <div style="font-size:11px; color:var(--muted);">INTENTS IN QUEUE</div>
                        <div id="stat-intents" style="font-size:28px; font-weight:700; color:#3b82f6; margin-top:6px;">0</div>
                    </div>
                    <div class="info-card" style="border-left:4px solid #8b5cf6;">
                        <div style="font-size:11px; color:var(--muted);">ACTIVE POSITIONS</div>
                        <div id="stat-positions" style="font-size:28px; font-weight:700; color:#8b5cf6; margin-top:6px;">0</div>
                    </div>
                </div>

                <!-- Warning for hidden strategies -->
                <div id="hiddenWarning" style="display:none; background:rgba(239,68,68,.15); border:2px solid #ef4444; border-radius:8px; padding:16px; margin-bottom:20px;">
                    <div style="font-weight:700; color:#ef4444;">‚ö†Ô∏è HIDDEN STRATEGY DETECTED</div>
                    <div style="font-size:12px; color:var(--text); margin-top:8px;">Strategy running with active positions but NO saved configuration. See below for details.</div>
                </div>

                <!-- All Strategies Table -->
                <div style="margin-top:20px;">
                    <h4 style="margin-bottom:12px;">üìä All Strategies in System</h4>
                    <table class="table-compact" style="width:100%;">
                        <thead>
                            <tr>
                                <th style="min-width:150px;">Strategy Name</th>
                                <th style="min-width:100px;">Status</th>
                                <th>Underlying</th>
                                <th>Pending Intents</th>
                                <th>Active Positions</th>
                                <th>Created</th>
                                <th>Update Status</th>
                            </tr>
                        </thead>
                        <tbody id="auditTableBody">
                            <tr><td colspan="7" class="text-center muted">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Control Intents Queue -->
                <div style="margin-top:24px;">
                    <h4 style="margin-bottom:12px;">üìã Control Intents Queue (Execution Order)</h4>
                    <div style="background:var(--panel-2); border:1px solid var(--border); border-radius:6px; padding:12px; font-family:monospace; font-size:11px; max-height:300px; overflow-y:auto;">
                        <div id="intentsQueue" style="color:var(--muted);">No pending intents in queue</div>
                    </div>
                </div>

                <!-- Auto-refresh indicator -->
                <div style="margin-top:20px; padding-top:20px; border-top:1px solid var(--border); text-align:center;">
                    <span style="font-size:11px; color:var(--muted);">üîÑ Auto-refreshing every 3 seconds</span>
                    <br/>
                    <button class="btn-primary btn-sm" onclick="loadExecutionAudit()" style="margin-top:10px;">Refresh Now</button>
                </div>
            </div>
        </div>        <div id="result" class="result" style="margin-top:var(--spacing-lg);"></div>
    </main>

    <script>
        const API = '/dashboard';
        let strategies = [];
        let activeIntents = new Map();  // Track ongoing intent submissions
        let auditRefreshInterval;

        function switchMainTab(tab) {
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            if (tab === 'control') { loadStrategies(); refreshMonitor(); }
            if (tab === 'audit') { loadExecutionAudit(); startAuditRefresh(); }
        }

        function switchBuilderTab(tab) {
            document.querySelectorAll('.builder-pane').forEach(p => p.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            document.querySelectorAll('.builder-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
        }

        function updateStrategyType() {
            const type = document.getElementById('stratType').value;
            const container = document.getElementById('legFields');
            let html = '<h4 style="margin-top:16px;">Strategy-Specific Parameters</h4><div class="row">';
            if (type === 'dnss') {
                html += `<div class="field"><label>Target Entry Delta</label><input type="number" step="0.01" value="0.20"></div>
                        <div class="field"><label>CE Offset (pts)</label><input type="number" step="50" value="100"></div>
                        <div class="field"><label>PE Offset (pts)</label><input type="number" step="50" value="100"></div>`;
            } else if (type === 'iron_condor') {
                html += `<div class="field"><label>Short CE Offset</label><input type="number" step="50" value="200"></div>
                        <div class="field"><label>Long CE Offset</label><input type="number" step="50" value="300"></div>
                        <div class="field"><label>Short PE Offset</label><input type="number" step="50" value="200"></div>
                        <div class="field"><label>Long PE Offset</label><input type="number" step="50" value="300"></div>`;
            }
            html += '</div>';
            container.innerHTML = html;
        }

        function resetBuilder() {
            document.querySelectorAll('input[type="text"], input[type="time"], input[type="number"], textarea').forEach(el => el.value = '');
            document.querySelectorAll('select').forEach(el => el.selectedIndex = 0);
            document.getElementById('underlying').value = 'NIFTY';
            document.getElementById('entryTime').value = '09:20';
            document.getElementById('entryEndTime').value = '14:00';
            document.getElementById('exitTime').value = '15:15';
            document.getElementById('positionSize').value = '1';
            document.getElementById('maxPositions').value = '1';
            updateStrategyType();
            switchBuilderTab('identity');
        }

        function saveStrategy() {
            if (!document.getElementById('stratName').value) { showResult(false, '‚ö†Ô∏è Strategy name is required'); return; }
            showResult(true, '‚úÖ Strategy saved successfully');
            setTimeout(() => { loadStrategies(); switchMainTab('control'); }, 1200);
        }

        async function loadStrategies() {
            try {
                console.log('üìã Loading strategies...');
                const r = await fetch(`${API}/strategy/configs`, { credentials: 'include' });
                if (!r.ok) {
                    console.error(`‚ùå Failed to load strategies: HTTP ${r.status}`);
                    return;
                }
                const data = await r.json();
                strategies = data.configs || [];
                console.log(`‚úÖ Loaded ${strategies.length} strategies:`, strategies.map(s => s.name));
                renderStrategyList();
            } catch (e) {
                console.error('‚ùå Strategy load error:', e);
                showResult(false, '‚ùå Error: ' + e.message);
            }
        }

        function renderStrategyList() {
            const container = document.getElementById('strategyList');
            if (!strategies.length) {
                container.innerHTML = `<div class="info-card">üì≠ No saved strategies. Go to <strong>Strategy Builder</strong> to create one!</div>`;
                return;
            }
            let html = '';
            for (const s of strategies) {
                const status = s.status || 'IDLE';
                const isRunning = status === 'RUNNING';
                const btnKey = `${s.name}-start`;
                const isLoading = activeIntents.has(btnKey);
                
                html += `<div class="strategy-item" data-strategy="${s.name}">
                    <div>
                        <div class="strategy-name">${s.name}</div>
                        <div class="strategy-subtitle">
                            ${s.identity?.underlying || 'N/A'} ¬∑ ${(s.identity?.strategy_type || 'custom').toUpperCase()} 
                            ${s.created_at ? ` ¬∑ Created: ${new Date(s.created_at).toLocaleDateString()}` : ''}
                        </div>
                    </div>
                    <div class="strategy-timing">
                        <select onchange="updateSchedule('${s.name}', this.value)" ${isLoading ? 'disabled' : ''} style="min-width:150px;">
                            <option value="disabled">‚è∏ Disabled</option>
                            <option value="daily" ${s.schedule === 'daily' ? 'selected' : ''}>üìÖ Daily</option>
                            <option value="weekly" ${s.schedule === 'weekly' ? 'selected' : ''}>üìÜ Weekly</option>
                            <option value="custom" ${s.schedule === 'custom' ? 'selected' : ''}>‚öôÔ∏è Custom</option>
                            <option value="immediate" ${s.schedule === 'immediate' ? 'selected' : ''}>‚ö° On Demand</option>
                        </select>
                        <span style="font-size:12px; color:var(--muted); font-weight:500; min-width:80px; text-align:center;">
                            ${s.entry?.timing?.entry_time || '--:--'} IST
                        </span>
                    </div>
                    <div><span class="status-pill status-${status.toLowerCase()}">‚óè ${status}</span></div>
                    <div class="strategy-actions">
                        <button class="btn-success btn-sm ${isLoading ? 'btn-loading' : ''}" 
                                onclick="actionStrategy('${s.name}', 'start')" 
                                ${isRunning || isLoading ? 'disabled' : ''} 
                                title="Start strategy execution">‚ñ∂ Start</button>
                        <button class="btn-warning btn-sm" 
                                onclick="actionStrategy('${s.name}', 'pause')" 
                                ${status !== 'RUNNING' ? 'disabled' : ''} 
                                title="Pause ongoing execution">‚è∏ Pause</button>
                        <button class="btn-danger btn-sm" 
                                onclick="actionStrategy('${s.name}', 'stop')" 
                                ${status === 'IDLE' ? 'disabled' : ''} 
                                title="Force stop execution">‚èπ Stop</button>
                    </div>
                </div>`;
            }
            container.innerHTML = html;
        }

        async function actionStrategy(name, action) {
            const confirmMsg = action === 'start' ? 
                `Start "${name}" strategy?\n\n‚ö†Ô∏è This will initialize positions based on configured rules.` :
                action === 'pause' ?
                `Pause "${name}" strategy?\n\nPositions will remain open but no new adjustments.` :
                `Stop "${name}" strategy?\n\n‚ö†Ô∏è All positions will be force-exited!`;
            
            if (!confirm(confirmMsg)) return;

            const btnKey = `${name}-${action}`;
            if (activeIntents.has(btnKey)) {
                console.warn('‚ö†Ô∏è Intent already in progress for this action');
                return;
            }

            // Mark as loading
            activeIntents.set(btnKey, true);
            updateButtonStates();

            try {
                const actionMap = { start: 'ENTRY', pause: 'ADJUST', stop: 'FORCE_EXIT' };
                const payload = { strategy_name: name, action: actionMap[action], reason: 'DASHBOARD_UI' };
                
                console.log(`üì§ Submitting intent: ${JSON.stringify(payload)}`);
                
                const r = await fetch(`${API}/intent/strategy`, {
                    method: 'POST', 
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!r.ok) {
                    const errText = await r.text();
                    console.error(`‚ùå API error (${r.status}): ${errText}`);
                    throw new Error(`HTTP ${r.status}: ${errText}`);
                }
                
                const result = await r.json();
                console.log(`‚úÖ Intent accepted:`, result);
                
                showResult(true, 
                    `‚úÖ INTENT SUBMITTED SUCCESSFULLY\n\n` +
                    `Strategy: ${name}\n` +
                    `Action: ${actionMap[action]}\n` +
                    `Intent ID: ${result.intent_id || 'pending'}\n\n` +
                    `‚è≥ Execution service is now processing...\n` +
                    `Check Console (F12) for real-time updates.`
                );
                
                // Auto-refresh after delay
                setTimeout(() => { loadStrategies(); refreshMonitor(); loadExecutionAudit(); }, 1500);
            } catch (e) {
                console.error(`‚ùå Error:`, e);
                showResult(false, `‚ùå FAILED TO SUBMIT\n\n${e.message}`);
            } finally {
                // Clear loading state
                activeIntents.delete(btnKey);
                updateButtonStates();
            }
        }

        function updateButtonStates() {
            renderStrategyList();
        }

        function updateSchedule(name, schedule) { 
            showResult(true, `üìÖ ${name} scheduled: ${schedule}`); 
        }

        function toggleSection(e, contentId) {
            e.preventDefault();
            const header = e.currentTarget;
            const content = document.getElementById(contentId);
            const toggle = header.querySelector('.section-toggle');
            content.classList.toggle('open');
            toggle.classList.toggle('open');
        }

        async function loadExecutionAudit() {
            try {
                console.log('üîç Loading execution audit...');
                const r = await fetch(`${API}/monitoring/all-strategies-status`, { credentials: 'include' });
                if (!r.ok) {
                    console.error(`‚ùå Audit failed: HTTP ${r.status}`);
                    return;
                }
                const data = await r.json();
                console.log('‚úÖ Execution audit loaded:', data);
                
                // Update stats
                const audit = data.audit || {};
                document.getElementById('stat-running').textContent = audit.strategies_running || 0;
                document.getElementById('stat-paused').textContent = audit.strategies_paused || 0;
                document.getElementById('stat-intents').textContent = audit.pending_intents_in_queue || 0;
                document.getElementById('stat-positions').textContent = audit.active_positions_total || 0;

                // Show banner if running
                const banner = document.getElementById('executionBanner');
                if (audit.strategies_running > 0 || audit.pending_intents_in_queue > 0) {
                    banner.style.display = 'block';
                    const bannerText = document.getElementById('bannerText');
                    bannerText.textContent = `${audit.strategies_running} running ¬∑ ${audit.pending_intents_in_queue} intents queued ¬∑ ${audit.active_positions_total} positions`;
                } else {
                    banner.style.display = 'none';
                }

                // Show hidden warning
                const hiddenWarning = document.getElementById('hiddenWarning');
                if (audit.has_hidden_strategies) {
                    hiddenWarning.style.display = 'block';
                } else {
                    hiddenWarning.style.display = 'none';
                }

                // Update strategies table
                let tableHtml = '';
                const strategies = data.strategies || [];
                for (const s of strategies) {
                    const statusColor = s.status === 'RUNNING' ? '#22c55e' : 
                                       s.status === 'PAUSED' ? '#eab308' :
                                       s.status === 'IDLE' ? 'var(--muted)' : '#ef4444';
                    const hiddenBadge = s.is_hidden ? ' <strong style="color:#ef4444;">HIDDEN</strong>' : '';
                    
                    tableHtml += `<tr>
                        <td><strong>${s.name}</strong>${hiddenBadge}</td>
                        <td><span class="status-pill status-${s.status.toLowerCase()}">‚óè ${s.status}</span></td>
                        <td>${s.underlying}</td>
                        <td><span class="greek" style="background:#3b82f6; color:white;">${s.intent_count}</span></td>
                        <td><span class="greek" style="background:#8b5cf6; color:white;">${s.position_count}</span></td>
                        <td style="font-size:10px;">${s.created_at ? new Date(s.created_at).toLocaleDateString() : 'N/A'}</td>
                        <td>
                            <select onchange="updateStrategyStatus('${s.name}', this.value)" style="padding:4px 8px; font-size:11px; border:1px solid var(--border); border-radius:3px; background:var(--panel-2);">
                                <option value="${s.status}">${s.status}</option>
                                <option value="IDLE">‚Üí IDLE</option>
                                ${s.status !== 'RUNNING' ? '<option value="RUNNING">‚Üí RUNNING</option>' : ''}
                                ${s.status === 'RUNNING' ? '<option value="PAUSED">‚Üí PAUSED</option>' : ''}
                                ${s.status !== 'IDLE' ? '<option value="STOPPED">‚Üí STOPPED</option>' : ''}
                            </select>
                        </td>
                    </tr>`;
                }
                if (!tableHtml) {
                    tableHtml = '<tr><td colspan="7" class="text-center muted">No strategies found</td></tr>';
                }
                document.getElementById('auditTableBody').innerHTML = tableHtml;

                // Update intents queue
                const intents = data.control_intents || [];
                let intentsHtml = '';
                if (intents.length === 0) {
                    intentsHtml = '‚Äî No pending intents in queue';
                } else {
                    for (const i of intents) {
                        intentsHtml += `<div style="margin-bottom:8px; padding-bottom:8px; border-bottom:1px solid var(--border);">
                            <strong style="color:#3b82f6;">${i.intent_id}</strong> | 
                            <span style="color:#eab308;">${i.strategy_name}</span> | 
                            <span style="color:#22c55e;">${i.action}</span> | 
                            <span style="color:var(--muted);">Created: ${new Date(i.created_at || '').toLocaleString()}</span>
                        </div>`;
                    }
                }
                document.getElementById('intentsQueue').innerHTML = intentsHtml;

            } catch (e) {
                console.error('‚ùå Audit load error:', e);
            }
        }

        function updateStrategyStatus(name, newStatus) {
            if (newStatus === name) return; // No change
            // This would call an API to update status - for now just show result
            showResult(true, `üìä Strategy "${name}" status will be updated to: ${newStatus}`);
        }

        function startAuditRefresh() {
            // Clear any existing interval
            if (auditRefreshInterval) clearInterval(auditRefreshInterval);
            // Refresh every 3 seconds when audit tab is active
            auditRefreshInterval = setInterval(() => {
                if (document.getElementById('audit').classList.contains('active')) {
                    loadExecutionAudit();
                }
            }, 3000);
        }

        async function refreshMonitor() {
            try {
                console.log('üîÑ Refreshing monitor data...');
                
                const orphanR = await fetch(`${API}/orphan-positions`, { credentials: 'include' });
                if (orphanR.ok) {
                    const orphanData = await orphanR.json();
                    const count = orphanData.positions?.length || 0;
                    console.log(`üëª Orphan positions: ${count}`);
                    let html = '<tr><td colspan="8" class="text-center muted">No orphan positions found</td></tr>';
                    if (orphanData.positions?.length) {
                        html = '';
                        for (const p of orphanData.positions) {
                            const pnl = parseFloat(p.pnl || 0);
                            html += `<tr>
                                <td><strong>${p.symbol}</strong></td>
                                <td>${p.netqty}</td>
                                <td>${parseFloat(p.ltp || 0).toFixed(2)}</td>
                                <td style="color:${pnl >= 0 ? '#22c55e' : '#ef4444'}; font-weight:600;">‚Çπ${pnl.toFixed(0)}</td>
                                <td><span class="greek">${parseFloat(p.delta || 0).toFixed(3)}</span></td>
                                <td><span class="greek">${parseFloat(p.gamma || 0).toFixed(4)}</span></td>
                                <td><span class="greek">${parseFloat(p.theta || 0).toFixed(2)}</span></td>
                                <td><span class="greek">${parseFloat(p.vega || 0).toFixed(2)}</span></td>
                            </tr>`;
                        }
                    }
                    document.getElementById('orphanBody').innerHTML = html;
                    document.getElementById('orphanBadge').innerHTML = `<span class="stat-badge">${count} position${count !== 1 ? 's' : ''}</span>`;
                }

                const monR = await fetch(`${API}/monitoring/strategy-positions`, { credentials: 'include' });
                if (monR.ok) {
                    const monData = await monR.json();
                    const runningCount = (monData.strategies || []).length;
                    console.log(`üìä Running strategies: ${runningCount}`);
                    
                    let html = '';
                    if (!runningCount) {
                        html = '<div class="info-card">üìä No running strategies. Start one from the <strong>Strategy Control</strong> section above.</div>';
                    } else {
                        for (const s of (monData.strategies || [])) {
                            const totalPnL = s.total_pnl || 0;
                            const delta = (s.combined_greeks?.delta || 0).toFixed(3);
                            const theta = (s.combined_greeks?.theta || 0).toFixed(2);
                            const posCount = s.positions?.reduce((sum, p) => sum + (p.legs || []).length, 0) || 0;
                            const pnlColor = totalPnL >= 0 ? '#22c55e' : '#ef4444';
                            
                            html += `<div class="monitor-section">
                                <div class="section-header" onclick="toggleSection(event, 'strat-${s.strategy_name.replace(/\s+/g, '-')}')">
                                    <span class="section-toggle">‚ñ∂</span>
                                    <span class="section-title">üìä ${s.strategy_name}</span>
                                    <span class="section-summary">
                                        <span class="stat-badge">Legs: ${posCount}</span>
                                        <span class="stat-badge" style="color: ${pnlColor}; font-weight: 700;">PnL: ‚Çπ${totalPnL.toFixed(0)}</span>
                                        <span class="stat-badge">Œî: ${delta}</span>
                                        <span class="stat-badge">Œ∏: ${theta}</span>
                                    </span>
                                </div>
                                <div id="strat-${s.strategy_name.replace(/\s+/g, '-')}" class="section-content">
                                    <div class="info-card"><strong>Strategy Status:</strong> RUNNING | <strong>Positions:</strong> ${posCount} active legs | <strong>Total Risk:</strong> ‚Çπ${Math.abs(totalPnL).toFixed(0)}</div>
                                    
                                    <div class="summary-2line"><span class="summary-label-2line">Total P&L:</span><span class="summary-value-2line" style="color:${pnlColor}">‚Çπ${totalPnL.toFixed(0)}</span></div>
                                    <div class="summary-2line"><span class="summary-label-2line">Combined Greeks:</span><span class="summary-value-2line">Œî ${delta} | Œò ${theta}</span></div>
                                    
                                    <table class="table-compact" style="margin-top:16px;">
                                        <thead><tr><th>Symbol</th><th>Type</th><th>Qty</th><th>LTP</th><th>Avg Price</th><th>PnL</th><th>Œî</th><th>Œì</th><th>Œò</th></tr></thead>
                                        <tbody>`;
                            
                            for (const p of (s.positions || [])) {
                                for (const l of (p.legs || [])) {
                                    const lpnl = parseFloat(l.pnl || 0);
                                    html += `<tr>
                                        <td><strong>${l.symbol || '?'}</strong></td>
                                        <td>${l.type || '?'}</td>
                                        <td>${l.qty || 0}</td>
                                        <td><strong>${parseFloat(l.ltp || 0).toFixed(2)}</strong></td>
                                        <td>${parseFloat(l.avg_price || 0).toFixed(2)}</td>
                                        <td style="color:${lpnl >= 0 ? '#22c55e' : '#ef4444'}; font-weight:600;">‚Çπ${lpnl.toFixed(0)}</td>
                                        <td><span class="greek">${parseFloat(l.delta || 0).toFixed(3)}</span></td>
                                        <td><span class="greek">${parseFloat(l.gamma || 0).toFixed(4)}</span></td>
                                        <td><span class="greek">${parseFloat(l.theta || 0).toFixed(2)}</span></td>
                                    </tr>`;
                                }
                            }
                            html += '</tbody></table></div></div>';
                        }
                    }
                    document.getElementById('strategyMonitors').innerHTML = html;
                } else {
                    console.warn(`‚ö†Ô∏è Monitoring endpoint returned ${monR.status}`);
                }
            } catch (e) {
                console.error('‚ùå Monitor refresh error:', e);
            }
        }

        function showResult(success, message) {
            const resultDiv = document.getElementById('result');
            resultDiv.className = success ? 'result success' : 'result error';
            resultDiv.innerHTML = `<div style="white-space: pre-wrap; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', monospace; font-size: 13px; line-height: 1.6;">${message}</div>`;
            resultDiv.style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
            setTimeout(() => { resultDiv.style.display = 'none'; }, 7000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Strategy Manager loaded');
            console.log(`üì° API endpoint: ${API}`);
            console.log('üí° TIP: Open DevTools (F12) ‚Üí Console for detailed intent tracking');
            updateStrategyType();
            loadExecutionAudit();  // Load audit on startup
        });
    </script>
</body>
</html>
