<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard – Shoonya Platform</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/dashboard/web/styles/common.css">
    <link rel="stylesheet" href="/dashboard/web/shared/layout.css">
    <script src="/dashboard/web/shared/pages-config.js" defer></script>
    <script src="/dashboard/web/shared/layout.js" defer></script>
    <style>
        /* ── KPI Strip ── */
        .kpi-strip {
            display: flex;
            gap: 10px;
            margin-bottom: 14px;
            flex-wrap: wrap;
        }
        .kpi-card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 10px 16px;
            flex: 1;
            min-width: 120px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            transition: border-color 0.2s;
        }
        .kpi-card:hover { border-color: var(--border-light); }
        .kpi-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--muted);
            font-weight: 600;
        }
        .kpi-value {
            font-size: 18px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            line-height: 1.3;
        }
        .kpi-sub {
            font-size: 10px;
            color: var(--muted);
        }

        /* ── Main Grid ── */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 14px;
            align-items: start;
        }

        /* ── Cards ── */
        .dash-card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-bottom: 14px;
        }
        .dash-card:last-child { margin-bottom: 0; }
        .card-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            border-bottom: 1px solid var(--border);
            background: var(--panel-2);
        }
        .card-head h3 {
            font-size: 12px;
            font-weight: 700;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }
        .card-head .head-right {
            font-size: 11px;
            color: var(--muted);
        }
        .card-body-pad { padding: 12px 14px; }

        /* ── Tables ── */
        .dash-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .dash-table thead { background: var(--panel-2); }
        .dash-table th {
            padding: 8px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            color: var(--muted);
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }
        .dash-table td {
            padding: 7px 10px;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }
        .dash-table tbody tr:hover { background: var(--panel-2); }
        .dash-table .empty-row td {
            text-align: center;
            padding: 24px 10px;
            color: var(--muted);
            font-style: italic;
        }

        /* ── Info rows (risk, account) ── */
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            font-size: 12px;
        }
        .info-row + .info-row { border-top: 1px solid var(--border); }
        .info-label { color: var(--muted); }
        .info-value { font-weight: 600; font-variant-numeric: tabular-nums; }

        /* ── Badges ── */
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.3px;
        }
        .status-badge.safe { background: var(--success-bg); color: var(--success); }
        .status-badge.warning { background: var(--warning-bg); color: var(--warning); }
        .status-badge.danger { background: var(--danger-bg); color: var(--danger); }
        .status-badge.neutral { background: var(--panel-3); color: var(--muted); }
        .status-badge.info { background: var(--info-bg); color: var(--info); }

        /* ── Order side badges ── */
        .side-buy { color: var(--success); font-weight: 700; }
        .side-sell { color: var(--danger); font-weight: 700; }

        /* ── Source badge ── */
        .src-system { color: var(--primary); font-weight: 600; font-size: 10px; }
        .src-broker { color: var(--warning); font-weight: 600; font-size: 10px; }

        /* ── Full-width bottom section ── */
        .full-width-section {
            margin-top: 14px;
        }

        /* ── Messages (horizontal layout) ── */
        .msg-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
        .msg-item {
            background: var(--panel-2);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 8px 12px;
            font-size: 11px;
            line-height: 1.4;
        }
        .msg-time {
            font-size: 10px;
            color: var(--muted);
            margin-bottom: 2px;
        }
        .msg-text { color: var(--text-secondary); }

        /* ── Force Exit Banner ── */
        .force-exit-banner {
            background: var(--danger-bg);
            border: 1px solid var(--danger);
            border-radius: var(--radius-md);
            padding: 10px 14px;
            margin-bottom: 14px;
            display: none;
            font-size: 13px;
            font-weight: 600;
            color: var(--danger);
            text-align: center;
        }

        /* ── Error Banner ── */
        .error-banner {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--danger-bg);
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 8px 20px;
            border-radius: var(--radius-md);
            font-size: 12px;
            z-index: 9999;
            display: none;
        }
        .error-banner.show { display: block; }

        /* ── Refresh indicator ── */
        .refresh-info {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--muted);
        }
        .refresh-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* ── Value flash animation ── */
        @keyframes flash {
            0% { background: rgba(59, 130, 246, 0.15); }
            100% { background: transparent; }
        }
        .value-changed { animation: flash 0.6s ease; }

        /* ── Responsive ── */
        @media (max-width: 1024px) {
            .main-grid { grid-template-columns: 1fr; }
            .sidebar { order: -1; }
            .msg-grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .kpi-strip { gap: 8px; }
            .kpi-card { min-width: 90px; padding: 8px 12px; }
            .kpi-value { font-size: 15px; }
        }
        @media (max-width: 480px) {
            .kpi-strip { flex-direction: column; }
            .kpi-card { min-width: unset; }
        }
    </style>
</head>
<body data-page="dashboard">
<div id="app-header"></div>

<main>
    <!-- Error Banner -->
    <div class="error-banner" id="errorBanner"></div>

    <!-- Force Exit Banner -->
    <div class="force-exit-banner" id="forceExitBanner">
        ⚠ FORCE EXIT IN PROGRESS — All positions being squared off
    </div>

    <!-- KPI Strip -->
    <div class="kpi-strip">
        <div class="kpi-card">
            <span class="kpi-label">Net P&amp;L</span>
            <span class="kpi-value" id="kpiNetPnl" style="color: var(--muted)">--</span>
        </div>
        <div class="kpi-card">
            <span class="kpi-label">Open Positions</span>
            <span class="kpi-value" id="kpiOpenPos">0</span>
        </div>
        <div class="kpi-card">
            <span class="kpi-label">Alerts</span>
            <span class="kpi-value" id="kpiAlertTotal">0</span>
            <span class="kpi-sub" id="kpiAlertSub">--</span>
        </div>
        <div class="kpi-card">
            <span class="kpi-label">Risk Status</span>
            <span class="kpi-value" id="kpiRiskStatus">
                <span class="status-badge neutral">--</span>
            </span>
        </div>
        <div class="kpi-card">
            <span class="kpi-label">Broker</span>
            <span class="kpi-value" id="kpiBroker">
                <span class="status-badge neutral">--</span>
            </span>
        </div>
        <div class="kpi-card" style="flex: 0 0 auto; min-width: unset;">
            <span class="kpi-label">Live</span>
            <div class="refresh-info">
                <span class="refresh-dot"></span>
                <span id="lastUpdateText">--</span>
            </div>
        </div>
    </div>

    <!-- Main 2-Column Layout -->
    <div class="main-grid">
        <!-- Left Column: Tables -->
        <div class="left-col">
            <!-- Active Positions -->
            <div class="dash-card">
                <div class="card-head">
                    <h3>Active Positions</h3>
                    <span class="head-right" id="posCount"></span>
                </div>
                <div style="overflow-x: auto;">
                    <table class="dash-table">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>LTP</th>
                                <th>Net P&amp;L</th>
                                <th>Realized</th>
                                <th>Unrealized</th>
                                <th>Exch</th>
                                <th>Product</th>
                                <th>Qty</th>
                                <th>Avg Price</th>
                            </tr>
                        </thead>
                        <tbody id="positionRows">
                            <tr class="empty-row"><td colspan="9">No open positions</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pending Orders (merged: system + broker) -->
            <div class="dash-card">
                <div class="card-head">
                    <h3>Pending Orders</h3>
                    <span class="head-right" id="pendingCount"></span>
                </div>
                <div style="overflow-x: auto;">
                    <table class="dash-table">
                        <thead>
                            <tr>
                                <th>Source</th>
                                <th>Symbol</th>
                                <th>Side</th>
                                <th>Qty</th>
                                <th>Type</th>
                                <th>Price</th>
                                <th>Trigger</th>
                                <th>Product</th>
                                <th>Status</th>
                                <th>Order ID</th>
                                <th>Updated</th>
                            </tr>
                        </thead>
                        <tbody id="pendingRows">
                            <tr class="empty-row"><td colspan="11">No pending orders</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Recent Orders -->
            <div class="dash-card">
                <div class="card-head">
                    <h3>Recent Orders</h3>
                    <span class="head-right" id="recentOrderCount"></span>
                </div>
                <div style="overflow-x: auto;">
                    <table class="dash-table">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Side</th>
                                <th>Qty</th>
                                <th>Type</th>
                                <th>Price</th>
                                <th>Status</th>
                                <th>Updated</th>
                            </tr>
                        </thead>
                        <tbody id="recentOrderRows">
                            <tr class="empty-row"><td colspan="7">No recent orders</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Holdings -->
            <div class="dash-card">
                <div class="card-head">
                    <h3>Holdings</h3>
                    <span class="head-right" id="holdingsCount"></span>
                </div>
                <div style="overflow-x: auto;">
                    <table class="dash-table">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>LTP</th>
                                <th>Net P&amp;L</th>
                                <th>Realized</th>
                                <th>Unrealized</th>
                                <th>Exch</th>
                                <th>Product</th>
                                <th>Qty</th>
                                <th>Avg Price</th>
                            </tr>
                        </thead>
                        <tbody id="holdingsRows">
                            <tr class="empty-row"><td colspan="9">No holdings</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Right Column: Sidebar Cards -->
        <div class="sidebar">
            <!-- Risk Manager -->
            <div class="dash-card">
                <div class="card-head">
                    <h3>Risk Manager</h3>
                    <span id="riskBadge" class="status-badge neutral">--</span>
                </div>
                <div class="card-body-pad">
                    <div class="info-row">
                        <span class="info-label">Daily P&amp;L</span>
                        <span class="info-value" id="riskDailyPnl">--</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Max Loss Limit</span>
                        <span class="info-value" id="riskMaxLoss">--</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Distance to Exit</span>
                        <span class="info-value" id="riskDistance">--</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Peak Profit</span>
                        <span class="info-value" id="riskPeakProfit">--</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Daily Loss Hit</span>
                        <span class="info-value" id="riskDailyLoss">--</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Human Violation</span>
                        <span class="info-value" id="riskHumanViolation">--</span>
                    </div>
                </div>
            </div>

            <!-- Account Summary -->
            <div class="dash-card">
                <div class="card-head">
                    <h3>Account</h3>
                </div>
                <div class="card-body-pad">
                    <div class="info-row">
                        <span class="info-label">Cash Available</span>
                        <span class="info-value" id="accCash">--</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Collateral</span>
                        <span class="info-value" id="accCollateral">--</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Margin Used</span>
                        <span class="info-value" id="accMarginUsed">--</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Margin Available</span>
                        <span class="info-value" id="accMarginAvail">--</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Net Available</span>
                        <span class="info-value" id="accNetAvail">--</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Full-Width: Recent Alerts / Telegram Messages -->
    <div class="full-width-section">
        <div class="dash-card">
            <div class="card-head">
                <h3>Recent Alerts / Telegram Messages</h3>
                <span class="head-right" id="alertCount">0 messages</span>
            </div>
            <div class="card-body-pad">
                <div class="msg-grid" id="telegramMessages">
                    <div class="msg-item" style="color: var(--muted); text-align: center; grid-column: 1/-1;">No alerts yet</div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    // ─── Auth ───
    window.addEventListener('DOMContentLoaded', function () {
        checkAuth();
        startAutoRefresh();
        updateDashboard(false);
    });

    async function checkAuth() {
        try {
            var res = await fetch('/dashboard/home/status', { credentials: 'include' });
            if (res.status === 401) window.location.href = '/';
        } catch (e) {}
    }

    // ─── Config & State ───
    var REFRESH_MS = 1000;
    var lastUpdate = Date.now();
    var autoRefreshTimer = null;
    var isRefreshing = false;
    var retryCount = 0;
    var MAX_RETRIES = 3;

    // ─── Formatting ───
    function fmt(val) {
        if (val == null || isNaN(val)) return '₹0.00';
        return '₹' + parseFloat(val).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function fmtNum(val) {
        if (val == null || isNaN(val)) return '0';
        return parseFloat(val).toLocaleString('en-IN');
    }

    function timeSince(sec) {
        if (!sec || sec < 0) return '--';
        if (sec < 60) return Math.floor(sec) + 's ago';
        if (sec < 3600) return Math.floor(sec / 60) + 'm ago';
        return Math.floor(sec / 3600) + 'h ago';
    }

    function pnlColor(val) {
        var n = parseFloat(val) || 0;
        return n > 0 ? 'var(--success)' : n < 0 ? 'var(--danger)' : 'var(--text)';
    }

    function timeStr(ts) {
        if (!ts) return '--';
        try {
            var d = typeof ts === 'number' ? new Date(ts * 1000) : new Date(ts);
            return d.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        } catch (e) { return '--'; }
    }

    // ─── Error ───
    function showError(msg) {
        var el = document.getElementById('errorBanner');
        el.textContent = '⚠ ' + msg;
        el.classList.add('show');
        setTimeout(function() { el.classList.remove('show'); }, 5000);
    }

    // ─── Flash animation helper ───
    function flashEl(el) {
        if (!el) return;
        el.classList.remove('value-changed');
        void el.offsetWidth;
        el.classList.add('value-changed');
    }

    // ─── Auto-refresh ───
    function startAutoRefresh() {
        stopAutoRefresh();
        autoRefreshTimer = setInterval(function() { updateDashboard(true); }, REFRESH_MS);
    }
    function stopAutoRefresh() {
        if (autoRefreshTimer) { clearInterval(autoRefreshTimer); autoRefreshTimer = null; }
    }

    // ─── Main Update ───
    async function updateDashboard(isAuto) {
        if (isAuto === undefined) isAuto = true;
        if (isRefreshing) return;
        isRefreshing = true;

        try {
            var res = await fetch('/dashboard/home/status', {
                credentials: 'include',
                headers: { 'Accept': 'application/json' }
            });

            if (!res.ok) {
                if (res.status === 401) { window.location.href = '/'; return; }
                var detail = 'HTTP ' + res.status;
                try { detail = (await res.json()).detail || detail; } catch (e) {}
                throw new Error(detail);
            }

            var data = await res.json();
            var broker = data.broker || {};
            var system = data.system || {};

            updateKPI(broker, system);
            updatePositions(broker.positions || []);
            updatePendingOrders(system.open_orders || [], broker.orders || []);
            updateRecentOrders(system.orders || []);
            updateHoldings(broker.holdings || []);
            updateRisk(system.risk || null);
            updateAccount(broker.limits || {});
            updateAlerts(system.telegram_messages || [], system.telegram_stats || {});

            // Force exit banner
            var risk = system.risk || {};
            document.getElementById('forceExitBanner').style.display =
                risk.force_exit_in_progress ? 'block' : 'none';

            lastUpdate = Date.now();
            retryCount = 0;

        } catch (err) {
            if (!isAuto) showError(err.message);
            if (isAuto && retryCount < MAX_RETRIES) {
                retryCount++;
                setTimeout(function() { updateDashboard(true); }, 2000);
            }
        } finally {
            isRefreshing = false;
        }
    }

    // ─── KPI Strip ───
    function updateKPI(broker, system) {
        var summary = broker.positions_summary || {};
        var netPnl = parseFloat(summary.net_pnl || summary.rpnl || 0);
        var openCount = summary.open_count || (broker.positions || []).length || 0;

        // Net PnL
        var pnlEl = document.getElementById('kpiNetPnl');
        var newPnl = fmt(netPnl);
        if (pnlEl.textContent !== newPnl) { pnlEl.textContent = newPnl; flashEl(pnlEl); }
        pnlEl.style.color = pnlColor(netPnl);

        // Open Positions
        document.getElementById('kpiOpenPos').textContent = openCount;

        // Alert stats
        var stats = system.telegram_stats || {};
        var total = stats.total || 0;
        var success = stats.success || 0;
        var failed = stats.failed || 0;
        var riskAlerts = stats.risk || 0;
        document.getElementById('kpiAlertTotal').textContent = total;
        var subParts = [];
        if (success) subParts.push(success + ' ok');
        if (failed) subParts.push(failed + ' fail');
        if (riskAlerts) subParts.push(riskAlerts + ' risk');
        document.getElementById('kpiAlertSub').textContent = subParts.length ? subParts.join(' · ') : 'no alerts';

        // Risk Status
        var risk = system.risk || {};
        var riskText, riskClass;
        if (risk.force_exit_in_progress) { riskText = 'EXIT'; riskClass = 'danger'; }
        else if (risk.daily_loss_hit) { riskText = 'LOSS HIT'; riskClass = 'danger'; }
        else if (risk.human_violation_detected) { riskText = 'VIOLATION'; riskClass = 'danger'; }
        else if (risk.warning_sent) { riskText = 'WARNING'; riskClass = 'warning'; }
        else if (Object.keys(risk).length > 0) { riskText = 'SAFE'; riskClass = 'safe'; }
        else { riskText = 'NO DATA'; riskClass = 'neutral'; }
        document.getElementById('kpiRiskStatus').innerHTML =
            '<span class="status-badge ' + riskClass + '">' + riskText + '</span>';

        // Broker connection
        var hb = system.heartbeat || {};
        var login = hb.login || hb.status || '';
        var brokerText, brokerClass;
        if (login === 'OK' || login === 'CONNECTED') { brokerText = 'CONNECTED'; brokerClass = 'safe'; }
        else if (login) { brokerText = login; brokerClass = 'warning'; }
        else { brokerText = 'UNKNOWN'; brokerClass = 'neutral'; }
        document.getElementById('kpiBroker').innerHTML =
            '<span class="status-badge ' + brokerClass + '">' + brokerText + '</span>';
    }

    // ─── Positions Table ───
    function updatePositions(positions) {
        var tbody = document.getElementById('positionRows');
        var countEl = document.getElementById('posCount');
        countEl.textContent = positions.length ? positions.length + ' position' + (positions.length > 1 ? 's' : '') : '';

        if (!positions.length) {
            tbody.innerHTML = '<tr class="empty-row"><td colspan="9">No open positions</td></tr>';
            return;
        }

        var curSymbols = Array.from(tbody.querySelectorAll('tr[data-sym]')).map(function(r) { return r.dataset.sym; });
        var newSymbols = positions.map(function(p) { return p.tsym || p.symbol || ''; });
        var rebuild = curSymbols.length !== newSymbols.length || !newSymbols.every(function(s, i) { return s === curSymbols[i]; });

        if (rebuild) {
            tbody.innerHTML = positions.map(function(p) {
                var net = parseFloat(p.rpnl || 0) + parseFloat(p.urmtom || 0);
                var prd = p.prd || p.product || '';
                return '<tr data-sym="' + (p.tsym || p.symbol || '') + '">'
                    + '<td style="font-weight:700">' + (p.tsym || p.symbol || '-') + '</td>'
                    + '<td data-f="ltp">' + fmt(p.lp || p.ltp || 0) + '</td>'
                    + '<td data-f="net" style="color:' + pnlColor(net) + ';font-weight:700">' + fmt(net) + '</td>'
                    + '<td data-f="rpnl" style="color:' + pnlColor(p.rpnl) + '">' + fmt(p.rpnl || 0) + '</td>'
                    + '<td data-f="urm" style="color:' + pnlColor(p.urmtom) + '">' + fmt(p.urmtom || 0) + '</td>'
                    + '<td>' + (p.exch || p.exchange || '-') + '</td>'
                    + '<td>' + (prd ? '<span class="status-badge safe">' + prd + '</span>' : '-') + '</td>'
                    + '<td data-f="qty">' + (p.netqty || 0) + '</td>'
                    + '<td data-f="avg">' + fmt(p.avgprc || p.avg_price || 0) + '</td>'
                    + '</tr>';
            }).join('');
        } else {
            positions.forEach(function(p) {
                var sym = p.tsym || p.symbol || '';
                var row = tbody.querySelector('tr[data-sym="' + sym + '"]');
                if (!row) return;
                var net = parseFloat(p.rpnl || 0) + parseFloat(p.urmtom || 0);
                var updateCell = function(sel, val, colored) {
                    var cell = row.querySelector(sel);
                    if (!cell) return;
                    var f = fmt(val);
                    if (cell.textContent !== f) { cell.textContent = f; flashEl(cell); }
                    if (colored) cell.style.color = pnlColor(val);
                };
                updateCell('[data-f="ltp"]', p.lp || p.ltp || 0, false);
                updateCell('[data-f="net"]', net, true);
                updateCell('[data-f="rpnl"]', p.rpnl || 0, true);
                updateCell('[data-f="urm"]', p.urmtom || 0, true);
                var qtyCell = row.querySelector('[data-f="qty"]');
                if (qtyCell) { var q = String(p.netqty || 0); if (qtyCell.textContent !== q) { qtyCell.textContent = q; flashEl(qtyCell); } }
                updateCell('[data-f="avg"]', p.avgprc || p.avg_price || 0, false);
            });
        }
    }

    // ─── Pending Orders Table (MERGED: system + broker) ───
    function updatePendingOrders(systemOpenOrders, brokerOrders) {
        var tbody = document.getElementById('pendingRows');
        var countEl = document.getElementById('pendingCount');

        // Normalize system orders (OrderRecord objects)
        var sysOrders = Array.isArray(systemOpenOrders) ? systemOpenOrders : [];
        var sysRows = sysOrders.map(function(o) {
            return {
                src: 'SYSTEM',
                symbol: o.symbol || o.tsym || '-',
                side: (o.side || '').toUpperCase(),
                qty: o.quantity || 0,
                type: o.order_type || '-',
                price: o.price,
                trigger: null,
                product: o.product || '-',
                status: o.status || '--',
                orderId: o.command_id || o.broker_order_id || '-',
                updated: o.updated_at
            };
        });

        // Normalize broker orders — filter to OPEN/PENDING only
        var brkOrders = Array.isArray(brokerOrders) ? brokerOrders : [];
        var brkRows = brkOrders
            .filter(function(o) {
                var st = (o.status || '').toUpperCase();
                return st === 'OPEN' || st === 'PENDING' || st === 'TRIGGER_PENDING' || st === 'SL-PENDING';
            })
            .map(function(o) {
                return {
                    src: 'BROKER',
                    symbol: o.tsym || '-',
                    side: o.trantype === 'B' ? 'BUY' : 'SELL',
                    qty: o.qty || 0,
                    type: o.prctyp || '-',
                    price: o.prc ? parseFloat(o.prc) : null,
                    trigger: o.trgprc ? parseFloat(o.trgprc) : null,
                    product: o.prd || '-',
                    status: o.status || '--',
                    orderId: o.norenordno || '-',
                    updated: o.norentm || o.exch_tm || null
                };
            });

        // Merge: system first, then broker
        var allPending = sysRows.concat(brkRows);
        countEl.textContent = allPending.length ? allPending.length + ' pending' : '';

        if (!allPending.length) {
            tbody.innerHTML = '<tr class="empty-row"><td colspan="11">No pending orders</td></tr>';
            return;
        }

        tbody.innerHTML = allPending.map(function(o) {
            var sideClass = (o.side === 'BUY' || o.side === 'B') ? 'side-buy' : 'side-sell';
            var srcClass = o.src === 'SYSTEM' ? 'src-system' : 'src-broker';
            var statusClass = 'neutral';
            if (o.status === 'CREATED' || o.status === 'PENDING' || o.status === 'TRIGGER_PENDING' || o.status === 'SL-PENDING') statusClass = 'warning';
            else if (o.status === 'SENT_TO_BROKER' || o.status === 'OPEN') statusClass = 'safe';

            return '<tr>'
                + '<td><span class="' + srcClass + '">' + o.src + '</span></td>'
                + '<td style="font-weight:700">' + o.symbol + '</td>'
                + '<td class="' + sideClass + '">' + o.side + '</td>'
                + '<td>' + o.qty + '</td>'
                + '<td>' + o.type + '</td>'
                + '<td>' + (o.price ? fmt(o.price) : 'MKT') + '</td>'
                + '<td>' + (o.trigger ? fmt(o.trigger) : '-') + '</td>'
                + '<td>' + o.product + '</td>'
                + '<td><span class="status-badge ' + statusClass + '">' + o.status + '</span></td>'
                + '<td style="font-size:10px;color:var(--muted)">' + o.orderId + '</td>'
                + '<td>' + timeStr(o.updated) + '</td>'
                + '</tr>';
        }).join('');
    }

    // ─── Recent Orders Table (last 15 from system DB) ───
    function updateRecentOrders(allOrders) {
        var tbody = document.getElementById('recentOrderRows');
        var countEl = document.getElementById('recentOrderCount');

        var orders = Array.isArray(allOrders) ? allOrders : [];
        var recent = orders
            .filter(function(o) { return ['CREATED', 'SENT_TO_BROKER'].indexOf(o.status) === -1; })
            .slice(0, 15);

        countEl.textContent = recent.length ? 'Last ' + recent.length : '';

        if (!recent.length) {
            tbody.innerHTML = '<tr class="empty-row"><td colspan="7">No recent orders</td></tr>';
            return;
        }

        tbody.innerHTML = recent.map(function(o) {
            var side = (o.side || '').toUpperCase();
            var sideClass = (side === 'BUY' || side === 'B') ? 'side-buy' : 'side-sell';
            var status = o.status || '--';
            var statusClass = 'neutral';
            if (status === 'EXECUTED') statusClass = 'safe';
            else if (status === 'FAILED' || status === 'REJECTED') statusClass = 'danger';
            else if (status === 'CANCELLED') statusClass = 'warning';

            return '<tr>'
                + '<td style="font-weight:700">' + (o.symbol || o.tsym || '-') + '</td>'
                + '<td class="' + sideClass + '">' + side + '</td>'
                + '<td>' + (o.quantity || 0) + '</td>'
                + '<td>' + (o.order_type || '-') + '</td>'
                + '<td>' + (o.price ? fmt(o.price) : 'MKT') + '</td>'
                + '<td><span class="status-badge ' + statusClass + '">' + status + '</span></td>'
                + '<td>' + timeStr(o.updated_at) + '</td>'
                + '</tr>';
        }).join('');
    }

    // ─── Holdings Table ───
    function updateHoldings(holdings) {
        var tbody = document.getElementById('holdingsRows');
        var countEl = document.getElementById('holdingsCount');
        countEl.textContent = holdings.length ? holdings.length + ' holding' + (holdings.length > 1 ? 's' : '') : '';

        if (!holdings.length) {
            tbody.innerHTML = '<tr class="empty-row"><td colspan="9">No holdings</td></tr>';
            return;
        }

        function extract(h) {
            var et = (h.exch_tsym && h.exch_tsym.length) ? h.exch_tsym[0] : {};
            var symbol = et.tsym || h.tsym || h.symbol || h.tradingsymbol || '-';
            var exchange = et.exch || h.exch || h.exchange || '-';
            var qty = parseInt(h.holdqty || h.quantity || h.qty || h.netqty || 0, 10);
            var avg = parseFloat(h.upldprc || h.avg_price || h.avgprc || 0);
            var ltp = parseFloat(h.c || h.lp || h.ltp || h.last_price || 0);
            var realized = parseFloat(h.rpnl || h.realized_pnl || 0);
            var urmRaw = parseFloat(h.urmtom || h.unrealized_pnl || NaN);
            var unrealized = Number.isFinite(urmRaw) ? urmRaw : (ltp - avg) * qty;
            var net = realized + unrealized;
            var product = h.s_prdt_ali || h.prd || h.product || '';
            return { symbol: symbol, exchange: exchange, qty: qty, avg: avg, ltp: ltp, realized: realized, unrealized: unrealized, net: net, product: product };
        }

        var curSymbols = Array.from(tbody.querySelectorAll('tr[data-sym]')).map(function(r) { return r.dataset.sym; });
        var newSymbols = holdings.map(function(h) { return extract(h).symbol; });
        var rebuild = curSymbols.length !== newSymbols.length || !newSymbols.every(function(s, i) { return s === curSymbols[i]; });

        if (rebuild) {
            tbody.innerHTML = holdings.map(function(h) {
                var f = extract(h);
                return '<tr data-sym="' + f.symbol + '">'
                    + '<td style="font-weight:700">' + f.symbol + '</td>'
                    + '<td data-f="ltp">' + fmt(f.ltp) + '</td>'
                    + '<td data-f="net" style="color:' + pnlColor(f.net) + ';font-weight:700">' + fmt(f.net) + '</td>'
                    + '<td data-f="rpnl" style="color:' + pnlColor(f.realized) + '">' + fmt(f.realized) + '</td>'
                    + '<td data-f="urm" style="color:' + pnlColor(f.unrealized) + '">' + fmt(f.unrealized) + '</td>'
                    + '<td>' + f.exchange + '</td>'
                    + '<td>' + (f.product ? '<span class="status-badge safe">' + f.product + '</span>' : '-') + '</td>'
                    + '<td data-f="qty">' + f.qty + '</td>'
                    + '<td data-f="avg">' + fmt(f.avg) + '</td>'
                    + '</tr>';
            }).join('');
        } else {
            holdings.forEach(function(h) {
                var f = extract(h);
                var row = tbody.querySelector('tr[data-sym="' + f.symbol + '"]');
                if (!row) return;
                var upd = function(sel, val, colored) {
                    var cell = row.querySelector(sel);
                    if (!cell) return;
                    var s = fmt(val);
                    if (cell.textContent !== s) { cell.textContent = s; flashEl(cell); }
                    if (colored) cell.style.color = pnlColor(val);
                };
                upd('[data-f="ltp"]', f.ltp, false);
                upd('[data-f="net"]', f.net, true);
                upd('[data-f="rpnl"]', f.realized, true);
                upd('[data-f="urm"]', f.unrealized, true);
                var qtyCell = row.querySelector('[data-f="qty"]');
                if (qtyCell) { var q = String(f.qty); if (qtyCell.textContent !== q) { qtyCell.textContent = q; flashEl(qtyCell); } }
                upd('[data-f="avg"]', f.avg, false);
            });
        }
    }

    // ─── Risk Manager Card ───
    function updateRisk(risk) {
        var badge = document.getElementById('riskBadge');
        var els = {
            pnl: document.getElementById('riskDailyPnl'),
            max: document.getElementById('riskMaxLoss'),
            dist: document.getElementById('riskDistance'),
            peak: document.getElementById('riskPeakProfit'),
            loss: document.getElementById('riskDailyLoss'),
            human: document.getElementById('riskHumanViolation')
        };

        if (!risk || !Object.keys(risk).length) {
            badge.textContent = 'NO DATA';
            badge.className = 'status-badge neutral';
            Object.keys(els).forEach(function(k) { if (els[k]) els[k].textContent = '--'; });
            return;
        }

        var forceExit = !!risk.force_exit_in_progress;
        var lossHit = !!risk.daily_loss_hit;
        var violation = !!risk.human_violation_detected;
        var warned = !!risk.warning_sent;

        var text, cls;
        if (forceExit) { text = 'EXIT IN PROGRESS'; cls = 'danger'; }
        else if (lossHit) { text = 'LOSS HIT'; cls = 'danger'; }
        else if (violation) { text = 'VIOLATION'; cls = 'danger'; }
        else if (warned) { text = 'WARNING'; cls = 'warning'; }
        else { text = 'SAFE'; cls = 'safe'; }
        badge.textContent = text;
        badge.className = 'status-badge ' + cls;

        var pnl = risk.daily_pnl != null ? risk.daily_pnl : null;
        var maxLoss = risk.dynamic_max_loss != null ? risk.dynamic_max_loss : null;

        if (els.pnl) {
            els.pnl.textContent = pnl != null ? fmt(pnl) : '--';
            if (pnl != null) els.pnl.style.color = pnlColor(pnl);
        }
        if (els.max) els.max.textContent = maxLoss != null ? fmt(maxLoss) : '--';

        if (els.dist && pnl != null && maxLoss != null) {
            var distance = pnl - maxLoss;
            els.dist.textContent = fmt(distance);
            els.dist.style.color = distance <= 2 ? 'var(--danger)' : distance <= 5 ? 'var(--warning)' : 'var(--text-secondary)';
        } else if (els.dist) {
            els.dist.textContent = '--';
        }

        if (els.peak) els.peak.textContent = fmt(risk.highest_profit || 0);
        if (els.loss) {
            els.loss.textContent = lossHit ? 'YES' : 'NO';
            els.loss.style.color = lossHit ? 'var(--danger)' : 'var(--success)';
        }
        if (els.human) {
            els.human.textContent = violation ? 'YES' : 'NO';
            els.human.style.color = violation ? 'var(--danger)' : 'var(--success)';
        }
    }

    // ─── Account Card ───
    function updateAccount(limits) {
        document.getElementById('accCash').textContent = fmt(limits.cash || limits.cashmrgnavail || 0);
        document.getElementById('accCollateral').textContent = fmt(limits.collateral || limits.collateralvalue || 0);
        document.getElementById('accMarginUsed').textContent = fmt(limits.marginused || limits.marginUsed || 0);
        document.getElementById('accMarginAvail').textContent = fmt(limits.marginAvailable || limits.marginavailable || 0);
        document.getElementById('accNetAvail').textContent = fmt(limits.net || limits.payin || 0);
    }

    // ─── Alerts / Telegram (full-width horizontal) ───
    function updateAlerts(messages, stats) {
        var container = document.getElementById('telegramMessages');
        var countEl = document.getElementById('alertCount');

        if (!messages || !messages.length) {
            container.innerHTML = '<div class="msg-item" style="color:var(--muted);text-align:center;grid-column:1/-1">No alerts yet</div>';
            countEl.textContent = '0 messages';
            return;
        }

        var recent = messages.slice(-30).reverse();
        countEl.textContent = messages.length + ' messages';

        container.innerHTML = recent.map(function(m) {
            var raw = (m.message || '').replace(/<[^>]*>/g, '');
            return '<div class="msg-item">'
                + '<div class="msg-time">' + timeStr(m.ts) + '</div>'
                + '<div class="msg-text">' + raw + '</div>'
                + '</div>';
        }).join('');
    }

    // ─── Last Update Timer ───
    setInterval(function() {
        var sec = Math.floor((Date.now() - lastUpdate) / 1000);
        var el = document.getElementById('lastUpdateText');
        if (sec === 0) el.textContent = 'just now';
        else if (sec < 60) el.textContent = sec + 's ago';
        else el.textContent = Math.floor(sec / 60) + 'm ago';
    }, 1000);

    // ─── Cleanup ───
    window.addEventListener('beforeunload', stopAutoRefresh);
</script>
</body>
</html>
