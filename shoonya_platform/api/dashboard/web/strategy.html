<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategy Management | Shoonya Platform</title>
    <link rel="stylesheet" href="/dashboard/web/styles/common.css">
    <link rel="stylesheet" href="/dashboard/web/shared/layout.css">
    <script src="/dashboard/web/shared/layout.js" defer></script>
    <style>
        .status-box { background: var(--panel-2); padding: 12px; border-radius: var(--radius-sm); border: 1px solid var(--border); }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { background: var(--panel-2); padding: 10px; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border); }
        td { padding: 10px; border-bottom: 1px solid var(--border); }
        tr:hover { background: var(--panel-2); }
        .tabs { display: flex; gap: 0; border-bottom: 1px solid var(--border); margin-bottom: var(--spacing-lg); overflow-x: auto; }
        .tab { padding: 12px 16px; cursor: pointer; border-bottom: 2px solid transparent; color: var(--muted); font-weight: 500; transition: all .2s; white-space: nowrap; }
        .tab:hover { color: var(--text); }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .row { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: var(--spacing-md); margin-bottom: var(--spacing-md); }
        .field { display: flex; flex-direction: column; gap: 4px; }
        label { font-size: 12px; font-weight: 500; }
        input, select, textarea { padding: 8px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--panel-2); color: var(--text); font-size: 12px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); }
        .card-footer { display: flex; gap: 8px; justify-content: flex-end; padding-top: var(--spacing-md); border-top: 1px solid var(--border); margin-top: var(--spacing-md); }
        h3 { font-size: 14px; font-weight: 600; margin: 20px 0 12px; }
        .result { padding: 12px; border-radius: var(--radius-md); margin-bottom: var(--spacing-lg); display: none; }
        .result.success { background: rgba(34, 197, 94, 0.1); color: #22c55e; border: 1px solid #22c55e; }
        .result.error { background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid #ef4444; }
        .greek { display: inline-block; padding: 2px 6px; background: var(--panel-2); border-radius: 4px; font-size: 10px; font-family: monospace; margin: 2px; }
        .grid { display: grid; gap: var(--spacing-md); }
        .grid.grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
        .grid.grid-cols-4 { grid-template-columns: repeat(4, 1fr); }
        @media(max-width: 768px) { .grid.grid-cols-3, .grid.grid-cols-4 { grid-template-columns: repeat(2, 1fr); } }
        .primary-actions { display: flex; gap: 8px; margin-bottom: var(--spacing-lg); }
        .breadcrumb { display: flex; gap: 8px; padding-bottom: 16px; border-bottom: 1px solid var(--border); margin-bottom: var(--spacing-lg); font-size: 12px; }
        .breadcrumb button { background: transparent; border: none; cursor: pointer; color: var(--muted); padding: 4px 8px; }
        .breadcrumb button.active { color: var(--primary); font-weight: 600; }
    </style>
</head>
<body data-page="strategy">
    <div id="app-header"></div>

    <main>
        <div class="page-header">
            <h1>Strategy Management</h1>
            <p class="muted">Build, execute, monitor, and manage trading strategies with position recovery and orphan management</p>
        </div>

        <!-- Section Breadcrumb Navigation -->
        <div class="breadcrumb">
            <button class="active" onclick="switchSection('builder')">üìã Strategy Builder</button>
            <button onclick="switchSection('monitor')">üìä Monitor & Control</button>
            <button onclick="switchSection('recovery')">‚Ü©Ô∏è Recovery/Resume</button>
            <button onclick="switchSection('orphan')">üëª Orphan Positions</button>
        </div>

        <!-- ‚ïê‚ïê‚ïê SECTION 1: STRATEGY BUILDER ‚ïê‚ïê‚ïê -->
        <div id="builderSection" class="section active">
            <!-- Strategy Control Panel -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Strategy Control</h3>
                    <div class="flex gap-sm">
                        <button class="btn-success btn-sm" onclick="startStrategy()">‚ñ∂ Start</button>
                        <button class="btn-warning btn-sm" onclick="pauseStrategy()">‚è∏ Pause</button>
                        <button class="btn-danger btn-sm" onclick="stopStrategy()">‚èπ Stop</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="grid grid-cols-4">
                        <div class="status-box">
                            <div class="muted">Status</div>
                            <div id="strategyStatus" style="font-weight:600; margin-top:4px;">IDLE</div>
                        </div>
                        <div class="status-box">
                            <div class="muted">Active Positions</div>
                            <div id="activePositions" style="font-weight:600; margin-top:4px;">0</div>
                        </div>
                        <div class="status-box">
                            <div class="muted">Today's PnL</div>
                            <div id="todayPnL" style="font-weight:600; margin-top:4px;">‚Çπ0.00</div>
                        </div>
                        <div class="status-box">
                            <div class="muted">Open Orders</div>
                            <div id="openOrders" style="font-weight:600; margin-top:4px;">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Configuration Tabs -->
            <div class="tabs">
                <div class="tab active" onclick="switchTab(event, 'entryTab')">Entry Rules</div>
                <div class="tab" onclick="switchTab(event, 'adjustmentTab')">Adjustment Rules</div>
                <div class="tab" onclick="switchTab(event, 'exitTab')">Exit Rules</div>
                <div class="tab" onclick="switchTab(event, 'rmsTab')">Risk Management</div>
                <div class="tab" onclick="switchTab(event, 'monitorTab')">Monitor</div>
            </div>

            <!-- TAB: ENTRY RULES -->
            <div id="entryTab" class="tab-content active">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Entry Configuration</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="field">
                                <label>Strategy Type</label>
                                <select id="strategyType" onchange="updateStrategyType()">
                                    <option value="custom">Custom Strategy</option>
                                    <option value="dnss">Delta Neutral Straddle/Strangle (DNSS)</option>
                                    <option value="iron_condor">Iron Condor</option>
                                    <option value="butterfly">Butterfly</option>
                                    <option value="long_straddle">Long Straddle</option>
                                    <option value="short_straddle">Short Straddle</option>
                                    <option value="directional">Directional Spread</option>
                                </select>
                            </div>
                            <div class="field">
                                <label>Underlying Symbol</label>
                                <input type="text" id="underlying" placeholder="e.g., NIFTY, BANKNIFTY, FINNIFTY" value="NIFTY">
                            </div>
                            <div class="field">
                                <label>Entry Time</label>
                                <input type="time" id="entryTime" value="09:20">
                            </div>
                            <div class="field">
                                <label>Entry Condition</label>
                                <select id="entryCondition">
                                    <option value="time_based">Time Based</option>
                                    <option value="price_based">Price Level</option>
                                    <option value="volatility_based">Volatility Threshold</option>
                                    <option value="indicator_based">Technical Indicator</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="field">
                                <label>Position Size (Lots)</label>
                                <input type="number" id="positionSize" min="1" value="1">
                            </div>
                            <div class="field">
                                <label>Max Positions</label>
                                <input type="number" id="maxPositions" min="1" value="1">
                            </div>
                            <div class="field">
                                <label>
                                    <input type="checkbox" id="hedgeEntry" style="width:auto; margin-right:8px;">
                                    Enable Hedging on Entry
                                </label>
                            </div>
                            <div class="field">
                                <label>
                                    <input type="checkbox" id="autoConfirm" style="width:auto; margin-right:8px;">
                                    Auto-confirm Orders
                                </label>
                            </div>
                        </div>

                        <!-- Dynamic Strategy-Specific Fields -->
                        <div id="strategySpecificFields"></div>
                    </div>
                    <div class="card-footer">
                        <button class="btn-primary" onclick="saveEntryRules()">Save Entry Rules</button>
                    </div>
                </div>
            </div>

            <!-- TAB: ADJUSTMENT RULES -->
            <div id="adjustmentTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Adjustment Configuration</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="field">
                                <label>
                                    <input type="checkbox" id="enableAdjustments" style="width:auto; margin-right:8px;">
                                    Enable Automatic Adjustments
                                </label>
                            </div>
                        </div>

                        <h3>Delta Adjustment</h3>
                        <div class="row">
                            <div class="field">
                                <label>Delta Trigger Threshold</label>
                                <input type="number" id="deltaTrigger" step="0.01" placeholder="e.g., 0.15">
                            </div>
                            <div class="field">
                                <label>Target Delta After Adjustment</label>
                                <input type="number" id="targetDelta" step="0.01" placeholder="e.g., 0.05">
                            </div>
                            <div class="field">
                                <label>Max Adjustments Per Day</label>
                                <input type="number" id="maxAdjustments" min="0" value="3">
                            </div>
                            <div class="field">
                                <label>Max Leg Delta</label>
                                <input type="number" id="maxLegDelta" step="0.01" placeholder="Max delta per leg">
                            </div>
                        </div>

                        <h3>Profit/Loss Adjustment</h3>
                        <div class="row">
                            <div class="field">
                                <label>Profit Lock Trigger (‚Çπ)</label>
                                <input type="number" id="profitLockTrigger" step="100" placeholder="Lock at profit level">
                            </div>
                            <div class="field">
                                <label>Loss Repair Trigger (‚Çπ)</label>
                                <input type="number" id="lossRepairTrigger" step="100" placeholder="Adjust at loss level">
                            </div>
                            <div class="field">
                                <label>Adjustment Check Interval (min)</label>
                                <input type="number" id="adjustCheckInterval" min="1" value="5">
                            </div>
                            <div class="field">
                                <label>Adjustment Action</label>
                                <select id="adjustmentAction">
                                    <option value="add_hedge">Add Hedge</option>
                                    <option value="roll_strike">Roll Strike</option>
                                    <option value="reduce_position">Reduce Position</option>
                                    <option value="inverse_spread">Add Inverse Spread</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <button class="btn-primary" onclick="saveAdjustmentRules()">Save Adjustment Rules</button>
                    </div>
                </div>
            </div>

            <!-- TAB: EXIT RULES -->
            <div id="exitTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Exit Configuration</h3>
                    </div>
                    <div class="card-body">
                        <h3>Time-Based Exit</h3>
                        <div class="row">
                            <div class="field">
                                <label>Exit Time</label>
                                <input type="time" id="exitTime" value="15:15">
                            </div>
                            <div class="field">
                                <label>Force Exit Before Expiry (minutes)</label>
                                <input type="number" id="forceExitMinutes" min="0" value="10">
                            </div>
                        </div>

                        <h3>Profit Target</h3>
                        <div class="row">
                            <div class="field">
                                <label>Target Profit (‚Çπ)</label>
                                <input type="number" id="targetProfit" step="100" placeholder="Exit at profit">
                            </div>
                            <div class="field">
                                <label>Target Profit (%)</label>
                                <input type="number" id="targetProfitPercent" step="1" placeholder="% of premium">
                            </div>
                            <div class="field">
                                <label>Partial Exit at Target</label>
                                <select id="partialExitPercent">
                                    <option value="100">Full Exit (100%)</option>
                                    <option value="75">Exit 75%</option>
                                    <option value="50">Exit 50%</option>
                                    <option value="25">Exit 25%</option>
                                </select>
                            </div>
                        </div>

                        <h3>Stop Loss</h3>
                        <div class="row">
                            <div class="field">
                                <label>Stop Loss (‚Çπ)</label>
                                <input type="number" id="stopLoss" step="100" placeholder="Exit at loss">
                            </div>
                            <div class="field">
                                <label>Stop Loss (%)</label>
                                <input type="number" id="stopLossPercent" step="1" placeholder="% of premium">
                            </div>
                            <div class="field">
                                <label>Trailing Stop (%)</label>
                                <input type="number" id="trailingStop" step="1" placeholder="Trail profit">
                            </div>
                        </div>

                        <h3>Position-Specific Exit</h3>
                        <div class="row">
                            <div class="field">
                                <label>Individual Leg SL (‚Çπ)</label>
                                <input type="number" id="legStopLoss" step="50" placeholder="Per leg stop loss">
                            </div>
                            <div class="field">
                                <label>Individual Leg Target (‚Çπ)</label>
                                <input type="number" id="legTarget" step="50" placeholder="Per leg target">
                            </div>
                            <div class="field">
                                <label>
                                    <input type="checkbox" id="exitAllOnLegBreach" style="width:auto; margin-right:8px;">
                                    Exit All Legs if One Breaches
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <button class="btn-primary" onclick="saveExitRules()">Save Exit Rules</button>
                    </div>
                </div>
            </div>

            <!-- TAB: RISK MANAGEMENT -->
            <div id="rmsTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Risk Management System</h3>
                    </div>
                    <div class="card-body">
                        <h3>Position Limits</h3>
                        <div class="row">
                            <div class="field">
                                <label>Max Position Value (‚Çπ)</label>
                                <input type="number" id="maxPositionValue" step="10000" placeholder="Total value limit">
                            </div>
                            <div class="field">
                                <label>Max Margin Usage (%)</label>
                                <input type="number" id="maxMarginPercent" min="0" max="100" value="70">
                            </div>
                            <div class="field">
                                <label>Max Lots Per Trade</label>
                                <input type="number" id="maxLotsPerTrade" min="1" value="10">
                            </div>
                        </div>

                        <h3>Daily Limits</h3>
                        <div class="row">
                            <div class="field">
                                <label>Daily Loss Limit (‚Çπ)</label>
                                <input type="number" id="dailyLossLimit" step="1000" placeholder="Stop trading at loss">
                            </div>
                            <div class="field">
                                <label>Daily Profit Target (‚Çπ)</label>
                                <input type="number" id="dailyProfitTarget" step="1000" placeholder="Stop trading at profit">
                            </div>
                            <div class="field">
                                <label>Max Trades Per Day</label>
                                <input type="number" id="maxTradesPerDay" min="1" value="10">
                            </div>
                        </div>

                        <h3>Risk Controls</h3>
                        <div class="row">
                            <div class="field">
                                <label>Circuit Breaker Loss (‚Çπ)</label>
                                <input type="number" id="circuitBreaker" step="1000" placeholder="Emergency stop">
                            </div>
                            <div class="field">
                                <label>Drawdown Limit (%)</label>
                                <input type="number" id="drawdownLimit" step="5" placeholder="From peak">
                            </div>
                            <div class="field">
                                <label>Position Concentration (%)</label>
                                <input type="number" id="concentrationLimit" min="0" max="100" value="30" placeholder="Max % in one symbol">
                            </div>
                        </div>

                        <h3>Combined Legs Management</h3>
                        <div class="row">
                            <div class="field">
                                <label>
                                    <input type="checkbox" id="trackCombinedPnL" style="width:auto; margin-right:8px;" checked>
                                    Track Combined Legs PnL (Strategy-Level)
                                </label>
                            </div>
                            <div class="field">
                                <label>Combined Stop Loss (‚Çπ)</label>
                                <input type="number" id="combinedStopLoss" step="100" placeholder="Total position SL">
                            </div>
                            <div class="field">
                                <label>Combined Target (‚Çπ)</label>
                                <input type="number" id="combinedTarget" step="100" placeholder="Total position target">
                            </div>
                            <div class="field">
                                <label>
                                    <input type="checkbox" id="autoSquareOff" style="width:auto; margin-right:8px;">
                                    Auto Square-Off on Risk Breach
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <button class="btn-primary" onclick="saveRMSRules()">Save RMS Configuration</button>
                    </div>
                </div>
            </div>

            <!-- TAB: MONITOR -->
            <div id="monitorTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Live Strategy Monitor</h3>
                        <span class="badge badge-success" style="margin-left:auto;">Auto-refresh: 2s</span>
                    </div>
                    <div class="card-body">
                        <h3>Position Summary with Greeks</h3>
                        <div class="table-container">
                            <table id="positionsTable">
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th>Type</th>
                                        <th>Qty</th>
                                        <th>LTP</th>
                                        <th>PnL</th>
                                        <th>Delta</th>
                                        <th>Gamma</th>
                                        <th>Theta</th>
                                        <th>Vega</th>
                                    </tr>
                                </thead>
                                <tbody id="positionsBody">
                                    <tr><td colspan="9" class="text-center muted">No active positions</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <h3>Strategy Greeks Summary</h3>
                        <div class="grid grid-cols-4">
                            <div class="status-box">
                                <div class="muted">Total Delta</div>
                                <div id="totalDelta" style="font-weight:600; margin-top:4px;">0.000</div>
                            </div>
                            <div class="status-box">
                                <div class="muted">Total Gamma</div>
                                <div id="totalGamma" style="font-weight:600; margin-top:4px;">0.0000</div>
                            </div>
                            <div class="status-box">
                                <div class="muted">Total Theta</div>
                                <div id="totalTheta" style="font-weight:600; margin-top:4px;">0.00</div>
                            </div>
                            <div class="status-box">
                                <div class="muted">Total Vega</div>
                                <div id="totalVega" style="font-weight:600; margin-top:4px;">0.00</div>
                            </div>
                            <div class="status-box">
                                <div class="muted">Combined PnL</div>
                                <div id="combinedPnL" style="font-weight:600; margin-top:4px;">‚Çπ0.00</div>
                            </div>
                            <div class="status-box">
                                <div class="muted">Total Premium</div>
                                <div id="totalPremium" style="font-weight:600; margin-top:4px;">‚Çπ0.00</div>
                            </div>
                            <div class="status-box">
                                <div class="muted">Margin Used</div>
                                <div id="marginUsed" style="font-weight:600; margin-top:4px;">‚Çπ0.00</div>
                            </div>
                            <div class="status-box">
                                <div class="muted">Risk Status</div>
                                <div id="riskStatus" style="font-weight:600; margin-top:4px; color:var(--success)">OK</div>
                            </div>
                        </div>

                        <h3>Event Log</h3>
                        <div class="status-box" style="max-height:300px; overflow-y:auto; font-family:monospace; font-size:11px;">
                            <div id="strategyLog">No events yet</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê SECTION 2: MONITOR & CONTROL (Live Monitoring) ‚ïê‚ïê‚ïê -->
        <div id="monitorSection" class="section" style="display:none;">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Running Strategies</h3>
                    <button class="btn-sm" onclick="refreshMonitoringData()" style="background:transparent; border:1px solid var(--border); cursor:pointer;">üîÑ Refresh</button>
                </div>
                <div class="card-body">
                    <div id="monitoringContent" class="muted" style="text-align:center; padding:20px;">Loading strategies...</div>
                </div>
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê SECTION 3: RECOVERY/RESUME ‚ïê‚ïê‚ïê -->
        <div id="recoverySection" class="section" style="display:none;">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Strategy Recovery & Resume</h3>
                    <p class="muted" style="margin:0; font-size:11px;">Manually resume crashed strategies or map orphan broker positions</p>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="field">
                            <label>Select Strategy to Resume</label>
                            <select id="recStrat" style="padding:8px; border:1px solid var(--border); border-radius:var(--radius-sm);">
                                <option value="">-- Choose Strategy --</option>
                            </select>
                        </div>
                        <div style="display:flex; align-items:flex-end;"><button class="btn-primary" onclick="loadRecoveryOptions()" style="margin-bottom:0;">Load Recovery Options</button></div>
                    </div>
                    <div id="recoveryContent"></div>
                </div>
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê SECTION 4: ORPHAN POSITIONS ‚ïê‚ïê‚ïê -->
        <div id="orphanSection" class="section" style="display:none;">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:var(--spacing-lg);">
                <!-- Left: Orphan Positions List -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Orphan Positions</h3>
                        <button class="btn-sm" onclick="refreshOrphanList()" style="background:transparent; border:1px solid var(--border); cursor:pointer;">üîÑ Refresh</button>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table id="orphanTable">
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th>Qty</th>
                                        <th>LTP</th>
                                        <th>PnL</th>
                                        <th>Delta</th>
                                        <th>Theta</th>
                                    </tr>
                                </thead>
                                <tbody id="orphanBody">
                                    <tr><td colspan="6" class="text-center muted">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Right: Rules & Summary -->
                <div>
                    <!-- Rules Management -->
                    <div class="card" style="margin-bottom:var(--spacing-lg);">
                        <div class="card-header">
                            <h3 class="card-title">Management Rules</h3>
                            <button class="btn-primary btn-sm" onclick="showNewRuleModal()">+ New Rule</button>
                        </div>
                        <div class="card-body">
                            <div id="rulesList">
                                <div class="muted" style="text-align:center; padding:20px;">Loading...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Summary -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Combined Summary</h3>
                        </div>
                        <div class="card-body">
                            <div id="orphanSummary">
                                <div class="muted" style="text-align:center; padding:20px;">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="result" class="result"></div>
    </main>

    <script>
        const API = '/dashboard';
        
        // Section Switching
        function switchSection(sectionName) {
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            document.getElementById(sectionName + 'Section').style.display = 'block';
            
            document.querySelectorAll('.breadcrumb button').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            if (sectionName === 'monitor') refreshMonitoringData();
            else if (sectionName === 'recovery') loadRecoveryStrategies();
            else if (sectionName === 'orphan') { refreshOrphanList(); refreshOrphanRules(); refreshOrphanSummary(); }
        }

        // Tab Switching
        function switchTab(e, tabId) {
            e.preventDefault();
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            e.target.classList.add('active');
        }

        function updateStrategyType() {
            const type = document.getElementById('strategyType').value;
            const container = document.getElementById('strategySpecificFields');
            let html = '<h3 style="margin-top:24px;">Strategy-Specific Parameters</h3><div class="row">';
            
            if (type === 'dnss') {
                html += `<div class="field"><label>Straddle/Strangle</label><select><option>Straddle (ATM)</option><option>Strangle (OTM)</option></select></div>
                        <div class="field"><label>ATM Offset (Points)</label><input type="number" step="50" value="0"></div>
                        <div class="field"><label>CE Offset</label><input type="number" step="50" value="100"></div>
                        <div class="field"><label>PE Offset</label><input type="number" step="50" value="100"></div>`;
            } else if (type === 'iron_condor') {
                html += `<div class="field"><label>Short CE Offset</label><input type="number" step="50" value="200"></div>
                        <div class="field"><label>Long CE Offset</label><input type="number" step="50" value="300"></div>
                        <div class="field"><label>Short PE Offset</label><input type="number" step="50" value="200"></div>
                        <div class="field"><label>Long PE Offset</label><input type="number" step="50" value="300"></div>`;
            } else if (type === 'butterfly') {
                html += `<div class="field"><label>Direction</label><select><option>Long Butterfly</option><option>Short Butterfly</option></select></div>
                        <div class="field"><label>Wing Width (Points)</label><input type="number" step="50" value="100"></div>
                        <div class="field"><label>Option Type</label><select><option>Call</option><option>Put</option></select></div>`;
            }
            html += '</div>';
            container.innerHTML = html;
        }

        function showResult(success, message) {
            const resultDiv = document.getElementById('result');
            resultDiv.className = 'result ' + (success ? 'success' : 'error');
            resultDiv.textContent = message;
            resultDiv.style.display = 'block';
            setTimeout(() => { resultDiv.style.display = 'none'; }, 5000);
        }

        // Save Functions
        function saveEntryRules() { showResult(true, 'Entry rules saved'); }
        function saveAdjustmentRules() { showResult(true, 'Adjustment rules saved'); }
        function saveExitRules() { showResult(true, 'Exit rules saved'); }
        function saveRMSRules() { showResult(true, 'RMS configuration saved'); }

        // Strategy Control
        function startStrategy() { showResult(true, 'Strategy start intent queued'); }
        function pauseStrategy() { showResult(true, 'Strategy pause intent queued'); }
        function stopStrategy() { showResult(true, 'Strategy stop intent queued'); }

        // Monitoring
        async function refreshMonitoringData() {
            try {
                const r = await fetch(`${API}/monitoring/strategy-positions`, { credentials: 'include' });
                if (!r.ok) return;
                const data = await r.json();
                let html = '';
                if (data.strategies && data.strategies.length) {
                    for (const s of data.strategies) {
                        html += `<div style="margin-bottom:20px; padding:16px; background:var(--panel-2); border-radius:var(--radius-md);">
                            <h4>${s.strategy_name}</h4>
                            <div class="table-container">
                                <table style="font-size:11px;">
                                    <thead><tr><th>Symbol</th><th>Qty</th><th>LTP</th><th>PnL</th><th style="text-align:right">Œî</th><th style="text-align:right">Œì</th><th style="text-align:right">Œ∏</th><th style="text-align:right">ŒΩ</th></tr></thead>
                                    <tbody>`;
                        for (const p of (s.positions || [])) {
                            for (const l of (p.legs || [])) {
                                const pnl = parseFloat(l.pnl || 0);
                                html += `<tr>
                                    <td>${l.symbol}</td><td>${l.qty}</td><td>${parseFloat(l.ltp || 0).toFixed(2)}</td>
                                    <td style="color:${pnl >= 0 ? 'var(--success)' : 'var(--danger)'}">‚Çπ${pnl.toFixed(0)}</td>
                                    <td style="text-align:right"><span class="greek">${parseFloat(l.delta || 0).toFixed(3)}</span></td>
                                    <td style="text-align:right"><span class="greek">${parseFloat(l.gamma || 0).toFixed(4)}</span></td>
                                    <td style="text-align:right">${parseFloat(l.theta || 0).toFixed(2)}</td>
                                    <td style="text-align:right">${parseFloat(l.vega || 0).toFixed(2)}</td>
                                </tr>`;
                            }
                        }
                        html += `</tbody></table></div>
                            <div style="margin-top:12px; padding-top:12px; border-top:1px solid var(--border); font-size:11px;">
                                <strong>PnL:</strong> <span style="color:${(s.total_pnl || 0) >= 0 ? 'var(--success)' : 'var(--danger)'}">‚Çπ${(s.total_pnl || 0).toFixed(0)}</span> | 
                                <strong>Œî:</strong> ${(s.combined_greeks?.delta || 0).toFixed(3)} | 
                                <strong>Œ∏:</strong> ${(s.combined_greeks?.theta || 0).toFixed(2)}
                            </div></div>`;
                    }
                } else html = '<div class="muted" style="text-align:center; padding:20px;">No running strategies</div>';
                document.getElementById('monitoringContent').innerHTML = html;
            } catch (e) { document.getElementById('monitoringContent').innerHTML = '<div class="muted" style="text-align:center;">Error loading data</div>'; }
        }

        // Recovery
        async function loadRecoveryStrategies() {
            try {
                const r = await fetch(`${API}/strategy/configs`, { credentials: 'include' });
                if (!r.ok) return;
                const data = await r.json();
                const sel = document.getElementById('recStrat');
                sel.innerHTML = '<option value="">-- Choose Strategy --</option>';
                for (const s of (data.configs || [])) sel.innerHTML += `<option value="${s.name}">${s.name}</option>`;
            } catch (e) { console.error(e); }
        }

        function loadRecoveryOptions() {
            const sname = document.getElementById('recStrat').value;
            if (!sname) { showResult(false, 'Please select a strategy'); return; }
            showResult(true, 'Recovery positions loaded for: ' + sname);
        }

        // Orphan Positions
        async function refreshOrphanList() {
            try {
                const r = await fetch(`${API}/orphan-positions`, { credentials: 'include' });
                if (!r.ok) return;
                const data = await r.json();
                let html = '<tr><td colspan="6" class="text-center muted">No orphan positions</td></tr>';
                if (data.positions && data.positions.length) {
                    html = '';
                    for (const p of data.positions) {
                        const pnl = parseFloat(p.pnl || 0);
                        html += `<tr><td>${p.symbol}</td><td>${p.netqty}</td><td>${parseFloat(p.ltp || 0).toFixed(2)}</td>
                                <td style="color:${pnl >= 0 ? 'var(--success)' : 'var(--danger)'}">‚Çπ${pnl.toFixed(0)}</td>
                                <td><span class="greek">${parseFloat(p.delta || 0).toFixed(3)}</span></td>
                                <td>${parseFloat(p.theta || 0).toFixed(2)}</td></tr>`;
                    }
                }
                document.getElementById('orphanBody').innerHTML = html;
            } catch (e) { console.error(e); }
        }

        async function refreshOrphanRules() {
            try {
                const r = await fetch(`${API}/orphan-positions/rules`, { credentials: 'include' });
                if (!r.ok) return;
                const data = await r.json();
                let html = '<div class="muted" style="text-align:center; padding:20px;">No rules yet</div>';
                if (data.rules && data.rules.length) {
                    html = '';
                    for (const rul of data.rules) {
                        html += `<div style="background:var(--panel-2); padding:12px; border-radius:var(--radius-sm); margin-bottom:8px;">
                                <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                                    <span style="display:inline-block; padding:2px 8px; background:var(--primary); color:#fff; border-radius:4px; font-size:10px; font-weight:600;">${rul.rule_type}</span>
                                    <button class="btn-ghost-danger btn-sm" onclick="deleteRule('${rul.rule_id}')">√ó</button>
                                </div>
                                <div style="font-size:11px; font-family:monospace; margin-bottom:4px;">${rul.symbols.join(', ')} - ${rul.action}</div>
                            </div>`;
                    }
                }
                document.getElementById('rulesList').innerHTML = html;
            } catch (e) { console.error(e); }
        }

        async function refreshOrphanSummary() {
            try {
                const r = await fetch(`${API}/orphan-positions/summary`, { credentials: 'include' });
                if (!r.ok) return;
                const data = await r.json();
                let html = '';
                if (data.summary) {
                    html = `<div class="status-box" style="margin-bottom:8px;"><div class="muted">Total Positions</div><div style="font-weight:600; margin-top:4px;">${data.summary.total_positions || 0}</div></div>
                           <div class="status-box" style="margin-bottom:8px;"><div class="muted">Net PnL</div><div style="font-weight:600; margin-top:4px; color:${(data.summary.total_pnl || 0) >= 0 ? 'var(--success)' : 'var(--danger)'}">‚Çπ${(data.summary.total_pnl || 0).toFixed(0)}</div></div>
                           <div class="status-box" style="margin-bottom:8px;"><div class="muted">Combined Œî</div><div style="font-weight:600; margin-top:4px;">${(data.summary.combined_delta || 0).toFixed(3)}</div></div>
                           <div class="status-box"><div class="muted">Combined Œ∏</div><div style="font-weight:600; margin-top:4px;">${(data.summary.combined_theta || 0).toFixed(2)}</div></div>`;
                }
                document.getElementById('orphanSummary').innerHTML = html || '<div class="muted">No summary data</div>';
            } catch (e) { console.error(e); }
        }

        function showNewRuleModal() { showResult(true, 'New rule modal would appear here'); }
        function deleteRule(rid) { showResult(true, 'Rule deleted'); refreshOrphanRules(); }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            updateStrategyType();
            setInterval(refreshMonitoringData, 2000);
        });
    </script>
</body>
</html>
