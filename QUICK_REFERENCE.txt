# ğŸ”§ Order Diagnostics Quick Reference Card

## Your Problem Summarized

```
âŒ Orders placed â†’ not appearing in orderbook

ğŸ“Š What's happening:
  âœ… Order received by dashboard
  âœ… Order created in database
  âŒ RMS blocked it (pnl = -â‚¹499, limit = -â‚¹15)
  âŒ Never reached broker
  âŒ Never reached orderbook
```

---

## 3 Tools to Check Orders

### Tool 1: Database Verification (Terminal)
```bash
# Terminal: Navigate to project root
cd c:\Users\gaura\OneDrive\Desktop\shoonya\shoonya_platform

# Run verification
python verify_orders.py

# Output: Shows all orders with status distribution
```

**What you see**:
```
ğŸ“Š Total orders: 42
âš™ï¸ CREATED: 2          â† Stuck, not sent to broker
ğŸš€ SENT_TO_BROKER: 0   â† Waiting for fill
âœ… EXECUTED: 35        â† In orderbook
âŒ FAILED: 5           â† Rejected
```

---

### Tool 2: Enhanced Orderbook (Web)
```
URL: http://localhost:8000/dashboard/web/orderbook.html

ğŸ†• TOP: Status cards
  Total | Pending | Executed | Failed

ğŸ“‹ System Orders table
   Shows all orders (created, pending, executed, failed)

ğŸ“‹ Broker Orders table
   Shows live orders from broker API
```

**Auto-refreshes every 3 seconds**

---

### Tool 3: Full Diagnostics Page (Web)
```
URL: http://localhost:8000/dashboard/web/order_diagnostics.html

ğŸ“Š Status cards (total, by status type)
ğŸ¯ Source breakdown (WEB, STRATEGY, SYSTEM)
âŒ Failed orders list
â³ Pending orders list
âš¡ 6-stage pipeline visualization
```

**Auto-refreshes every 5 seconds**

---

## Order Status Lifecycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. DASHBOARD                                        â”‚
â”‚    Order form submitted                             â”‚
â”‚    UniversalOrderCommand created                    â”‚
â”‚    âœ… LOGGED: "ğŸ“¥ orders queued"                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. DATABASE (orders.db)                             â”‚
â”‚    Status: CREATED                                  â”‚
â”‚    âœ… Can verify: python verify_orders.py           â”‚
â”‚    âŒ May see here but stuck                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. RISK CHECK (RMS)                                 â”‚
â”‚    âŒ IF LOSS LIMIT HIT â†’ ORDER BLOCKED             â”‚
â”‚    ğŸ“Š Your case: pnl=-499, limit=-15 â†’ BLOCKED      â”‚
â”‚    âœ… LOGGED: "RMS: Max loss breach detected"       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
        Order stops here if RMS blocks
             â”‚
             â†“ (If RMS passes)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. BROKER SEND                                      â”‚
â”‚    Consumer sends to broker API                     â”‚
â”‚    Status: SENT_TO_BROKER                           â”‚
â”‚    Broker Order ID assigned                         â”‚
â”‚    âœ… Can verify: v.py --order=ID                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. ORDERWATCH RECONCILIATION                        â”‚
â”‚    Polls broker every 1-2 seconds                   â”‚
â”‚    Checks fill status                               â”‚
â”‚    Status: EXECUTED (or FAILED)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. ORDERBOOK DISPLAY                                â”‚
â”‚    Order visible in web dashboard                   â”‚
â”‚    Shows in both System & Broker tables             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Where Your Orders Are Right Now

| Status | Count | Location | Action |
|--------|-------|----------|--------|
| **CREATED** | 2 | Database only | Blocked by RMS |
| **SENT_TO_BROKER** | 0 | Broker + DB | (None yet) |
| **EXECUTED** | 35 | Orderbook | âœ… Done |
| **FAILED** | 5 | DB + logs | Need review |

**Run**: `python verify_orders.py` to see current counts

---

## Why Orders Are Stuck

```
Your Current State:
â””â”€ Daily PnL: -â‚¹499 (LOSS)
â””â”€ RMS Limit: -â‚¹15 (MAX LOSS)
â””â”€ Status: BLOCKED ğŸš«

RMS Decision: "Too much loss already! Block new orders!"

Fix:
   Close losing positions â†’ Reduce loss â†’ Try again
```

---

## Intent Generation Flow (For Verification)

```
Step 1: Web Form
   â””â”€â†’ /dashboard/intent/basket (or other endpoint)
   â””â”€â†’ Creates UniversalOrderCommand JSON
   â””â”€â†’ Sends to system

Step 2: Database Write
   â””â”€â†’ Order persisted with status: CREATED
   â””â”€â†’ Can verify: SELECT * FROM orders WHERE status='CREATED'

Step 3: Intent Queue
   â””â”€â†’ Execution consumer picks up intent
   â””â”€â†’ Validates with RMS
   â””â”€â†’ Can verify: Check RMS logs

Step 4: Broker Send (if RMS passes)
   â””â”€â†’ Sends to broker API
   â””â”€â†’ Gets broker_order_id back
   â””â”€â†’ Updates status: SENT_TO_BROKER

Step 5: Watcher Polling
   â””â”€â†’ Gets live broker status
   â””â”€â†’ Updates to EXECUTED or FAILED
   â””â”€â†’ Displays in orderbook

âœ… All can be verified with tools!
```

---

## Quick Diagnosis

### Q: "Did my order reach the database?"
**A**: Run `python verify_orders.py` â†’ Count > 0 means YES

### Q: "Why is it stuck at CREATED?"
**A**: Either:
   - RMS blocked it (most likely in your case)
   - Consumer not running (check logs)

### Q: "Where's the RMS check log?"
**A**: Look for: `"RMS: Max loss breach detected"`
   - In your case: pnl=-499, limit=-15

### Q: "How do I see failed order reasons?"
**A**: Run `python verify_orders.py` â†’ Scroll to "Recent failed orders"

### Q: "Is orderwatch running?"
**A**: Check logs for: "OrderWatcherEngine started"
   - Should be running continuously

---

## API Endpoints (For Developers)

```
GET /dashboard/diagnostics/orders
   â†’ Returns status breakdown + failed orders

GET /dashboard/diagnostics/intent-verification
   â†’ Returns intent pipeline status + data quality

GET /dashboard/orderbook
   â†’ Returns system_orders + broker_orders

GET /dashboard/orderbook/system
   â†’ System orders only

GET /dashboard/orderbook/broker
   â†’ Broker orders only
```

---

## Logging Locations

```
ğŸ“„ Intent Tracking:
   File: logs/intent_tracking.log
   Format: JSON (one per line)
   Command: tail -f logs/intent_tracking.log

ğŸ“„ Risk State:
   File: logs/risk/current_state.json
   Contains: daily_pnl, max_loss, EXIT_TRIGGERED status

ğŸ“„ Application Logs:
   Console: Check for "RMS: ...", "INTENT ...", "ORDER ..."

ğŸ“„ Database:
   File: shoonya_platform/persistence/data/orders.db
   Tool: python verify_orders.py
```

---

## Status Indicators

| Indicator | Meaning |
|-----------|---------|
| âš™ï¸ CREATED | In database, awaiting processing |
| ğŸš€ SENT_TO_BROKER | Sent to broker, awaiting fill |
| âœ… EXECUTED | Filled and confirmed |
| âŒ FAILED | Rejected (by RMS, broker, or validation) |
| ğŸ“¥ QUEUED | Just received by system |
| ğŸš« BLOCKED | RMS stopped it from sending |
| â³ PENDING | Waiting for something |

---

## Your Action Plan

### Immediate (Next 5 min)
1. Run: `python verify_orders.py`
   - See how many orders in each status
   - Note the failed orders section

2. Open: `/dashboard/web/order_diagnostics.html`
   - See the 6-stage pipeline
   - Identify where orders are stuck

### Short-term (Next 15 min)
1. Review failed orders with reasons
2. Check if orders are in CREATED/PENDING state
3. Verify RMS state: loss = -499, limit = -15

### Medium-term (Next hour)
1. Close losing positions to reduce loss
2. Get PnL back to at least -15 (or positive)
3. Try placing order again

### Verify Success
Once you reduce losses:
1. Place new order
2. Open `/dashboard/web/order_diagnostics.html`
3. Watch order move through 6 stages (takes 5-10 sec)
4. See it appear in orderbook

---

## Command Cheat Sheet

```bash
# Verify all orders in database
python verify_orders.py

# Check specific order
python verify_orders.py --order=COMMAND_ID

# Watch intent logs (every new log line)
tail -f logs/intent_tracking.log

# Count orders by status (bash)
sqlite3 shoonya_platform/persistence/data/orders.db \
  "SELECT status, COUNT(*) FROM orders GROUP BY status"

# List failed orders (bash)
sqlite3 shoonya_platform/persistence/data/orders.db \
  "SELECT command_id, symbol, status FROM orders WHERE status='FAILED'"
```

---

## Summary

**Your orders ARE being created in the database âœ…**

**They're just blocked by RMS âŒ**

**This is NOT a bug - it's a safety feature ğŸ”’**

**To fix: Close losing positions, reduce loss, try again âœ…**

---

**Need details?** See:
- `IMPLEMENTATION_ORDER_DIAGNOSTICS.md` - Complete feature docs
- `ORDER_PLACEMENT_GUIDE.md` - Detailed troubleshooting
- `QUICK_START_DIAGNOSTICS.md` - Step-by-step tutorial
