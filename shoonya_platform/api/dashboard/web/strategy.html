<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategy Management | Shoonya Platform</title>
    <link rel="stylesheet" href="/dashboard/web/styles/common.css">
    <link rel="stylesheet" href="/dashboard/web/shared/layout.css">
    <script src="/dashboard/web/shared/layout.js" defer></script>
    <style>
        .strategy-item { background: var(--panel-2); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 12px; margin-bottom: 8px; display: grid; grid-template-columns: 200px 1fr 200px auto; gap: 12px; align-items: center; }
        .strategy-name { font-weight: 600; color: var(--text); }
        .strategy-timing { display: flex; gap: 8px; align-items: center; }
        .strategy-timing select { padding: 4px 8px; font-size: 11px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--panel); color: var(--text); }
        .strategy-actions { display: flex; gap: 4px; }
        .status-pill { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 9px; font-weight: 700; text-transform: uppercase; }
        .status-idle { background: rgba(255,255,255,.06); color: var(--muted); }
        .status-running { background: rgba(34,197,94,.12); color: #22c55e; }
        .status-paused { background: rgba(234,179,8,.12); color: #eab308; }

        .monitor-section { margin-bottom: 20px; }
        .section-header { display: flex; align-items: center; gap: 8px; padding: 12px; background: var(--panel-2); border: 1px solid var(--border); border-radius: var(--radius-md); cursor: pointer; user-select: none; }
        .section-header:hover { background: var(--panel); }
        .section-toggle { display: inline-block; width: 16px; text-align: center; transition: transform .2s; }
        .section-toggle.open { transform: rotate(90deg); }
        .section-title { font-weight: 600; color: var(--text); flex: 1; }
        .section-summary { font-size: 11px; color: var(--muted); }
        .section-content { display: none; padding: 12px; background: var(--panel); border: 1px solid var(--border); border-top: none; border-radius: 0 0 var(--radius-md) var(--radius-md); }
        .section-content.open { display: block; }

        .position-row { display: grid; grid-template-columns: 120px 60px 80px 80px 60px 60px 60px 60px; gap: 8px; padding: 8px; border-bottom: 1px solid var(--border); font-size: 11px; align-items: center; }
        .position-row:last-child { border-bottom: none; }
        .position-row.header { background: var(--panel-2); font-weight: 600; padding: 10px 8px; }
        .greek { display: inline-block; padding: 2px 4px; background: var(--panel-2); border-radius: 3px; font-family: monospace; font-size: 10px; }

        .stat-badge { display: inline-block; padding: 4px 8px; background: var(--panel-2); border-radius: 4px; font-size: 10px; margin-right: 8px; margin-bottom: 4px; }

        .orphan-summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 8px; }
        .summary-box { background: var(--panel); border: 1px solid var(--border); padding: 8px; border-radius: 4px; text-align: center; }
        .summary-label { font-size: 10px; color: var(--muted); }
        .summary-value { font-size: 14px; font-weight: 600; color: var(--primary); margin-top: 4px; }

        .table-compact { width: 100%; border-collapse: collapse; font-size: 10px; }
        .table-compact th { background: var(--panel-2); padding: 6px; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border); }
        .table-compact td { padding: 6px; border-bottom: 1px solid var(--border); }
        .table-compact tr:hover { background: var(--panel-2); }

        .summary-2line { display: flex; justify-content: space-between; font-size: 11px; padding: 4px 0; }
        .summary-label-2line { color: var(--muted); }
        .summary-value-2line { font-weight: 600; color: var(--text); }

        @media(max-width: 1200px) {
            .strategy-item { grid-template-columns: 150px 1fr 150px auto; }
        }
        @media(max-width: 768px) {
            .strategy-item { grid-template-columns: 1fr; }
            .strategy-timing { flex-wrap: wrap; }
            .position-row { grid-template-columns: repeat(4, 1fr); }
            .orphan-summary { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body data-page="strategy">
    <div id="app-header"></div>

    <main>
        <div class="page-header">
            <h1>Strategy Management</h1>
            <p class="muted">Control and monitor your trading strategies with real-time position tracking</p>
        </div>

        <!-- ‚ïê‚ïê‚ïê SECTION 1: STRATEGY CONTROL ‚ïê‚ïê‚ïê -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Strategy Control & Scheduling</h3>
                <button class="btn-primary btn-sm" onclick="loadStrategies()" style="margin-left:auto;">üîÑ Refresh List</button>
            </div>
            <div class="card-body">
                <div id="strategyList" style="min-height: 200px;">
                    <div class="muted" style="text-align:center; padding:20px;">Loading strategies...</div>
                </div>
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê SECTION 2: STRATEGY MONITOR ‚ïê‚ïê‚ïê -->
        <div class="card" style="margin-top: var(--spacing-lg);">
            <div class="card-header">
                <h3 class="card-title">Strategy Monitor</h3>
                <button class="btn-sm" onclick="refreshMonitor()" style="background:transparent; border:1px solid var(--border); cursor:pointer; margin-left:auto;">üîÑ Refresh</button>
            </div>
            <div class="card-body">
                <!-- Orphan Positions Section -->
                <div class="monitor-section">
                    <div class="section-header" onclick="toggleSection(event, 'orphanContent')">
                        <span class="section-toggle">‚ñ∂</span>
                        <span class="section-title">üëª Orphan Positions</span>
                        <span class="section-summary" id="orphanSummaryBadge">0 positions</span>
                    </div>
                    <div id="orphanContent" class="section-content">
                        <div id="orphanPositions">
                            <table class="table-compact">
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th>Qty</th>
                                        <th>LTP</th>
                                        <th>PnL</th>
                                        <th>Œî</th>
                                        <th>Œì</th>
                                        <th>Œ∏</th>
                                        <th>ŒΩ</th>
                                    </tr>
                                </thead>
                                <tbody id="orphanBody">
                                    <tr><td colspan="8" class="text-center muted">No orphan positions</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="orphan-summary" id="orphanSummary" style="display:none; margin-top:12px; padding-top:12px; border-top:1px solid var(--border);">
                            <div class="summary-box">
                                <div class="summary-label">Total PnL</div>
                                <div class="summary-value" id="orphanTotalPnL">‚Çπ0</div>
                            </div>
                            <div class="summary-box">
                                <div class="summary-label">Combined Œî</div>
                                <div class="summary-value" id="orphanDelta">0.000</div>
                            </div>
                            <div class="summary-box">
                                <div class="summary-label">Combined Œ∏</div>
                                <div class="summary-value" id="orphanTheta">0.00</div>
                            </div>
                            <div class="summary-box">
                                <div class="summary-label">Positions</div>
                                <div class="summary-value" id="orphanCount">0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Strategy Monitoring Sections (Dynamic) -->
                <div id="strategyMonitors"></div>
            </div>
        </div>

        <div id="result" class="result" style="padding:12px; border-radius:var(--radius-md); margin-top:var(--spacing-lg); display:none;"></div>
    </main>

    <script>
        const API = '/dashboard';
        let strategies = [];
        let selectedStrategy = null;

        // Show/Hide Sections
        function toggleSection(e, contentId) {
            e.preventDefault();
            const header = e.currentTarget;
            const content = document.getElementById(contentId);
            const toggle = header.querySelector('.section-toggle');
            
            content.classList.toggle('open');
            toggle.classList.toggle('open');
        }

        // Load Strategy List
        async function loadStrategies() {
            try {
                const r = await fetch(`${API}/strategy/configs`, { credentials: 'include' });
                if (!r.ok) return showResult(false, 'Failed to load strategies');
                const data = await r.json();
                strategies = data.configs || [];
                renderStrategyList();
            } catch (e) {
                showResult(false, 'Error: ' + e.message);
            }
        }

        function renderStrategyList() {
            const container = document.getElementById('strategyList');
            if (!strategies.length) {
                container.innerHTML = '<div class="muted" style="text-align:center; padding:20px;">No saved strategies</div>';
                return;
            }

            let html = '';
            for (const s of strategies) {
                const status = s.status || 'IDLE';
                html += `
                    <div class="strategy-item">
                        <div>
                            <div class="strategy-name">${s.name}</div>
                            <div style="font-size:10px; color:var(--muted); margin-top:2px;">${s.identity?.underlying || 'N/A'} ¬∑ ${s.identity?.strategy_type || 'custom'}</div>
                        </div>
                        <div class="strategy-timing">
                            <select onchange="updateSchedule('${s.name}', this.value)" style="min-width:150px;">
                                <option value="disabled">‚è∏ Disabled</option>
                                <option value="daily" ${s.schedule === 'daily' ? 'selected' : ''}>üìÖ Daily</option>
                                <option value="weekly" ${s.schedule === 'weekly' ? 'selected' : ''}>üìÜ Weekly</option>
                                <option value="custom" ${s.schedule === 'custom' ? 'selected' : ''}>‚öôÔ∏è Custom Time</option>
                                <option value="immediate" ${s.schedule === 'immediate' ? 'selected' : ''}>‚ö° On Demand</option>
                            </select>
                            <span style="font-size:11px; color:var(--muted); min-width:80px;">
                                ${s.entry?.timing?.entry_time ? s.entry.timing.entry_time : '--:--'}
                            </span>
                        </div>
                        <div style="text-align:center;">
                            <span class="status-pill status-${status.toLowerCase()}">${status}</span>
                        </div>
                        <div class="strategy-actions">
                            <button class="btn-success btn-sm" onclick="actionStrategy('${s.name}', 'start')" ${status === 'RUNNING' ? 'disabled' : ''}>‚ñ∂</button>
                            <button class="btn-warning btn-sm" onclick="actionStrategy('${s.name}', 'pause')" ${status !== 'RUNNING' ? 'disabled' : ''}>‚è∏</button>
                            <button class="btn-danger btn-sm" onclick="actionStrategy('${s.name}', 'stop')" ${status === 'IDLE' ? 'disabled' : ''}>‚èπ</button>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        async function actionStrategy(name, action) {
            if (!confirm(`${action.toUpperCase()} strategy "${name}"?`)) return;
            try {
                const actionMap = { start: 'ENTRY', pause: 'ADJUST', stop: 'FORCE_EXIT' };
                const r = await fetch(`${API}/intent/strategy`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ strategy_name: name, action: actionMap[action], reason: 'DASHBOARD_UI' })
                });
                if (!r.ok) throw new Error('Failed');
                showResult(true, `Strategy ${action}ed: ${name}`);
                setTimeout(() => { loadStrategies(); refreshMonitor(); }, 1000);
            } catch (e) {
                showResult(false, `Failed to ${action}: ${e.message}`);
            }
        }

        function updateSchedule(name, schedule) {
            showResult(true, `Schedule updated for ${name}: ${schedule}`);
        }

        // Refresh Monitor
        async function refreshMonitor() {
            try {
                // Load orphan positions
                const orphanR = await fetch(`${API}/orphan-positions`, { credentials: 'include' });
                if (orphanR.ok) {
                    const orphanData = await orphanR.json();
                    renderOrphanPositions(orphanData);
                }

                // Load strategy positions
                const monR = await fetch(`${API}/monitoring/strategy-positions`, { credentials: 'include' });
                if (monR.ok) {
                    const monData = await monR.json();
                    renderStrategyMonitors(monData);
                } else {
                    document.getElementById('strategyMonitors').innerHTML = '<div class="muted" style="text-align:center; padding:20px;">No running strategies</div>';
                }
            } catch (e) {
                console.error('Monitor error:', e);
            }
        }

        function renderOrphanPositions(data) {
            const positions = data.positions || [];
            let html = '';
            
            if (positions.length) {
                for (const p of positions) {
                    const pnl = parseFloat(p.pnl || 0);
                    html += `
                        <tr>
                            <td>${p.symbol}</td>
                            <td>${p.netqty}</td>
                            <td>${parseFloat(p.ltp || 0).toFixed(2)}</td>
                            <td style="color:${pnl >= 0 ? 'var(--success)' : 'var(--danger)'}">‚Çπ${pnl.toFixed(0)}</td>
                            <td><span class="greek">${parseFloat(p.delta || 0).toFixed(3)}</span></td>
                            <td><span class="greek">${parseFloat(p.gamma || 0).toFixed(4)}</span></td>
                            <td>${parseFloat(p.theta || 0).toFixed(2)}</td>
                            <td>${parseFloat(p.vega || 0).toFixed(2)}</td>
                        </tr>
                    `;
                }
                document.getElementById('orphanBody').innerHTML = html;
                document.getElementById('orphanSummaryBadge').textContent = positions.length + ' position' + (positions.length !== 1 ? 's' : '');
                
                // Load summary
                const summaryR = fetch(`${API}/orphan-positions/summary`, { credentials: 'include' });
                summaryR.then(r => r.ok ? r.json() : null).then(s => {
                    if (s && s.summary) {
                        document.getElementById('orphanTotalPnL').textContent = '‚Çπ' + (s.summary.total_pnl || 0).toFixed(0);
                        document.getElementById('orphanDelta').textContent = (s.summary.combined_delta || 0).toFixed(3);
                        document.getElementById('orphanTheta').textContent = (s.summary.combined_theta || 0).toFixed(2);
                        document.getElementById('orphanCount').textContent = s.summary.total_positions || 0;
                        document.getElementById('orphanSummary').style.display = 'grid';
                    }
                });
            } else {
                document.getElementById('orphanBody').innerHTML = '<tr><td colspan="8" class="text-center muted">No orphan positions</td></tr>';
                document.getElementById('orphanSummaryBadge').textContent = '0 positions';
            }
        }

        function renderStrategyMonitors(data) {
            const strategies = data.strategies || [];
            let html = '';

            if (!strategies.length) {
                document.getElementById('strategyMonitors').innerHTML = '<div class="muted" style="text-align:center; padding:20px;">No running strategies</div>';
                return;
            }

            for (const s of strategies) {
                const positions = s.positions || [];
                const totalPnL = s.total_pnl || 0;
                const delta = (s.combined_greeks?.delta || 0).toFixed(3);
                const theta = (s.combined_greeks?.theta || 0).toFixed(2);
                const posCount = positions.reduce((sum, p) => sum + (p.legs || []).length, 0);

                html += `
                    <div class="monitor-section" style="margin-top:12px;">
                        <div class="section-header" onclick="toggleSection(event, 'strat-${s.strategy_name.replace(/\s+/g, '-')}')">
                            <span class="section-toggle">‚ñ∂</span>
                            <span class="section-title">üìä ${s.strategy_name}</span>
                            <span class="section-summary">
                                <span class="stat-badge">Positions: ${posCount}</span>
                                <span class="stat-badge" style="color:${totalPnL >= 0 ? 'var(--success)' : 'var(--danger)'}">PnL: ‚Çπ${totalPnL.toFixed(0)}</span>
                                <span class="stat-badge">Œî: ${delta}</span>
                            </span>
                        </div>
                        <div id="strat-${s.strategy_name.replace(/\s+/g, '-')}" class="section-content">
                            <div class="table-compact" style="margin-bottom:12px;">
                                <div class="summary-2line">
                                    <span class="summary-label-2line">Total PnL:</span>
                                    <span class="summary-value-2line" style="color:${totalPnL >= 0 ? 'var(--success)' : 'var(--danger)'}">‚Çπ${totalPnL.toFixed(0)}</span>
                                </div>
                                <div class="summary-2line">
                                    <span class="summary-label-2line">Combined Greeks:</span>
                                    <span class="summary-value-2line">Œî ${delta} | Œ∏ ${theta}</span>
                                </div>
                                <div style="margin-top:12px; padding-top:12px; border-top:1px solid var(--border);">
                                    <strong style="font-size:11px;">Leg-wise Positions:</strong>
                                </div>
                            </div>
                            <table class="table-compact">
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th>Type</th>
                                        <th>Qty</th>
                                        <th>LTP</th>
                                        <th>PnL</th>
                                        <th>Œî</th>
                                        <th>Œì</th>
                                        <th>Œ∏</th>
                                    </tr>
                                </thead>
                                <tbody>
`;
                for (const p of positions) {
                    for (const l of (p.legs || [])) {
                        const lpnl = parseFloat(l.pnl || 0);
                        html += `
                                    <tr>
                                        <td>${l.symbol || '?'}</td>
                                        <td>${l.type || '?'}</td>
                                        <td>${l.qty || 0}</td>
                                        <td>${parseFloat(l.ltp || 0).toFixed(2)}</td>
                                        <td style="color:${lpnl >= 0 ? 'var(--success)' : 'var(--danger)'}">‚Çπ${lpnl.toFixed(0)}</td>
                                        <td><span class="greek">${parseFloat(l.delta || 0).toFixed(3)}</span></td>
                                        <td><span class="greek">${parseFloat(l.gamma || 0).toFixed(4)}</span></td>
                                        <td>${parseFloat(l.theta || 0).toFixed(2)}</td>
                                    </tr>
`;
                    }
                }
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            document.getElementById('strategyMonitors').innerHTML = html;
        }

        function showResult(success, message) {
            const resultDiv = document.getElementById('result');
            resultDiv.className = success ? 'result' : 'result';
            resultDiv.style.background = success ? 'rgba(34,197,94,.1)' : 'rgba(239,68,68,.1)';
            resultDiv.style.color = success ? '#22c55e' : '#ef4444';
            resultDiv.style.border = success ? '1px solid #22c55e' : '1px solid #ef4444';
            resultDiv.textContent = message;
            resultDiv.style.display = 'block';
            setTimeout(() => { resultDiv.style.display = 'none'; }, 4000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadStrategies();
            refreshMonitor();
            setInterval(refreshMonitor, 5000);
        });
    </script>
</body>
</html>
