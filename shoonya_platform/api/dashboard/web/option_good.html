<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Option Chain ‚Äì Shoonya OMS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        :root {
            --bg: #0a0e13;
            --panel: #151b26;
            --border: #2d3548;
            --text: #f1f5f9;
            --muted: #94a3b8;
            --primary: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --atm: #f59e0b;
            --itm-call: rgba(16, 185, 129, 0.08);
            --itm-put: rgba(239, 68, 68, 0.08);
            --otm-call: rgba(16, 185, 129, 0.03);
            --otm-put: rgba(239, 68, 68, 0.03);
            --call-bg: rgba(16, 185, 129, 0.02);
            --put-bg: rgba(239, 68, 68, 0.02);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.4;
            font-size: 12px;
        }
        
        /* Header */
        header {
            height: 56px;
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 16px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }
        
        .nav-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .brand {
            font-weight: 700;
            font-size: 18px;
            color: var(--primary);
            cursor: pointer;
        }
        
        .nav-link {
            color: var(--muted);
            font-size: 13px;
            text-decoration: none;
            padding: 6px 10px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .nav-link:hover {
            color: var(--text);
            background: rgba(28, 35, 51, 0.5);
        }
        
        .nav-link.active {
            color: var(--primary);
            background: rgba(59, 130, 246, 0.1);
        }
        
        /* Main Container */
        main {
            margin-top: 56px;
            padding: 12px;
        }
        
        /* Controls Bar */
        .controls-bar {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px 12px;
            margin-bottom: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        select, input {
            padding: 6px 10px;
            background: #1c2333;
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 4px;
            font-size: 12px;
            height: 32px;
            min-width: 120px;
        }
        
        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            height: 32px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: background 0.2s;
        }
        
        button:hover {
            background: #2563eb;
        }
        
        button:disabled {
            background: var(--muted);
            cursor: not-allowed;
        }
        
        /* Info Bar */
        .info-bar {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px 12px;
            margin-bottom: 10px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .info-label {
            font-size: 10px;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .info-value {
            font-size: 14px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }
        
        .spot-price {
            color: var(--success);
        }
        
        .future-price {
            color: var(--primary);
        }
        
        .atm-price {
            color: var(--atm);
        }
        
        /* Option Chain Container */
        .chain-container {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
        }
        
        .chain-header {
            position: sticky;
            top: 0;
            background: #1c2333;
            z-index: 50;
            border-bottom: 1px solid var(--border);
        }
        
        .table-wrapper {
            overflow-x: auto;
            max-height: calc(100vh - 220px);
        }
        
        /* Table Styles */
        .option-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            min-width: 800px;
        }
        
        .option-table th {
            padding: 8px 4px;
            text-align: center;
            font-weight: 700;
            color: var(--muted);
            text-transform: uppercase;
            font-size: 10px;
            letter-spacing: 0.3px;
            border-bottom: 1px solid var(--border);
            background: #1c2333;
            position: sticky;
            top: 0;
            z-index: 20;
        }
        
        .option-table th.section-header {
            background: var(--panel);
            color: var(--text);
            font-size: 11px;
            padding: 8px 4px;
        }
        
        .option-table th.calls-header {
            background: linear-gradient(to bottom, rgba(16, 185, 129, 0.1), transparent);
            color: var(--success);
        }
        
        .option-table th.puts-header {
            background: linear-gradient(to bottom, rgba(239, 68, 68, 0.1), transparent);
            color: var(--danger);
        }
        
        .option-table td {
            padding: 6px 4px;
            text-align: center;
            border-bottom: 1px solid rgba(45, 53, 72, 0.3);
            font-variant-numeric: tabular-nums;
            position: relative;
            height: 36px;
        }
        
        .option-table tbody tr {
            transition: background 0.2s;
            cursor: pointer;
        }
        
        .option-table tbody tr:hover {
            background: rgba(59, 130, 246, 0.05);
        }
        
        /* ATM Row */
        .atm-row {
            background: rgba(245, 158, 11, 0.08) !important;
            border-top: 1px solid rgba(245, 158, 11, 0.3);
            border-bottom: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .atm-row .strike-cell {
            background: var(--atm) !important;
            color: #000;
            font-weight: 900;
            position: relative;
        }
        
        .atm-row .strike-cell::before {
            content: "ATM";
            position: absolute;
            top: 2px;
            right: 4px;
            font-size: 8px;
            background: rgba(0, 0, 0, 0.2);
            padding: 1px 4px;
            border-radius: 2px;
            font-weight: 700;
        }
        
        /* Strike Cell */
        .strike-cell {
            background: #1c2333;
            font-weight: 700;
            color: var(--primary);
            border-left: 1px solid var(--border);
            border-right: 1px solid var(--border);
            min-width: 70px;
            position: sticky;
            left: 0;
            z-index: 10;
        }
        
        /* ITM/OTM Styling */
        .call-itm {
            background: var(--itm-call);
        }
        
        .call-otm {
            background: var(--otm-call);
        }
        
        .put-itm {
            background: var(--itm-put);
        }
        
        .put-otm {
            background: var(--otm-put);
        }
        
        /* LTP Cells */
        .ltp-cell {
            font-weight: 700;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 3px;
            padding: 4px 0;
            min-width: 65px;
        }
        
        .ltp-cell:hover {
            background: rgba(59, 130, 246, 0.2);
        }
        
        .positive {
            color: var(--success);
        }
        
        .negative {
            color: var(--danger);
        }
        
        /* Bar Indicators */
        .bar-container {
            position: relative;
            height: 20px;
            margin: 2px 0;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .bar-fill {
            position: absolute;
            top: 0;
            bottom: 0;
            opacity: 0.15;
            transition: width 0.3s ease;
        }
        
        .bar-text {
            position: relative;
            z-index: 1;
            font-weight: 600;
            line-height: 20px;
        }
        
        .bar-call {
            background: var(--success);
            left: 0;
        }
        
        .bar-put {
            background: var(--danger);
            right: 0;
        }
        
        /* Column Selector */
        .column-selector {
            position: relative;
            display: inline-block;
        }
        
        .column-selector-btn {
            background: #1c2333;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 6px 10px;
            cursor: pointer;
            font-size: 11px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 5px;
            height: 32px;
        }
        
        .column-selector-btn:hover {
            background: #2d3548;
        }
        
        .column-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 2px;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            min-width: 180px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            padding: 4px;
        }
        
        .column-dropdown.show {
            display: block;
        }
        
        .column-option {
            padding: 6px 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 11px;
            border-radius: 3px;
        }
        
        .column-option:hover {
            background: #1c2333;
        }
        
        .column-option input[type="checkbox"] {
            cursor: pointer;
            width: 14px;
            height: 14px;
            accent-color: var(--primary);
        }
        
        /* Basket */
        .basket-indicator {
            position: relative;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .basket-indicator:hover {
            background: #1c2333;
        }
        
        .basket-count {
            position: absolute;
            top: -6px;
            right: -6px;
            background: var(--danger);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 1px 5px;
            border-radius: 10px;
            min-width: 16px;
            text-align: center;
            display: none;
        }
        
        .basket-count.show {
            display: block;
        }
        
        /* Auto-refresh */
        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--muted);
        }
        
        .refresh-indicator {
            color: var(--success);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .refresh-indicator.paused {
            color: var(--muted);
        }
        
        .refresh-indicator::before {
            content: "‚óè";
            font-size: 8px;
            animation: pulse 1s infinite;
        }
        
        .refresh-indicator.paused::before {
            animation: none;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Loading States */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--muted);
            font-size: 13px;
        }
        
        .error-msg {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            padding: 10px 12px;
            border-radius: 4px;
            margin-bottom: 10px;
            border: 1px solid rgba(239, 68, 68, 0.3);
            display: none;
        }
        
        /* Modal Styles (for basket) */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            font-size: 14px;
        }
        
        .modal-body {
            padding: 16px;
        }
        
        .modal-footer {
            padding: 16px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        /* Order Entry Popup */
        .order-popup {
            position: absolute;
            background: var(--panel);
            border: 2px solid var(--primary);
            border-radius: 6px;
            padding: 12px;
            min-width: 250px;
            z-index: 1000;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            display: none;
        }
        
        .order-popup.show {
            display: block;
        }
        
        .order-popup-header {
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }
        
        .order-popup-close {
            cursor: pointer;
            color: var(--muted);
            font-size: 18px;
            line-height: 1;
        }
        
        .order-form-group {
            margin-bottom: 8px;
        }
        
        .order-form-label {
            font-size: 10px;
            color: var(--muted);
            display: block;
            margin-bottom: 3px;
        }
        
        .order-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .order-form-input {
            width: 100%;
            padding: 5px 6px;
            background: #1c2333;
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 4px;
            font-size: 12px;
        }
        
        .order-form-actions {
            display: flex;
            gap: 6px;
            margin-top: 10px;
        }
        
        .order-form-actions button {
            flex: 1;
            padding: 8px;
            font-size: 12px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            main {
                padding: 8px;
            }
            
            .controls-bar {
                padding: 8px;
                gap: 8px;
            }
            
            select, input, button {
                min-width: auto;
                flex: 1;
            }
            
            .info-bar {
                grid-template-columns: repeat(2, 1fr);
                padding: 8px;
            }
        }
    </style>
</head>
<body>
<header>
    <div class="nav-left">
        <div class="brand" onclick="window.location.href='/dashboard/home'">‚ö° Shoonya OMS</div>
        <a class="nav-link" href="/dashboard/home">Home</a>
        <a class="nav-link active" href="/dashboard/web/option_chain_dashboard.html">Option Chain</a>
        <a class="nav-link" href="/dashboard/web/place_order.html">Place Order</a>
        <a class="nav-link" href="/dashboard/web/orderbook.html">Orderbook</a>
    </div>
</header>

<main>
    <div id="errorMsg" class="error-msg"></div>
    
    <!-- Controls Bar -->
    <div class="controls-bar">
        <select id="symbol">
            <option value="NIFTY" selected>NIFTY</option>
            <option value="BANKNIFTY">BANKNIFTY</option>
            <option value="FINNIFTY">FINNIFTY</option>
            <option value="SENSEX">SENSEX</option>
        </select>
        
        <select id="expiry">
            <option>Loading...</option>
        </select>
        
        <button id="refreshBtn" onclick="loadOptionChain()">
            üîÑ Refresh
        </button>
        
        <!-- Column Selector -->
        <div class="column-selector">
            <div class="column-selector-btn" onclick="toggleColumnSelector()">
                üìä Columns
            </div>
            <div id="columnDropdown" class="column-dropdown">
                <div class="column-option"><input type="checkbox" id="col-oi" checked onchange="updateColumnVisibility()"><label for="col-oi">OI</label></div>
                <div class="column-option"><input type="checkbox" id="col-volume" checked onchange="updateColumnVisibility()"><label for="col-volume">Volume</label></div>
                <div class="column-option"><input type="checkbox" id="col-iv" checked onchange="updateColumnVisibility()"><label for="col-iv">IV</label></div>
                <div class="column-option"><input type="checkbox" id="col-delta" checked onchange="updateColumnVisibility()"><label for="col-delta">Delta (Œî)</label></div>
                <div class="column-option"><input type="checkbox" id="col-gamma" onchange="updateColumnVisibility()"><label for="col-gamma">Gamma (Œì)</label></div>
                <div class="column-option"><input type="checkbox" id="col-theta" onchange="updateColumnVisibility()"><label for="col-theta">Theta (Œò)</label></div>
                <div class="column-option"><input type="checkbox" id="col-vega" onchange="updateColumnVisibility()"><label for="col-vega">Vega (ŒΩ)</label></div>
            </div>
        </div>
        
        <div style="margin-left: auto; display: flex; align-items: center; gap: 12px;">
            <div class="auto-refresh">
                <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                    <input type="checkbox" id="autoRefresh" checked onchange="toggleAutoRefresh()">
                    <span style="font-size: 11px;">Auto-refresh</span>
                </label>
                <div id="refreshIndicator" class="refresh-indicator">
                    <span>3s</span>
                </div>
            </div>
            
            <div class="basket-indicator" onclick="openBasketModal()">
                üõí
                <span id="basketCount" class="basket-count"></span>
            </div>
        </div>
    </div>
    
    <!-- Info Bar -->
    <div class="info-bar" id="infoBar">
        <div class="info-item">
            <div class="info-label">Spot Price</div>
            <div class="info-value spot-price" id="spotPrice">‚Çπ0.00</div>
        </div>
        <div class="info-item">
            <div class="info-label">Future Price</div>
            <div class="info-value future-price" id="futurePrice">‚Çπ0.00</div>
        </div>
        <div class="info-item">
            <div class="info-label">ATM Strike</div>
            <div class="info-value atm-price" id="atmStrike">0</div>
        </div>
        <div class="info-item">
            <div class="info-label">Total OI</div>
            <div class="info-value" id="totalOI">0</div>
        </div>
        <div class="info-item">
            <div class="info-label">PCR</div>
            <div class="info-value" id="pcr">0.00</div>
        </div>
        <div class="info-item">
            <div class="info-label">Last Updated</div>
            <div class="info-value" id="lastUpdated">--:--:--</div>
        </div>
    </div>
    
    <!-- Option Chain Table -->
    <div class="chain-container">
        <div class="table-wrapper">
            <table class="option-table" id="optionTable">
                <thead id="tableHeader">
                    <!-- Headers will be generated here -->
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="100" class="loading">Loading option chain data...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Order Entry Popup -->
    <div id="orderPopup" class="order-popup">
        <div class="order-popup-header">
            <span id="orderPopupTitle">Place Order</span>
            <span class="order-popup-close" onclick="closeOrderPopup()">&times;</span>
        </div>
        <div class="order-form-group">
            <label class="order-form-label">Side</label>
            <div class="order-form-row">
                <button id="orderSideBuy" class="order-form-input" style="background:var(--success)" onclick="setOrderSide('BUY')">BUY</button>
                <button id="orderSideSell" class="order-form-input" style="background:var(--danger)" onclick="setOrderSide('SELL')">SELL</button>
            </div>
        </div>
        <div class="order-form-group">
            <label class="order-form-label">Quantity (Lots)</label>
            <input type="number" id="orderQty" class="order-form-input" value="1" min="1">
        </div>
        <div class="order-form-group">
            <label class="order-form-label">Product Type</label>
            <div class="order-form-row">
                <button id="orderProductMIS" class="order-form-input" onclick="setOrderProduct('MIS')">MIS</button>
                <button id="orderProductNRML" class="order-form-input" onclick="setOrderProduct('NRML')">NRML</button>
            </div>
        </div>
        <div class="order-form-group">
            <label class="order-form-label">Price Type</label>
            <div class="order-form-row">
                <button id="orderPriceTypeMKT" class="order-form-input" onclick="setOrderPriceType('MARKET')">MARKET</button>
                <button id="orderPriceTypeLMT" class="order-form-input" onclick="setOrderPriceType('LIMIT')">LIMIT</button>
            </div>
        </div>
        <div class="order-form-group" id="orderPriceGroup">
            <label class="order-form-label">Price</label>
            <input type="number" id="orderPrice" class="order-form-input" step="0.05">
        </div>
        <div class="order-form-actions">
            <button onclick="closeOrderPopup()" style="background:var(--muted)">Cancel</button>
            <button onclick="confirmOrderEntry()" style="background:var(--success)">Add to Basket</button>
        </div>
    </div>
    
    <!-- Basket Modal -->
    <div id="basketModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>üõí Order Basket</span>
                <button onclick="closeBasketModal()" style="background:transparent;border:none;color:var(--muted);font-size:20px;cursor:pointer;padding:0">&times;</button>
            </div>
            <div class="modal-body">
                <div id="basketItems"></div>
            </div>
            <div class="modal-footer">
                <button onclick="closeBasketModal()" style="background:var(--muted)">Cancel</button>
                <button id="confirmBasketBtn" onclick="placeBasketOrders()" style="background:var(--success)">Confirm & Place Orders</button>
            </div>
        </div>
    </div>
</main>

<script>
    // Configuration
    const config = {
        visibleColumns: {
            oi: true,
            volume: true,
            iv: true,
            delta: true,
            gamma: false,
            theta: false,
            vega: false
        },
        autoRefreshInterval: 3000
    };
    
    // State
    let chainData = {};
    let currentSpotPrice = 0;
    let currentFuturePrice = 0;
    let atmStrike = 0;
    let autoRefreshTimer = null;
    let refreshCountdown = 3;
    let selectedStrike = null;
    let basket = [];
    
    // DOM Elements
    const elements = {
        symbol: document.getElementById('symbol'),
        expiry: document.getElementById('expiry'),
        refreshBtn: document.getElementById('refreshBtn'),
        tableHeader: document.getElementById('tableHeader'),
        tableBody: document.getElementById('tableBody'),
        errorMsg: document.getElementById('errorMsg'),
        spotPrice: document.getElementById('spotPrice'),
        futurePrice: document.getElementById('futurePrice'),
        atmStrikeEl: document.getElementById('atmStrike'),
        totalOI: document.getElementById('totalOI'),
        pcr: document.getElementById('pcr'),
        lastUpdated: document.getElementById('lastUpdated'),
        autoRefresh: document.getElementById('autoRefresh'),
        refreshIndicator: document.getElementById('refreshIndicator'),
        basketCount: document.getElementById('basketCount'),
        basketModal: document.getElementById('basketModal'),
        basketItems: document.getElementById('basketItems'),
        orderPopup: document.getElementById('orderPopup'),
        orderPopupTitle: document.getElementById('orderPopupTitle'),
        orderQty: document.getElementById('orderQty'),
        orderPrice: document.getElementById('orderPrice'),
        orderSideBuy: document.getElementById('orderSideBuy'),
        orderSideSell: document.getElementById('orderSideSell'),
        orderProductMIS: document.getElementById('orderProductMIS'),
        orderProductNRML: document.getElementById('orderProductNRML'),
        orderPriceTypeMKT: document.getElementById('orderPriceTypeMKT'),
        orderPriceTypeLMT: document.getElementById('orderPriceTypeLMT'),
        orderPriceGroup: document.getElementById('orderPriceGroup')
    };
    
    // Current order entry
    let currentOrderEntry = {
        strike: null,
        optionType: null,
        ltp: null,
        tradingSymbol: null,
        side: 'BUY',
        qty: 1,
        product: 'MIS',
        priceType: 'LIMIT',
        price: null
    };
    
    // Initialize
    function init() {
        setupEventListeners();
        setupColumnVisibility();
        loadExpiries();
        startAutoRefresh();
        updateBasketUI();
    }
    
    // Event Listeners
    function setupEventListeners() {
        elements.symbol.addEventListener('change', () => {
            stopAutoRefresh();
            loadExpiries();
        });
        
        elements.expiry.addEventListener('change', () => {
            stopAutoRefresh();
            loadOptionChain();
            startAutoRefresh();
        });
        
        // Close column selector when clicking outside
        document.addEventListener('click', (e) => {
            const selector = document.querySelector('.column-selector');
            const dropdown = document.getElementById('columnDropdown');
            if (selector && !selector.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });
        
        // Close modals when clicking outside
        document.addEventListener('click', (e) => {
            if (e.target === elements.basketModal) {
                closeBasketModal();
            }
            const popup = document.getElementById('orderPopup');
            if (popup.classList.contains('show') && !popup.contains(e.target)) {
                closeOrderPopup();
            }
        });
    }
    
    // Column Visibility
    function setupColumnVisibility() {
        for (const [key, visible] of Object.entries(config.visibleColumns)) {
            const checkbox = document.getElementById(`col-${key}`);
            if (checkbox) {
                checkbox.checked = visible;
            }
        }
    }
    
    function updateColumnVisibility() {
        for (const key in config.visibleColumns) {
            const checkbox = document.getElementById(`col-${key}`);
            if (checkbox) {
                config.visibleColumns[key] = checkbox.checked;
            }
        }
        if (Object.keys(chainData).length > 0) {
            renderTable();
        }
    }
    
    function toggleColumnSelector() {
        const dropdown = document.getElementById('columnDropdown');
        dropdown.classList.toggle('show');
    }
    
    function getVisibleColumns() {
        return Object.keys(config.visibleColumns).filter(key => config.visibleColumns[key]);
    }
    
    // Auto Refresh
    function startAutoRefresh() {
        if (!elements.autoRefresh.checked) return;
        
        stopAutoRefresh();
        refreshCountdown = 3;
        updateRefreshIndicator();
        
        autoRefreshTimer = setInterval(() => {
            refreshCountdown--;
            updateRefreshIndicator();
            
            if (refreshCountdown <= 0) {
                refreshCountdown = 3;
                if (elements.symbol.value && elements.expiry.value) {
                    loadOptionChain(true);
                }
            }
        }, 1000);
    }
    
    function stopAutoRefresh() {
        if (autoRefreshTimer) {
            clearInterval(autoRefreshTimer);
            autoRefreshTimer = null;
            elements.refreshIndicator.classList.add('paused');
        }
    }
    
    function toggleAutoRefresh() {
        if (elements.autoRefresh.checked) {
            startAutoRefresh();
        } else {
            stopAutoRefresh();
            elements.refreshIndicator.textContent = 'Paused';
            elements.refreshIndicator.classList.add('paused');
        }
    }
    
    function updateRefreshIndicator() {
        elements.refreshIndicator.innerHTML = `<span>${refreshCountdown}s</span>`;
        elements.refreshIndicator.classList.remove('paused');
    }
    
    // Error Handling
    function showError(message) {
        elements.errorMsg.textContent = message;
        elements.errorMsg.style.display = 'block';
        setTimeout(() => {
            elements.errorMsg.style.display = 'none';
        }, 5000);
    }
    
    // Data Loading
    async function loadExpiries() {
        try {
            elements.expiry.innerHTML = '<option>Loading...</option>';
            elements.expiry.disabled = true;
            elements.refreshBtn.disabled = true;
            
            const res = await fetch(
                `/dashboard/option-chain/active-expiries?exchange=NFO&symbol=${elements.symbol.value}`,
                { credentials: 'include' }
            );
            
            if (!res.ok) throw new Error(`Failed to load expiries: ${res.status}`);
            
            const expiries = await res.json();
            
            if (!Array.isArray(expiries) || expiries.length === 0) {
                elements.expiry.innerHTML = '<option>No expiries found</option>';
                elements.tableBody.innerHTML = '<tr><td colspan="100" class="loading">No expiries available</td></tr>';
                return;
            }
            
            elements.expiry.innerHTML = expiries.map(e => {
                const expiryValue = typeof e === 'string' ? e : e.expiry;
                return `<option value="${expiryValue}">${expiryValue}</option>`;
            }).join('');
            
            elements.expiry.disabled = false;
            elements.refreshBtn.disabled = false;
            
            // Load chain for first expiry
            await loadOptionChain();
            
        } catch (error) {
            console.error('Error loading expiries:', error);
            showError(error.message);
            elements.expiry.innerHTML = '<option>Error loading</option>';
            elements.expiry.disabled = false;
            elements.refreshBtn.disabled = false;
        }
    }
    
    async function loadOptionChain(isAutoRefresh = false) {
        if (!isAutoRefresh) {
            elements.refreshBtn.disabled = true;
            elements.tableBody.innerHTML = '<tr><td colspan="100" class="loading">Loading option chain...</td></tr>';
        }
        
        try {
            const res = await fetch(
                `/dashboard/option-chain?exchange=NFO&symbol=${elements.symbol.value}&expiry=${elements.expiry.value}&max_age=5`,
                { credentials: 'include' }
            );
            
            if (!res.ok) {
                const errorData = await res.json().catch(() => ({ detail: 'Unknown error' }));
                throw new Error(errorData.detail || `HTTP ${res.status}`);
            }
            
            const data = await res.json();
            
            // Update info bar
            if (data.meta) {
                currentSpotPrice = data.meta.spot_price || 0;
                currentFuturePrice = data.meta.future_price || currentSpotPrice;
                
                elements.spotPrice.textContent = `‚Çπ${formatNumber(currentSpotPrice, 2)}`;
                elements.futurePrice.textContent = `‚Çπ${formatNumber(currentFuturePrice, 2)}`;
                
                // Update timestamp
                elements.lastUpdated.textContent = data.meta.snapshot_ts ? 
                    new Date(parseFloat(data.meta.snapshot_ts) * 1000).toLocaleTimeString('en-IN', {
                        hour12: false,
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    }) : new Date().toLocaleTimeString('en-IN', {
                        hour12: false,
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
            }
            
            // Process chain data
            processChainData(data.rows || []);
            
            // Render table
            renderTable();
            
        } catch (error) {
            console.error('Error loading option chain:', error);
            if (!isAutoRefresh) {
                showError(error.message);
                elements.tableBody.innerHTML = '<tr><td colspan="100" class="loading">Error loading option chain</td></tr>';
            }
        } finally {
            if (!isAutoRefresh) {
                elements.refreshBtn.disabled = false;
            }
        }
    }
    
    function processChainData(rows) {
        chainData = {};
        let totalCallOI = 0;
        let totalPutOI = 0;
        let maxOI = 0;
        
        // Create strike map
        rows.forEach(row => {
            if (!chainData[row.strike]) {
                chainData[row.strike] = { strike: row.strike };
            }
            
            const prefix = row.option_type === 'CE' ? 'ce' : 'pe';
            chainData[row.strike][`${prefix}_ltp`] = row.ltp;
            chainData[row.strike][`${prefix}_change_pct`] = row.change_pct;
            chainData[row.strike][`${prefix}_volume`] = row.volume;
            chainData[row.strike][`${prefix}_oi`] = row.oi;
            chainData[row.strike][`${prefix}_iv`] = row.iv;
            chainData[row.strike][`${prefix}_trading_symbol`] = row.trading_symbol;
            chainData[row.strike][`${prefix}_delta`] = row.delta;
            chainData[row.strike][`${prefix}_gamma`] = row.gamma;
            chainData[row.strike][`${prefix}_theta`] = row.theta;
            chainData[row.strike][`${prefix}_vega`] = row.vega;
            
            if (row.option_type === 'CE') {
                totalCallOI += row.oi || 0;
            } else {
                totalPutOI += row.oi || 0;
            }
            
            maxOI = Math.max(maxOI, row.oi || 0);
        });
        
        // Find ATM strike
        const strikes = Object.keys(chainData).map(Number).sort((a, b) => a - b);
        atmStrike = findATMStrike(strikes, currentSpotPrice);
        
        // Update info bar
        elements.atmStrikeEl.textContent = atmStrike;
        elements.totalOI.textContent = formatNumber(totalCallOI + totalPutOI, 0);
        elements.pcr.textContent = totalCallOI > 0 ? (totalPutOI / totalCallOI).toFixed(2) : '0.00';
    }
    
    function findATMStrike(strikes, spotPrice) {
        if (!spotPrice || strikes.length === 0) return 0;
        return strikes.reduce((prev, curr) => 
            Math.abs(curr - spotPrice) < Math.abs(prev - spotPrice) ? curr : prev
        );
    }
    
    // Table Rendering
    function renderTable() {
        renderTableHeader();
        renderTableBody();
    }
    
    function renderTableHeader() {
        const visibleColumns = getVisibleColumns();
        const columnLabels = {
            oi: 'OI',
            volume: 'VOL',
            iv: 'IV%',
            delta: 'Œî',
            gamma: 'Œì',
            theta: 'Œò',
            vega: 'ŒΩ'
        };
        
        let headerHTML = '';
        
        // Calls header
        headerHTML += `<th colspan="${visibleColumns.length + 1}" class="section-header calls-header">CALLS</th>`;
        headerHTML += `<th class="section-header">STRIKE</th>`;
        headerHTML += `<th colspan="${visibleColumns.length + 1}" class="section-header puts-header">PUTS</th>`;
        headerHTML = `<tr>${headerHTML}</tr><tr>`;
        
        // Call columns
        visibleColumns.forEach(col => {
            headerHTML += `<th>${columnLabels[col]}</th>`;
        });
        headerHTML += `<th>LTP</th>`;
        
        // Strike column
        headerHTML += `<th>STRIKE</th>`;
        
        // Put columns (in reverse order)
        headerHTML += `<th>LTP</th>`;
        [...visibleColumns].reverse().forEach(col => {
            headerHTML += `<th>${columnLabels[col]}</th>`;
        });
        
        headerHTML += '</tr>';
        elements.tableHeader.innerHTML = headerHTML;
    }
    
    function renderTableBody() {
        const strikes = Object.keys(chainData).map(Number).sort((a, b) => a - b);
        const visibleColumns = getVisibleColumns();
        
        let bodyHTML = '';
        let maxOI = Math.max(...strikes.map(s => Math.max(chainData[s].ce_oi || 0, chainData[s].pe_oi || 0)));
        
        strikes.forEach(strike => {
            const data = chainData[strike];
            const isATM = strike === atmStrike;
            const callItm = strike <= currentSpotPrice;
            const putItm = strike >= currentSpotPrice;
            
            let rowHTML = `<tr class="${isATM ? 'atm-row' : ''}" onclick="selectStrike(${strike})">`;
            
            // Call columns
            visibleColumns.forEach(col => {
                const value = data[`ce_${col}`];
                const cellClass = `call-${callItm ? 'itm' : 'otm'}`;
                rowHTML += `<td class="${cellClass}">${formatColumnValue(col, value, 'call', data.ce_oi, maxOI)}</td>`;
            });
            
            // Call LTP
            rowHTML += `<td class="ltp-cell ${callItm ? 'call-itm' : 'call-otm'} ${getChangeClass(data.ce_change_pct)}" 
                           onclick="openOrderEntry(${strike}, 'CE', ${data.ce_ltp || 0}, '${data.ce_trading_symbol || ''}', event)">
                           ${formatNumber(data.ce_ltp, 2)}
                       </td>`;
            
            // Strike cell
            rowHTML += `<td class="strike-cell">${formatNumber(strike, 0)}</td>`;
            
            // Put LTP
            rowHTML += `<td class="ltp-cell ${putItm ? 'put-itm' : 'put-otm'} ${getChangeClass(data.pe_change_pct)}" 
                           onclick="openOrderEntry(${strike}, 'PE', ${data.pe_ltp || 0}, '${data.pe_trading_symbol || ''}', event)">
                           ${formatNumber(data.pe_ltp, 2)}
                       </td>`;
            
            // Put columns (in reverse order)
            [...visibleColumns].reverse().forEach(col => {
                const value = data[`pe_${col}`];
                const cellClass = `put-${putItm ? 'itm' : 'otm'}`;
                rowHTML += `<td class="${cellClass}">${formatColumnValue(col, value, 'put', data.pe_oi, maxOI)}</td>`;
            });
            
            rowHTML += '</tr>';
            bodyHTML += rowHTML;
        });
        
        elements.tableBody.innerHTML = bodyHTML;
    }
    
    function formatColumnValue(column, value, side, oi, maxOI) {
        if (value === null || value === undefined) return '-';
        
        switch(column) {
            case 'oi':
                const oiPct = maxOI > 0 ? ((oi || 0) / maxOI) * 100 : 0;
                return `
                    <div class="bar-container">
                        <div class="bar-fill bar-${side}" style="width: ${oiPct}%"></div>
                        <div class="bar-text">${formatNumber(value, 0)}</div>
                    </div>
                `;
                
            case 'volume':
                return formatNumber(value, 0);
                
            case 'iv':
                return formatNumber(value, 1) + '%';
                
            case 'delta':
            case 'gamma':
            case 'theta':
            case 'vega':
                return formatNumber(value, 3);
                
            default:
                return formatNumber(value, 2);
        }
    }
    
    function formatNumber(value, decimals = 2) {
        if (value === null || value === undefined || value === '') return '-';
        const num = parseFloat(value);
        if (isNaN(num)) return '-';
        
        if (decimals === 0) {
            return num.toLocaleString('en-IN');
        }
        
        return num.toFixed(decimals);
    }
    
    function getChangeClass(change) {
        if (change === null || change === undefined) return '';
        return change >= 0 ? 'positive' : 'negative';
    }
    
    function selectStrike(strike) {
        selectedStrike = selectedStrike === strike ? null : strike;
        // You can add visual feedback for selected strike here
    }
    
    // Order Entry
    function openOrderEntry(strike, optionType, ltp, tradingSymbol, event) {
        event.stopPropagation();
        
        currentOrderEntry = {
            strike,
            optionType,
            ltp,
            tradingSymbol,
            side: 'BUY',
            qty: 1,
            product: 'MIS',
            priceType: 'LIMIT',
            price: ltp
        };
        
        elements.orderPopupTitle.textContent = tradingSymbol;
        elements.orderQty.value = 1;
        elements.orderPrice.value = ltp;
        
        setOrderSide('BUY');
        setOrderProduct('MIS');
        setOrderPriceType('LIMIT');
        
        const popup = elements.orderPopup;
        const rect = event.target.getBoundingClientRect();
        popup.style.left = `${rect.left}px`;
        popup.style.top = `${rect.bottom + 5}px`;
        
        // Adjust position if needed
        setTimeout(() => {
            const popupRect = popup.getBoundingClientRect();
            if (popupRect.right > window.innerWidth) {
                popup.style.left = `${window.innerWidth - popupRect.width - 10}px`;
            }
            if (popupRect.bottom > window.innerHeight) {
                popup.style.top = `${rect.top - popupRect.height - 5}px`;
            }
        }, 10);
        
        popup.classList.add('show');
    }
    
    function closeOrderPopup() {
        elements.orderPopup.classList.remove('show');
    }
    
    function setOrderSide(side) {
        currentOrderEntry.side = side;
        elements.orderSideBuy.style.opacity = side === 'BUY' ? '1' : '0.5';
        elements.orderSideSell.style.opacity = side === 'SELL' ? '1' : '0.5';
    }
    
    function setOrderProduct(product) {
        currentOrderEntry.product = product;
        elements.orderProductMIS.style.opacity = product === 'MIS' ? '1' : '0.5';
        elements.orderProductNRML.style.opacity = product === 'NRML' ? '1' : '0.5';
    }
    
    function setOrderPriceType(priceType) {
        currentOrderEntry.priceType = priceType;
        elements.orderPriceTypeMKT.style.opacity = priceType === 'MARKET' ? '1' : '0.5';
        elements.orderPriceTypeLMT.style.opacity = priceType === 'LIMIT' ? '1' : '0.5';
        elements.orderPriceGroup.style.display = priceType === 'MARKET' ? 'none' : 'block';
    }
    
    function confirmOrderEntry() {
        const qty = parseInt(elements.orderQty.value);
        const price = parseFloat(elements.orderPrice.value);
        
        if (!qty || qty < 1) {
            showError('Invalid quantity');
            return;
        }
        
        if (currentOrderEntry.priceType === 'LIMIT' && (!price || price <= 0)) {
            showError('Invalid price for LIMIT order');
            return;
        }
        
        currentOrderEntry.qty = qty;
        currentOrderEntry.price = currentOrderEntry.priceType === 'LIMIT' ? price : null;
        
        addToBasket(
            currentOrderEntry.strike,
            currentOrderEntry.optionType,
            currentOrderEntry.ltp,
            currentOrderEntry.tradingSymbol,
            currentOrderEntry.side,
            currentOrderEntry.qty,
            currentOrderEntry.product,
            currentOrderEntry.priceType,
            currentOrderEntry.price
        );
        
        closeOrderPopup();
    }
    
    // Basket Functions
    function addToBasket(strike, optionType, ltp, tradingSymbol, side, qty, product, orderType, price) {
        const exists = basket.find(item => item.strike === strike && item.optionType === optionType);
        
        if (exists) {
            showError(`${tradingSymbol} already in basket`);
            return;
        }
        
        basket.push({
            strike,
            optionType,
            ltp,
            tradingSymbol,
            side,
            qty,
            product,
            orderType,
            price
        });
        
        updateBasketUI();
        showBasketToast(`Added ${tradingSymbol} to basket`);
    }
    
    function removeFromBasket(index) {
        basket.splice(index, 1);
        updateBasketUI();
        renderBasketItems();
    }
    
    function updateBasketUI() {
        const count = basket.length;
        elements.basketCount.textContent = count;
        if (count > 0) {
            elements.basketCount.classList.add('show');
        } else {
            elements.basketCount.classList.remove('show');
        }
    }
    
    function showBasketToast(msg) {
        // Create toast element
        const toast = document.createElement('div');
        toast.textContent = msg;
        toast.style.cssText = `
            position: fixed;
            top: 70px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 10px 16px;
            border-radius: 6px;
            z-index: 1000;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 2000);
    }
    
    function openBasketModal() {
        if (basket.length === 0) {
            showError('Basket is empty');
            return;
        }
        renderBasketItems();
        elements.basketModal.style.display = 'flex';
    }
    
    function closeBasketModal() {
        elements.basketModal.style.display = 'none';
    }
    
    function renderBasketItems() {
        if (basket.length === 0) {
            elements.basketItems.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--muted)">Basket is empty</div>';
            return;
        }
        
        elements.basketItems.innerHTML = basket.map((item, idx) => `
            <div class="basket-item" style="background: #1c2333; padding: 12px; border-radius: 6px; margin-bottom: 8px; border: 1px solid var(--border)">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px">
                    <span style="font-weight: 700; font-size: 13px">${item.tradingSymbol}</span>
                    <button onclick="removeFromBasket(${idx})" style="background: var(--danger); padding: 3px 6px; font-size: 10px; border: none; border-radius: 3px; color: white; cursor: pointer">
                        Remove
                    </button>
                </div>
                <div style="font-size: 11px; color: var(--muted)">
                    ${item.side} | ${item.qty} Lots | ${item.product} | ${item.orderType} ${item.orderType === 'LIMIT' ? '@ ‚Çπ' + item.price : ''}
                </div>
            </div>
        `).join('');
    }
    
    async function placeBasketOrders() {
        if (basket.length === 0) return;
        
        const confirmBtn = document.getElementById('confirmBasketBtn');
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'Placing...';
        
        try {
            const orders = basket.map(item => ({
                exchange: 'NFO',
                symbol: item.tradingSymbol,
                side: item.side,
                qty: item.qty,
                product: item.product,
                order_type: item.orderType,
                price: item.orderType === 'LIMIT' ? item.price : null,
                execution_type: 'ENTRY',
                reason: 'OPTION_CHAIN_BASKET'
            }));
            
            const res = await fetch('/dashboard/intent/basket', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ orders, reason: 'OPTION_CHAIN_BASKET' })
            });
            
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            
            showBasketToast('‚úì Basket orders submitted!');
            basket = [];
            updateBasketUI();
            closeBasketModal();
        } catch (err) {
            showError('Failed to place basket orders: ' + err.message);
        } finally {
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'Confirm & Place Orders';
        }
    }
    
    // Initialize on load
    window.addEventListener('load', init);
</script>
</body>
</html>