<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Strategy Management | Shoonya Platform</title>
<link rel="stylesheet" href="/dashboard/web/styles/common.css">
<link rel="stylesheet" href="/dashboard/web/shared/layout.css">
<script src="/dashboard/web/shared/pages-config.js" defer></script>
<script src="/dashboard/web/shared/layout.js" defer></script>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SHOONYA STRATEGY ‚Äî ADVANCED MANAGEMENT INTERFACE
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
:root {
  --primary: #66e4ff;
  --primary-dark: #23b6ff;
  --success: #4ade80;
  --warning: #fbcb5c;
  --danger: #fb7185;
  --panel: rgba(13, 18, 41, 0.8);
  --panel-2: rgba(6, 10, 26, 0.95);
  --panel-3: rgba(13, 18, 41, 0.9);
  --panel-4: rgba(30, 40, 60, 0.85);
  --border: rgba(255, 255, 255, 0.08);
  --border-2: rgba(102, 228, 255, 0.15);
  --text: #f8fbff;
  --muted: rgba(248, 251, 255, 0.65);
  --muted-2: rgba(248, 251, 255, 0.45);
  --accent: #8b5cf6;
  --cyan: #06b6d4;
  --font-mono: 'IBM Plex Mono', monospace;
  --font-head: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  background: radial-gradient(circle at top, #0f1a3c 0%, #050815 55%, #020308 100%);
  color: var(--text);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  font-size: 13px;
  overflow-x: hidden;
  letter-spacing: 0.1px;
}

main {
  padding: 20px 20px 40px;
  max-width: 1800px;
  margin: 0 auto;
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.top-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
  gap: 16px;
}

.top-bar h1 {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  font-size: 28px;
  font-weight: 700;
  color: var(--text);
}

.top-bar p { font-size: 11px; color: var(--muted); margin-top: 2px; }

.btn-create {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 24px;
  background: linear-gradient(120deg, var(--primary), var(--primary-dark));
  color: #04060f;
  font-weight: 600;
  font-size: 14px;
  border: none;
  border-radius: 999px;
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.2s;
  box-shadow: 0 10px 20px rgba(35, 182, 255, 0.35);
  flex-shrink: 0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  letter-spacing: 0.2px;
}

.btn-create:hover {
  transform: translateY(-2px);
  box-shadow: 0 18px 26px rgba(35, 182, 255, 0.45);
}

.btn-create .plus-icon {
  width: 18px; height: 18px;
  background: rgba(255,255,255,0.2);
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; font-weight: 400; line-height: 1;
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ LAYOUT GRID ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.main-grid {
  display: grid;
  grid-template-rows: auto auto;
  gap: 16px;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MONITOR WIDGET ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.monitor-widget {
  background: rgba(13, 18, 41, 0.8);
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 20px 45px rgba(3, 5, 20, 0.5);
  backdrop-filter: blur(20px);
}

.widget-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  background: rgba(6, 10, 26, 0.95);
  border-bottom: 1px solid rgba(255, 255, 255, 0.08);
  gap: 12px;
}

.widget-title {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  font-size: 13px;
  font-weight: 700;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 8px;
}

.live-dot {
  width: 7px; height: 7px;
  background: var(--success);
  border-radius: 50%;
  animation: pulse-dot 2s infinite;
}

@keyframes pulse-dot {
  0%,100% { opacity: 1; box-shadow: 0 0 0 0 rgba(16,185,129,0.4); }
  50% { opacity: 0.8; box-shadow: 0 0 0 4px rgba(16,185,129,0); }
}

.monitor-tabs {
  display: flex;
  gap: 2px;
}

.mtab {
  padding: 5px 12px;
  font-size: 11px;
  font-weight: 600;
  border-radius: 6px;
  cursor: pointer;
  color: var(--muted);
  border: 1px solid transparent;
  background: transparent;
  transition: all 0.15s;
}

.mtab.active {
  background: var(--panel-4);
  color: var(--primary);
  border-color: var(--border-2);
}

.mtab:hover:not(.active) { color: var(--text); }

.monitor-body { padding: 0; }

/* Orphan Section */
.orphan-section {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  background: linear-gradient(90deg, rgba(239,68,68,0.04) 0%, transparent 100%);
}

.section-label {
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--danger);
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.section-label::after {
  content: '';
  flex: 1;
  height: 1px;
  background: linear-gradient(90deg, var(--danger) 0%, transparent 60%);
  opacity: 0.3;
}

.orphan-table, .monitor-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 11px;
  font-family: var(--font-mono);
}

.orphan-table th, .monitor-table th {
  padding: 6px 10px;
  color: var(--muted-2);
  font-weight: 600;
  font-size: 9.5px;
  text-transform: uppercase;
  letter-spacing: 0.4px;
  text-align: right;
  border-bottom: 1px solid var(--border);
  background: rgba(255,255,255,0.01);
  white-space: nowrap;
}

.orphan-table th:first-child, .monitor-table th:first-child { text-align: left; }

.orphan-table td, .monitor-table td {
  padding: 7px 10px;
  text-align: right;
  border-bottom: 1px solid rgba(30,45,69,0.5);
  white-space: nowrap;
}

.orphan-table td:first-child, .monitor-table td:first-child { text-align: left; }

.orphan-table tr:last-child td, .monitor-table tr:last-child td { border-bottom: none; }

.orphan-table tr:hover td, .monitor-table tr:hover td {
  background: rgba(255,255,255,0.02);
}

.strategy-section {
  padding: 0 16px 12px;
}

.strategy-section .section-label {
  color: var(--primary);
  padding-top: 12px;
}

.strategy-section .section-label::after {
  background: linear-gradient(90deg, var(--primary) 0%, transparent 60%);
}

/* Greek value coloring */
.val-pos { color: var(--success); }
.val-neg { color: var(--danger); }
.val-neu { color: var(--text); }
.val-muted { color: var(--muted); }
.val-warn { color: var(--warning); }
.val-accent { color: var(--cyan); }

/* Strategy row expansion */
.strategy-group-row {
  cursor: pointer;
  background: rgba(59,130,246,0.03);
}

.strategy-group-row:hover td { background: rgba(59,130,246,0.06) !important; }

.expand-icon {
  display: inline-block;
  width: 14px;
  transition: transform 0.2s;
  color: var(--muted);
  font-size: 10px;
}

.expanded .expand-icon { transform: rotate(90deg); }

.sub-row td { background: rgba(255,255,255,0.01) !important; }
.sub-row td:first-child { padding-left: 28px; color: var(--muted); }

.combined-row td {
  background: rgba(139,92,246,0.05) !important;
  color: var(--accent);
  font-weight: 600;
}

.badge-ce {
  background: rgba(59,130,246,0.15);
  color: #60a5fa;
  padding: 1px 6px;
  border-radius: 4px;
  font-size: 9px;
  font-weight: 700;
}

.badge-pe {
  background: rgba(239,68,68,0.15);
  color: #f87171;
  padding: 1px 6px;
  border-radius: 4px;
  font-size: 9px;
  font-weight: 700;
}

.badge-buy {
  background: rgba(16,185,129,0.15);
  color: #34d399;
  padding: 1px 6px;
  border-radius: 4px;
  font-size: 9px;
  font-weight: 700;
}

.badge-sell {
  background: rgba(239,68,68,0.15);
  color: #f87171;
  padding: 1px 6px;
  border-radius: 4px;
  font-size: 9px;
  font-weight: 700;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONTROL WIDGET ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.control-widget {
  background: rgba(13, 18, 41, 0.8);
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 20px 45px rgba(3, 5, 20, 0.5);
  backdrop-filter: blur(20px);
}

.control-header-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  background: var(--panel-2);
  border-bottom: 1px solid var(--border);
}

.control-stats {
  display: flex;
  gap: 16px;
}

.c-stat {
  text-align: center;
}

.c-stat-val {
  font-family: var(--font-mono);
  font-size: 18px;
  font-weight: 700;
}

.c-stat-lbl {
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--muted);
}

.strategy-cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 12px;
  padding: 16px;
}

.s-card {
  background: var(--panel-2);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 14px;
  transition: all 0.2s;
  position: relative;
  overflow: hidden;
}

.s-card::before {
  content: '';
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 3px;
  background: var(--muted-2);
  border-radius: 0;
}

.s-card.running::before { background: var(--success); }
.s-card.paused::before { background: var(--warning); }
.s-card.stopped::before { background: var(--danger); }

.s-card:hover { border-color: var(--border-2); }

.s-card-top {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 10px;
}

.s-card-name {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  font-size: 14px;
  font-weight: 700;
  color: var(--text);
}

.s-card-sub {
  font-size: 10px;
  color: var(--muted);
  margin-top: 2px;
  font-family: var(--font-mono);
}

.status-pill {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 10px;
  font-weight: 700;
  font-family: var(--font-mono);
}

.status-pill.idle { background: rgba(107,124,150,0.12); color: var(--muted); }
.status-pill.running { background: rgba(16,185,129,0.12); color: var(--success); border: 1px solid rgba(16,185,129,0.3); }
.status-pill.paused { background: rgba(245,158,11,0.12); color: var(--warning); border: 1px solid rgba(245,158,11,0.3); }
.status-pill.stopped { background: rgba(239,68,68,0.12); color: var(--danger); border: 1px solid rgba(239,68,68,0.3); }

.status-dot {
  width: 6px; height: 6px;
  border-radius: 50%;
  background: currentColor;
}

.status-pill.running .status-dot { animation: pulse-dot 1.5s infinite; }

.s-card-metrics {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 6px;
  padding: 8px;
  background: rgba(0,0,0,0.2);
  border-radius: 6px;
  margin-bottom: 10px;
}

.s-metric { text-align: center; }
.s-metric-val {
  font-family: var(--font-mono);
  font-size: 11px;
  font-weight: 600;
}

.s-metric-lbl {
  font-size: 8.5px;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.s-card-actions {
  display: flex;
  gap: 6px;
}

.s-btn {
  flex: 1;
  padding: 6px 8px;
  font-size: 10px;
  font-weight: 700;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.15s;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  letter-spacing: 0.2px;
}

.s-btn:disabled {
  opacity: 0.2;
  cursor: not-allowed;
  pointer-events: none;
}

.s-btn-start { background: rgba(16,185,129,0.15); color: var(--success); border: 1px solid rgba(16,185,129,0.25); }
.s-btn-start:hover { background: rgba(16,185,129,0.25); }
.s-btn-pause { background: rgba(245,158,11,0.15); color: var(--warning); border: 1px solid rgba(245,158,11,0.25); }
.s-btn-pause:hover { background: rgba(245,158,11,0.25); }
.s-btn-stop { background: rgba(239,68,68,0.12); color: var(--danger); border: 1px solid rgba(239,68,68,0.25); }
.s-btn-stop:hover { background: rgba(239,68,68,0.25); }
.s-btn-edit { background: rgba(59,130,246,0.1); color: var(--primary); border: 1px solid rgba(59,130,246,0.2); }
.s-btn-edit:hover { background: rgba(59,130,246,0.2); }

/* Running card: hide start/edit, show lock overlay on those */
.s-card.running .s-btn-start,
.s-card.running .s-btn-edit { display: none; }

.running-lock {
  display: none;
  align-items: center;
  gap: 4px;
  font-size: 9px;
  color: var(--success);
  opacity: 0.6;
  font-family: var(--font-mono);
  padding: 2px 6px;
}

.s-card.running .running-lock { display: flex; }

.empty-control {
  text-align: center;
  padding: 48px 20px;
  color: var(--muted);
  grid-column: 1/-1;
}

.empty-control .empty-ico { font-size: 40px; margin-bottom: 12px; }
.empty-control p { font-size: 12px; }


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL OVERLAY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#modalOverlay {
  position: fixed;
  inset: 0;
  z-index: 9999;
  background: rgba(0,0,0,0.75);
  backdrop-filter: blur(6px);
  display: flex;
  align-items: flex-start;
  justify-content: center;
  padding: 20px;
  overflow-y: auto;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.25s;
}

#modalOverlay.open {
  opacity: 1;
  pointer-events: all;
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ BUILDER MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.builder-modal {
  width: 100%;
  max-width: 1100px;
  background: var(--panel);
  border: 1px solid var(--border-2);
  border-radius: 16px;
  overflow: hidden;
  transform: translateY(-24px);
  transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1);
  box-shadow: 0 32px 80px rgba(0,0,0,0.6);
  margin: auto;
}

#modalOverlay.open .builder-modal { transform: translateY(0); }

/* Builder Header */
.builder-modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 24px;
  background: linear-gradient(90deg, var(--panel-3) 0%, var(--panel-2) 100%);
  border-bottom: 1px solid var(--border);
}

.builder-modal-title {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  font-size: 18px;
  font-weight: 800;
  background: linear-gradient(135deg, #e8edf5 0%, var(--primary) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.builder-modal-sub { font-size: 11px; color: var(--muted); margin-top: 3px; }

.modal-close {
  width: 32px; height: 32px;
  display: flex; align-items: center; justify-content: center;
  background: rgba(255,255,255,0.05);
  border: 1px solid var(--border);
  border-radius: 8px;
  cursor: pointer;
  color: var(--muted);
  font-size: 18px;
  font-weight: 300;
  transition: all 0.15s;
  flex-shrink: 0;
}

.modal-close:hover { background: rgba(239,68,68,0.15); color: var(--danger); border-color: var(--danger); }

/* Builder Section Tabs */
.builder-nav {
  display: flex;
  gap: 0;
  border-bottom: 1px solid var(--border);
  background: var(--panel-2);
  overflow-x: auto;
}

.bnav-tab {
  padding: 11px 18px;
  font-size: 12px;
  font-weight: 600;
  color: var(--muted);
  border: none;
  background: transparent;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.15s;
  white-space: nowrap;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  letter-spacing: 0.2px;
  position: relative;
}

.bnav-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
.bnav-tab:hover:not(.active) { color: var(--text); }

.bnav-tab .tab-badge {
  position: absolute;
  top: 6px; right: 6px;
  background: var(--primary);
  color: #fff;
  border-radius: 10px;
  font-size: 8px;
  font-weight: 700;
  padding: 0 5px;
  min-width: 14px;
  text-align: center;
  line-height: 14px;
  height: 14px;
}

/* Builder Body */
.builder-body {
  padding: 20px 24px;
  max-height: calc(100vh - 240px);
  overflow-y: auto;
}

.builder-body::-webkit-scrollbar { width: 6px; }
.builder-body::-webkit-scrollbar-track { background: var(--panel); }
.builder-body::-webkit-scrollbar-thumb { background: var(--border-2); border-radius: 3px; }

.bsec { display: none; }
.bsec.active { display: block; }

/* Form Styles */
.form-row {
  display: grid;
  gap: 12px;
  margin-bottom: 16px;
}

.form-row.cols-2 { grid-template-columns: 1fr 1fr; }
.form-row.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
.form-row.cols-4 { grid-template-columns: repeat(4, 1fr); }
.form-row.cols-6 { grid-template-columns: repeat(6, 1fr); }

.f-group { display: flex; flex-direction: column; gap: 5px; }
.f-label {
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--muted);
}

.f-input, .f-select, .f-textarea {
  padding: 8px 12px;
  background: rgba(255, 255, 255, 0.04);
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 8px;
  color: var(--text);
  font-size: 12px;
  font-family: inherit;
  transition: all 0.2s;
  width: 100%;
}

.f-input:focus, .f-select:focus, .f-textarea:focus {
  outline: none;
  border-color: var(--primary);
  background: rgba(255, 255, 255, 0.06);
  box-shadow: 0 0 0 2px rgba(102, 228, 255, 0.12);
}

.f-select option { background: var(--panel-3); }

.f-textarea { resize: vertical; min-height: 60px; font-family: var(--font-mono); font-size: 11px; }

.sec-divider {
  font-size: 10px;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--primary);
  margin: 20px 0 12px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
}

.sec-divider::after {
  content: '';
  flex: 1;
  height: 1px;
  background: linear-gradient(90deg, var(--border-2) 0%, transparent 100%);
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ LEG BUILDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.legs-container { display: flex; flex-direction: column; gap: 10px; }

.leg-card {
  background: var(--panel-2);
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
  transition: border-color 0.2s;
}

.leg-card:hover { border-color: var(--border-2); }

.leg-card.leg-buy { border-left: 3px solid var(--success); }
.leg-card.leg-sell { border-left: 3px solid var(--danger); }

.leg-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 14px;
  background: rgba(0,0,0,0.2);
  cursor: pointer;
  gap: 10px;
}

.leg-title {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  font-size: 12px;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 8px;
}

.leg-body { padding: 12px 14px; }

.leg-basic-row {
  display: grid;
  grid-template-columns: 70px 70px 90px 100px 80px 80px 1fr;
  gap: 8px;
  margin-bottom: 10px;
  align-items: end;
}

.leg-remove {
  width: 28px; height: 28px;
  display: flex; align-items: center; justify-content: center;
  background: rgba(239,68,68,0.1);
  border: 1px solid rgba(239,68,68,0.2);
  border-radius: 6px;
  cursor: pointer;
  color: var(--danger);
  font-size: 14px;
  transition: all 0.15s;
  flex-shrink: 0;
}

.leg-remove:hover { background: rgba(239,68,68,0.25); }

/* Condition Rows */
.conditions-section { margin-top: 12px; }

.conditions-label {
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--accent);
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.conditions-list { display: flex; flex-direction: column; gap: 6px; }

.condition-row {
  display: grid;
  grid-template-columns: 160px 120px 90px 120px 28px;
  gap: 6px;
  align-items: center;
  background: rgba(0,0,0,0.15);
  padding: 8px 10px;
  border-radius: 6px;
  border: 1px solid rgba(255,255,255,0.03);
}

.cond-join {
  font-size: 9px;
  font-weight: 700;
  color: var(--warning);
  text-align: center;
  font-family: var(--font-mono);
}

.cond-remove {
  width: 24px; height: 24px;
  display: flex; align-items: center; justify-content: center;
  background: rgba(239,68,68,0.08);
  border: 1px solid rgba(239,68,68,0.15);
  border-radius: 4px;
  cursor: pointer;
  color: var(--danger);
  font-size: 13px;
  transition: all 0.15s;
}

.cond-remove:hover { background: rgba(239,68,68,0.2); }

.add-cond-btn {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 5px 10px;
  background: rgba(139,92,246,0.08);
  border: 1px dashed rgba(139,92,246,0.3);
  border-radius: 6px;
  color: var(--accent);
  font-size: 10px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s;
  width: fit-content;
  margin-top: 6px;
}

.add-cond-btn:hover { background: rgba(139,92,246,0.15); border-style: solid; }

.add-leg-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 16px;
  background: rgba(16,185,129,0.06);
  border: 1px dashed rgba(16,185,129,0.3);
  border-radius: 8px;
  color: var(--success);
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
}

.add-leg-btn:hover { background: rgba(16,185,129,0.12); border-style: solid; }

/* Combined Conditions */
.combined-section {
  background: rgba(139,92,246,0.04);
  border: 1px solid rgba(139,92,246,0.15);
  border-radius: 8px;
  padding: 12px 14px;
  margin-top: 12px;
}

.combined-title {
  font-size: 11px;
  font-weight: 700;
  color: var(--accent);
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.combined-cond-row {
  display: grid;
  grid-template-columns: 130px 120px 90px 120px 120px 28px;
  gap: 6px;
  align-items: center;
  background: rgba(0,0,0,0.2);
  padding: 8px 10px;
  border-radius: 6px;
  margin-bottom: 6px;
  border: 1px solid rgba(139,92,246,0.1);
}

/* Adjustment ref section */
.adj-ref-note {
  background: rgba(6,182,212,0.06);
  border: 1px solid rgba(6,182,212,0.2);
  border-radius: 6px;
  padding: 10px 12px;
  font-size: 11px;
  color: var(--cyan);
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

/* Risk Section */
.risk-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
}

.risk-card {
  background: var(--panel-2);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 14px;
}

.risk-card-title {
  font-size: 11px;
  font-weight: 700;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 12px;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
}

/* Builder Footer */
.builder-footer {
  padding: 14px 24px;
  border-top: 1px solid var(--border);
  background: var(--panel-2);
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
}

.footer-actions { display: flex; gap: 8px; }

.btn-cancel {
  padding: 9px 20px;
  background: transparent;
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 999px;
  color: var(--muted);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
}

.btn-cancel:hover { 
  background: rgba(255, 255, 255, 0.05); 
  color: var(--text);
  border-color: rgba(255, 255, 255, 0.4);
}

.btn-save {
  padding: 9px 24px;
  background: linear-gradient(120deg, var(--success), #3edc71);
  border: none;
  border-radius: 999px;
  color: #000;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  box-shadow: 0 8px 16px rgba(74, 222, 128, 0.3);
}

.btn-save:hover { 
  transform: translateY(-1px); 
  box-shadow: 0 12px 24px rgba(74, 222, 128, 0.4); 
}
.btn-save:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

.save-status {
  font-size: 11px;
  font-family: var(--font-mono);
}

/* Alert */
.builder-alert {
  padding: 10px 14px;
  border-radius: 6px;
  font-size: 11px;
  font-family: var(--font-mono);
  margin-bottom: 14px;
  display: none;
}

.builder-alert.show { display: flex; align-items: center; gap: 8px; }
.builder-alert.success { background: rgba(16,185,129,0.1); border: 1px solid var(--success); color: var(--success); }
.builder-alert.error { background: rgba(239,68,68,0.1); border: 1px solid var(--danger); color: var(--danger); }

/* Scrollbar */
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border-2); border-radius: 3px; }

/* Responsive */
@media (max-width: 900px) {
  .leg-basic-row { grid-template-columns: repeat(3, 1fr); }
  .condition-row { grid-template-columns: 1fr 1fr; }
  .combined-cond-row { grid-template-columns: 1fr 1fr; }
  .risk-grid { grid-template-columns: 1fr 1fr; }
  .form-row.cols-6 { grid-template-columns: repeat(3, 1fr); }
}

@media (max-width: 600px) {
  .builder-modal { border-radius: 12px; }
  .risk-grid { grid-template-columns: 1fr; }
  .form-row.cols-4, .form-row.cols-3, .form-row.cols-2 { grid-template-columns: 1fr 1fr; }
}

/* ‚îÄ‚îÄ tiny toggle checkbox ‚îÄ‚îÄ */
.tog-wrap { display: flex; align-items: center; gap: 8px; }
.tog { display:none; }
.tog-lbl {
  width: 34px; height: 18px;
  background: var(--border-2);
  border-radius: 9px;
  cursor: pointer;
  position: relative;
  transition: background 0.2s;
}
.tog-lbl::after {
  content:'';
  width: 12px; height: 12px;
  background: #fff;
  border-radius: 50%;
  position: absolute;
  top: 3px; left: 3px;
  transition: transform 0.2s;
}
.tog:checked + .tog-lbl { background: var(--primary); }
.tog:checked + .tog-lbl::after { transform: translateX(16px); }
.tog-text { font-size: 11px; color: var(--muted); }

</style>
</head>
<body data-page="strategy">
<div id="app-header"></div>

<main>
  <!-- TOP BAR -->
  <div class="top-bar">
    <div>
      <h1>‚ö° Strategy Management</h1>
      <p>Build, monitor and control advanced options strategies in real-time</p>
    </div>
    <button class="btn-create" onclick="openBuilder()">
      <span class="plus-icon">+</span>
      Create Strategy
    </button>
  </div>

  <div class="main-grid">

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ADVANCED MONITOR WIDGET ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="monitor-widget">
      <div class="widget-header">
        <div class="widget-title">
          <div class="live-dot"></div>
          Live Position Monitor
        </div>
        <div class="monitor-tabs">
          <button class="mtab active" onclick="switchMTab('all',this)">All Positions</button>
          <button class="mtab" onclick="switchMTab('greeks',this)">Greeks View</button>
          <button class="mtab" onclick="switchMTab('pnl',this)">P&L View</button>
        </div>
      </div>

      <div class="monitor-body">
        <!-- Orphan Legs -->
        <div class="orphan-section">
          <div class="section-label">‚ö† Orphan Legs (Unassigned Positions)</div>
          <div class="monitor-table-wrap" style="overflow-x:auto;">
          <table class="orphan-table">
            <thead>
              <tr>
                <th>Instrument</th>
                <th>B/S</th>
                <th>Qty</th>
                <th>Avg</th>
                <th>LTP</th>
                <th>P&L</th>
                <th>IV</th>
                <th>Delta</th>
                <th>Gamma</th>
                <th>Theta</th>
                <th>Vega</th>
                <th>OI</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="orphanBody">
              <tr>
                <td colspan="13" style="text-align:center; color:var(--muted); padding:16px; font-size:11px;">
                  No orphan positions detected
                </td>
              </tr>
            </tbody>
          </table>
          </div>
        </div>

        <!-- Strategy Positions -->
        <div class="strategy-section">
          <div class="section-label">üìä Strategy Positions</div>
          <div style="overflow-x:auto;">
          <table class="monitor-table">
            <thead>
              <tr>
                <th>Strategy / Leg</th>
                <th>B/S</th>
                <th>Qty</th>
                <th>Avg</th>
                <th>LTP</th>
                <th>P&L</th>
                <th>IV</th>
                <th>Delta</th>
                <th>Gamma</th>
                <th>Theta</th>
                <th>Vega</th>
                <th>Net Œî</th>
                <th>OI</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="monitorBody">
              <tr>
                <td colspan="14" style="text-align:center; color:var(--muted); padding:20px; font-size:11px;">
                  No active strategy positions ‚Äî start a strategy to see live data here
                </td>
              </tr>
            </tbody>
          </table>
          </div>
        </div>
      </div>
    </div><!-- /monitor-widget -->

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STRATEGY CONTROL WIDGET ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="control-widget">
      <div class="control-header-bar">
        <div class="widget-title">üéõÔ∏è Strategy Control</div>
        <div class="control-stats">
          <div class="c-stat">
            <div class="c-stat-val" id="statRunning" style="color:var(--success)">0</div>
            <div class="c-stat-lbl">Running</div>
          </div>
          <div class="c-stat">
            <div class="c-stat-val" id="statPaused" style="color:var(--warning)">0</div>
            <div class="c-stat-lbl">Paused</div>
          </div>
          <div class="c-stat">
            <div class="c-stat-val" id="statIdle" style="color:var(--muted)">0</div>
            <div class="c-stat-lbl">Idle</div>
          </div>
          <div class="c-stat">
            <div class="c-stat-val" id="statTotal">0</div>
            <div class="c-stat-lbl">Total</div>
          </div>
        </div>
      </div>
      <div class="strategy-cards" id="strategyCards">
        <div class="empty-control">
          <div class="empty-ico">üì≠</div>
          <p>No strategies saved yet.<br>Click <strong>+ Create Strategy</strong> to build one.</p>
        </div>
      </div>
    </div><!-- /control-widget -->

  </div><!-- /main-grid -->
</main>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     STRATEGY CONSTRUCTOR MODAL
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="modalOverlay" onclick="handleOverlayClick(event)">
  <div class="builder-modal" id="builderModal">

    <div class="builder-modal-header">
      <div>
        <div class="builder-modal-title">‚öô Create / Edit Strategy</div>
        <div class="builder-modal-sub" id="modalSubtitle">Fast & easy strategy configuration</div>
      </div>
      <button class="modal-close" onclick="closeBuilder()">‚úï</button>
    </div>

    <div class="builder-nav">
      <button class="bnav-tab active" data-sec="identity" onclick="switchBSec('identity',this)">‚ö° Quick Config</button>
      <button class="bnav-tab" data-sec="entry" onclick="switchBSec('entry',this)">üìã Entry</button>
      <button class="bnav-tab" data-sec="adjustment" onclick="switchBSec('adjustment',this)">‚Ü© Adjustment</button>
      <button class="bnav-tab" data-sec="exit" onclick="switchBSec('exit',this)">üö™ Exit</button>
      <button class="bnav-tab" data-sec="risk" onclick="switchBSec('risk',this)">‚ö† Risk Mgmt</button>
      <button class="bnav-tab" data-sec="schedule" onclick="switchBSec('schedule',this)">üìÖ Schedule</button>
    </div>

    <div class="builder-body">
      <div id="alertBox" class="builder-alert"></div>

      <!-- ‚îÄ‚îÄ‚îÄ SECTION 1: IDENTITY ‚îÄ‚îÄ‚îÄ -->
      <div class="bsec active" id="sec-identity">
        <div class="sec-divider">Strategy Identity</div>
        <div class="form-row cols-3">
          <div class="f-group">
            <label class="f-label">Strategy Name *</label>
            <input class="f-input" id="sName" placeholder="e.g. NIFTY Weekly Straddle" required>
          </div>
          <div class="f-group">
            <label class="f-label">Strategy ID *</label>
            <input class="f-input" id="sId" placeholder="Auto-generated from name" readonly style="opacity:0.7; cursor:not-allowed;">
          </div>
          <div class="f-group">
            <label class="f-label">Strategy Type</label>
            <select class="f-select" id="sType">
              <option value="custom">Custom</option>
              <option value="straddle">Straddle</option>
              <option value="strangle">Strangle</option>
              <option value="iron_condor">Iron Condor</option>
              <option value="butterfly">Butterfly</option>
              <option value="calendar">Calendar Spread</option>
              <option value="ratio">Ratio Spread</option>
              <option value="dnss">DNSS (Delta Neutral)</option>
            </select>
          </div>
        </div>
        <div class="form-row cols-4">
          <div class="f-group">
            <label class="f-label">Underlying</label>
            <select class="f-select" id="sUnderlying">
              <option>NIFTY</option>
              <option>BANKNIFTY</option>
              <option>FINNIFTY</option>
              <option>MIDCPNIFTY</option>
              <option>SENSEX</option>
            </select>
          </div>
          <div class="f-group">
            <label class="f-label">Segment</label>
            <select class="f-select" id="sSegment">
              <option value="NFO">NFO (NSE F&O)</option>
              <option value="BFO">BFO (BSE F&O)</option>
              <option value="MCX">MCX</option>
            </select>
          </div>
          <div class="f-group">
            <label class="f-label">Product Type</label>
            <select class="f-select" id="sProduct">
              <option value="MIS">MIS (Intraday)</option>
              <option value="NRML">NRML (Overnight)</option>
            </select>
          </div>
          <div class="f-group">
            <label class="f-label">Order Type</label>
            <select class="f-select" id="sOrderType">
              <option value="MKT">Market</option>
              <option value="LMT">Limit</option>
              <option value="SL">Stop Loss</option>
              <option value="SLM">SL-Market</option>
            </select>
          </div>
        </div>
        <div class="form-row cols-3">
          <div class="f-group">
            <label class="f-label">Lots / Max Positions</label>
            <input class="f-input" id="sLots" type="number" value="1" min="1">
          </div>
          <div class="f-group">
            <label class="f-label">Re-entry Count</label>
            <input class="f-input" id="sReentry" type="number" value="0" min="0">
          </div>
          <div class="f-group">
            <label class="f-label">Description</label>
            <input class="f-input" id="sDesc" placeholder="Optional notes about this strategy">
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ‚îÄ SECTION 2: ENTRY ‚îÄ‚îÄ‚îÄ -->
      <div class="bsec" id="sec-entry">
        <div class="adj-ref-note">
          ‚Ñπ Entry legs define the initial positions. Each leg can have independent entry conditions using option chain parameters, time, or spot/futures data.
        </div>

        <div class="sec-divider">Entry Legs</div>
        <div class="legs-container" id="entryLegs"></div>
        <button class="add-leg-btn" onclick="addLeg('entry')" style="margin-top:10px;">
          Ôºã Add Entry Leg
        </button>

        <div class="sec-divider" style="margin-top:20px;">Combined Entry Conditions</div>
        <div class="combined-section">
          <div class="combined-title">‚ö° Trigger when combined leg metrics satisfy:</div>
          <div class="conditions-list" id="entryCombined"></div>
          <button class="add-cond-btn" onclick="addCombinedCond('entryCombined')">Ôºã Add Combined Condition</button>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ‚îÄ SECTION 3: ADJUSTMENT ‚îÄ‚îÄ‚îÄ -->
      <div class="bsec" id="sec-adjustment">
        <div class="adj-ref-note">
          ‚Ü© Adjustment rules use the same legs defined in Entry. You can override positions, shift strikes, or add/remove legs when conditions are met.
        </div>

        <div class="sec-divider">Adjustment Triggers & Actions</div>
        <div class="legs-container" id="adjLegs"></div>
        <button class="add-leg-btn" onclick="addAdjLeg()" style="margin-top:10px;">
          Ôºã Add Adjustment Rule
        </button>

        <div class="sec-divider" style="margin-top:20px;">Combined Adjustment Conditions</div>
        <div class="combined-section">
          <div class="combined-title">‚ö° Trigger adjustment when combined metrics satisfy:</div>
          <div class="conditions-list" id="adjCombined"></div>
          <button class="add-cond-btn" onclick="addCombinedCond('adjCombined')">Ôºã Add Combined Condition</button>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ‚îÄ SECTION 4: EXIT ‚îÄ‚îÄ‚îÄ -->
      <div class="bsec" id="sec-exit">
        <div class="adj-ref-note">
          üö™ Exit conditions determine when to close positions. Can be leg-specific or strategy-wide.
        </div>

        <div class="sec-divider">Exit Conditions per Leg</div>
        <div class="legs-container" id="exitLegs"></div>
        <button class="add-leg-btn" onclick="addExitLeg()" style="margin-top:10px;">
          Ôºã Add Exit Condition
        </button>

        <div class="sec-divider" style="margin-top:20px;">Combined Exit Conditions</div>
        <div class="combined-section">
          <div class="combined-title">‚ö° Exit strategy when combined metrics satisfy:</div>
          <div class="conditions-list" id="exitCombined"></div>
          <button class="add-cond-btn" onclick="addCombinedCond('exitCombined')">Ôºã Add Combined Condition</button>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ‚îÄ SECTION 5: RISK MANAGEMENT ‚îÄ‚îÄ‚îÄ -->
      <div class="bsec" id="sec-risk">
        <div class="sec-divider">P&L Limits</div>
        <div class="risk-grid">
          <div class="risk-card">
            <div class="risk-card-title">Target Profit</div>
            <div class="form-row cols-2" style="margin-bottom:8px;">
              <div class="f-group">
                <label class="f-label">Amount (‚Çπ)</label>
                <input class="f-input" id="rTargetAmt" type="number" placeholder="e.g. 5000">
              </div>
              <div class="f-group">
                <label class="f-label">% of Premium</label>
                <input class="f-input" id="rTargetPct" type="number" placeholder="e.g. 50">
              </div>
            </div>
            <div class="f-group">
              <label class="f-label">Action on Target</label>
              <select class="f-select" id="rTargetAction">
                <option value="exit_all">Exit All Legs</option>
                <option value="trail">Trail Profit</option>
                <option value="partial">Partial Exit (50%)</option>
                <option value="lock">Lock & Trail</option>
              </select>
            </div>
          </div>
          <div class="risk-card">
            <div class="risk-card-title">Stop Loss</div>
            <div class="form-row cols-2" style="margin-bottom:8px;">
              <div class="f-group">
                <label class="f-label">Amount (‚Çπ)</label>
                <input class="f-input" id="rSlAmt" type="number" placeholder="e.g. 3000">
              </div>
              <div class="f-group">
                <label class="f-label">% of Premium</label>
                <input class="f-input" id="rSlPct" type="number" placeholder="e.g. 100">
              </div>
            </div>
            <div class="f-group">
              <label class="f-label">Action on SL Hit</label>
              <select class="f-select" id="rSlAction">
                <option value="exit_all">Exit All Legs</option>
                <option value="adjust">Trigger Adjustment</option>
                <option value="partial">Partial Exit (50%)</option>
                <option value="leg_sl">Leg-level SL Only</option>
              </select>
            </div>
          </div>
          <div class="risk-card">
            <div class="risk-card-title">Trailing Stop Loss</div>
            <div class="form-row cols-2" style="margin-bottom:8px;">
              <div class="f-group">
                <label class="f-label">Trail Amount (‚Çπ)</label>
                <input class="f-input" id="rTrailAmt" type="number" placeholder="e.g. 1000">
              </div>
              <div class="f-group">
                <label class="f-label">Lock-in Profit (‚Çπ)</label>
                <input class="f-input" id="rLockIn" type="number" placeholder="e.g. 2000">
              </div>
            </div>
            <div class="f-group">
              <label class="f-label">Trail Step (‚Çπ)</label>
              <input class="f-input" id="rTrailStep" type="number" placeholder="e.g. 500">
            </div>
          </div>
        </div>

        <div class="sec-divider" style="margin-top:20px;">Delta / Greek Limits</div>
        <div class="risk-grid">
          <div class="risk-card">
            <div class="risk-card-title">Delta Limits</div>
            <div class="form-row cols-2">
              <div class="f-group">
                <label class="f-label">Max Net Delta</label>
                <input class="f-input" id="rMaxDelta" type="number" placeholder="e.g. 0.5" step="0.01">
              </div>
              <div class="f-group">
                <label class="f-label">Action on Breach</label>
                <select class="f-select" id="rDeltaAction">
                  <option value="hedge">Auto Hedge</option>
                  <option value="adjust">Adjustment</option>
                  <option value="alert">Alert Only</option>
                </select>
              </div>
            </div>
          </div>
          <div class="risk-card">
            <div class="risk-card-title">IV / Vega Limits</div>
            <div class="form-row cols-2">
              <div class="f-group">
                <label class="f-label">Max IV (entry block)</label>
                <input class="f-input" id="rMaxIv" type="number" placeholder="e.g. 25">
              </div>
              <div class="f-group">
                <label class="f-label">Min IV (entry block)</label>
                <input class="f-input" id="rMinIv" type="number" placeholder="e.g. 10">
              </div>
            </div>
          </div>
          <div class="risk-card">
            <div class="risk-card-title">Position Limits</div>
            <div class="form-row cols-2">
              <div class="f-group">
                <label class="f-label">Max Capital (‚Çπ)</label>
                <input class="f-input" id="rMaxCap" type="number" placeholder="e.g. 200000">
              </div>
              <div class="f-group">
                <label class="f-label">Max Legs</label>
                <input class="f-input" id="rMaxLegs" type="number" value="4" min="1">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ‚îÄ SECTION 6: SCHEDULE ‚îÄ‚îÄ‚îÄ -->
      <div class="bsec" id="sec-schedule">
        <div class="sec-divider">Trading Schedule</div>
        <div class="form-row cols-3">
          <div class="f-group">
            <label class="f-label">Frequency</label>
            <select class="f-select" id="schFreq">
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
              <option value="monthly">Monthly (Expiry Week)</option>
              <option value="manual">Manual Only</option>
            </select>
          </div>
          <div class="f-group">
            <label class="f-label">Entry Time</label>
            <input class="f-input" id="schEntry" type="time" value="09:20">
          </div>
          <div class="f-group">
            <label class="f-label">Exit Time (EOD)</label>
            <input class="f-input" id="schExit" type="time" value="15:15">
          </div>
        </div>
        <div class="form-row cols-3">
          <div class="f-group">
            <label class="f-label">Expiry Type</label>
            <select class="f-select" id="schExpiry">
              <option value="weekly">Current Weekly</option>
              <option value="next_weekly">Next Weekly</option>
              <option value="monthly">Monthly</option>
              <option value="next_monthly">Next Monthly</option>
            </select>
          </div>
          <div class="f-group">
            <label class="f-label">Days to Expiry (min)</label>
            <input class="f-input" id="schDteMin" type="number" placeholder="e.g. 1">
          </div>
          <div class="f-group">
            <label class="f-label">Days to Expiry (max)</label>
            <input class="f-input" id="schDteMax" type="number" placeholder="e.g. 7">
          </div>
        </div>
        <div class="form-row cols-3">
          <div class="f-group">
            <label class="f-label">Square Off Before (mins)</label>
            <input class="f-input" id="schSqoffMins" type="number" placeholder="e.g. 30">
          </div>
          <div class="f-group">
            <label class="f-label">Entry on Expiry Day</label>
            <select class="f-select" id="schEntryExpiry">
              <option value="yes">Yes</option>
              <option value="no">No</option>
            </select>
          </div>
          <div class="f-group">
            <label class="f-label">Active Days</label>
            <select class="f-select" id="schDays" multiple style="height:70px;">
              <option value="0" selected>Monday</option>
              <option value="1" selected>Tuesday</option>
              <option value="2" selected>Wednesday</option>
              <option value="3" selected>Thursday</option>
              <option value="4" selected>Friday</option>
            </select>
          </div>
        </div>
      </div>
    </div><!-- /builder-body -->

    <div class="builder-footer">
      <div class="save-status" id="saveStatus" style="color:var(--muted);">
        <!-- Status messages here -->
      </div>
      <div class="footer-actions">
        <button class="btn-cancel" onclick="closeBuilder()">Cancel</button>
        <button class="btn-save" id="btnSave" onclick="saveStrategy()">
          üíæ Save Strategy
        </button>
      </div>
    </div>
  </div><!-- /builder-modal -->
</div><!-- /modalOverlay -->
          üíæ Save Strategy
        </button>
      </div>
    </div>
  </div><!-- /builder-modal -->
</div><!-- /modalOverlay -->


<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CONSTANTS & HELPERS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

// All option chain columns available for conditions
const OC_PARAMS = [
  // Price / Premium
  { v:'ltp',        l:'LTP (Last Price)',      cat:'Price' },
  { v:'bid',        l:'Bid Price',             cat:'Price' },
  { v:'ask',        l:'Ask Price',             cat:'Price' },
  { v:'mid',        l:'Mid Price',             cat:'Price' },
  { v:'close',      l:'Close Price',           cat:'Price' },
  { v:'open',       l:'Open Price',            cat:'Price' },
  { v:'high',       l:'High Price',            cat:'Price' },
  { v:'low',        l:'Low Price',             cat:'Price' },
  { v:'spread',     l:'Bid-Ask Spread',        cat:'Price' },
  // Spot / Futures
  { v:'spot',       l:'Spot Price',            cat:'Market' },
  { v:'futures',    l:'Futures Price',         cat:'Market' },
  { v:'basis',      l:'Futures Basis',         cat:'Market' },
  { v:'atm_strike', l:'ATM Strike',            cat:'Market' },
  { v:'strike_diff',l:'Strike from ATM',       cat:'Market' },
  // Greeks
  { v:'delta',      l:'Delta',                 cat:'Greeks' },
  { v:'gamma',      l:'Gamma',                 cat:'Greeks' },
  { v:'theta',      l:'Theta',                 cat:'Greeks' },
  { v:'vega',       l:'Vega',                  cat:'Greeks' },
  { v:'rho',        l:'Rho',                   cat:'Greeks' },
  { v:'charm',      l:'Charm (dDelta/dt)',      cat:'Greeks' },
  { v:'vanna',      l:'Vanna',                 cat:'Greeks' },
  { v:'volga',      l:'Volga',                 cat:'Greeks' },
  // Volatility
  { v:'iv',         l:'Implied Volatility',    cat:'Volatility' },
  { v:'hv',         l:'Historical Volatility', cat:'Volatility' },
  { v:'iv_rank',    l:'IV Rank',               cat:'Volatility' },
  { v:'iv_percentile',l:'IV Percentile',       cat:'Volatility' },
  { v:'vix',        l:'India VIX',             cat:'Volatility' },
  { v:'pcr_iv',     l:'PCR (IV-weighted)',      cat:'Volatility' },
  // OI / Volume
  { v:'oi',         l:'Open Interest',         cat:'OI / Volume' },
  { v:'oi_change',  l:'OI Change',             cat:'OI / Volume' },
  { v:'oi_change_pct',l:'OI Change %',         cat:'OI / Volume' },
  { v:'volume',     l:'Volume',                cat:'OI / Volume' },
  { v:'pcr_oi',     l:'PCR (OI-based)',         cat:'OI / Volume' },
  { v:'pcr_volume', l:'PCR (Volume)',           cat:'OI / Volume' },
  { v:'coi',        l:'Change in OI (Œî)',       cat:'OI / Volume' },
  // Time
  { v:'dte',        l:'Days to Expiry',        cat:'Time' },
  { v:'time_elapsed',l:'Time Elapsed (mins)',   cat:'Time' },
  { v:'time_remaining',l:'Time Remaining (mins)',cat:'Time' },
  { v:'current_time',l:'Current Time',         cat:'Time' },
  // P&L
  { v:'unrealized_pnl',l:'Unrealized P&L',     cat:'P&L' },
  { v:'realized_pnl',l:'Realized P&L',          cat:'P&L' },
  { v:'total_pnl',  l:'Total P&L',             cat:'P&L' },
  { v:'pnl_pct',    l:'P&L %',                 cat:'P&L' },
];

// Combined params (use same list but prefix with "combined.")
const COMBINED_PARAMS = [
  { v:'combined_delta',  l:'Combined Net Delta' },
  { v:'combined_gamma',  l:'Combined Net Gamma' },
  { v:'combined_theta',  l:'Combined Net Theta' },
  { v:'combined_vega',   l:'Combined Net Vega' },
  { v:'combined_pnl',    l:'Combined P&L' },
  { v:'combined_premium',l:'Combined Premium' },
  { v:'combined_oi',     l:'Combined OI' },
  { v:'combined_iv_avg', l:'Avg IV (all legs)' },
  { v:'leg_ratio',       l:'Leg Price Ratio (L1/L2)' },
  { v:'spread_width',    l:'Spread Width' },
  { v:'net_credit',      l:'Net Credit Received' },
  { v:'net_debit',       l:'Net Debit Paid' },
];

const OPERATORS = ['>', '>=', '<', '<=', '==', '!=', 'crosses_above', 'crosses_below', 'between', 'outside'];
const JOIN_OPS   = ['AND', 'OR'];

const LEG_ACTIONS_ADJ = ['shift_strike_up', 'shift_strike_down', 'add_lot', 'reduce_lot', 'close', 'reverse', 'convert_to_spread', 'roll_expiry'];

let state = {
  editing: null, // null = new, else strategy id
  entryLegs: [],
  adjRules: [],
  exitRules: [],
};

let strategies = [];

/* Build <select> for OC params grouped by category */
function buildParamSelect(val = '') {
  let cats = {};
  OC_PARAMS.forEach(p => { if(!cats[p.cat]) cats[p.cat]=[]; cats[p.cat].push(p); });
  let html = `<select class="f-select" style="font-size:11px; padding:6px 8px;">`;
  html += `<option value="">-- Parameter --</option>`;
  for(let cat in cats) {
    html += `<optgroup label="${cat}">`;
    cats[cat].forEach(p => html += `<option value="${p.v}" ${p.v===val?'selected':''}>${p.l}</option>`);
    html += `</optgroup>`;
  }
  html += `</select>`;
  return html;
}

function buildOpSelect(val = '>') {
  return `<select class="f-select" style="font-size:11px; padding:6px 8px; max-width:120px;">
    ${OPERATORS.map(o => `<option value="${o}" ${o===val?'selected':''}>${o}</option>`).join('')}
  </select>`;
}

function buildJoinSelect(val = 'AND') {
  return `<select class="f-select" style="font-size:11px; padding:6px 8px; max-width:70px;">
    ${JOIN_OPS.map(j => `<option value="${j}" ${j===val?'selected':''}>${j}</option>`).join('')}
  </select>`;
}

function buildCombinedParamSelect(val = '') {
  let html = `<select class="f-select" style="font-size:11px; padding:6px 8px;">`;
  html += `<option value="">-- Combined Metric --</option>`;
  COMBINED_PARAMS.forEach(p => html += `<option value="${p.v}" ${p.v===val?'selected':''}>${p.l}</option>`);
  html += `</select>`;
  return html;
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   ADD / REMOVE CONDITION ROW
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function addConditionRow(listId) {
  const list = document.getElementById(listId);
  if(!list) return;
  const rows = list.querySelectorAll('.condition-row').length;
  const joinHtml = rows > 0 ? `<div class="cond-join">AND</div>` : '';

  const row = document.createElement('div');
  row.innerHTML = joinHtml + `<div class="condition-row">
    ${buildParamSelect()}
    ${buildOpSelect()}
    <input class="f-input" placeholder="Value" style="font-size:11px; padding:6px 8px;">
    ${buildParamSelect()}
    <button class="cond-remove" onclick="this.closest('.condition-row').previousElementSibling?.classList.contains('cond-join')&&this.closest('.condition-row').previousElementSibling.remove(); this.closest('.condition-row').remove();">‚úï</button>
  </div>`;
  list.appendChild(row);
  updateBadge(listId);
}

window.addCondition = addConditionRow; // alias

function addCombinedCond(listId) {
  const list = document.getElementById(listId);
  if(!list) return;
  const rows = list.querySelectorAll('.combined-cond-row').length;
  const joinHtml = rows > 0 ? `<div class="cond-join">AND</div>` : '';
  const wrap = document.createElement('div');
  wrap.innerHTML = joinHtml + `<div class="combined-cond-row">
    ${buildCombinedParamSelect()}
    ${buildOpSelect()}
    <input class="f-input" placeholder="Value" style="font-size:11px; padding:6px 8px;">
    ${buildJoinSelect()}
    <input class="f-input" placeholder="Compare to" style="font-size:11px; padding:6px 8px;">
    <button class="cond-remove" onclick="this.closest('.combined-cond-row').previousElementSibling?.classList.contains('cond-join')&&this.closest('.combined-cond-row').previousElementSibling.remove();this.closest('.combined-cond-row').remove();">‚úï</button>
  </div>`;
  list.appendChild(wrap);
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   LEG BUILDER
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
let legCounter = 0;

function buildLegCard(id, section, legLabel) {
  const isAdj = section === 'adj';
  const isExit = section === 'exit';
  const condListId = `cond_${section}_${id}`;
  const legParamListId = `legparam_${section}_${id}`;

  return `
  <div class="leg-card" id="legcard_${section}_${id}">
    <div class="leg-header" onclick="toggleLeg('${section}_${id}')">
      <div class="leg-title">
        <span class="expand-icon" id="expIcon_${section}_${id}">‚ñ∂</span>
        <span id="legTitleLabel_${section}_${id}">${legLabel || 'Leg ' + id}</span>
        <span class="badge-buy" id="legBadge_${section}_${id}">BUY</span>
      </div>
      <button class="leg-remove" onclick="event.stopPropagation();removeLeg('${section}','${id}')">‚úï</button>
    </div>
    <div class="leg-body" id="legbody_${section}_${id}" style="display:none;">

      ${isAdj ? `
      <div class="f-group" style="margin-bottom:10px;">
        <label class="f-label">Adjustment Action</label>
        <select class="f-select" onchange="updateLegTitle('${section}','${id}',this.value)">
          ${LEG_ACTIONS_ADJ.map(a=>`<option value="${a}">${a.replace(/_/g,' ')}</option>`).join('')}
        </select>
      </div>
      ` : ''}

      ${isExit ? `
      <div class="form-row cols-2" style="margin-bottom:12px;">
        <div class="f-group">
          <label class="f-label">Exit Leg Reference</label>
          <select class="f-select" id="exitRef_${id}">
            <option value="all">All Legs</option>
            <option value="leg1">Leg 1</option>
            <option value="leg2">Leg 2</option>
            <option value="leg3">Leg 3</option>
            <option value="profitable">Profitable Legs</option>
            <option value="loss">Loss-making Legs</option>
            <option value="specific_ce">Specific CE Leg</option>
            <option value="specific_pe">Specific PE Leg</option>
          </select>
        </div>
        <div class="f-group">
          <label class="f-label">Exit Order Type</label>
          <select class="f-select">
            <option>Market</option><option>Limit</option><option>SL-Market</option>
          </select>
        </div>
      </div>
      ` : ''}

      ${!isAdj && !isExit ? `
      <!-- Basic Leg Definition -->
      <div class="leg-basic-row">
        <div class="f-group">
          <label class="f-label">B/S</label>
          <select class="f-select" onchange="updateLegBadge('${section}','${id}',this.value)">
            <option value="BUY">BUY</option><option value="SELL">SELL</option>
          </select>
        </div>
        <div class="f-group">
          <label class="f-label">CE/PE</label>
          <select class="f-select">
            <option>CE</option><option>PE</option>
          </select>
        </div>
        <div class="f-group">
          <label class="f-label">Strike Sel.</label>
          <select class="f-select">
            <option value="atm">ATM</option>
            <option value="atm+1">ATM+1</option><option value="atm-1">ATM-1</option>
            <option value="atm+2">ATM+2</option><option value="atm-2">ATM-2</option>
            <option value="delta">By Delta</option>
            <option value="strike">By Strike</option>
            <option value="premium">By Premium</option>
            <option value="otm_pct">OTM %</option>
          </select>
        </div>
        <div class="f-group">
          <label class="f-label">Strike/Value</label>
          <input class="f-input" placeholder="e.g. 0.3 / 200" style="font-size:11px;">
        </div>
        <div class="f-group">
          <label class="f-label">Lots</label>
          <input class="f-input" type="number" value="1" min="1" style="font-size:11px;">
        </div>
        <div class="f-group">
          <label class="f-label">Expiry</label>
          <select class="f-select" style="font-size:11px;">
            <option value="current">Current</option>
            <option value="next">Next</option>
            <option value="monthly">Monthly</option>
          </select>
        </div>
      </div>
      ` : ''}

      <!-- Leg-level Conditions -->
      <div class="conditions-section">
        <div class="conditions-label">üìã Entry Conditions for this Leg</div>
        <div class="conditions-list" id="${condListId}"></div>
        <button class="add-cond-btn" onclick="addConditionRow('${condListId}')">Ôºã Add Condition</button>
      </div>

      <!-- Leg-parameter Conditions -->
      <div class="conditions-section" style="margin-top:14px;">
        <div class="conditions-label" style="color:var(--warning);">‚öô Leg Parameter Triggers (live monitoring)</div>
        <div class="f-group" style="margin-bottom:8px;">
          <label class="f-label">When this leg's parameter...</label>
        </div>
        <div class="conditions-list" id="${legParamListId}"></div>
        <div style="display:grid;grid-template-columns:160px 100px 100px 120px 100px 28px;gap:6px;align-items:center;background:rgba(0,0,0,0.15);padding:8px 10px;border-radius:6px;border:1px dashed rgba(245,158,11,0.2);margin-top:6px;">
          ${buildParamSelect()}
          ${buildOpSelect()}
          <input class="f-input" placeholder="Trigger Val" style="font-size:11px;padding:6px 8px;">
          <select class="f-select" style="font-size:11px;padding:6px 8px;">
            <option value="">Then...</option>
            <option value="close_leg">Close this Leg</option>
            <option value="alert">Alert Only</option>
            <option value="book_partial">Book 50%</option>
            <option value="add_hedge">Add Hedge</option>
            <option value="trigger_adj">Trigger Adjustment</option>
          </select>
          <div class="tog-wrap"><input type="checkbox" class="tog" id="togLpActive_${id}"><label class="tog-lbl" for="togLpActive_${id}"></label><span class="tog-text">Active</span></div>
        </div>
      </div>
    </div>
  </div>`;
}

let legIds = { entry: 0, adj: 0, exit: 0 };

function addLeg(section) {
  legIds[section]++;
  const id = legIds[section];
  const container = document.getElementById(section === 'entry' ? 'entryLegs' : section === 'adj' ? 'adjLegs' : 'exitLegs');
  const div = document.createElement('div');
  div.innerHTML = buildLegCard(id, section, `Leg ${id}`);
  container.appendChild(div.firstElementChild || div);
  // auto-open
  toggleLeg(`${section}_${id}`);
  updateBadge(section);
}

function addAdjLeg() { addLeg('adj'); }
function addExitLeg() { addLeg('exit'); }

function removeLeg(section, id) {
  const card = document.getElementById(`legcard_${section}_${id}`);
  if(card) card.remove();
  updateBadge(section);
}

function toggleLeg(key) {
  const body = document.getElementById(`legbody_${key}`);
  const icon = document.getElementById(`expIcon_${key}`);
  if(!body) return;
  const shown = body.style.display !== 'none';
  body.style.display = shown ? 'none' : 'block';
  if(icon) icon.style.transform = shown ? '' : 'rotate(90deg)';
}

function updateLegBadge(section, id, val) {
  const badge = document.getElementById(`legBadge_${section}_${id}`);
  if(!badge) return;
  badge.textContent = val;
  badge.className = val === 'BUY' ? 'badge-buy' : 'badge-sell';
  const card = document.getElementById(`legcard_${section}_${id}`);
  if(card) card.className = `leg-card leg-${val.toLowerCase()}`;
}

function updateLegTitle(section, id, val) {
  const lbl = document.getElementById(`legTitleLabel_${section}_${id}`);
  if(lbl) lbl.textContent = val.replace(/_/g,' ');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PARAMETER BUILDER FUNCTIONS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

// Available columns from option chain .sqlite files
const SQLITE_COLUMNS = {
  price: ['ltp', 'bid', 'ask', 'mid', 'close', 'open', 'high', 'low', 'spread'],
  market: ['spot', 'futures', 'basis', 'atm_strike', 'strike_diff'],
  greeks: ['delta', 'gamma', 'theta', 'vega', 'rho', 'charm', 'vanna', 'volga'],
  volatility: ['iv', 'hv', 'iv_rank', 'iv_percentile', 'vix', 'pcr_iv'],
  volume: ['oi', 'oi_change', 'oi_change_pct', 'volume', 'pcr_oi', 'pcr_volume'],
  time: ['entry_time', 'exit_time', 'market_open', 'expiry_time', 'day_of_week']
};

const COMPARISON_OPS = ['==', '!=', '>', '<', '>=', '<=', 'contains', 'in_range'];
let conditions = [];

function initializeParameterList() {
  const paramList = document.getElementById('paramList');
  if(!paramList) return;
  paramList.innerHTML = '';
  
  // Flatten all columns and create buttons
  const allCols = [];
  Object.values(SQLITE_COLUMNS).forEach(cols => allCols.push(...cols));
  
  allCols.forEach(col => {
    const btn = document.createElement('button');
    btn.className = 'f-button';
    btn.textContent = col;
    btn.style.cssText = 'padding:6px 8px;font-size:10px;border:1px solid var(--border);background:var(--panel-3);cursor:pointer;border-radius:4px;transition:all 0.2s;';
    btn.onmouseover = () => btn.style.background = 'var(--primary)';
    btn.onmouseout = () => btn.style.background = 'var(--panel-3)';
    btn.onclick = () => addCondition(col, 'number');
    paramList.appendChild(btn);
  });
}

function addCondition(param, type = 'number') {
  try {
    // Ensure conditions array exists
    if(!Array.isArray(conditions)) {
      window.conditions = [];
    }
    
    const condId = 'cond_' + Date.now();
    const condObj = {
      id: condId,
      param: param,
      operator: '==',
      value: '',
      type: type
    };
    conditions.push(condObj);
    
    if(typeof renderConditions === 'function') {
      renderConditions();
    }
    
    if(typeof addLog === 'function') {
      addLog(`Condition added: ${param}`, 'INFO');
    }
  } catch(err) {
    console.error('Error adding condition:', err);
  }
}

function removeCondition(condId) {
  try {
    if(Array.isArray(conditions)) {
      conditions = conditions.filter(c => c.id !== condId);
      if(typeof renderConditions === 'function') {
        renderConditions();
      }
    }
  } catch(err) {
    console.error('Error removing condition:', err);
  }
}

function updateCondition(condId, field, value) {
  try {
    if(Array.isArray(conditions)) {
      const cond = conditions.find(c => c.id === condId);
      if(cond) {
        cond[field] = value;
        if(typeof renderConditions === 'function') {
          renderConditions();
        }
      }
    }
  } catch(err) {
    console.error('Error updating condition:', err);
  }
}

function renderConditions() {
  try {
    const condList = document.getElementById('conditionsList');
    if(!condList) return;
    
    // Ensure conditions is an array
    if(!Array.isArray(conditions)) {
      window.conditions = [];
    }
    
    if(conditions.length === 0) {
      condList.innerHTML = '<div style="color:var(--muted);font-size:11px;text-align:center;padding:12px;">No conditions added yet. Click a parameter to add one.</div>';
      return;
    }
    
    condList.innerHTML = conditions.map(cond => `
      <div style="display:flex;gap:6px;align-items:center;background:var(--panel-3);border:1px solid var(--border);border-radius:4px;padding:8px;font-size:11px;">
        <span style="min-width:60px;font-weight:bold;color:var(--accent);">${cond.param}</span>
        <select onchange="updateCondition('${cond.id}','operator',this.value)" style="padding:4px;border-radius:3px;border:1px solid var(--border);">
          ${COMPARISON_OPS.map(op => `<option value="${op}" ${cond.operator===op?'selected':''}>${op}</option>`).join('')}
        </select>
        <input type="text" placeholder="value" value="${cond.value}" onchange="updateCondition('${cond.id}','value',this.value)" style="flex:1;padding:4px;border-radius:3px;border:1px solid var(--border);">
        <button onclick="removeCondition('${cond.id}')" style="padding:4px 8px;background:var(--danger);color:white;border:none;border-radius:3px;cursor:pointer;font-size:10px;">‚úï</button>
      </div>
    `).join('');
  } catch(err) {
    console.error('Error rendering conditions:', err);
  }
}

function addTimeCondition(timeType) {
  try {
    let param = timeType;
    let defaultVal = '';
    
    if(timeType === 'entry_time') defaultVal = document.getElementById('quickEntryTime').value || '09:20';
    else if(timeType === 'exit_time') defaultVal = document.getElementById('quickExitTime').value || '15:15';
    else if(timeType === 'market_open') defaultVal = '09:15';
    else if(timeType === 'expiry_time') defaultVal = 'third_thursday';
    
    addCondition(param, 'time');
    
    // Ensure conditions array exists and has elements
    if(conditions && conditions.length > 0) {
      const lastCond = conditions[conditions.length - 1];
      if(lastCond) {
        lastCond.operator = 'after';
        lastCond.value = defaultVal;
        renderConditions();
      }
    }
  } catch(err) {
    console.error('Error adding time condition:', err);
    addLog('Error adding time condition: ' + err.message, 'ERROR');
  }
}

function syncConditionsToJSON() {
  const jsonEditor = document.getElementById('jsonEditor');
  if(!jsonEditor) return;
  const paramsObj = {
    conditions: conditions.map(c => ({
      param: c.param,
      operator: c.operator,
      value: c.value
    }))
  };
  jsonEditor.value = JSON.stringify(paramsObj, null, 2);
  updateJSONStatus('‚úì Synced from builder', 'success');
  addLog('Conditions exported to JSON', 'INFO');
}

function conditionsClearAll() {
  if(confirm('Clear all conditions?')) {
    conditions = [];
    renderConditions();
    addLog('All conditions cleared', 'INFO');
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BUILDER MODAL CONTROLS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

function openBuilder(editData = null) {
  try {
    console.log('openBuilder called', { editData });
    
    if(editData) {
      state.editing = editData.id;
      const subtitle = document.getElementById('modalSubtitle');
      if(subtitle) subtitle.textContent = `Editing: ${editData.name}`;
      
      // Populate form with existing data from 6-section form layout
      const fields = {
        sName: editData.name || '',
        sId: editData.id || '',
        sDesc: editData.description || ''
      };
      
      if(editData.identity) {
        fields.sSegment = editData.identity.exchange || 'NFO';
        fields.sUnderlying = editData.identity.symbol || '';
        fields.sType = editData.identity.instrument_type || 'OPTIDX';
        fields.schEntry = editData.identity.entry_time || '09:20';
        fields.schExit = editData.identity.exit_time || '15:15';
        fields.sOrderType = editData.identity.order_type || 'MKT';
        fields.sProduct = editData.identity.product || 'MIS';
        fields.sLots = (editData.identity.lot_qty || '1').toString();
      }
      
      // Set all fields
      Object.entries(fields).forEach(([id, val]) => {
        const el = document.getElementById(id);
        if(el) el.value = val;
      });
    } else {
      state.editing = null;
      const subtitle = document.getElementById('modalSubtitle');
      if(subtitle) subtitle.textContent = 'Fast & easy strategy configuration';
      
      // Reset all form fields to defaults
      const resetFields = {
        sName: '', sId: '', sDesc: '',
        sType: 'custom', sUnderlying: 'NIFTY', sSegment: 'NFO',
        sProduct: 'MIS', sOrderType: 'MKT', sLots: '1', sReentry: '0',
        schEntry: '09:20', schExit: '15:15',
        schFreq: 'daily', schExpiry: 'weekly',
        rTargetAmt: '', rTargetPct: '', rTargetAction: 'exit_all',
        rSlAmt: '', rSlPct: '', rSlAction: 'exit_all',
        rTrailAmt: '', rTrailStep: '', rLockIn: '',
        rMaxDelta: '', rDeltaAction: 'hedge',
        rMaxIv: '', rMinIv: '', rMaxCap: '', rMaxLegs: '4'
      };
      
      Object.entries(resetFields).forEach(([id, val]) => {
        const el = document.getElementById(id);
        if(el) el.value = val;
      });
    }
    
    // Switch to identity tab
    const btn = document.querySelector('.bnav-tab[data-sec="identity"]');
    if(btn) switchBSec('identity', btn);
    
    // Open modal
    const modal = document.getElementById('modalOverlay');
    if(modal) {
      modal.classList.add('open');
      console.log('Modal opened successfully');
    } else {
      console.error('Modal element not found');
    }
  } catch(err) {
    console.error('Error opening builder:', err);
    alert('Error opening strategy builder. Check browser console.\n\n' + err.message);
  }
}

function closeBuilder() {
  document.getElementById('modalOverlay').classList.remove('open');
}

function handleOverlayClick(e) {
  if(e.target === document.getElementById('modalOverlay')) closeBuilder();
}

function switchBSec(sec, btn) {
  document.querySelectorAll('.bsec').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.bnav-tab').forEach(t => t.classList.remove('active'));
  const s = document.getElementById(`sec-${sec}`);
  if(s) s.classList.add('active');
  if(btn) btn.classList.add('active');
  else {
    const target = document.querySelector(`.bnav-tab[data-sec="${sec}"]`);
    if(target) target.classList.add('active');
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   QUICK CONFIG TAB FUNCTIONS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

function onExchangeChange() {
  const exchange = document.getElementById('quickExchange').value;
  const instType = document.getElementById('quickInstrumentType');
  
  // Auto-detect instrument type based on exchange
  if(exchange === 'MCX') {
    instType.value = 'MCX';
  } else if(exchange === 'NFO' || exchange === 'BFO') {
    instType.value = 'OPTIDX';
  }
  
  addLog(`Exchange changed to: ${exchange}`, 'INFO');
}

function onSymbolChange() {
  const symbol = document.getElementById('quickSymbol').value;
  if(symbol) {
    addLog(`Symbol selected: ${symbol}`, 'INFO');
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   JSON EDITOR FUNCTIONS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

function formatJSON() {
  const editor = document.getElementById('jsonEditor');
  try {
    const obj = JSON.parse(editor.value);
    editor.value = JSON.stringify(obj, null, 2);
    updateJSONStatus('‚úì Formatted', 'success');
  } catch(e) {
    updateJSONStatus(`‚úó Invalid JSON: ${e.message}`, 'error');
  }
}

function validateJSON() {
  const editor = document.getElementById('jsonEditor');
  try {
    const obj = JSON.parse(editor.value);
    
    if(obj.conditions && Array.isArray(obj.conditions)) {
      const required = ['param', 'operator', 'value'];
      const invalid = obj.conditions.filter(c => !required.every(r => r in c));
      
      if(invalid.length > 0) {
        updateJSONStatus(`‚ö† Some conditions missing fields`, 'warning');
      } else {
        updateJSONStatus('‚úì Valid conditions', 'success');
      }
    } else {
      updateJSONStatus('‚úì Valid JSON', 'success');
    }
  } catch(e) {
    updateJSONStatus(`‚úó Parse error: ${e.message}`, 'error');
  }
}

function updateJSONStatus(msg, type) {
  const status = document.getElementById('jsonStatus');
  status.textContent = msg;
  status.style.color = type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--danger)' : 'var(--warning)';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   VALIDATION TAB FUNCTIONS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

function runBuildTest() {
  const name = document.getElementById('quickName').value.trim();
  const version = document.getElementById('quickVersion').value.trim() || '1.0';
  const exchange = document.getElementById('quickExchange').value;
  const symbol = document.getElementById('quickSymbol').value;
  const instrumentType = document.getElementById('quickInstrumentType').value || (exchange === 'MCX' ? 'MCX' : 'OPTIDX');
  const entryTime = document.getElementById('quickEntryTime').value;
  const exitTime = document.getElementById('quickExitTime').value;
  const orderType = document.getElementById('quickOrderType').value;
  const product = document.getElementById('quickProduct').value;
  const lotQty = parseInt(document.getElementById('quickLotQty').value) || 1;

  const resultDiv = document.getElementById('buildTestResult');
  resultDiv.style.display = 'block';
  resultDiv.innerHTML = '<div style="color:var(--muted);">‚è≥ Testing build...</div>';

  // Build the test config just like saveStrategy does
  const testConfig = {
    strategy_name: name || 'TEST',
    strategy_version: version,
    exchange: exchange || 'NFO',
    symbol: symbol || 'NIFTY',
    instrument_type: instrumentType,
    entry_time: entryTime || '09:20',
    exit_time: exitTime || '15:15',
    order_type: orderType || 'MKT',
    product: product || 'NRML',
    lot_qty: lotQty,
    params: conditions.length > 0 ? { conditions } : {},
    poll_interval: 2.0,
    cooldown_seconds: 0
  };

  // Test validation
  const errors = [];
  const warnings = [];
  
  if(!testConfig.strategy_name || !testConfig.strategy_name.trim()) errors.push('strategy_name is required');
  if(!testConfig.exchange) errors.push('exchange is required');
  if(!testConfig.symbol) errors.push('symbol is required (NIFTY, BANKNIFTY, etc)');
  if(!testConfig.instrument_type) warnings.push('instrument_type: will auto-detect to OPTIDX');
  if(!testConfig.entry_time) errors.push('entry_time is required (HH:MM format)');
  if(!testConfig.exit_time) errors.push('exit_time is required (HH:MM format)');
  if(!testConfig.order_type) errors.push('order_type is required (MKT, LMT, SLM)');
  if(!testConfig.product) errors.push('product is required (MIS or NRML)');
  if(testConfig.lot_qty < 1) errors.push('lot_qty must be >= 1');

  let html = '<div style="color:var(--success);margin-bottom:8px;">‚úì UniversalStrategyConfig Test Results:</div>';
  html += '<div style="font-size:10px;margin-bottom:10px;color:var(--muted);">';
  html += `<div>Name: ${testConfig.strategy_name}</div>`;
  html += `<div>Version: ${testConfig.strategy_version}</div>`;
  html += `<div>Exchange: ${testConfig.exchange} | Symbol: ${testConfig.symbol}</div>`;
  if(conditions.length > 0) {
    html += `<div>Conditions: ${conditions.length} rules</div>`;
  }
  html += '</div>';

  if(errors.length > 0) {
    html += '<div style="color:var(--danger);margin-bottom:8px;">‚ùå Errors:</div>';
    errors.forEach(e => html += `<div style="color:var(--danger);margin-left:12px;">‚Ä¢ ${e}</div>`);
  }

  if(warnings.length > 0) {
    html += '<div style="color:var(--warning);margin-bottom:8px;">‚ö† Warnings:</div>';
    warnings.forEach(w => html += `<div style="color:var(--warning);margin-left:12px;">‚Ä¢ ${w}</div>`);
  }

  if(errors.length === 0 && warnings.length === 0) {
    html += '<div style="color:var(--success);">‚úì All validations passed! Configuration is ready to save.</div>';
  } else if(errors.length === 0) {
    html += '<div style="color:var(--warning);">‚ö† Can save with warnings.</div>';
  }

  resultDiv.innerHTML = html;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LOGGER FUNCTIONS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

let allLogs = [];

function addLog(message, level = 'INFO') {
  const now = new Date();
  const time = now.toLocaleTimeString('en-US', { hour12: false });
  allLogs.push({ message, level, time });
  renderLogs();
}

function renderLogs() {
  const loggerBody = document.getElementById('loggerBody');
  const filter = document.getElementById('logFilter').value;
  
  const filteredLogs = filter ? allLogs.filter(l => l.level === filter) : allLogs;
  const displayLogs = filteredLogs.slice(-50); // Show last 50

  if(displayLogs.length === 0) {
    loggerBody.innerHTML = '<div class="log-empty">No logs yet ‚Äî run a strategy to see events</div>';
    return;
  }

  loggerBody.innerHTML = displayLogs.map(log => `
    <div class="log-entry ${log.level}">
      <div class="log-timestamp">${log.time}</div>
      <div class="log-level">${log.level}</div>
      <div class="log-message">${log.message}</div>
    </div>
  `).join('');
  
  // Auto-scroll to bottom
  loggerBody.scrollTop = loggerBody.scrollHeight;
}

function filterLogs(level) {
  renderLogs();
}

function clearLogs() {
  allLogs = [];
  document.getElementById('loggerBody').innerHTML = '<div class="log-empty">No logs yet ‚Äî run a strategy to see events</div>';
}

function toggleLogger() {
  const logger = document.getElementById('strategyLogger');
  logger.classList.toggle('minimized');
}

// Initialize strategies and parameter list
document.addEventListener('DOMContentLoaded', () => {
  // Initialize form with auto-generated ID from name
  const nameInput = document.getElementById('sName');
  if(nameInput) {
    nameInput.addEventListener('input', () => {
      const id = nameInput.value.toUpperCase().replace(/\s+/g,'_').replace(/[^A-Z0-9_]/g,'');
      const sIdEl = document.getElementById('sId');
      if(sIdEl) sIdEl.value = id;
    });
  }
  
  loadStrategies();
  setInterval(loadStrategies, 6000);
  setInterval(refreshMonitorMock, 4000);
  addLog('Strategy management system initialized', 'INFO');
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SAVE STRATEGY
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function saveStrategy() {
  // Validate all required fields from the 6-section form
  const name = document.getElementById('sName').value.trim();
  const exchange = document.getElementById('sSegment').value;
  const symbol = document.getElementById('sUnderlying').value;
  const instrumentType = document.getElementById('sType').value || 'OPTIDX';
  const entryTime = document.getElementById('schEntry').value;
  const exitTime = document.getElementById('schExit').value;
  const orderType = document.getElementById('sOrderType').value;
  const product = document.getElementById('sProduct').value;
  const lotQty = parseInt(document.getElementById('sLots').value) || 1;
  const version = '1.0';
  const pollInterval = 2.0;
  const cooldown = 0;

  // Validation
  const errors = [];
  if(!name) errors.push('Strategy name is required');
  if(!exchange) errors.push('Exchange is required');
  if(!symbol) errors.push('Symbol is required');
  if(!entryTime) errors.push('Entry time is required');
  if(!exitTime) errors.push('Exit time is required');
  if(!orderType) errors.push('Order type is required');
  if(!product) errors.push('Product is required');
  if(lotQty < 1) errors.push('Lot quantity must be >= 1');

  if(errors.length > 0) {
    showAlert(`Validation errors: ${errors.join(', ')}`, 'error');
    return;
  }

  // Build params from form data (simplified - start with empty params)
  let params = {};

  // Build payload with UniversalStrategyConfig structure
  // Map the 6-tab form values to UniversalStrategyConfig fields
  // Note: exchange maps from Segment field (NFO, BFO, MCX)
  const exchange_mapped = exchange === 'NFO' ? 'NFO' : exchange === 'BFO' ? 'BFO' : 'MCX';
  const id = name.toUpperCase().replace(/\s+/g,'_');
  const payload = {
    id,
    name,
    schema_version: '2.0',
    description: `Strategy: ${name}`,
    status: 'IDLE',
    created_at: new Date().toISOString(),
    updated_at: new Date().toISOString(),
    tags: ['user-created'],
    
    // Map to UniversalStrategyConfig fields
    identity: {
      strategy_name: id,
      strategy_version: version,
      exchange: exchange_mapped,
      symbol: symbol,
      instrument_type: instrumentType,
      entry_time: entryTime,
      exit_time: exitTime,
      order_type: orderType,
      product: product,
      lot_qty: lotQty,
      params: params,
      poll_interval: pollInterval,
      cooldown_seconds: cooldown,
    }
  };

  const btn = document.getElementById('btnSave');
  const statusEl = document.getElementById('saveStatus');
  btn.disabled = true;
  statusEl.textContent = '‚è≥ Validating and saving...';
  statusEl.style.color = 'var(--muted)';

  try {
    // First validate the config
    const validateRes = await fetch('/dashboard/api/validate-strategy-config', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload.identity),
      credentials: 'include'
    }).catch(() => null); // Ignore if endpoint doesn't exist yet

    if(validateRes && !validateRes.ok) {
      const err = await validateRes.json().catch(() => ({}));
      statusEl.textContent = `‚ùå Validation failed: ${err.detail || err.message || 'Unknown error'}`;
      statusEl.style.color = 'var(--danger)';
      showAlert(`Validation failed: ${err.detail || err.message || 'Config does not match UniversalStrategyConfig'}`, 'error');
      btn.disabled = false;
      return;
    }

    // Now save the config
    const res = await fetch('/dashboard/strategy/config/save-all', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
      credentials: 'include'
    });

    if(res.ok) {
      statusEl.textContent = '‚úÖ Saved successfully!';
      statusEl.style.color = 'var(--success)';
      addLog(`‚úì Strategy saved: ${name}`, 'INFO');
      showAlert(`Strategy "${name}" saved and ready to run!`, 'success');
      setTimeout(() => { closeBuilder(); loadStrategies(); }, 1200);
    } else {
      const err = await res.json().catch(() => ({}));
      const errMsg = err.detail || err.message || res.statusText;
      statusEl.textContent = `‚ùå ${errMsg}`;
      statusEl.style.color = 'var(--danger)';
      addLog(`‚úó Failed to save strategy: ${errMsg}`, 'ERROR');
      showAlert(`Failed to save: ${errMsg}`, 'error');
    }
  } catch(e) {
    statusEl.textContent = '‚ö† Error: ' + e.message;
    statusEl.style.color = 'var(--warning)';
    addLog(`‚úó Exception: ${e.message}`, 'ERROR');
    showAlert(`Error: ${e.message}`, 'error');
  } finally {
    btn.disabled = false;
  }
}

function showAlert(msg, type) {
  const box = document.getElementById('alertBox');
  box.className = `builder-alert show ${type}`;
  box.innerHTML = `<span>${type==='success'?'‚úì':'‚úï'}</span> ${msg}`;
  setTimeout(() => box.classList.remove('show'), 4000);
}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LOAD + RENDER STRATEGIES
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function loadStrategies() {
  try {
    const res = await fetch('/dashboard/strategy/configs', { credentials: 'include' });
    if(res.ok) {
      const data = await res.json();
      strategies = data.configs || [];
      renderStrategies(strategies);
    } else if(res.status === 401) {
      window.location.href = '/';
    }
  } catch(e) {
    renderStrategies(strategies); // show cached
  }
}

function renderStrategies(list) {
  const container = document.getElementById('strategyCards');
  const statR = document.getElementById('statRunning');
  const statP = document.getElementById('statPaused');
  const statI = document.getElementById('statIdle');
  const statT = document.getElementById('statTotal');

  const running = list.filter(s=>s.status==='RUNNING').length;
  const paused  = list.filter(s=>s.status==='PAUSED').length;
  const idle    = list.filter(s=>!['RUNNING','PAUSED'].includes(s.status)).length;
  if(statR) statR.textContent = running;
  if(statP) statP.textContent = paused;
  if(statI) statI.textContent = idle;
  if(statT) statT.textContent = list.length;

  if(!list.length) {
    container.innerHTML = `<div class="empty-control">
      <div class="empty-ico">üì≠</div>
      <p>No strategies saved yet.<br>Click <strong>+ Create Strategy</strong> to build one.</p>
    </div>`;
    return;
  }

  container.innerHTML = list.map(s => {
    const status   = (s.status || 'IDLE').toUpperCase();
    const statusCls = status.toLowerCase();
    const isRunning = status === 'RUNNING';
    const isPaused  = status === 'PAUSED';
    const isIdle    = !isRunning && !isPaused;

    const target = s.risk?.target_amt ? `‚Çπ${s.risk.target_amt.toLocaleString('en-IN')}` : (s.identity?.target ? `‚Çπ${s.identity.target}` : '--');
    const sl     = s.risk?.sl_amt ? `‚Çπ${s.risk.sl_amt.toLocaleString('en-IN')}` : (s.identity?.stop_loss ? `‚Çπ${s.identity.stop_loss}` : '--');
    const freq   = s.schedule?.frequency || s.entry?.frequency || 'manual';
    const und    = s.underlying || s.identity?.underlying || 'NIFTY';
    const legs   = s.entry?.legs || 0;
    const entryT = s.schedule?.entry_time || s.identity?.entry_time || '--:--';

    return `
    <div class="s-card ${statusCls}" id="scard_${s.id}">
      <div class="s-card-top">
        <div>
          <div class="s-card-name">${s.name}</div>
          <div class="s-card-sub">${s.type||'custom'} ‚Ä¢ ${und} ‚Ä¢ ${freq} ‚Ä¢ ${legs} leg${legs!==1?'s':''}</div>
        </div>
        <div class="status-pill ${statusCls}">
          <div class="status-dot"></div>
          ${status}
        </div>
      </div>

      <div class="s-card-metrics">
        <div class="s-metric">
          <div class="s-metric-val val-accent">${entryT}</div>
          <div class="s-metric-lbl">Entry</div>
        </div>
        <div class="s-metric">
          <div class="s-metric-val val-pos">${target}</div>
          <div class="s-metric-lbl">Target</div>
        </div>
        <div class="s-metric">
          <div class="s-metric-val val-neg">${sl}</div>
          <div class="s-metric-lbl">SL</div>
        </div>
        <div class="s-metric">
          <div class="s-metric-val val-neu">${s.lots||1}</div>
          <div class="s-metric-lbl">Lots</div>
        </div>
      </div>

      <div class="s-card-actions">
        ${isRunning ? `
          <div class="running-lock">üîí Running ‚Äî locked</div>
          <button class="s-btn s-btn-pause" onclick="sendIntent('${s.name}','ADJUST')">‚è∏ Pause</button>
          <button class="s-btn s-btn-stop" onclick="sendIntent('${s.name}','EXIT')">‚èπ Stop</button>
        ` : isPaused ? `
          <button class="s-btn s-btn-start" onclick="sendIntent('${s.name}','ENTRY')">‚ñ∂ Resume</button>
          <button class="s-btn s-btn-edit" onclick="openBuilder(${JSON.stringify(s).replace(/"/g,'&quot;')})">‚úè Edit</button>
          <button class="s-btn s-btn-stop" onclick="sendIntent('${s.name}','EXIT')">‚èπ Stop</button>
        ` : `
          <button class="s-btn s-btn-start" onclick="sendIntent('${s.name}','ENTRY')">‚ñ∂ Start</button>
          <button class="s-btn s-btn-edit" onclick="openBuilder(${JSON.stringify(s).replace(/"/g,'&quot;')})">‚úè Edit</button>
          <button class="s-btn s-btn-stop" onclick="sendIntent('${s.name}','EXIT')" ${isIdle?'disabled':''}>‚èπ Stop</button>
        `}
      </div>
    </div>`;
  }).join('');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INTENT / ACTION
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function sendIntent(stratName, action) {
  try {
    const res = await fetch('/dashboard/intent/strategy', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ strategy_name: stratName, action }),
      credentials: 'include'
    });
    if(res.ok) {
      // Optimistically update status
      const idx = strategies.findIndex(s=>s.name===stratName);
      if(idx>=0) {
        if(action==='ENTRY') strategies[idx].status='RUNNING';
        else if(action==='ADJUST') strategies[idx].status='PAUSED';
        else if(action==='EXIT') strategies[idx].status='IDLE';
        renderStrategies(strategies);
      }
      setTimeout(loadStrategies, 800);
    } else {
      const err = await res.json().catch(()=>({}));
      alert(`Failed: ${err.detail || res.statusText}`);
    }
  } catch(e) {
    // Optimistic fallback
    const idx = strategies.findIndex(s=>s.name===stratName);
    if(idx>=0) {
      if(action==='ENTRY') strategies[idx].status='RUNNING';
      else if(action==='PAUSE') strategies[idx].status='PAUSED';
      else if(action==='EXIT') strategies[idx].status='IDLE';
      renderStrategies(strategies);
    }
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MONITOR TAB SWITCH
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function switchMTab(tab, btn) {
  document.querySelectorAll('.mtab').forEach(t=>t.classList.remove('active'));
  if(btn) btn.classList.add('active');
}

/* Render monitor data from API endpoint */
function renderMonitorData(data) {
  const orphanBody = document.getElementById('orphanBody');
  const monitorBody = document.getElementById('monitorBody');

  // Render orphan legs
  if (data.orphan_legs && data.orphan_legs.length) {
    orphanBody.innerHTML = data.orphan_legs.map(leg => `
      <tr>
        <td><span class="badge-${leg.option_type === 'CE' ? 'ce' : 'pe'}">${leg.option_type}</span> ${leg.instrument} ${leg.strike}</td>
        <td><span class="badge-${leg.side === 'BUY' ? 'buy' : 'sell'}">${leg.side}</span></td>
        <td>${leg.quantity || 0}</td>
        <td class="val-muted">${Number(leg.avg_price || 0).toFixed(1)}</td>
        <td class="val-muted">${Number(leg.last_price || 0).toFixed(1)}</td>
        <td class="${(leg.unrealized_pnl || 0) >= 0 ? 'val-pos' : 'val-neg'}">‚Çπ${Number(leg.unrealized_pnl || 0).toFixed(0)}</td>
        <td class="val-muted">${Number(leg.iv || 0).toFixed(1)}%</td>
        <td class="${(leg.delta || 0) >= 0 ? 'val-pos' : 'val-neg'}">${Number(leg.delta || 0).toFixed(2)}</td>
        <td class="val-muted">${Number(leg.gamma || 0).toFixed(4)}</td>
        <td class="${(leg.theta || 0) >= 0 ? 'val-pos' : 'val-neg'}">${Number(leg.theta || 0).toFixed(2)}</td>
        <td class="val-warn">${Number(leg.vega || 0).toFixed(2)}</td>
        <td class="val-muted">${Number(leg.open_interest || 0).toLocaleString()}</td>
        <td><button class="s-btn s-btn-stop" style="padding:3px 8px;font-size:9px;">Close</button></td>
      </tr>
    `).join('');
  } else {
    orphanBody.innerHTML = '<tr><td colspan="13" style="text-align:center;color:var(--muted);padding:16px;">No orphan positions detected</td></tr>';
  }

  // Render strategy positions
  if (data.strategies && data.strategies.length) {
    let html = '';
    data.strategies.forEach((strat, si) => {
      const greeks = strat.greeks || {};
      const pnl = strat.pnl || 0;
      const pnlCls = pnl >= 0 ? 'val-pos' : 'val-neg';
      const pnlStr = `${pnl >= 0 ? '+' : ''}‚Çπ${Math.abs(pnl).toFixed(0)}`;
      const delta = Number(greeks.delta || 0).toFixed(2);

      html += `
        <tr class="strategy-group-row" onclick="toggleMonitorGroup('${si}')">
          <td><span class="expand-icon" id="mg_${si}">‚ñ∂</span> <strong>${strat.name}</strong></td>
          <td>‚Äî</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td>
          <td class="${pnlCls}"><strong>${pnlStr}</strong></td>
          <td>${Number(strat.iv_avg || 0).toFixed(1)}%</td>
          <td class="${parseFloat(delta)>=0?'val-pos':'val-neg'}">${delta}</td>
          <td>${Number(greeks.gamma || 0).toFixed(4)}</td>
          <td class="${Number(greeks.theta || 0) >= 0 ? 'val-pos' : 'val-neg'}">${Number(greeks.theta || 0).toFixed(2)}</td>
          <td class="val-warn">${Number(greeks.vega || 0).toFixed(2)}</td>
          <td>${delta}</td><td>‚Äî</td>
          <td><span class="status-pill running" style="font-size:9px;padding:2px 6px;">${strat.status || 'RUNNING'}</span></td>
        </tr>`;
      
      // Render legs if available
      if (strat.legs && strat.legs.length) {
        strat.legs.forEach((leg, li) => {
          const legGreeks = leg.greeks || {};
          html += `
            <tr class="sub-row" id="mg_rows_${si}_${li}" style="display:none;">
              <td>‚îî <span class="badge-${leg.side === 'BUY' ? 'buy' : 'sell'}">${leg.side}</span> ${leg.instrument} ${leg.strike} ${leg.option_type}</td>
              <td><span class="badge-${leg.side === 'BUY' ? 'buy' : 'sell'}">${leg.side}</span></td>
              <td>${leg.quantity || 0}</td>
              <td class="val-muted">${Number(leg.avg_price || 0).toFixed(1)}</td>
              <td class="val-muted">${Number(leg.last_price || 0).toFixed(1)}</td>
              <td class="${(leg.unrealized_pnl || 0) >= 0 ? 'val-pos' : 'val-neg'}">‚Çπ${Number(leg.unrealized_pnl || 0).toFixed(0)}</td>
              <td>${Number(leg.iv || 0).toFixed(1)}%</td>
              <td class="${Number(legGreeks.delta || 0) >= 0 ? 'val-pos' : 'val-neg'}">${Number(legGreeks.delta || 0).toFixed(2)}</td>
              <td>${Number(legGreeks.gamma || 0).toFixed(4)}</td>
              <td class="${Number(legGreeks.theta || 0) >= 0 ? 'val-pos' : 'val-neg'}">${Number(legGreeks.theta || 0).toFixed(2)}</td>
              <td class="val-warn">${Number(legGreeks.vega || 0).toFixed(2)}</td>
              <td>‚Äî</td>
              <td class="val-muted">${Number(leg.open_interest || 0).toLocaleString()}</td>
              <td>‚Äî</td>
            </tr>`;
        });
      }

      // Combined greeks row
      html += `
        <tr class="combined-row" id="mg_combined_${si}" style="display:none;">
          <td>‚ö° Combined Greeks</td>
          <td>‚Äî</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td>
          <td>${pnlStr}</td>
          <td>${Number(strat.iv_avg || 0).toFixed(1)}%</td>
          <td>${delta}</td>
          <td>${Number(greeks.gamma || 0).toFixed(4)}</td>
          <td class="${Number(greeks.theta || 0) >= 0 ? 'val-pos' : 'val-neg'}">${Number(greeks.theta || 0).toFixed(2)}</td>
          <td class="val-warn">${Number(greeks.vega || 0).toFixed(2)}</td>
          <td>${delta}</td><td>‚Äî</td><td>‚Äî</td>
        </tr>`;
    });
    monitorBody.innerHTML = html;
  } else {
    monitorBody.innerHTML = '<tr><td colspan="14" style="text-align:center;color:var(--muted);padding:20px;">No active strategy positions</td></tr>';
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MONITOR DATA ‚Äî tries API endpoint, falls back to mock
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function refreshMonitorMock() {
  const running = strategies.filter(s => s.status === 'RUNNING');
  if(!running.length) return;

  try {
    const res = await fetch('/dashboard/monitoring/strategy-positions', { credentials: 'include' });
    if(res.ok) {
      const data = await res.json();
      // Transform backend response to expected format
      const transformed = {
        orphan_legs: data.legs_detailed || [],
        strategies: (data.strategy_positions || []).map(s => ({
          name: s.strategy_name,
          legs: s.legs || [],
          combined_delta: s.combined_delta || 0,
          combined_gamma: s.combined_gamma || 0,
          combined_theta: s.combined_theta || 0,
          combined_vega: s.combined_vega || 0,
          total_pnl: (s.total_unrealized_pnl || 0) + (s.total_realized_pnl || 0),
        }))
      };
      renderMonitorData(transformed);
      return;
    }
  } catch(e) {
    // Fall through to mock data
  }
  
  // Fallback: mock data
  const orphanBody = document.getElementById('orphanBody');
  const monitorBody = document.getElementById('monitorBody');

  orphanBody.innerHTML = `
    <tr>
      <td><span class="badge-ce">CE</span> NIFTY 24200 CE 27JUN</td>
      <td><span class="badge-buy">BUY</span></td>
      <td>50</td>
      <td class="val-muted">142.50</td>
      <td class="val-neg">134.20</td>
      <td class="val-neg">-‚Çπ415</td>
      <td class="val-muted">12.4%</td>
      <td class="val-pos">+0.42</td>
      <td class="val-muted">0.003</td>
      <td class="val-neg">-1.82</td>
      <td class="val-warn">+0.95</td>
      <td class="val-muted">1.2M</td>
      <td><button class="s-btn s-btn-stop" style="padding:3px 8px;font-size:9px;">Close</button></td>
    </tr>`;

  // Mock running strategy rows
  let html = '';
  running.forEach((s, si) => {
    const pnl = (Math.random()-0.4) * 3000;
    const pnlCls = pnl>=0 ? 'val-pos' : 'val-neg';
    const pnlStr = `${pnl>=0?'+':''}‚Çπ${Math.abs(pnl).toFixed(0)}`;
    const delta = ((Math.random()-0.5)*0.3).toFixed(2);
    html += `
    <tr class="strategy-group-row" onclick="toggleMonitorGroup('${si}')">
      <td><span class="expand-icon" id="mg_${si}">‚ñ∂</span> <strong style="font-family:var(--font-head)">${s.name}</strong></td>
      <td>‚Äî</td>
      <td>‚Äî</td>
      <td>‚Äî</td>
      <td>‚Äî</td>
      <td class="${pnlCls}"><strong>${pnlStr}</strong></td>
      <td>‚Äî</td>
      <td class="${parseFloat(delta)>=0?'val-pos':'val-neg'}">${delta}</td>
      <td>‚Äî</td>
      <td class="val-neg">${(-Math.random()*5).toFixed(2)}</td>
      <td class="val-warn">${(Math.random()*2).toFixed(2)}</td>
      <td class="${parseFloat(delta)>=0?'val-pos':'val-neg'}">${delta}</td>
      <td>‚Äî</td>
      <td><span class="status-pill running" style="font-size:9px;padding:2px 6px;">RUNNING</span></td>
    </tr>
    <tr class="sub-row" id="mg_rows_${si}" style="display:none;">
      <td>‚îî <span class="badge-sell">SELL</span> NIFTY ATM CE</td>
      <td><span class="badge-sell">SELL</span></td>
      <td>50</td>
      <td class="val-muted">210.00</td>
      <td class="val-muted">${(195+Math.random()*30).toFixed(1)}</td>
      <td class="val-pos">+‚Çπ${(Math.random()*1500).toFixed(0)}</td>
      <td class="val-muted">${(11+Math.random()*5).toFixed(1)}%</td>
      <td class="val-neg">-0.50</td>
      <td class="val-muted">0.004</td>
      <td class="val-pos">+1.95</td>
      <td class="val-neg">-1.10</td>
      <td>‚Äî</td>
      <td class="val-muted">3.4M</td>
      <td>‚Äî</td>
    </tr>
    <tr class="sub-row" id="mg_rows2_${si}" style="display:none;">
      <td>‚îî <span class="badge-sell">SELL</span> NIFTY ATM PE</td>
      <td><span class="badge-sell">SELL</span></td>
      <td>50</td>
      <td class="val-muted">205.00</td>
      <td class="val-muted">${(190+Math.random()*30).toFixed(1)}</td>
      <td class="val-pos">+‚Çπ${(Math.random()*1500).toFixed(0)}</td>
      <td class="val-muted">${(11+Math.random()*5).toFixed(1)}%</td>
      <td class="val-pos">+0.50</td>
      <td class="val-muted">0.004</td>
      <td class="val-pos">+1.90</td>
      <td class="val-neg">-1.05</td>
      <td>‚Äî</td>
      <td class="val-muted">2.9M</td>
      <td>‚Äî</td>
    </tr>
    <tr class="combined-row" id="mg_combined_${si}" style="display:none;">
      <td>‚ö° Combined Greeks</td>
      <td>‚Äî</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td>
      <td>${pnlStr}</td>
      <td>${(12+Math.random()*4).toFixed(1)}%</td>
      <td>${delta}</td>
      <td>${(0.008+Math.random()*0.002).toFixed(4)}</td>
      <td>${(3.8+Math.random()*0.5).toFixed(2)}</td>
      <td>${(-2.1-Math.random()*0.3).toFixed(2)}</td>
      <td>${delta}</td>
      <td>‚Äî</td>
      <td>‚Äî</td>
    </tr>`;
  });

  monitorBody.innerHTML = html || `<tr><td colspan="14" style="text-align:center;color:var(--muted);padding:20px;font-size:11px;">No active strategy positions</td></tr>`;
}

function toggleMonitorGroup(idx) {
  const rows = [
    document.getElementById(`mg_rows_${idx}`),
    document.getElementById(`mg_rows2_${idx}`),
    document.getElementById(`mg_combined_${idx}`),
  ];
  const icon = document.getElementById(`mg_${idx}`);
  const visible = rows[0] && rows[0].style.display !== 'none';
  rows.forEach(r => { if(r) r.style.display = visible ? 'none' : 'table-row'; });
  if(icon) icon.style.transform = visible ? '' : 'rotate(90deg)';
}

// Keyboard close
document.addEventListener('keydown', e => {
  if(e.key === 'Escape') closeBuilder();
});
</script>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     STRATEGY LOGGER WINDOW
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="strategyLogger" class="strategy-logger">
  <div class="logger-header">
    <div class="logger-title">üìã Strategy Execution Logger</div>
    <div class="logger-controls">
      <select id="logFilter" onchange="filterLogs(this.value)" class="logger-select">
        <option value="">All Levels</option>
        <option value="INFO">INFO</option>
        <option value="WARNING">WARNING</option>
        <option value="ERROR">ERROR</option>
      </select>
      <button onclick="clearLogs()" class="logger-btn">Clear</button>
      <button onclick="toggleLogger()" class="logger-btn">‚àí</button>
    </div>
  </div>
  <div class="logger-body" id="loggerBody">
    <div class="log-empty">No logs yet ‚Äî run a strategy to see events</div>
  </div>
</div>

<style>
/* Strategy Logger Styles */
.strategy-logger {
  position: fixed;
  bottom: 0;
  right: 0;
  width: 100%;
  height: 250px;
  background: var(--panel-2);
  border-top: 1px solid var(--border);
  border-left: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  z-index: 1000;
  font-family: var(--font-mono);
  font-size: 11px;
  box-shadow: 0 -5px 20px rgba(0,0,0,0.3);
}

.strategy-logger.minimized {
  height: 32px;
}

.strategy-logger.minimized .logger-body {
  display: none;
}

.logger-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 14px;
  background: var(--panel-3);
  border-bottom: 1px solid var(--border);
  gap: 8px;
  flex-shrink: 0;
}

.logger-title {
  font-weight: 700;
  color: var(--primary);
  flex: 1;
}

.logger-controls {
  display: flex;
  gap: 6px;
  align-items: center;
}

.logger-select {
  padding: 4px 8px;
  background: rgba(255,255,255,0.05);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--muted);
  font-size: 10px;
}

.logger-btn {
  padding: 4px 10px;
  background: rgba(255,255,255,0.05);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--muted);
  cursor: pointer;
  font-size: 10px;
  transition: all 0.15s;
}

.logger-btn:hover {
  background: rgba(255,255,255,0.1);
  color: var(--text);
}

.logger-body {
  flex: 1;
  overflow-y: auto;
  padding: 8px 12px;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.log-entry {
  display: flex;
  gap: 8px;
  padding: 4px 6px;
  border-radius: 3px;
  line-height: 1.3;
  font-size: 10px;
}

.log-entry.INFO {
  background: rgba(59,130,246,0.1);
  color: #60a5fa;
}

.log-entry.WARNING {
  background: rgba(245,158,11,0.1);
  color: #fbbf24;
}

.log-entry.ERROR {
  background: rgba(239,68,68,0.1);
  color: #f87171;
}

.log-timestamp {
  color: var(--muted);
  min-width: 110px;
  text-align: right;
}

.log-level {
  font-weight: 700;
  min-width: 65px;
}

.log-message {
  flex: 1;
  word-break: break-word;
}

.log-empty {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: var(--muted);
  font-size: 11px;
}
</style>

</body>
</html>
