<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>API Diagnostics - Shoonya OMS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/dashboard/web/styles/common.css">
    <link rel="stylesheet" href="/dashboard/web/shared/layout.css">
    <script src="/dashboard/web/shared/pages-config.js" defer></script>
    <script src="/dashboard/web/shared/layout.js" defer></script>
    <style>
        :root{--bg:#0a0e13;--panel:#151b26;--panel-2:#1c2333;--border:#2d3548;--text:#f1f5f9;--muted:#94a3b8;--primary:#3b82f6;--success:#10b981;--danger:#ef4444;--warning:#f59e0b}
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;background:var(--bg);color:var(--text);padding:72px 20px 20px;line-height:1.6}
        main{max-width:1200px;margin:0 auto}
        h1{color:var(--primary);margin-bottom:20px;font-size:28px;font-weight:700}
        h2{color:var(--text);font-size:16px;margin:24px 0 12px;font-weight:600}
        h3{color:var(--text);font-size:14px;margin:16px 0 8px;font-weight:600}
        .section{background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:20px;margin-bottom:20px}
        select{padding:8px;background:var(--panel-2);border:1px solid var(--border);color:var(--text);border-radius:6px;cursor:pointer;font-size:13px}
        button{background:var(--primary);color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;margin:5px;font-weight:600;transition:background 0.2s}
        button:hover{background:#2563eb}
        pre{background:#0a0e13;padding:15px;border-radius:6px;overflow-x:auto;border:1px solid var(--border);color:var(--muted);font-size:11px;max-height:300px;overflow-y:auto}
        .error{color:var(--danger)}
        .success{color:var(--success)}
        .status{display:inline-block;padding:3px 8px;border-radius:4px;font-size:11px;font-weight:600;text-transform:uppercase}
        .status.CREATED{background:rgba(245,158,11,.1);color:var(--warning);border:1px solid var(--warning)}
        .status.SENT_TO_BROKER{background:rgba(59,130,246,.1);color:var(--primary);border:1px solid var(--primary)}
        .status.EXECUTED{background:rgba(16,185,129,.12);color:var(--success);border:1px solid var(--success)}
        .status.FAILED{background:rgba(239,68,68,.15);color:var(--danger);border:1px solid var(--danger)}
        .info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-top:12px}
        .info-card{background:var(--panel-2);padding:16px;border-radius:8px;border-left:4px solid var(--primary);transition:all 0.2s}
        .info-card.warning{border-left-color:var(--warning);background:rgba(245,158,11,.05)}
        .info-card.danger{border-left-color:var(--danger);background:rgba(239,68,68,.05)}
        .info-card.success{border-left-color:var(--success);background:rgba(16,185,129,.05)}
        .info-label{font-size:11px;color:var(--muted);text-transform:uppercase;font-weight:600;margin-bottom:6px;letter-spacing:0.3px}
        .info-value{font-size:20px;font-weight:700;color:var(--text);font-variant-numeric:tabular-nums}
        .list-item{padding:12px;background:var(--panel-2);border-radius:6px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;border-left:4px solid var(--border);font-size:13px}
        .list-item.error{border-left-color:var(--danger);background:rgba(239,68,68,.05)}
        .list-item.warning{border-left-color:var(--warning);background:rgba(245,158,11,.05)}
        .list-item.success{border-left-color:var(--success);background:rgba(16,185,129,.05)}
        .pipeline-step{display:flex;align-items:center;gap:12px;padding:12px;background:var(--panel-2);border-radius:8px;margin-bottom:8px;border-left:4px solid var(--border);transition:all 0.2s}
        .pipeline-step.active{background:rgba(16,185,129,.05);border-left-color:var(--success)}
        .pipeline-step.pending{background:rgba(245,158,11,.05);border-left-color:var(--warning)}
        .pipeline-step.failed{background:rgba(239,68,68,.05);border-left-color:var(--danger)}
        .step-icon{font-size:20px;font-weight:700;color:var(--primary);min-width:28px;text-align:center}
        .step-content{flex:1}
        .step-label{font-weight:600;font-size:13px;color:var(--text)}
        .step-desc{font-size:12px;color:var(--muted);margin-top:4px}
        .loading{text-align:center;padding:20px;color:var(--muted);font-size:14px}
    </style>
</head>
<body data-page="diagnostics">
<div id="app-header"></div>
<main>
    <h1>üîç API Diagnostics & System Status</h1>
    
    <div class="section">
        <h2>Dashboard Status (Live)</h2>
        <div style="margin-bottom:8px;color:var(--success);font-weight:600">‚úì Auto-refreshing every 1s</div>
        <pre id="dashboardResult">Initializing...</pre>
    </div>

    <div class="section">
        <h2>Test Endpoints</h2>
        <div style="margin-bottom:12px">
            <label style="font-size:12px;color:var(--muted);text-transform:uppercase;font-weight:600;display:block;margin-bottom:6px">Symbol</label>
            <select id="symbolSelect">
                <option>NIFTY</option>
                <option>BANKNIFTY</option>
                <option>FINNIFTY</option>
            </select>
        </div>
        <div style="margin-bottom:12px">
            <button onclick="testExpiries()" style="margin-right:8px">üìä Test Expiries</button>
            <button onclick="testOptionChain()">üìã Test Option Chain</button>
        </div>
        <div style="margin-bottom:8px">
            <label style="font-size:12px;color:var(--muted);text-transform:uppercase;font-weight:600;display:block;margin-bottom:6px">Expiry (e.g., 27-FEB-2025)</label>
            <input id="expiryInput" placeholder="27-FEB-2025" type="text" style="padding:8px;background:var(--panel-2);border:1px solid var(--border);color:var(--text);border-radius:6px;font-size:13px;width:200px">
        </div>
        <pre id="expiriesResult">Click button to test endpoint...</pre>
        <pre id="optionChainResult">Click button to test endpoint...</pre>
    </div>

    <div class="section">
        <h2>Order Pipeline Diagnostics</h2>
        <div id="diagnosticsContent">
            <div class="loading">Loading diagnostics...</div>
        </div>
    </div>

    <div class="section">
        <h2>Intent Verification</h2>
        <div id="intentContent">
            <div class="loading">Loading intent verification...</div>
        </div>
    </div>

    <div class="section">
        <h2>Order Processing Pipeline</h2>
        <div>
            <div class="pipeline-step pending">
                <div class="step-icon">1</div>
                <div class="step-content">
                    <div class="step-label">Intent Created</div>
                    <div class="step-desc">Order created in OMS layer (status: CREATED)</div>
                </div>
            </div>
            <div class="pipeline-step pending">
                <div class="step-icon">2</div>
                <div class="step-content">
                    <div class="step-label">Intent Generation</div>
                    <div class="step-desc">Dashboard generates UniversalOrderCommand via /intent endpoint</div>
                </div>
            </div>
            <div class="pipeline-step pending">
                <div class="step-icon">3</div>
                <div class="step-content">
                    <div class="step-label">DB Write</div>
                    <div class="step-desc">Order persisted to orders.db with command_id</div>
                </div>
            </div>
            <div class="pipeline-step pending">
                <div class="step-icon">4</div>
                <div class="step-content">
                    <div class="step-label">Sent to Broker</div>
                    <div class="step-desc">Execution consumer processes intent, sends to broker (status: SENT_TO_BROKER)</div>
                </div>
            </div>
            <div class="pipeline-step pending">
                <div class="step-icon">5</div>
                <div class="step-content">
                    <div class="step-label">Broker Confirmation</div>
                    <div class="step-desc">Broker returns order_id, persisted as broker_order_id</div>
                </div>
            </div>
            <div class="pipeline-step pending">
                <div class="step-icon">6</div>
                <div class="step-content">
                    <div class="step-label">Watcher Reconciliation</div>
                    <div class="step-desc">OrderWatcher polls broker, updates status on fill/rejection</div>
                </div>
            </div>
        </div>
    </div>

<script>
async function testDashboard() {
    const result = document.getElementById('dashboardResult');
    try {
        result.textContent = 'Loading...';
        const res = await fetch('/dashboard/home/status', { credentials: 'include' });
        
        result.innerHTML = `
<span class="success">Status: ${res.status} ${res.statusText}</span>

Response:
${JSON.stringify(await res.json(), null, 2)}
        `;
    } catch (err) {
        result.innerHTML = `<span class="error">Error: ${err.message}</span>\n\n${err.stack}`;
    }
}

async function testExpiries() {
    const result = document.getElementById('expiriesResult');
    const symbol = document.getElementById('symbolSelect').value;
    try {
        result.textContent = 'Loading...';
        const res = await fetch(`/dashboard/symbols/expiries?exchange=NFO&symbol=${symbol}`, { credentials: 'include' });
        
        const data = await res.json();
        result.innerHTML = `
<span class="success">Status: ${res.status} ${res.statusText}</span>

Response Type: ${Array.isArray(data) ? 'Array' : typeof data}
Length: ${data.length}

First Item Type: ${typeof data[0]}
First Item: ${JSON.stringify(data[0], null, 2)}

Full Response:
${JSON.stringify(data, null, 2)}
        `;
    } catch (err) {
        result.innerHTML = `<span class="error">Error: ${err.message}</span>\n\n${err.stack}`;
    }
}

async function testOptionChain() {
    const result = document.getElementById('optionChainResult');
    const symbol = document.getElementById('symbolSelect').value;
    const expiry = document.getElementById('expiryInput').value;
    
    if (!expiry) {
        result.textContent = 'Please enter an expiry date (e.g., 27-FEB-2025)';
        return;
    }
    
    try {
        result.textContent = 'Loading...';
        const res = await fetch(`/dashboard/option-chain?exchange=NFO&symbol=${symbol}&expiry=${expiry}&max_age=10`, { credentials: 'include' });
        
        const data = await res.json();
        result.innerHTML = `
<span class="success">Status: ${res.status} ${res.statusText}</span>

Meta: ${JSON.stringify(data.meta, null, 2)}

Rows Count: ${data.rows ? data.rows.length : 0}
First Row: ${data.rows && data.rows[0] ? JSON.stringify(data.rows[0], null, 2) : 'N/A'}

Sample strikes:
${data.rows ? data.rows.slice(0, 5).map(r => `  ${r.strike} ${r.option_type}: ${r.ltp}`).join('\n') : 'N/A'}
        `;
    } catch (err) {
        result.innerHTML = `<span class="error">Error: ${err.message}</span>\n\n${err.stack}`;
    }
}

async function loadDiagnostics(){
    try{
        const container = document.getElementById('diagnosticsContent');
        if (!container) return;
        container.innerHTML = '<div class="loading">Loading...</div>';
        const res = await fetch('/dashboard/diagnostics/orders',{credentials:'include'});
        const data = await res.json();

        let html = '<div class="info-grid">';
        html += `<div class="info-card">
            <div class="info-label">Total Orders</div>
            <div class="info-value">${data.summary.total_orders}</div>
        </div>`;

        for (const [status, count] of Object.entries(data.summary.status_breakdown)) {
            let color = 'info-card';
            if (status === 'EXECUTED') color = 'info-card success';
            if (status === 'FAILED') color = 'info-card danger';
            if (status === 'CREATED' || status === 'SENT_TO_BROKER') color = 'info-card warning';
            html += `<div class="${color}">
                <div class="info-label">${status}</div>
                <div class="info-value">${count || 0}</div>
            </div>`;
        }
        html += '</div>';

        html += '<h3 style="margin-top:16px;margin-bottom:8px">Source Breakdown</h3>';
        html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:8px">';
        for (const [source, count] of Object.entries(data.summary.source_breakdown)) {
            html += `<div class="list-item"><span>${source}</span><strong>${count}</strong></div>`;
        }
        html += '</div>';

        if (data.failed_orders.count > 0) {
            html += `<h3 style="margin-top:16px;margin-bottom:8px;color:var(--danger)">Failed Orders (${data.failed_orders.count})</h3>`;
            for (const order of data.failed_orders.details) {
                html += `<div class="list-item error">
                    <div>
                        <strong>${order.symbol}</strong> ${order.side} ${order.qty}<br>
                        <span style="color:var(--muted);font-size:11px">${order.command_id}</span>
                    </div>
                    <span style="color:var(--muted);font-size:11px">${formatTime(order.updated)}</span>
                </div>`;
            }
        }

        if (data.pending_orders.count > 0) {
            html += `<h3 style="margin-top:16px;margin-bottom:8px;color:var(--warning)">Pending Orders (${data.pending_orders.count})</h3>`;
            for (const order of data.pending_orders.details.slice(0,10)) {
                html += `<div class="list-item warning">
                    <div>
                        <strong>${order.symbol}</strong> ${order.side} ${order.qty} - <span style="color:var(--warning)">${order.status}</span><br>
                        <span style="color:var(--muted);font-size:11px">${order.command_id}</span>
                    </div>
                </div>`;
            }
        }

        container.innerHTML = html;
    } catch (err) {
        document.getElementById('diagnosticsContent').innerHTML = `<div style="color:var(--danger)">Error: ${err.message}</div>`;
    }
}

async function loadIntentVerification(){
    try{
        const container = document.getElementById('intentContent');
        if (!container) return;
        container.innerHTML = '<div class="loading">Loading...</div>';
        const res = await fetch('/dashboard/diagnostics/intent-verification',{credentials:'include'});
        const data = await res.json();

        let html = '<div class="info-grid">';
        html += `<div class="info-card">
            <div class="info-label">Total Intents</div>
            <div class="info-value">${data.intent_pipeline.total_intents}</div>
        </div>`;
        html += `<div class="info-card success">
            <div class="info-label">Sent to Broker</div>
            <div class="info-value">${data.intent_pipeline.sent_to_broker}</div>
        </div>`;
        html += `<div class="info-card danger">
            <div class="info-label">Missing Broker ID</div>
            <div class="info-value">${data.data_quality.missing_broker_id_count}</div>
        </div>`;
        html += '</div>';

        html += '<h3 style="margin-top:16px;margin-bottom:8px">Orders by Execution Type</h3>';
        for (const [execType, orders] of Object.entries(data.intent_pipeline.by_execution_type)) {
            html += `<div class="list-item"><strong>${execType}</strong><span style="color:var(--primary)">${orders.length}</span></div>`;
        }

        if (data.data_quality.incomplete_orders.length > 0) {
            html += `<h3 style="margin-top:16px;margin-bottom:8px;color:var(--danger)">Data Quality Issues (${data.data_quality.incomplete_orders.length})</h3>`;
            for (const order of data.data_quality.incomplete_orders.slice(0,5)) {
                html += `<div class="list-item error">
                    <div>
                        <strong>${order.command_id}</strong><br>
                        <span style="color:var(--danger);font-size:11px">${order.issues.join(', ')}</span>
                    </div>
                </div>`;
            }
        }

        html += '<h3 style="margin-top:16px;margin-bottom:8px">Recent Activity</h3>';
        for (const order of data.recent_activity) {
            html += `<div class="list-item">
                <div>
                    <strong>${order.symbol}</strong> [${order.source}] <span class="status ${order.status}">${order.status}</span><br>
                    <span style="color:var(--muted);font-size:11px">${order.command_id}</span>
                </div>
                <span style="color:var(--muted);font-size:11px">${formatTime(order.updated)}</span>
            </div>`;
        }

        container.innerHTML = html;
    } catch (err) {
        document.getElementById('intentContent').innerHTML = `<div style="color:var(--danger)">Error: ${err.message}</div>`;
    }
}

function formatTime(ts){
    if (!ts) return '-';
    const d = new Date(ts);
    return d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
}

async function logout() {
    try {
        await fetch('/auth/logout', {
            method: 'POST',
            credentials: 'include'
        });
    } catch (e) {
        console.log('Logout completed');
    }
    window.location.href = '/';
}

window.addEventListener('DOMContentLoaded', function() {
    checkAuth();
});

// Smart refresh for diagnostics - update values only, not full page rebuild
let diagnosticsAutoTimer = null;
let lastDiagnosticsData = null;
let lastIntentData = null;
let lastDashboardData = null;

function smartUpdateDiagnostics() {
    fetch('/dashboard/diagnostics', {credentials:'include'})
        .then(r => r.json())
        .then(data => {
            if (JSON.stringify(data) !== JSON.stringify(lastDiagnosticsData)) {
                lastDiagnosticsData = data;
                loadDiagnostics();
            }
        })
        .catch(() => {});
}

function smartUpdateIntent() {
    fetch('/dashboard/diagnostics/intent-verification', {credentials:'include'})
        .then(r => r.json())
        .then(data => {
            if (JSON.stringify(data) !== JSON.stringify(lastIntentData)) {
                lastIntentData = data;
                loadIntentVerification();
            }
        })
        .catch(() => {});
}

function smartUpdateDashboard() {
    fetch('/dashboard/home/status', {credentials:'include'})
        .then(r => r.json())
        .then(data => {
            if (JSON.stringify(data) !== JSON.stringify(lastDashboardData)) {
                lastDashboardData = data;
                testDashboard();
            }
        })
        .catch(() => {});
}

window.addEventListener('DOMContentLoaded', function() {
    checkAuth();
    try { testDashboard(); } catch (e) {}
    try { loadDiagnostics(); } catch (e) {}
    try { loadIntentVerification(); } catch (e) {}
    // Smart refresh that only updates when data changes (5 second interval instead of 1)
    diagnosticsAutoTimer = setInterval(() => {
        try { smartUpdateDashboard(); } catch (e) {}
        try { smartUpdateDiagnostics(); } catch (e) {}
        try { smartUpdateIntent(); } catch (e) {}
    }, 5000);  // 5 second refresh - only updates if data changed
});

async function checkAuth() {
    try {
        const res = await fetch('/dashboard/home/status', {
            credentials: 'include'
        });
        if (res.status === 401) {
            window.location.href = '/';
        }
    } catch (e) {
        console.log('Auth check completed');
    }
}
</script>
</main>
</body>
</html>