<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard – Shoonya OMS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        :root{--bg:#0a0e13;--panel:#151b26;--border:#2d3548;--text:#f1f5f9;--muted:#94a3b8;--primary:#3b82f6;--success:#10b981;--danger:#ef4444;--warning:#f59e0b}
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);line-height:1.6}
        header{height:64px;background:var(--panel);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;padding:0 24px;position:sticky;top:0;z-index:100}
        .nav-left{display:flex;gap:24px;align-items:center}
        .brand{font-weight:700;font-size:18px;color:var(--primary);cursor:pointer}
        .nav-link{color:var(--muted);font-size:14px;text-decoration:none;padding:8px 12px;border-radius:6px;transition:0.2s}
        .nav-link:hover{color:var(--text);background:#1c2333}
        .nav-link.active{color:var(--primary);background:#1c2333}
        .logout-btn{background:transparent;border:1px solid var(--border);color:var(--danger);padding:8px 16px;border-radius:8px;cursor:pointer;font-size:14px}
        main{max-width:1400px;margin:0 auto;padding:32px 24px}
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:24px;margin-bottom:32px}
        .stat-card{background:var(--panel);border:1px solid var(--border);padding:24px;border-radius:16px;box-shadow:0 4px 6px rgba(0,0,0,0.3)}
        .stat-label{font-size:12px;color:var(--muted);text-transform:uppercase;margin-bottom:8px;font-weight:600}
        .stat-value{font-size:24px;font-weight:700}
        .stat-value.up{color:var(--success)}
        .stat-value.down{color:var(--danger)}
        .grid-main{display:grid;grid-template-columns:2fr 1fr;gap:24px}
        .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;overflow:hidden}
        .card-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;font-weight:700}
        .table-wrap{overflow-x:auto}
        table{width:100%;border-collapse:collapse;font-size:13px}
        th{background:#1c2333;padding:12px;text-align:left;color:var(--muted)}
        td{padding:12px;border-bottom:1px solid var(--border)}
        .badge{padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600;text-transform:uppercase}
        .badge.ok{background:rgba(16,185,129,0.1);color:var(--success)}
        .badge.warn{background:rgba(245,158,11,0.1);color:var(--warning)}
        @media (max-width:1024px){.grid-main{grid-template-columns:1fr}}
    </style>
</head>
<body>
<header>
    <div class="nav-left">
        <div class="brand">⚡ Shoonya OMS</div>
        <a class="nav-link active" href="/dashboard/home">Home</a>
        <a class="nav-link" href="/dashboard/web/option_chain_dashboard.html">Option Chain</a>
        <a class="nav-link" href="/dashboard/web/place_order.html">Place Order</a>
        <a class="nav-link" href="/dashboard/web/orderbook.html">Orderbook</a>
    </div>
    <button class="logout-btn" onclick="logout()">Logout</button>
</header>
<main>
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Net PnL</div>
            <div id="netPnl" class="stat-value">₹0.00</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Open Positions</div>
            <div id="openPositions" class="stat-value">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Pending Orders</div>
            <div id="pendingOrders" class="stat-value">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">System Signal</div>
            <div id="systemSignal" class="stat-value">IDLE</div>
        </div>
    </div>
    <div class="grid-main">
        <div class="card">
            <div class="card-header">Active Positions</div>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Symbol</th><th>Qty</th><th>Avg Price</th><th>LTP</th><th>PnL</th></tr></thead>
                    <tbody id="positionRows"></tbody>
                </table>
            </div>
        </div>
        <div class="card">
            <div class="card-header">System Status</div>
            <div style="padding:20px;display:flex;flex-direction:column;gap:16px">
                <div style="display:flex;justify-content:space-between">
                    <span class="muted">Broker Login</span>
                    <span id="loginStatus" class="badge ok">OK</span>
                </div>
                <div style="display:flex;justify-content:space-between">
                    <span class="muted">Heartbeat</span>
                    <span id="heartbeatAge">0s ago</span>
                </div>
                <div style="display:flex;justify-content:space-between">
                    <span class="muted">Risk Check</span>
                    <span id="riskStatus" class="badge ok">Safe</span>
                </div>
                <div id="forceExitAlert" style="display:none;padding:12px;background:rgba(239,68,68,0.1);color:var(--danger);border-radius:8px;font-size:12px;font-weight:600;text-align:center">
                    ⚠️ FORCE EXIT IN PROGRESS
                </div>
            </div>
        </div>
    </div>
</main>
<script>
    async function logout(){await fetch('/auth/logout',{method:'POST'});window.location.href='/';}
    async function updateDashboard(){
        try{
            const res = await fetch('/dashboard/home/status');
            const data = await res.json();
            const {broker, system} = data;
            
            // Stats
            const pnl = broker.positions_summary.net_pnl || 0;
            netPnl.textContent = `₹${pnl.toFixed(2)}`;
            netPnl.className = `stat-value ${pnl>=0?'up':'down'}`;
            openPositions.textContent = broker.positions_summary.open_count || 0;
            pendingOrders.textContent = system.open_orders || 0;
            systemSignal.textContent = system.signal.status || 'IDLE';
            
            // System
            loginStatus.textContent = system.heartbeat.login;
            heartbeatAge.textContent = `${system.heartbeat.age_sec}s ago`;
            riskStatus.textContent = system.risk.daily_loss_hit ? 'LIMIT HIT' : 'SAFE';
            riskStatus.className = `badge ${system.risk.daily_loss_hit?'warn':'ok'}`;
            forceExitAlert.style.display = system.risk.force_exit_in_progress ? 'block' : 'none';
            
            // Positions
            positionRows.innerHTML = broker.positions.map(p => `
                <tr>
                    <td style="font-weight:700">${p.tsym}</td>
                    <td>${p.netqty}</td>
                    <td>${parseFloat(p.avgprc).toFixed(2)}</td>
                    <td>${parseFloat(p.lp).toFixed(2)}</td>
                    <td style="color:${parseFloat(p.rpnl)>=0?'var(--success)':'var(--danger)'};font-weight:700">₹${parseFloat(p.rpnl).toFixed(2)}</td>
                </tr>
            `).join('') || '<tr><td colspan="5" style="text-align:center;padding:40px;color:var(--muted)">No open positions</td></tr>';
        } catch(e) { console.error(e); }
    }
    setInterval(updateDashboard, 3000);
    updateDashboard();
</script>
</body>
</html>
