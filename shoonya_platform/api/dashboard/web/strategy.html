<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Strategy Manager | Shoonya Platform</title>
<link rel="stylesheet" href="/dashboard/web/styles/common.css">
<link rel="stylesheet" href="/dashboard/web/shared/layout.css">
<script src="/dashboard/web/shared/pages-config.js" defer></script>
<script src="/dashboard/web/shared/layout.js" defer></script>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #66e4ff;
  --primary-dark: #23b6ff;
  --success: #4ade80;
  --warning: #fbcb5c;
  --danger: #fb7185;
  --panel: rgba(13, 18, 41, 0.8);
  --panel-2: rgba(6, 10, 26, 0.95);
  --panel-3: rgba(13, 18, 41, 0.9);
  --text: #f8fbff;
  --muted: rgba(248, 251, 255, 0.65);
  --border: rgba(255, 255, 255, 0.08);
  --font-mono: 'IBM Plex Mono', monospace;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: radial-gradient(circle at top, #0f1a3c 0%, #050815 55%, #020308 100%);
  color: var(--text);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto;
  font-size: 13px;
  overflow-x: hidden;
}

main { padding: 20px; max-width: 1800px; margin: 0 auto; }

.header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.header h1 { font-size: 24px; font-weight: 700; }

.tabs {
  display: flex;
  gap: 12px;
  margin-bottom: 20px;
  border-bottom: 1px solid var(--border);
  padding-bottom: 12px;
}

.tab-btn {
  padding: 8px 16px;
  background: none;
  border: none;
  color: var(--muted);
  cursor: pointer;
  transition: all 0.3s;
  border-bottom: 2px solid transparent;
  font-weight: 600;
}

.tab-btn.active {
  color: var(--primary);
  border-bottom-color: var(--primary);
}

.tab-content {
  display: none;
  animation: fadeIn 0.3s;
}

.tab-content.active {
  display: block;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* Panels */
.widget {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 16px;
  backdrop-filter: blur(20px);
}

.widget-title {
  font-size: 14px;
  font-weight: 700;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.live-indicator {
  width: 8px;
  height: 8px;
  background: var(--success);
  border-radius: 50%;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* Buttons */
.btn {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 12px;
}

.btn-primary {
  background: linear-gradient(120deg, var(--primary), var(--primary-dark));
  color: #04060f;
  box-shadow: 0 8px 16px rgba(35, 182, 255, 0.3);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 24px rgba(35, 182, 255, 0.4);
}

.btn-success {
  background: var(--success);
  color: #000;
}

.btn-danger {
  background: var(--danger);
  color: #fff;
}

.btn-secondary {
  background: rgba(255,255,255,0.1);
  color: var(--text);
  border: 1px solid var(--border);
}

/* Tables */
.table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
}

.table thead {
  background: rgba(0,0,0,0.3);
  border-bottom: 1px solid var(--border);
}

.table th {
  padding: 10px;
  text-align: left;
  font-weight: 700;
  color: var(--primary);
}

.table td {
  padding: 10px;
  border-bottom: 1px solid rgba(255,255,255,0.03);
}

.table tbody tr:hover {
  background: rgba(255,255,255,0.03);
}

/* Forms */
.form-group {
  margin-bottom: 12px;
}

.form-group label {
  display: block;
  font-size: 12px;
  font-weight: 600;
  margin-bottom: 4px;
  color: var(--text);
}

.form-control {
  width: 100%;
  padding: 8px;
  background: rgba(0,0,0,0.3);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--text);
  font-family: var(--font-mono);
  font-size: 12px;
}

.form-control:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 12px rgba(102,228,255,0.1);
}

/* Status Badges */
.badge {
  display: inline-block;
  padding: 3px 8px;
  border-radius: 3px;
  font-size: 11px;
  font-weight: 600;
}

.badge-valid {
  background: rgba(74, 222, 128, 0.2);
  color: var(--success);
}

.badge-invalid {
  background: rgba(251, 113, 133, 0.2);
  color: var(--danger);
}

.badge-warning {
  background: rgba(251, 203, 92, 0.2);
  color: var(--warning);
}

.badge-running {
  background: rgba(102, 228, 255, 0.2);
  color: var(--primary);
}

/* Validation Messages */
.validation-result {
  margin-top: 12px;
  padding: 12px;
  background: rgba(0,0,0,0.2);
  border-radius: 6px;
  border-left: 3px solid var(--danger);
  font-size: 11px;
}

.validation-result.valid {
  border-left-color: var(--success);
}

.validation-error {
  color: var(--danger);
  margin-bottom: 6px;
  padding-left: 8px;
}

.validation-warning {
  color: var(--warning);
  margin-bottom: 6px;
  padding-left: 8px;
}

/* Control Console */
.control-console {
  display: flex;
  gap: 12px;
  margin-bottom: 16px;
}

.control-btn {
  flex: 1;
  padding: 12px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,0.05);
  border-radius: 8px;
  color: var(--text);
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  font-weight: 600;
}

.control-btn:hover {
  background: rgba(255,255,255,0.1);
}

.control-btn.running {
  border-color: var(--success);
  color: var(--success);
}

.control-btn.stopped {
  border-color: var(--danger);
  color: var(--danger);
}

/* Logger */
.logger-container {
  background: rgba(0,0,0,0.5);
  border: 1px solid var(--border);
  border-radius: 8px;
  display: flex;
  flex-direction: column;
  height: 400px;
  font-family: var(--font-mono);
  font-size: 11px;
}

.logger-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 12px;
  background: rgba(0,0,0,0.3);
  border-bottom: 1px solid var(--border);
}

.logger-body {
  flex: 1;
  overflow-y: auto;
  padding: 8px 12px;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.log-entry {
  display: flex;
  gap: 8px;
  padding: 4px;
  border-radius: 3px;
  line-height: 1.4;
}

.log-entry.INFO { color: #60a5fa; }
.log-entry.WARNING { color: var(--warning); }
.log-entry.ERROR { color: var(--danger); }
.log-entry.DEBUG { color: var(--muted); }

.log-time { color: var(--muted); min-width: 140px; }
.log-level { font-weight: 700; min-width: 70px; }

/* Search Box */
.search-box {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
}

.search-box input {
  flex: 1;
  padding: 8px;
  background: rgba(0,0,0,0.2);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--text);
}

.search-box input::placeholder {
  color: var(--muted);
}

.loader {
  display: inline-block;
  width: 14px;
  height: 14px;
  border: 2px solid var(--muted);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

</style>
</head>

<body>
<main>
  <div class="header">
    <h1>ğŸ“Š Strategy Manager</h1>
    <div id="status-indicator" style="display: flex; align-items: center; gap: 8px; font-size: 12px;">
      <span class="live-indicator"></span>
      <span id="runner-status">Status: Offline</span>
    </div>
  </div>

  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('strategies')">ğŸ“ Strategies</button>
    <button class="tab-btn" onclick="switchTab('control')">ğŸ® Control</button>
    <button class="tab-btn" onclick="switchTab('logs')">ğŸ“‹ Logs</button>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TAB 1: STRATEGIES MANAGEMENT
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="strategies" class="tab-content active">
    <div class="widget">
      <div class="widget-title">
        <span>ğŸ“‚ Saved Strategies</span>
        <button class="btn btn-primary" onclick="showCreateForm()">+ New Strategy</button>
      </div>
      
      <div class="search-box">
        <input type="text" id="search-strategies" placeholder="Search strategies..." onkeyup="filterStrategies()">
        <button class="btn btn-secondary" onclick="reloadStrategies()">âŸ³ Reload</button>
      </div>

      <div id="strategies-list">
        <p style="color: var(--muted); text-align: center; padding: 20px;">Loading...</p>
      </div>
    </div>

    <!-- Create/Edit Form -->
    <div id="create-form-widget" class="widget" style="display: none;">
      <div class="widget-title">âœï¸ Strategy Editor</div>
      
      <div class="form-group">
        <label>Strategy Name *</label>
        <input type="text" id="strategy-name" class="form-control" placeholder="e.g., NIFTY_DNSS">
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
        <div class="form-group">
          <label>Market Type *</label>
          <select id="market-type" class="form-control" onchange="updateMarketConfig()">
            <option value="">Select...</option>
            <option value="database_market">Database Market</option>
            <option value="live_feed_market">Live Feed Market</option>
          </select>
        </div>

        <div class="form-group">
          <label>Exchange *</label>
          <select id="exchange" class="form-control">
            <option value="">Select...</option>
            <option value="NFO">NFO</option>
            <option value="MCX">MCX</option>
            <option value="NCDEX">NCDEX</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label>Symbol *</label>
        <input type="text" id="symbol" class="form-control" placeholder="e.g., NIFTY">
      </div>

      <div id="db-config" style="display: none;">
        <div class="form-group">
          <label>Database Path *</label>
          <input type="text" id="db-path" class="form-control" placeholder="/path/to/option_chain.db">
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
        <div class="form-group">
          <label>Entry Time (HH:MM) *</label>
          <input type="text" id="entry-time" class="form-control" placeholder="09:15">
        </div>
        <div class="form-group">
          <label>Exit Time (HH:MM) *</label>
          <input type="text" id="exit-time" class="form-control" placeholder="15:30">
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
        <div class="form-group">
          <label>Entry CE Delta [0-1]</label>
          <input type="number" id="entry-ce-delta" class="form-control" min="0" max="1" step="0.05">
        </div>
        <div class="form-group">
          <label>Entry PE Delta [0-1]</label>
          <input type="number" id="entry-pe-delta" class="form-control" min="0" max="1" step="0.05">
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
        <div class="form-group">
          <label>Profit Target</label>
          <input type="number" id="profit-target" class="form-control">
        </div>
        <div class="form-group">
          <label>Max Loss</label>
          <input type="number" id="max-loss" class="form-control">
        </div>
      </div>

      <div class="form-group">
        <label>Quantity</label>
        <input type="number" id="quantity" class="form-control" value="1" min="1">
      </div>

      <!-- Validation Result -->
      <div id="validation-result"></div>

      <!-- Action Buttons -->
      <div style="display: flex; gap: 8px; margin-top: 16px;">
        <button class="btn btn-primary" onclick="validateStrategy()">âœ“ Validate</button>
        <button class="btn btn-success" id="save-strategy-btn" onclick="saveStrategy()" style="display: none;">ğŸ’¾ Save Strategy</button>
        <button class="btn btn-secondary" onclick="cancelEdit()">âœ• Cancel</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TAB 2: CONTROL CONSOLE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="control" class="tab-content">
    <div class="widget">
      <div class="widget-title">ğŸ® Control Console</div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
        <div style="padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px; border-left: 3px solid var(--primary);">
          <div style="font-size: 11px; color: var(--muted);">Runner Status</div>
          <div id="runner-status-text" style="font-size: 18px; font-weight: 700; color: var(--primary);">âš« OFFLINE</div>
        </div>

        <div style="padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px; border-left: 3px solid var(--primary);">
          <div style="font-size: 11px; color: var(--muted);">Strategies Loaded</div>
          <div id="strategies-count" style="font-size: 18px; font-weight: 700; color: var(--primary);">0</div>
        </div>
      </div>

      <div class="control-console">
        <button class="btn btn-success" onclick="startRunner()" style="flex: 1; padding: 12px;">
          â–¶ START RUNNER
        </button>
        <button class="btn btn-danger" onclick="stopRunner()" style="flex: 1; padding: 12px;">
          â¹ STOP RUNNER
        </button>
      </div>

      <div id="active-strategies-widget" style="display: none;">
        <h3 style="font-size: 13px; margin-bottom: 12px;">ğŸš€ Active Strategies</h3>
        <table class="table">
          <thead>
            <tr>
              <th>Strategy</th>
              <th>Market Type</th>
              <th>Symbol</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="active-strategies-list">
          </tbody>
        </table>

        <h3 style="font-size: 13px; margin-bottom: 12px; margin-top: 20px;">ğŸ“‹ Live Logs</h3>
        <div class="logger-container" style="height: 300px; overflow-y: auto;">
          <div class="logger-body" id="control-logs-body" style="font-size: 11px; line-height: 1.4;">
            <div style="color: var(--muted); text-align: center; padding: 20px;">Waiting for logs...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TAB 3: LOGGING CONSOLE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="logs" class="tab-content">
    <div class="widget">
      <div class="widget-title">ğŸ“‹ Execution Logs</div>

      <div style="display: flex; gap: 8px; margin-bottom: 12px;">
        <select id="log-strategy-filter" class="form-control" style="flex: 1;">
          <option value="">All Strategies</option>
        </select>
        <select id="log-level-filter" class="form-control" style="flex: 1;">
          <option value="">All Levels</option>
          <option value="DEBUG">DEBUG</option>
          <option value="INFO">INFO</option>
          <option value="WARNING">WARNING</option>
          <option value="ERROR">ERROR</option>
        </select>
        <button class="btn btn-secondary" onclick="loadLogs();">âŸ³ Refresh</button>
      </div>

      <div class="logger-container">
        <div class="logger-header">
          <span id="log-count">0 entries</span>
          <button class="btn btn-secondary" style="padding: 4px 8px;" onclick="clearLogs();">ğŸ—‘ï¸ Clear</button>
        </div>
        <div class="logger-body" id="logger-body">
          <div style="color: var(--muted); text-align: center; padding: 40px;">No logs yet...</div>
        </div>
      </div>
    </div>
  </div>

</main>

<script>
const API_BASE = '/dashboard';
let currentEditStrategy = null;
let runnerActive = false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB SWITCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function switchTab(tabName) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  
  document.getElementById(tabName).classList.add('active');
  event.target.classList.add('active');

  if (tabName === 'logs') {
    loadLogs();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API CALLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function apiCall(method, endpoint, data = null) {
  try {
    const opts = {
      method,
      headers: { 'Content-Type': 'application/json' }
    };
    if (data) opts.body = JSON.stringify(data);
    
    const response = await fetch(`${API_BASE}${endpoint}`, opts);
    const result = await response.json();
    
    if (!response.ok) {
      throw new Error(result.detail || `API error: ${response.status}`);
    }
    return result;
  } catch (e) {
    showError(e.message);
    throw e;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STRATEGIES TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function reloadStrategies() {
  try {
    const result = await apiCall('GET', '/strategy/list');
    displayStrategies(result.strategies || []);
  } catch (e) {
    console.error('Failed to load strategies:', e);
  }
}

function displayStrategies(strategies) {
  const container = document.getElementById('strategies-list');
  
  if (!strategies.length) {
    container.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 20px;">No strategies found. Create one to get started!</p>';
    return;
  }

  container.innerHTML = `
    <table class="table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Market Type</th>
          <th>Symbol</th>
          <th>Validation</th>
          <th>Execution</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        ${strategies.map(s => `
          <tr>
            <td><code style="color: var(--primary);">${s.name}</code></td>
            <td>${s.config.market_config?.market_type || '-'}</td>
            <td>${s.config.market_config?.symbol || '-'}</td>
            <td>
              <button class="btn btn-secondary" onclick="validateExisting('${s.name}')" style="padding: 3px 6px; font-size: 10px;">âœ“ Check</button>
            </td>
            <td>
              <button class="btn btn-success" onclick="startIndividualStrategy('${s.name}')" style="padding: 3px 6px; font-size: 10px;">â–¶ Start</button>
              <button class="btn btn-danger" onclick="stopIndividualStrategy('${s.name}')" style="padding: 3px 6px; font-size: 10px;">â¹ Stop</button>
            </td>
            <td>
              <button class="btn btn-secondary" onclick="editStrategy('${s.name}')" style="padding: 3px 6px;">âœï¸</button>
              <button class="btn btn-danger" onclick="deleteStrategy('${s.name}')" style="padding: 3px 6px;">ğŸ—‘ï¸</button>
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
}

function filterStrategies() {
  const search = document.getElementById('search-strategies').value.toLowerCase();
  document.querySelectorAll('#strategies-list table tbody tr').forEach(row => {
    const name = row.cells[0].textContent.toLowerCase();
    row.style.display = name.includes(search) ? '' : 'none';
  });
}

function showCreateForm() {
  currentEditStrategy = null;
  document.getElementById('create-form-widget').style.display = 'block';
  document.getElementById('strategy-name').value = '';
  document.getElementById('market-type').value = '';
  document.getElementById('save-strategy-btn').style.display = 'none';
  clearValidationResult();
}

function editStrategy(name) {
  currentEditStrategy = name;
  apiCall('GET', `/strategy/${name}`).then(result => {
    const cfg = result.config;
    document.getElementById('strategy-name').value = name;
    document.getElementById('market-type').value = cfg.market_config?.market_type || '';
    document.getElementById('exchange').value = cfg.market_config?.exchange || '';
    document.getElementById('symbol').value = cfg.market_config?.symbol || '';
    document.getElementById('db-path').value = cfg.market_config?.db_path || '';
    document.getElementById('entry-time').value = cfg.entry?.time || '';
    document.getElementById('exit-time').value = cfg.exit?.time || '';
    document.getElementById('entry-ce-delta').value = cfg.entry?.delta?.CE || '';
    document.getElementById('entry-pe-delta').value = cfg.entry?.delta?.PE || '';
    document.getElementById('profit-target').value = cfg.exit?.profit_target || '';
    document.getElementById('max-loss').value = cfg.exit?.max_loss || '';
    document.getElementById('quantity').value = cfg.entry?.quantity || '1';
    
    updateMarketConfig();
    document.getElementById('create-form-widget').style.display = 'block';
    document.getElementById('save-strategy-btn').style.display = 'inline-block';
  });
}

function cancelEdit() {
  document.getElementById('create-form-widget').style.display = 'none';
  currentEditStrategy = null;
}

function updateMarketConfig() {
  const marketType = document.getElementById('market-type').value;
  document.getElementById('db-config').style.display = marketType === 'database_market' ? 'block' : 'none';
}

async function validateStrategy() {
  const config = buildStrategyConfig();
  const name = document.getElementById('strategy-name').value || 'NEW_STRATEGY';
  
  try {
    const result = await apiCall('POST', '/strategy/validate', config);
    showValidationResult(result.validation);
    
    if (result.validation.valid) {
      document.getElementById('save-strategy-btn').style.display = 'inline-block';
    }
  } catch (e) {
    console.error('Validation failed:', e);
  }
}

async function validateExisting(name) {
  try {
    const result = await apiCall('GET', `/strategy/${name}`);
    showValidationResult(result.validation);
  } catch (e) {
    console.error('Validation check failed:', e);
  }
}

function buildStrategyConfig() {
  return {
    market_config: {
      market_type: document.getElementById('market-type').value,
      exchange: document.getElementById('exchange').value,
      symbol: document.getElementById('symbol').value,
      db_path: document.getElementById('db-path').value || undefined
    },
    entry: {
      time: document.getElementById('entry-time').value,
      delta: {
        CE: parseFloat(document.getElementById('entry-ce-delta').value) || 0.3,
        PE: parseFloat(document.getElementById('entry-pe-delta').value) || 0.3
      },
      quantity: parseInt(document.getElementById('quantity').value) || 1
    },
    exit: {
      time: document.getElementById('exit-time').value,
      profit_target: parseFloat(document.getElementById('profit-target').value) || 100,
      max_loss: parseFloat(document.getElementById('max-loss').value) || 50
    }
  };
}

async function saveStrategy() {
  const name = document.getElementById('strategy-name').value;
  if (!name) {
    showError('Please enter a strategy name');
    return;
  }

  const config = buildStrategyConfig();
  
  try {
    if (currentEditStrategy) {
      await apiCall('PUT', `/strategy/${name}`, config);
      showSuccess(`âœ“ Strategy '${name}' updated`);
    } else {
      await apiCall('POST', '/strategy/create', config);
      showSuccess(`âœ“ Strategy '${name}' created`);
    }
    
    cancelEdit();
    reloadStrategies();
  } catch (e) {
    console.error('Save failed:', e);
  }
}

async function deleteStrategy(name) {
  if (!confirm(`Delete strategy '${name}'?`)) return;
  
  try {
    await apiCall('DELETE', `/strategy/${name}`);
    showSuccess(`âœ“ Strategy '${name}' deleted`);
    reloadStrategies();
  } catch (e) {
    console.error('Delete failed:', e);
  }
}

function showValidationResult(validation) {
  const container = document.getElementById('validation-result');
  if (!validation || validation.valid) {
    container.innerHTML = '<div class="validation-result valid">âœ“ Configuration is valid!</div>';
    return;
  }

  let html = '<div class="validation-result">';
  (validation.errors || []).forEach(e => {
    html += `<div class="validation-error">âŒ ${e.field}: ${e.message}</div>`;
  });
  (validation.warnings || []).forEach(w => {
    html += `<div class="validation-warning">âš ï¸ ${w.field}: ${w.message}</div>`;
  });
  html += '</div>';
  container.innerHTML = html;
}

function clearValidationResult() {
  document.getElementById('validation-result').innerHTML = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INDIVIDUAL STRATEGY EXECUTION (Per-Strategy Control)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function startIndividualStrategy(strategyName) {
  try {
    const result = await apiCall('POST', `/strategy/${strategyName}/start-execution`);
    if (result.success) {
      showSuccess(`âœ“ Strategy '${strategyName}' started`);
      updateRunnerStatus();
      loadLogs(); // Auto-load logs when strategy starts
      // Switch to logs tab
      document.getElementById('logs').classList.add('active');
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => {
        if (b.textContent.includes('Logs')) b.classList.add('active');
      });
    } else {
      showError(result.message || 'Failed to start strategy');
    }
  } catch (e) {
    console.error('Failed to start strategy:', e);
  }
}

async function stopIndividualStrategy(strategyName) {
  if (!confirm(`Stop strategy '${strategyName}'?`)) return;
  
  try {
    const result = await apiCall('POST', `/strategy/${strategyName}/stop-execution`);
    if (result.success) {
      showSuccess(`âœ“ Strategy '${strategyName}' stopped`);
      updateRunnerStatus();
      loadLogs();
    } else {
      showError(result.message || 'Failed to stop strategy');
    }
  } catch (e) {
    console.error('Failed to stop strategy:', e);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTROL TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function startRunner() {
  try {
    const result = await apiCall('POST', '/runner/start');
    runnerActive = true;
    updateRunnerStatus();
    showSuccess(`âœ“ Runner started with ${result.strategies_loaded} strategies`);
    displayActiveStrategies(result.strategies);
    loadLogs(); // Auto-load logs
  } catch (e) {
    console.error('Failed to start runner:', e);
  }
}

async function stopRunner() {
  try {
    await apiCall('POST', '/runner/stop');
    runnerActive = false;
    updateRunnerStatus();
    showSuccess('âœ“ Runner stopped');
    document.getElementById('active-strategies-widget').style.display = 'none';
    loadLogs();
  } catch (e) {
    console.error('Failed to stop runner:', e);
  }
}

async function updateRunnerStatus() {
  try {
    const result = await apiCall('GET', '/runner/status');
    runnerActive = result.is_running;
    document.getElementById('runner-status').textContent = `Status: ${runnerActive ? 'ğŸŸ¢ ONLINE' : 'âš« OFFLINE'}`;
    document.getElementById('runner-status-text').textContent = runnerActive ? 'ğŸŸ¢ RUNNING' : 'âš« OFFLINE';
    document.getElementById('runner-status-text').style.color = runnerActive ? 'var(--success)' : '#999';
    document.getElementById('strategies-count').textContent = result.strategies_active || 0;
    
    if (result.active_strategies && result.active_strategies.length > 0) {
      document.getElementById('active-strategies-widget').style.display = 'block';
      displayActiveStrategies(result.active_strategies);
      // Auto-load logs when strategies are active
      loadLogs();
    } else {
      document.getElementById('active-strategies-widget').style.display = 'none';
    }
  } catch (e) {
    console.error('Failed to get runner status:', e);
  }
}

function displayActiveStrategies(strategies) {
  const list = document.getElementById('active-strategies-list');
  if (!strategies || !strategies.length) {
    list.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--muted);">No active strategies</td></tr>';
    return;
  }

  list.innerHTML = strategies.map(s => `
    <tr>
      <td>${s}</td>
      <td>-</td>
      <td>-</td>
      <td><span class="badge badge-running">RUNNING</span></td>
    </tr>
  `).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOGS TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function loadLogs() {
  try {
    const result = await apiCall('GET', '/runner/logs');
    displayLogs(result.logs || []);
    document.getElementById('log-count').textContent = `${result.logs?.length || 0} entries`;
  } catch (e) {
    console.error('Failed to load logs:', e);
  }
}

function displayLogs(logs) {
  const mainContainer = document.getElementById('logger-body');
  const controlContainer = document.getElementById('control-logs-body');
  
  if (!logs || !logs.length) {
    const emptyMsg = '<div style="color: var(--muted); text-align: center; padding: 40px;">No logs available</div>';
    if (mainContainer) mainContainer.innerHTML = emptyMsg;
    if (controlContainer && runnerActive) controlContainer.innerHTML = '<div style="color: var(--muted); text-align: center; padding: 20px;">No logs yet...</div>';
    return;
  }

  const logsHtml = logs.map(log => `
    <div class="log-entry ${log.level}" style="padding: 6px; border-bottom: 1px solid rgba(255,255,255,0.03);">
      <span class="log-time" style="color: var(--muted); font-size: 10px;">${log.timestamp}</span>
      <span class="log-level" style="font-weight: 600; color: ${
        log.level === 'ERROR' ? 'var(--danger)' : 
        log.level === 'WARNING' ? 'var(--warning)' :
        log.level === 'INFO' ? 'var(--success)' : 
        'var(--primary)'
      };">[${log.level}]</span>
      <span style="margin-left: 8px;">${log.message}</span>
    </div>
  `).join('');

  // Update main logs panel
  if (mainContainer) {
    mainContainer.innerHTML = logsHtml;
    mainContainer.scrollTop = mainContainer.scrollHeight;
  }
  
  // Update control panel logs (show last 10 entries only to save space)
  if (controlContainer && runnerActive) {
    const recentLogs = logs.slice(-10).reverse().map(log => `
      <div style="padding: 4px 6px; border-bottom: 1px solid rgba(255,255,255,0.03); font-size: 10px;">
        <span style="color: var(--muted);">${log.timestamp}</span>
        <span style="margin: 0 4px; color: ${
          log.level === 'ERROR' ? 'var(--danger)' : 
          log.level === 'WARNING' ? 'var(--warning)' :
          'inherit'
        };">${log.level}</span>
        <span style="color: var(--text);">${log.message.substring(0, 100)}</span>
      </div>
    `).join('');
    controlContainer.innerHTML = recentLogs;
    controlContainer.scrollTop = controlContainer.scrollHeight;
  }
}

function clearLogs() {
  if (!confirm('Clear all logs?')) return;
  document.getElementById('logger-body').innerHTML = '<div style="color: var(--muted); text-align: center; padding: 40px;">Logs cleared</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showSuccess(msg) {
  console.log('âœ“', msg);
  // Could add toast notification here
}

function showError(msg) {
  console.error('âœ—', msg);
  alert('Error: ' + msg);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INITIALIZATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

window.addEventListener('load', () => {
  reloadStrategies();
  updateRunnerStatus();
  
  // Poll runner status every 3 seconds to check for active strategies
  setInterval(updateRunnerStatus, 3000);
  
  // Poll logs frequently when strategies are active - every 2 seconds
  let logsPollInterval = setInterval(() => {
    try {
      const result = document.getElementById('logger-body');
      if (result && runnerActive) {
        // Load logs whenever runner is active, not just on logs tab
        loadLogs();
      }
    } catch (e) {
      // Silent error handling for polling
    }
  }, 2000);
});

</script>
</body>
</html>
