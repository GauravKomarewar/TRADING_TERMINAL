<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Option Chain â€“ Shoonya OMS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/dashboard/web/styles/common.css">
    <link rel="stylesheet" href="/dashboard/web/shared/layout.css">
    <script src="/dashboard/web/shared/layout.js" defer></script>
    <style>
        :root {
            --bg: #0a0e13;
            --panel: #151b26;
            --border: #2d3548;
            --text: #f1f5f9;
            --muted: #94a3b8;
            --primary: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --atm: #f59e0b;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.4;
            font-size: 12px;
        }
        
        /* Header */
        header {
            height: 56px;
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 16px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }
        
        .nav-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .brand {
            font-weight: 700;
            font-size: 18px;
            color: var(--primary);
            cursor: pointer;
        }
        
        .nav-link {
            color: var(--muted);
            font-size: 13px;
            text-decoration: none;
            padding: 6px 10px;
            border-radius: 4px;
            transition: all 0.2s;
            display: inline-block;
            border: 1px solid transparent;
        }
        
        .nav-link:hover {
            color: var(--text);
            background: rgba(28, 35, 51, 0.8);
            border-color: var(--primary);
        }
        
        .nav-link.active {
            color: var(--primary);
            background: rgba(59, 130, 246, 0.15);
            border-color: var(--primary);
            font-weight: 600;
        }
        
        /* Main Layout */
        main {
            margin-top: 56px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 100vh;
        }
        
        /* Top Controls Container */
        .top-controls-container {
            display: grid;
            grid-template-columns: 160px 1fr;
            gap: 10px;
            min-height: 120px;
        }
        
        /* Left Control Panel */
        .control-panel {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            height: fit-content;
        }
        
        .control-panel select,
        .control-panel button,
        .control-panel .symbol-combo {
            width: 100%;
        }
        
        /* Info Panel */
        .info-panel {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            grid-template-rows: auto auto auto;
        }
        
        .info-panel .info-item {
            min-width: 0;
        }
        
        .info-label {
            font-size: 9px;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 3px;
        }
        
        .info-value {
            font-size: 14px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            word-break: break-word;
        }
        
        select {
            padding: 6px 8px;
            background: #1c2333;
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 4px;
            font-size: 11px;
            height: 28px;
            width: 100%;
        }
        
        select:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Searchable Symbol Combobox */
        .symbol-combo {
            position: relative;
            width: 100%;
        }
        .symbol-input {
            padding: 6px 24px 6px 8px;
            background: #1c2333;
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 4px;
            font-size: 11px;
            height: 28px;
            width: 100%;
            box-sizing: border-box;
            outline: none;
            font-weight: 600;
            text-transform: uppercase;
        }
        .symbol-input:focus {
            border-color: var(--primary);
        }
        .symbol-arrow {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--muted);
            font-size: 11px;
            pointer-events: none;
        }
        .symbol-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 2px;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 200;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        .symbol-dropdown.open {
            display: block;
        }
        .symbol-option {
            padding: 6px 8px;
            font-size: 11px;
            cursor: pointer;
            color: var(--text);
        }
        .symbol-option:hover, .symbol-option.highlight {
            background: rgba(59,130,246,0.15);
        }
        .symbol-option.selected {
            color: var(--primary);
            font-weight: 700;
        }
        .symbol-option.hidden {
            display: none;
        }
        
        .column-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 4px;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px;
            min-width: 200px;
            display: none;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .column-dropdown.show {
            display: block;
        }
        
        .column-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .column-option:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        
        .column-option input[type="checkbox"] {
            cursor: pointer;
        }
        
        .column-option label {
            cursor: pointer;
            flex: 1;
            font-size: 12px;
        }
        
        /* Info Bar */
        .info-bar {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 12px;
            margin-bottom: 8px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            max-height: 70px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
            justify-content: center;
        }
        
        .info-label {
            font-size: 9px;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .info-value {
            font-size: 13px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }
        
        .spot-price {
            color: var(--success);
        }
        

        
        .future-price {
            color: var(--primary);
        }
        
        .atm-price {
            color: var(--atm);
        }
        
        /* Option Chain Container */
        .chain-container {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
        }
        
        .table-wrapper {
            overflow-x: auto;
            max-height: calc(100vh - 200px);
        }
        
        /* Table Styles */
        .option-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            min-width: 900px;
        }
        
        .option-table th {
            padding: 8px 6px;
            text-align: center;
            font-weight: 700;
            color: var(--muted);
            text-transform: uppercase;
            font-size: 10px;
            letter-spacing: 0.3px;
            border-bottom: 1px solid var(--border);
            background: #1c2333;
            position: sticky;
            top: 0;
            z-index: 20;
            white-space: nowrap;
        }
        
        .option-table th.section-header {
            background: var(--panel);
            color: var(--text);
            font-size: 12px;
            padding: 10px 6px;
            font-weight: 800;
        }
        
        .option-table th.calls-header {
            background: linear-gradient(to bottom, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05));
            color: var(--success);
        }
        
        .option-table th.puts-header {
            background: linear-gradient(to bottom, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.05));
            color: var(--danger);
        }
        
        .option-table td {
            padding: 6px 6px;
            text-align: center;
            border-bottom: 1px solid rgba(45, 53, 72, 0.3);
            font-variant-numeric: tabular-nums;
            position: relative;
            height: 36px;
        }
        
        .option-table tbody tr {
            transition: background 0.2s;
            cursor: pointer;
        }
        
        .option-table tbody tr:hover {
            background: rgba(59, 130, 246, 0.08);
        }
        
        /* ATM Row - Enhanced Orange Highlighting */
        .atm-row {
            background: rgba(245, 158, 11, 0.2) !important;
            border-top: 2px solid var(--atm);
            border-bottom: 2px solid var(--atm);
        }
        
        .atm-row td {
            border-top: 2px solid rgba(245, 158, 11, 0.5);
            border-bottom: 2px solid rgba(245, 158, 11, 0.5);
        }
        
        .atm-row .strike-cell {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
            color: #000;
            font-weight: 900;
            position: relative;
            border-left: 2px solid var(--atm);
            border-right: 2px solid var(--atm);
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.3);
        }
        
        .atm-row .strike-cell::before {
            content: "ATM";
            position: absolute;
            top: 3px;
            right: 6px;
            font-size: 8px;
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        /* Strike Cell */
        .strike-cell {
            background: #1c2333;
            font-weight: 700;
            color: var(--primary);
            border-left: 1px solid var(--border);
            border-right: 1px solid var(--border);
            min-width: 80px;
            position: sticky;
            left: 0;
            z-index: 10;
            font-size: 12px;
        }
        
        /* ITM/OTM Styling - Enhanced Gradients */
        .call-itm {
            background: linear-gradient(90deg, 
                rgba(16, 185, 129, 0.18) 0%, 
                rgba(16, 185, 129, 0.12) 50%, 
                rgba(16, 185, 129, 0.05) 100%);
        }
        
        .call-otm {
            background: linear-gradient(90deg, 
                rgba(16, 185, 129, 0.06) 0%, 
                rgba(16, 185, 129, 0.03) 50%, 
                transparent 100%);
        }
        
        .put-itm {
            background: linear-gradient(270deg, 
                rgba(239, 68, 68, 0.18) 0%, 
                rgba(239, 68, 68, 0.12) 50%, 
                rgba(239, 68, 68, 0.05) 100%);
        }
        
        .put-otm {
            background: linear-gradient(270deg, 
                rgba(239, 68, 68, 0.06) 0%, 
                rgba(239, 68, 68, 0.03) 50%, 
                transparent 100%);
        }
        
        /* LTP Cells */
        .ltp-cell {
            font-weight: 700;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 3px;
            padding: 4px 0;
            min-width: 70px;
        }
        
        .ltp-cell:hover {
            background: rgba(59, 130, 246, 0.25);
            transform: scale(1.05);
        }
        
        .positive {
            color: var(--success);
        }
        
        .negative {
            color: var(--danger);
        }
        
        /* Bar Indicators */
        .bar-container {
            position: relative;
            height: 22px;
            margin: 2px 0;
            border-radius: 3px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.2);
        }
        
        .bar-fill {
            position: absolute;
            top: 0;
            bottom: 0;
            opacity: 0.25;
            transition: width 0.3s ease;
        }
        
        .bar-text {
            position: relative;
            z-index: 1;
            font-weight: 600;
            line-height: 22px;
        }
        
        .bar-call {
            background: var(--success);
            left: 0;
        }
        
        .bar-put {
            background: var(--danger);
            right: 0;
        }
        
        /* Hidden columns */
        .col-hidden {
            display: none;
        }
        
        /* Basket */
        .basket-indicator {
            position: relative;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background 0.2s;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid var(--border);
            font-size: 12px;
            white-space: nowrap;
        }
        
        .basket-indicator:hover {
            background: rgba(59, 130, 246, 0.2);
        }
        
        .basket-count {
            position: absolute;
            top: -6px;
            right: -6px;
            background: var(--danger);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
            display: none;
        }
        
        .basket-count.show {
            display: block;
        }
        
        /* Loading States */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--muted);
            font-size: 13px;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: var(--muted);
            font-size: 13px;
        }
        
        .error-msg {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            padding: 10px 12px;
            border-radius: 4px;
            margin-bottom: 10px;
            border: 1px solid rgba(239, 68, 68, 0.3);
            display: none;
        }
        
        /* Value change animation - subtle and transparent */
        @keyframes valueChange {
            0% { background-color: rgba(59, 130, 246, 0.08); }
            100% { background-color: transparent; }
        }
        
        .value-changed {
            animation: valueChange 0.6s ease-out;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            font-size: 14px;
        }
        
        .modal-body {
            padding: 16px;
        }
        
        .modal-footer {
            padding: 16px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        /* Order Entry Popup */
        .order-popup {
            position: absolute;
            background: var(--panel);
            border: 2px solid var(--primary);
            border-radius: 6px;
            padding: 12px;
            min-width: 250px;
            z-index: 1000;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            display: none;
        }
        
        .order-popup.show {
            display: block;
        }
        
        .order-popup-header {
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }
        
        .order-popup-close {
            cursor: pointer;
            color: var(--muted);
            font-size: 18px;
            line-height: 1;
        }
        
        .order-form-group {
            margin-bottom: 8px;
        }
        
        .order-form-label {
            font-size: 10px;
            color: var(--muted);
            display: block;
            margin-bottom: 3px;
        }
        
        .order-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .order-form-input {
            width: 100%;
            padding: 5px 6px;
            background: #1c2333;
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 4px;
            font-size: 12px;
        }
        
        .order-form-actions {
            display: flex;
            gap: 6px;
            margin-top: 10px;
        }
        
        .order-form-actions button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: background 0.2s;
            flex: 1;
        }
        
        .order-form-actions button:hover {
            background: #2563eb;
        }
        
        button {
            cursor: pointer;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .top-controls-container {
                grid-template-columns: 1fr;
            }
            
            .info-panel {
                grid-template-columns: repeat(2, 1fr);
                max-height: none;
            }
        }
        
        @media (max-width: 768px) {
            main {
                padding: 8px;
            }
            
            .top-controls-container {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .info-panel {
                grid-template-columns: repeat(2, 1fr);
                padding: 8px;
                gap: 8px;
            }
        }
    </style>
</head>
<body data-page="option-chain">
<div id="app-header"></div>

<main>
    <div id="errorMsg" class="error-msg"></div>
    
    <!-- Top Controls and Info Container -->
    <div class="top-controls-container">
        <!-- Left Control Panel -->
        <div class="control-panel">
            <div class="symbol-combo" id="symbolCombo">
                <input type="text" id="symbolInput" class="symbol-input" value="" placeholder="Loading symbols..." autocomplete="off" spellcheck="false" disabled>
                <span class="symbol-arrow">â–¾</span>
                <div class="symbol-dropdown" id="symbolDropdown">
                    <div class="symbol-option" style="color:var(--muted);cursor:default">Loading...</div>
                </div>
            </div>
            <!-- Hidden select kept for JS compatibility -->
            <select id="symbol" style="display:none">
                <option value="">Loading...</option>
            </select>
            
            <select id="expiry">
                <option>Loading...</option>
            </select>
            
            <div class="column-selector" style="position: relative;">
                <button id="columnSelectorBtn" style="padding: 6px 8px; background: #1c2333; border: 1px solid var(--border); color: var(--text); border-radius: 4px; font-size: 11px; height: 28px; cursor: pointer; width: 100%;">
                    ðŸ“Š Columns
                </button>
                <div id="columnDropdown" class="column-dropdown" style="width: 180px;">
                    <div class="column-option">
                        <input type="checkbox" id="col-oi" checked>
                        <label for="col-oi">Open Interest (OI)</label>
                    </div>
                    <div class="column-option">
                        <input type="checkbox" id="col-volume" checked>
                        <label for="col-volume">Volume</label>
                    </div>
                    <div class="column-option">
                        <input type="checkbox" id="col-iv" checked>
                        <label for="col-iv">IV%</label>
                    </div>
                    <div class="column-option">
                        <input type="checkbox" id="col-delta" checked>
                        <label for="col-delta">Delta (Î”)</label>
                    </div>
                    <div class="column-option">
                        <input type="checkbox" id="col-gamma" checked>
                        <label for="col-gamma">Gamma (Î“)</label>
                    </div>
                    <div class="column-option">
                        <input type="checkbox" id="col-theta" checked>
                        <label for="col-theta">Theta (Î˜)</label>
                    </div>
                    <div class="column-option">
                        <input type="checkbox" id="col-vega" checked>
                        <label for="col-vega">Vega (Î½)</label>
                    </div>
                    <div class="column-option">
                        <input type="checkbox" id="col-change" checked>
                        <label for="col-change">Change %</label>
                    </div>
                </div>
            </div>
            
            <div class="basket-indicator" onclick="openBasketModal()" style="padding: 6px 8px; font-size: 11px; text-align: center;">
                ðŸ›’ Basket
                <span id="basketCount" class="basket-count"></span>
            </div>
        </div>
        
        <!-- Right Info Panel - Row 1: Spot LTP, Future LTP, ATM Strike, PCR -->
        <!-- Row 2: Total OI, CE OI, PE OI, Last Updated -->
        <!-- Row 3: Spread, Implied Vol, Call Volume, Put Volume -->
        <div class="info-panel">
            <div class="info-item">
                <div class="info-label">Spot LTP</div>
                <div class="info-value spot-price" id="spotPrice">â‚¹0.00</div>
            </div>
            <div class="info-item">
                <div class="info-label">Future LTP</div>
                <div class="info-value future-price" id="futurePrice">â‚¹0.00</div>
            </div>
            <div class="info-item">
                <div class="info-label">ATM Strike</div>
                <div class="info-value atm-price" id="atmStrike">0</div>
            </div>
            <div class="info-item">
                <div class="info-label">Spread</div>
                <div class="info-value" id="spreadValue" style="font-size: 12px;">â‚¹0.00</div>
            </div>
            
            <!-- Row 2 -->
            <div class="info-item">
                <div class="info-label">Total OI</div>
                <div class="info-value" id="totalOI">0</div>
            </div>
            <div class="info-item">
                <div class="info-label">CE OI</div>
                <div class="info-value" id="ceOi">0</div>
            </div>
            <div class="info-item">
                <div class="info-label">PE OI</div>
                <div class="info-value" id="peOi">0</div>
            </div>
            <div class="info-item">
                <div class="info-label">Call/Put Ratio</div>
                <div class="info-value" id="pcr">0.00</div>
            </div>
            
            <!-- Row 3 - Additional Analytics -->
            <div class="info-item">
                <div class="info-label">Total Volume</div>
                <div class="info-value" id="totalVolume" style="font-size: 12px;">0</div>
            </div>
            <div class="info-item">
                <div class="info-label">Call Volume</div>
                <div class="info-value" id="ceVolume" style="font-size: 12px;">0</div>
            </div>
            <div class="info-item">
                <div class="info-label">Put Volume</div>
                <div class="info-value" id="peVolume" style="font-size: 12px;">0</div>
            </div>
            <div class="info-item">
                <div class="info-label">Last Updated</div>
                <div class="info-value" id="lastUpdated" style="font-size: 12px;">--:--:--</div>
            </div>
        </div>
    </div>
    
    <!-- Option Chain Table -->
    <div class="chain-container">
        <div class="table-wrapper">
            <table class="option-table" id="optionTable">
                <thead id="tableHeader">
                    <!-- Headers will be generated here -->
                </thead>
                <tbody id="tableBody">
                    <!-- Table rows will be generated here -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Order Entry Popup -->
    <div id="orderPopup" class="order-popup">
        <div class="order-popup-content">
            <div class="order-popup-header">
                <span id="orderPopupTitle">Place Order</span>
                <span class="order-popup-close" onclick="closeOrderPopup()">&times;</span>
            </div>
            <div class="order-form-group">
                <label class="order-form-label">Side</label>
                <div class="order-form-row">
                    <button id="orderSideBuy" class="order-form-input" style="background:var(--success)" onclick="setOrderSide('BUY')">BUY</button>
                    <button id="orderSideSell" class="order-form-input" style="background:var(--danger)" onclick="setOrderSide('SELL')">SELL</button>
                </div>
            </div>
            <div class="order-form-group">
                <label class="order-form-label">Quantity (Lots)</label>
                <input type="number" id="orderQty" class="order-form-input" value="1" min="1">
            </div>
            <div class="order-form-group">
                <label class="order-form-label">Product Type</label>
                <div class="order-form-row">
                    <button id="orderProductMIS" class="order-form-input" onclick="setOrderProduct('MIS')">MIS</button>
                    <button id="orderProductNRML" class="order-form-input" onclick="setOrderProduct('NRML')">NRML</button>
                </div>
            </div>
            <div class="order-form-group">
                <label class="order-form-label">Execution Type</label>
                <div class="order-form-row">
                    <button id="orderExecEntry" class="order-form-input" onclick="setOrderExecution('ENTRY')" style="background:var(--primary)">ENTRY</button>
                    <button id="orderExecExit" class="order-form-input" style="opacity:0.5;background:var(--muted)" onclick="setOrderExecution('EXIT')">EXIT</button>
                </div>
            </div>
            <div class="order-form-group">
                <label class="order-form-label">Price Type</label>
                <div class="order-form-row">
                    <button id="orderPriceTypeMKT" class="order-form-input" onclick="setOrderPriceType('MARKET')">MARKET</button>
                    <button id="orderPriceTypeLMT" class="order-form-input" onclick="setOrderPriceType('LIMIT')">LIMIT</button>
                </div>
            </div>
            <div class="order-form-group" id="orderPriceGroup">
                <label class="order-form-label">Price</label>
                <input type="number" id="orderPrice" class="order-form-input" step="0.05">
            </div>
            <div class="order-form-actions">
                <button onclick="closeOrderPopup()" style="background:var(--muted)">Cancel</button>
                <button onclick="confirmOrderEntry()" style="background:var(--success)">Add to Basket</button>
            </div>
        </div>
    </div>
    
    <!-- Basket Modal -->
    <div id="basketModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>ðŸ›’ Order Basket</span>
                <button onclick="closeBasketModal()" style="background:transparent;border:none;color:var(--muted);font-size:20px;cursor:pointer;padding:0">&times;</button>
            </div>
            <div class="modal-body">
                <div id="basketItems"></div>
            </div>
            <div class="modal-footer">
                <button onclick="closeBasketModal()" style="background:var(--muted);padding:8px 16px;border:none;border-radius:4px;color:white;font-size:12px">Cancel</button>
                <button id="confirmBasketBtn" onclick="placeBasketOrders()" style="background:var(--success);padding:8px 16px;border:none;border-radius:4px;color:white;font-size:12px">Confirm & Place Orders</button>
            </div>
        </div>
    </div>
</main>

<script>
    // Configuration
    const config = {
        autoRefreshInterval: 1000,  // 1 second for real-time background updates
        lastChainData: {}
    };
    
    // Column visibility state
    const columnVisibility = {
        oi: true,
        volume: true,
        iv: true,
        delta: true,
        gamma: true,
        theta: true,
        vega: true,
        change: true
    };
    
    // State
    let chainData = {};
    let currentSpotPrice = 0;
    let currentFuturePrice = 0;
    let atmStrike = 0;
    let autoRefreshTimer = null;
    let selectedStrike = null;
    let basket = [];
    let isFirstLoad = true;
    let currentStrikes = [];
    let totalCeOi = 0;
    let totalPeOi = 0;
    
    // Symbol â†’ exchange mapping from API
    let symbolExchangeMap = {};  // e.g. { NIFTY: 'NFO', CRUDEOILM: 'MCX' }
    let activeSymbolData = [];   // full API response
    
    // DOM Elements
    const elements = {
        symbol: document.getElementById('symbol'),
        expiry: document.getElementById('expiry'),
        tableHeader: document.getElementById('tableHeader'),
        tableBody: document.getElementById('tableBody'),
        errorMsg: document.getElementById('errorMsg'),
        spotPrice: document.getElementById('spotPrice'),
        futurePrice: document.getElementById('futurePrice'),
        atmStrikeEl: document.getElementById('atmStrike'),
        ceOi: document.getElementById('ceOi'),
        peOi: document.getElementById('peOi'),
        totalOI: document.getElementById('totalOI'),
        pcr: document.getElementById('pcr'),
        lastUpdated: document.getElementById('lastUpdated'),
        basketCount: document.getElementById('basketCount'),
        basketModal: document.getElementById('basketModal'),
        basketItems: document.getElementById('basketItems'),
        orderPopup: document.getElementById('orderPopup'),
        orderPopupTitle: document.getElementById('orderPopupTitle'),
        orderQty: document.getElementById('orderQty'),
        orderPrice: document.getElementById('orderPrice'),
        orderSideBuy: document.getElementById('orderSideBuy'),
        orderSideSell: document.getElementById('orderSideSell'),
        orderProductMIS: document.getElementById('orderProductMIS'),
        orderProductNRML: document.getElementById('orderProductNRML'),
        orderPriceTypeMKT: document.getElementById('orderPriceTypeMKT'),
        orderPriceTypeLMT: document.getElementById('orderPriceTypeLMT'),
        orderPriceGroup: document.getElementById('orderPriceGroup'),
        columnSelectorBtn: document.getElementById('columnSelectorBtn'),
        columnDropdown: document.getElementById('columnDropdown'),
        // New info panel elements
        spreadValue: document.getElementById('spreadValue'),
        ceVolume: document.getElementById('ceVolume'),
        peVolume: document.getElementById('peVolume'),
        totalVolume: document.getElementById('totalVolume')
    };
    
    // Current order entry
    let currentOrderEntry = {
        strike: null,
        optionType: null,
        ltp: null,
        tradingSymbol: null,
        lotSize: 1,
        qtyLots: 1,
        qty: 1,
        side: 'BUY',
        execution: 'ENTRY',  // NEW: Execution type (ENTRY/EXIT)
        product: 'MIS',
        priceType: 'LIMIT',
        price: null
    };
    
    // Initialize
    function init() {
        initSymbolCombo();
        setupEventListeners();
        // Load symbols from DB, then expiries, then start refresh
        loadActiveSymbols();
        updateBasketUI();
    }
    
    // Searchable symbol combobox â€” direct DB file mapping
    // Each symbol maps directly to its sqlite file: just "NIFTY" â†’ NFO_NIFTY_10-FEB-2026.sqlite
    function initSymbolCombo() {
        const combo = document.getElementById('symbolCombo');
        const input = document.getElementById('symbolInput');
        const dropdown = document.getElementById('symbolDropdown');
        const hiddenSelect = elements.symbol;
        const arrow = combo.querySelector('.symbol-arrow');
        let highlightIdx = -1;

        function getOptions() {
            return Array.from(dropdown.querySelectorAll('.symbol-option[data-value]'));
        }
        function getVisible() {
            return getOptions().filter(o => !o.classList.contains('hidden'));
        }
        function isOpen() { return dropdown.classList.contains('open'); }

        function openDropdown() {
            filterOptions(input.value);
            dropdown.classList.add('open');
        }
        function closeDropdown() {
            dropdown.classList.remove('open');
            highlightIdx = -1;
            getOptions().forEach(o => o.classList.remove('highlight'));
        }
        function filterOptions(query) {
            const q = query.trim().toUpperCase();
            getOptions().forEach(opt => {
                const match = !q || opt.dataset.value.toUpperCase().includes(q);
                opt.classList.toggle('hidden', !match);
            });
            highlightIdx = -1;
            getOptions().forEach(o => o.classList.remove('highlight'));
        }
        function selectSymbol(val) {
            val = val.toUpperCase();
            input.value = val;
            // Sync hidden select
            let opt = hiddenSelect.querySelector(`option[value="${val}"]`);
            if (!opt) {
                opt = document.createElement('option');
                opt.value = val; opt.textContent = val;
                hiddenSelect.appendChild(opt);
            }
            hiddenSelect.value = val;
            getOptions().forEach(o => o.classList.toggle('selected', o.dataset.value === val));
            closeDropdown();
            input.blur();
            // Fire change so setupEventListeners handler runs
            hiddenSelect.dispatchEvent(new Event('change'));
        }
        function setHighlight(idx) {
            const visible = getVisible();
            if (!visible.length) return;
            highlightIdx = Math.max(0, Math.min(idx, visible.length - 1));
            getOptions().forEach(o => o.classList.remove('highlight'));
            visible[highlightIdx].classList.add('highlight');
            visible[highlightIdx].scrollIntoView({ block: 'nearest' });
        }

        // Click on input: open/select text
        input.addEventListener('click', (e) => {
            e.stopPropagation();
            input.select();
            if (!isOpen()) openDropdown();
        });

        // Typing filters
        input.addEventListener('input', () => {
            if (!isOpen()) openDropdown();
            else filterOptions(input.value);
        });

        // Keyboard
        input.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (!isOpen()) openDropdown();
                setHighlight(highlightIdx + 1);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                setHighlight(highlightIdx - 1);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                const visible = getVisible();
                if (highlightIdx >= 0 && visible[highlightIdx]) {
                    selectSymbol(visible[highlightIdx].dataset.value);
                } else if (input.value.trim()) {
                    selectSymbol(input.value.trim());
                }
            } else if (e.key === 'Escape') {
                closeDropdown();
                input.value = hiddenSelect.value;
                input.blur();
            }
        });

        // Click on dropdown option â€” mousedown to prevent input blur race
        dropdown.addEventListener('mousedown', (e) => {
            e.preventDefault();   // prevent input blur
            e.stopPropagation();  // prevent combo/document handlers
            const opt = e.target.closest('.symbol-option[data-value]');
            if (opt) selectSymbol(opt.dataset.value);
        });

        // Arrow toggle
        arrow.addEventListener('click', (e) => {
            e.stopPropagation();
            if (isOpen()) {
                closeDropdown();
                input.blur();
            } else {
                input.focus();
                input.select();
                openDropdown();
            }
        });

        // Close on outside click
        document.addEventListener('click', (e) => {
            if (!combo.contains(e.target)) closeDropdown();
        });

        // Blur: restore value if invalid, close dropdown (with delay for click handlers)
        input.addEventListener('blur', () => {
            setTimeout(() => {
                if (!combo.contains(document.activeElement)) {
                    closeDropdown();
                    // Restore to last valid symbol if user left garbage in input
                    if (input.value !== hiddenSelect.value) {
                        input.value = hiddenSelect.value;
                    }
                }
            }, 150);
        });
    }

    // Load active symbols from supervisor DB files
    // Maps symbol name (e.g. "NIFTY") directly to its DB file (NFO_NIFTY_10-FEB-2026.sqlite)
    async function loadActiveSymbols() {
        const input = document.getElementById('symbolInput');
        const dropdown = document.getElementById('symbolDropdown');
        const hiddenSelect = elements.symbol;

        try {
            const res = await fetch('/dashboard/option-chain/active-symbols', { credentials: 'include' });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            activeSymbolData = await res.json();
            console.log('[OptionChain] DB files found:', activeSymbolData.map(s => `${s.exchange}_${s.symbol} [${s.expiries.join(',')}]`));

            if (!activeSymbolData || activeSymbolData.length === 0) {
                input.value = '';
                input.placeholder = 'No DB files found';
                dropdown.innerHTML = '<div class="symbol-option" style="color:var(--muted);cursor:default">No active chains in data/ folder</div>';
                return;
            }

            // Build direct symbol â†’ exchange map from DB filenames
            symbolExchangeMap = {};
            activeSymbolData.forEach(item => {
                symbolExchangeMap[item.symbol] = item.exchange;
            });

            // NIFTY first (if exists), otherwise first available
            let defaultIdx = activeSymbolData.findIndex(s => s.symbol === 'NIFTY');
            if (defaultIdx < 0) defaultIdx = 0;
            const defaultItem = activeSymbolData[defaultIdx];

            // Populate combobox dropdown options
            dropdown.innerHTML = activeSymbolData.map((item, idx) => {
                const label = item.exchange !== 'NFO' ? `${item.symbol} (${item.exchange})` : item.symbol;
                const sel = idx === defaultIdx ? ' selected' : '';
                return `<div class="symbol-option${sel}" data-value="${item.symbol}" data-exchange="${item.exchange}">${label}</div>`;
            }).join('');

            // Populate hidden <select> for JS compatibility
            hiddenSelect.innerHTML = activeSymbolData.map((item, idx) =>
                `<option value="${item.symbol}"${idx === defaultIdx ? ' selected' : ''}>${item.symbol}</option>`
            ).join('');

            // Set default symbol in input + hidden select
            input.value = defaultItem.symbol;
            input.placeholder = 'Type symbol...';
            input.disabled = false;
            hiddenSelect.value = defaultItem.symbol;

            console.log('[OptionChain] Default:', defaultItem.symbol, '| Exchange:', defaultItem.exchange,
                        '| Expiries:', defaultItem.expiries);

            // Directly load expiries + chain for default symbol from DB
            populateExpiries(defaultItem.expiries);
            await loadOptionChain();
            startAutoRefresh();

        } catch (err) {
            console.error('[OptionChain] Failed to load symbols from DB:', err);
            // Fallback: manual NIFTY
            input.value = 'NIFTY';
            input.placeholder = 'Type symbol...';
            input.disabled = false;
            symbolExchangeMap['NIFTY'] = 'NFO';
            hiddenSelect.innerHTML = '<option value="NIFTY" selected>NIFTY</option>';
            hiddenSelect.value = 'NIFTY';
            dropdown.innerHTML = '<div class="symbol-option selected" data-value="NIFTY" data-exchange="NFO">NIFTY</div>';
            await loadExpiries();
            startAutoRefresh();
        }
    }

    // Populate expiry dropdown from data (no API call)
    function populateExpiries(expiries) {
        if (!Array.isArray(expiries) || expiries.length === 0) {
            elements.expiry.innerHTML = '<option>No expiries</option>';
            elements.expiry.disabled = true;
            return;
        }
        elements.expiry.innerHTML = expiries.map(e =>
            `<option value="${e}">${e}</option>`
        ).join('');
        elements.expiry.disabled = false;
        elements.expiry.value = expiries[0];
    }
    
    // Event Listeners
    function setupEventListeners() {
        elements.symbol.addEventListener('change', async () => {
            stopAutoRefresh();
            // When symbol changes, try to use cached expiries first
            const sym = elements.symbol.value;
            const item = activeSymbolData.find(s => s.symbol === sym);
            if (item && item.expiries && item.expiries.length > 0) {
                populateExpiries(item.expiries);
                await loadOptionChain();
            } else {
                await loadExpiries();
            }
            startAutoRefresh();
        });
        
        elements.expiry.addEventListener('change', () => {
            stopAutoRefresh();
            loadOptionChain();
            startAutoRefresh();
        });
        
        // Column selector
        elements.columnSelectorBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            elements.columnDropdown.classList.toggle('show');
        });
        
        // Column checkboxes
        Object.keys(columnVisibility).forEach(col => {
            const checkbox = document.getElementById(`col-${col}`);
            if (checkbox) {
                checkbox.addEventListener('change', () => {
                    columnVisibility[col] = checkbox.checked;
                    renderTable();
                });
            }
        });
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!elements.columnDropdown.contains(e.target) && e.target !== elements.columnSelectorBtn) {
                elements.columnDropdown.classList.remove('show');
            }
            
            if (e.target === elements.basketModal) {
                closeBasketModal();
            }
            
            const popup = document.getElementById('orderPopup');
            if (popup.classList.contains('show') && !popup.contains(e.target)) {
                closeOrderPopup();
            }
        });
    }
    
    // Auto Refresh - Background data update
    function startAutoRefresh() {
        stopAutoRefresh();
        
        autoRefreshTimer = setInterval(() => {
            if (elements.symbol.value && elements.expiry.value) {
                loadOptionChain(true);  // Auto-refresh with smart update
            }
        }, config.autoRefreshInterval);
        
        console.log(`Auto-refresh started: ${config.autoRefreshInterval}ms interval`);
    }
    
    function stopAutoRefresh() {
        if (autoRefreshTimer) {
            clearInterval(autoRefreshTimer);
            autoRefreshTimer = null;
            console.log('Auto-refresh stopped');
        }
    }
    

    
    // Error Handling
    function showError(message) {
        elements.errorMsg.textContent = message;
        elements.errorMsg.style.display = 'block';
        setTimeout(() => {
            elements.errorMsg.style.display = 'none';
        }, 5000);
    }
    
    // Helper: get exchange for current symbol
    function getCurrentExchange() {
        const sym = elements.symbol.value;
        return symbolExchangeMap[sym] || 'NFO';
    }

    // Load Expiries
    async function loadExpiries() {
        try {
            elements.expiry.innerHTML = '<option>Loading...</option>';
            elements.expiry.disabled = true;
            
            const exchange = getCurrentExchange();
            const res = await fetch(
                `/dashboard/option-chain/active-expiries?exchange=${exchange}&symbol=${elements.symbol.value}`,
                { credentials: 'include' }
            );
            
            if (!res.ok) throw new Error(`Failed to load expiries: ${res.status}`);
            
            const expiries = await res.json();
            
            if (!Array.isArray(expiries) || expiries.length === 0) {
                elements.expiry.innerHTML = '<option>No expiries</option>';
                elements.tableBody.innerHTML = '<tr><td colspan="100" class="no-data">No data available</td></tr>';
                return;
            }
            
            elements.expiry.innerHTML = expiries.map(e => {
                const expiryValue = typeof e === 'string' ? e : e.expiry;
                return `<option value="${expiryValue}">${expiryValue}</option>`;
            }).join('');
            
            elements.expiry.disabled = false;
            
            if (expiries.length > 0) {
                const firstExpiry = typeof expiries[0] === 'string' ? expiries[0] : expiries[0].expiry;
                elements.expiry.value = firstExpiry;
                await loadOptionChain();
            }
            
        } catch (error) {
            console.error('Error loading expiries:', error);
            showError(error.message);
            elements.expiry.innerHTML = '<option>Error</option>';
            elements.expiry.disabled = false;
        }
    }
    
    // Load Option Chain
    async function loadOptionChain(isAutoRefresh = false) {
        try {
            console.log('[OptionChain] loadOptionChain called, isAutoRefresh:', isAutoRefresh);
            
            const res = await fetch(
                `/dashboard/option-chain?exchange=${getCurrentExchange()}&symbol=${elements.symbol.value}&expiry=${elements.expiry.value}&max_age=5`,
                { credentials: 'include' }
            );
            
            if (!res.ok) {
                const errorData = await res.json().catch(() => ({ detail: 'Unknown error' }));
                throw new Error(errorData.detail || `HTTP ${res.status}`);
            }
            
            const data = await res.json();
            console.log('[OptionChain] API Response received:', data.rows.length, 'rows');
            
            if (!data.rows || data.rows.length === 0) {
                elements.tableBody.innerHTML = '<tr><td colspan="100" class="no-data">No data available</td></tr>';
                return;
            }
            
            const newStrikes = Object.keys(processChainData(data.rows)).map(Number).sort((a, b) => a - b);
            const strikeListChanged = JSON.stringify(newStrikes) !== JSON.stringify(currentStrikes);
            
            console.log('[OptionChain] Strike list changed:', strikeListChanged);
            console.log('[OptionChain] Current strikes:', currentStrikes.length, '| New strikes:', newStrikes.length);
            
            // Update info bar FIRST so atmStrike is set before rendering table
            updateInfoBar(data.meta || {});
            console.log('[OptionChain] âœ“ Info bar updated');
            
            if (strikeListChanged || isFirstLoad) {
                console.log('[OptionChain] ðŸ”„ RENDERING FULL TABLE (strike list changed or first load)');
                isFirstLoad = false;
                currentStrikes = newStrikes;
                renderTable();
                console.log(`%câœ“ Table rendered with ${newStrikes.length} strikes`, 'color: green; font-weight: bold');
            } else {
                console.log('[OptionChain] ðŸ”„ CALLING SMART UPDATE (strike list unchanged)');
                // Force update all cells even if strike list hasn't changed
                smartUpdateValues(data.rows);
                console.log(`%câœ“ Smart update executed for ${data.rows.length} rows`, 'color: blue; font-weight: bold');
            }
            
        } catch (error) {
            console.error('Error loading option chain:', error);
            if (!isAutoRefresh) {
                showError(error.message);
            }
        }
    }
    
    function processChainData(rows) {
        const strikeMap = {};
        totalCeOi = 0;
        totalPeOi = 0;
        
        rows.forEach(row => {
            const strike = row.strike;
            if (!strikeMap[strike]) {
                strikeMap[strike] = { strike };
            }
            
            const prefix = row.option_type === 'CE' ? 'ce' : 'pe';
            strikeMap[strike][`${prefix}_ltp`] = parseFloat(row.ltp) || 0;
            strikeMap[strike][`${prefix}_change_pct`] = parseFloat(row.change_pct) || 0;
            strikeMap[strike][`${prefix}_volume`] = parseFloat(row.volume) || 0;
            strikeMap[strike][`${prefix}_oi`] = parseFloat(row.oi) || 0;
            strikeMap[strike][`${prefix}_iv`] = parseFloat(row.iv) || 0;
            strikeMap[strike][`${prefix}_trading_symbol`] = row.trading_symbol;
            strikeMap[strike][`${prefix}_lot_size`] = parseInt(row.lot_size, 10) || 1;
            strikeMap[strike][`${prefix}_delta`] = parseFloat(row.delta) || 0;
            strikeMap[strike][`${prefix}_gamma`] = parseFloat(row.gamma) || 0;
            strikeMap[strike][`${prefix}_theta`] = parseFloat(row.theta) || 0;
            strikeMap[strike][`${prefix}_vega`] = parseFloat(row.vega) || 0;
            
            if (row.option_type === 'CE') {
                totalCeOi += parseFloat(row.oi) || 0;
            } else {
                totalPeOi += parseFloat(row.oi) || 0;
            }
        });
        
        chainData = strikeMap;
        
        elements.ceOi.textContent = formatNumber(totalCeOi, 0);
        elements.peOi.textContent = formatNumber(totalPeOi, 0);
        elements.totalOI.textContent = formatNumber(totalCeOi + totalPeOi, 0);
        elements.pcr.textContent = totalCeOi > 0 ? (totalPeOi / totalCeOi).toFixed(2) : '0.00';
        
        return strikeMap;
    }
    
    function smartUpdateValues(rows) {
        console.log('%câ­ SMART UPDATE CALLED â­', 'color: orange; font-weight: bold; font-size: 14px');
        console.log('[OptionChain] Starting smartUpdate with', rows.length, 'rows of data');
        console.log('[OptionChain] Current table rows in DOM:', document.querySelectorAll('tr[data-strike]').length);
        
        const newStrikeMap = {};
        let totalCeOiNew = 0;
        let totalPeOiNew = 0;
        let totalCeVolumeNew = 0;
        let totalPeVolumeNew = 0;
        
        rows.forEach(row => {
            const strike = row.strike;
            if (!newStrikeMap[strike]) {
                newStrikeMap[strike] = {};
            }
            
            const prefix = row.option_type === 'CE' ? 'ce' : 'pe';
            newStrikeMap[strike][`${prefix}_ltp`] = parseFloat(row.ltp) || 0;
            newStrikeMap[strike][`${prefix}_change_pct`] = parseFloat(row.change_pct) || 0;
            newStrikeMap[strike][`${prefix}_volume`] = parseFloat(row.volume) || 0;
            newStrikeMap[strike][`${prefix}_oi`] = parseFloat(row.oi) || 0;
            newStrikeMap[strike][`${prefix}_iv`] = parseFloat(row.iv) || 0;
            newStrikeMap[strike][`${prefix}_delta`] = parseFloat(row.delta) || 0;
            newStrikeMap[strike][`${prefix}_gamma`] = parseFloat(row.gamma) || 0;
            newStrikeMap[strike][`${prefix}_theta`] = parseFloat(row.theta) || 0;
            newStrikeMap[strike][`${prefix}_vega`] = parseFloat(row.vega) || 0;
            
            // Calculate total OI and Volume
            if (row.option_type === 'CE') {
                totalCeOiNew += parseFloat(row.oi) || 0;
                totalCeVolumeNew += parseFloat(row.volume) || 0;
            } else {
                totalPeOiNew += parseFloat(row.oi) || 0;
                totalPeVolumeNew += parseFloat(row.volume) || 0;
            }
        });
        
        console.log('[OptionChain] Parsed', Object.keys(newStrikeMap).length, 'strikes from data');
        console.log('[OptionChain] Sample strikes parsed:', Object.keys(newStrikeMap).slice(0, 3));
        
        // CRITICAL FIX: Compare newStrikeMap against what's ACTUALLY displayed in DOM, not chainData
        // This ensures we detect real changes even if chainData is out of sync
        let forcedUpdateCount = 0;
        
        // Update info bar values
        elements.ceOi.textContent = formatNumber(totalCeOiNew, 0);
        elements.peOi.textContent = formatNumber(totalPeOiNew, 0);
        elements.totalOI.textContent = formatNumber(totalCeOiNew + totalPeOiNew, 0);
        elements.pcr.textContent = totalCeOiNew > 0 ? (totalPeOiNew / totalCeOiNew).toFixed(2) : '0.00';
        
        console.log('[OptionChain] âœ“ Updated OI info');
        
        // Update volume metrics
        const ceVolumeEl = document.getElementById('ceVolume');
        const peVolumeEl = document.getElementById('peVolume');
        const totalVolumeEl = document.getElementById('totalVolume');
        if (ceVolumeEl) ceVolumeEl.textContent = formatNumber(totalCeVolumeNew, 0);
        if (peVolumeEl) peVolumeEl.textContent = formatNumber(totalPeVolumeNew, 0);
        if (totalVolumeEl) totalVolumeEl.textContent = formatNumber(totalCeVolumeNew + totalPeVolumeNew, 0);
        
        console.log('[OptionChain] âœ“ Updated volume info');
        
        // Update row values
        let updateCount = 0;
        let failCount = 0;
        
        Object.keys(newStrikeMap).forEach(strike => {
            const newData = newStrikeMap[strike];
            const oldData = chainData[strike] || {};
            
            // CHECK IF ROW EXISTS FIRST
            const row = document.querySelector(`tr[data-strike="${strike}"]`);
            if (!row) {
                failCount++;
                if (failCount <= 3) {
                    console.warn(`[OptionChain] âœ— Row NOT FOUND for strike: ${strike}`);
                }
                return;
            }
            
            // FORCE UPDATE: Always update strike row, even if values look unchanged
            // This fixes the synchronization issue when DOM is out of sync with chainData
            updateStrikeRow(strike, newData, oldData, true);
            chainData[strike] = { ...newData };
            updateCount++;
        });
        
        console.log(`%câœ“ Updated ${updateCount} rows | âœ— ${failCount} rows NOT FOUND`, 'color: green; font-weight: bold');
        if (forcedUpdateCount > 0) {
            console.log(`%câš ï¸ Force-synced ${forcedUpdateCount} cells that were out of sync`, 'color: gold; font-weight: bold');
        }
        
        if (failCount > 0) {
            console.error('[OptionChain] ERROR: Table rows not found! Check data-strike attributes!');
        }
        
        // Refresh ATM highlighting in case atmStrike changed
        refreshATMHighlighting();
        
        console.log('[OptionChain] Smart update complete');
    }
    
    function refreshATMHighlighting() {
        // Remove ATM class from all rows
        document.querySelectorAll('.atm-row').forEach(row => {
            row.classList.remove('atm-row');
        });
        
        // Add ATM class to correct row
        if (atmStrike) {
            const atmRow = document.querySelector(`tr[data-strike="${atmStrike}"]`);
            if (atmRow) {
                atmRow.classList.add('atm-row');
            }
        }
    }
    
    function updateStrikeRow(strike, newData, oldData, forceUpdate = false) {
        const row = document.querySelector(`tr[data-strike="${strike}"]`);
        if (!row) {
            console.warn('[OptionChain] Row not found for strike:', strike);
            return;
        }
        
        console.log(`[OptionChain] Updating strike ${strike}:`, {
            newData: newData,
            oldData: oldData,
            rowElement: row,
            forceUpdate: forceUpdate
        });
        
        updateCellGroup(row, newData, oldData, 'ce', forceUpdate);
        updateCellGroup(row, newData, oldData, 'pe', forceUpdate);
    }
    
    function updateCellGroup(row, newData, oldData, prefix, forceUpdate = false) {
        console.log(`[OptionChain] updateCellGroup called for ${prefix}:`, {
            newData: newData,
            oldData: oldData,
            forceUpdate: forceUpdate
        });
        
        // LTP - Always present
        const ltpCell = row.querySelector(`.${prefix}-ltp-cell`);
        console.log(`[OptionChain] ${prefix}-ltp-cell search:`, ltpCell ? 'FOUND âœ“' : 'NOT FOUND âœ—');
        if (ltpCell) {
            const newVal = newData[`${prefix}_ltp`];
            const oldVal = oldData[`${prefix}_ltp`];
            console.log(`[OptionChain] LTP - New: ${newVal}, Old: ${oldVal}`);
            updateCellValue(ltpCell, newVal, oldVal, 'ltp', forceUpdate);
        }
        
        // Change %
        if (columnVisibility.change) {
            const changeCell = row.querySelector(`.${prefix}-change-cell`);
            console.log(`[OptionChain] ${prefix}-change-cell search:`, changeCell ? 'FOUND âœ“' : 'NOT FOUND âœ—');
            if (changeCell) {
                updateCellValue(changeCell, newData[`${prefix}_change_pct`], oldData[`${prefix}_change_pct`], 'change', forceUpdate);
            }
        }
        
        // OI
        if (columnVisibility.oi) {
            const oiCell = row.querySelector(`.${prefix}-oi-cell`);
            console.log(`[OptionChain] ${prefix}-oi-cell search:`, oiCell ? 'FOUND âœ“' : 'NOT FOUND âœ—');
            if (oiCell) {
                updateOiCell(oiCell, newData[`${prefix}_oi`], oldData[`${prefix}_oi`], forceUpdate);
            }
        }
        
        // Volume
        if (columnVisibility.volume) {
            const volumeCell = row.querySelector(`.${prefix}-volume-cell`);
            console.log(`[OptionChain] ${prefix}-volume-cell search:`, volumeCell ? 'FOUND âœ“' : 'NOT FOUND âœ—');
            if (volumeCell) {
                updateCellValue(volumeCell, newData[`${prefix}_volume`], oldData[`${prefix}_volume`], 'volume', forceUpdate);
            }
        }
        
        // IV
        if (columnVisibility.iv) {
            const ivCell = row.querySelector(`.${prefix}-iv-cell`);
            console.log(`[OptionChain] ${prefix}-iv-cell search:`, ivCell ? 'FOUND âœ“' : 'NOT FOUND âœ—');
            if (ivCell) {
                updateCellValue(ivCell, newData[`${prefix}_iv`], oldData[`${prefix}_iv`], 'iv', forceUpdate);
            }
        }
        
        // Delta
        if (columnVisibility.delta) {
            const deltaCell = row.querySelector(`.${prefix}-delta-cell`);
            console.log(`[OptionChain] ${prefix}-delta-cell search:`, deltaCell ? 'FOUND âœ“' : 'NOT FOUND âœ—');
            if (deltaCell) {
                updateCellValue(deltaCell, newData[`${prefix}_delta`], oldData[`${prefix}_delta`], 'delta', forceUpdate);
            }
        }
        
        // Gamma
        if (columnVisibility.gamma) {
            const gammaCell = row.querySelector(`.${prefix}-gamma-cell`);
            console.log(`[OptionChain] ${prefix}-gamma-cell search:`, gammaCell ? 'FOUND âœ“' : 'NOT FOUND âœ—');
            if (gammaCell) {
                updateCellValue(gammaCell, newData[`${prefix}_gamma`], oldData[`${prefix}_gamma`], 'gamma', forceUpdate);
            }
        }
        
        // Theta
        if (columnVisibility.theta) {
            const thetaCell = row.querySelector(`.${prefix}-theta-cell`);
            console.log(`[OptionChain] ${prefix}-theta-cell search:`, thetaCell ? 'FOUND âœ“' : 'NOT FOUND âœ—');
            if (thetaCell) {
                updateCellValue(thetaCell, newData[`${prefix}_theta`], oldData[`${prefix}_theta`], 'theta', forceUpdate);
            }
        }
        
        // Vega
        if (columnVisibility.vega) {
            const vegaCell = row.querySelector(`.${prefix}-vega-cell`);
            console.log(`[OptionChain] ${prefix}-vega-cell search:`, vegaCell ? 'FOUND âœ“' : 'NOT FOUND âœ—');
            if (vegaCell) {
                updateCellValue(vegaCell, newData[`${prefix}_vega`], oldData[`${prefix}_vega`], 'vega');
            }
        }
    }
    
    function updateCellValue(cell, newValue, oldValue, column, forceUpdate = false) {
        if (!cell) {
            console.warn('[OptionChain] Cell element is null for column:', column);
            return;
        }
        
        const newNum = parseFloat(newValue) || 0;
        const oldNum = parseFloat(oldValue) || 0;
        const hasChanged = Math.abs(newNum - oldNum) > 0.0001 || forceUpdate;
        
        const cellText = cell.textContent.trim();
        console.log(`[OptionChain] Cell Update - Column: ${column} | Old: ${oldNum} | New: ${newNum} | Changed: ${hasChanged} | Current Text: "${cellText}" | ForceUpdate: ${forceUpdate}`);
        
        if (hasChanged) {
            let displayValue;
            if (column === 'change') {
                const changeClass = newValue >= 0 ? 'positive' : 'negative';
                displayValue = `<span class="${changeClass}">${newValue >= 0 ? '+' : ''}${formatNumber(newValue, 2)}%</span>`;
                cell.innerHTML = displayValue;
            } else if (column === 'iv') {
                cell.textContent = formatNumber(newValue, 1) + '%';
            } else if (column === 'delta' || column === 'gamma' || column === 'theta' || column === 'vega') {
                cell.textContent = formatNumber(newValue, Math.abs(newValue) < 0.01 ? 4 : 3);
            } else if (column === 'volume' || column === 'oi') {
                cell.textContent = formatNumber(newValue, 0);
            } else {
                cell.textContent = formatNumber(newValue, 2);
            }
            
            console.log(`[OptionChain] Updated cell to: "${cell.textContent}"`);
            cell.classList.remove('value-changed');
            void cell.offsetWidth;
            cell.classList.add('value-changed');
        }
    }
    
    function updateOiCell(cell, newValue, oldValue, forceUpdate = false) {
        const hasChanged = Math.abs((newValue || 0) - (oldValue || 0)) > 0.0001 || forceUpdate;
        
        if (hasChanged) {
            const barText = cell.querySelector('.bar-text');
            
            if (barText) {
                barText.textContent = formatNumber(newValue, 0);
            }
            
            cell.classList.remove('value-changed');
            void cell.offsetWidth;
            cell.classList.add('value-changed');
        }
    }
    
    function updateInfoBar(meta) {
        const newSpotPrice = parseFloat(meta.spot_price) || parseFloat(meta.spot_ltp) || parseFloat(meta.ltp) || 0;
        const newFuturePrice = parseFloat(meta.future_price) || parseFloat(meta.fut_ltp) || parseFloat(meta.fut) || 0;
        
        console.log('%c[OptionChain] updateInfoBar - API Meta Data:', 'color: cyan; font-weight: bold');
        console.log('Raw API Response:', meta);
        console.log('Parsed Values:', { 
            spot_price: meta.spot_price, 
            spot_ltp: meta.spot_ltp,
            ltp: meta.ltp,
            future_price: meta.future_price,
            fut_ltp: meta.fut_ltp,
            fut: meta.fut,
            parsedSpot: newSpotPrice,
            parsedFuture: newFuturePrice,
            currentSpotPrice: currentSpotPrice,
            changed: newSpotPrice !== currentSpotPrice
        });
        
        // Update spot price with animation
        if (newSpotPrice !== currentSpotPrice) {
            console.log(`[OptionChain] Spot price changed: ${currentSpotPrice} â†’ ${newSpotPrice}`);
            currentSpotPrice = newSpotPrice;
            const formattedSpot = `â‚¹${formatNumber(currentSpotPrice, 2)}`;
            if (elements.spotPrice.textContent !== formattedSpot) {
                elements.spotPrice.textContent = formattedSpot;
                elements.spotPrice.classList.remove('value-changed');
                void elements.spotPrice.offsetWidth; // Force reflow
                elements.spotPrice.classList.add('value-changed');
            }
        } else {
            console.log(`[OptionChain] Spot price unchanged: ${currentSpotPrice}`);
        }
        
        // Update future price with animation
        if (newFuturePrice !== currentFuturePrice) {
            console.log(`[OptionChain] Future price changed: ${currentFuturePrice} â†’ ${newFuturePrice}`);
            currentFuturePrice = newFuturePrice;
            const formattedFuture = `â‚¹${formatNumber(currentFuturePrice, 2)}`;
            if (elements.futurePrice.textContent !== formattedFuture) {
                elements.futurePrice.textContent = formattedFuture;
                elements.futurePrice.classList.remove('value-changed');
                void elements.futurePrice.offsetWidth; // Force reflow
                elements.futurePrice.classList.add('value-changed');
            }
        } else {
            console.log(`[OptionChain] Future price unchanged: ${currentFuturePrice}`);
        }
        
        // Calculate Spot-Future Spread
        const spread = currentFuturePrice - currentSpotPrice;
        const spreadEl = document.getElementById('spreadValue');
        if (spreadEl) {
            const formattedSpread = `â‚¹${formatNumber(spread, 2)}`;
            spreadEl.textContent = formattedSpread;
            spreadEl.style.color = spread >= 0 ? 'var(--success)' : 'var(--danger)';
            spreadEl.classList.remove('value-changed');
            void spreadEl.offsetWidth;
            spreadEl.classList.add('value-changed');
        }
        
        // Calculate ATM Strike based on FUTURE LTP (not spot)
        const strikes = Object.keys(chainData).map(Number).sort((a, b) => a - b);
        if (strikes.length > 0 && currentFuturePrice > 0) {
            atmStrike = findATMStrike(strikes, currentFuturePrice);
            elements.atmStrikeEl.textContent = atmStrike;
        }
        
        // Update timestamp
        elements.lastUpdated.textContent = new Date().toLocaleTimeString('en-IN', {
            hour12: false,
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }
    
    function findATMStrike(strikes, spotPrice) {
        if (!spotPrice || strikes.length === 0) return 0;
        return strikes.reduce((prev, curr) => 
            Math.abs(curr - spotPrice) < Math.abs(prev - spotPrice) ? curr : prev
        );
    }
    
    // Table rendering
    function renderTable() {
        renderTableHeaders();
        renderTableBody();
    }
    
    function renderTableHeaders() {
        const columnLabels = {
            oi: 'OI',
            volume: 'Volume',
            iv: 'IV%',
            delta: 'Delta',
            gamma: 'Gamma',
            theta: 'Theta',
            vega: 'Vega',
            change: 'Change%',
            ltp: 'LTP'
        };
        
        const visibleColumns = Object.keys(columnVisibility).filter(col => columnVisibility[col]);
        const colCount = visibleColumns.length + 1; // +1 for LTP
        
        let headerHTML = '';
        
        headerHTML += `<th colspan="${colCount}" class="section-header calls-header">CALLS</th>`;
        headerHTML += `<th class="section-header">STRIKE</th>`;
        headerHTML += `<th colspan="${colCount}" class="section-header puts-header">PUTS</th>`;
        headerHTML = `<tr>${headerHTML}</tr><tr>`;
        
        // Call columns
        visibleColumns.forEach(col => {
            headerHTML += `<th>${columnLabels[col]}</th>`;
        });
        headerHTML += `<th>${columnLabels.ltp}</th>`;
        
        // Strike
        headerHTML += `<th>STRIKE</th>`;
        
        // Put columns (reverse order)
        headerHTML += `<th>${columnLabels.ltp}</th>`;
        visibleColumns.slice().reverse().forEach(col => {
            headerHTML += `<th>${columnLabels[col]}</th>`;
        });
        
        headerHTML += '</tr>';
        elements.tableHeader.innerHTML = headerHTML;
    }
    
    function renderTableBody() {
        const strikes = Object.keys(chainData).map(Number).sort((a, b) => a - b);
        let maxOI = 0;
        
        strikes.forEach(strike => {
            maxOI = Math.max(maxOI, chainData[strike].ce_oi || 0, chainData[strike].pe_oi || 0);
        });
        
        let bodyHTML = '';
        
        strikes.forEach(strike => {
            const data = chainData[strike];
            const isATM = strike === atmStrike;
            const callItm = strike < currentSpotPrice;
            const putItm = strike > currentSpotPrice;
            
            bodyHTML += `<tr class="${isATM ? 'atm-row' : ''}" data-strike="${strike}">`;
            
            // Call columns
            if (columnVisibility.oi) {
                const ceOiPct = maxOI > 0 ? ((data.ce_oi || 0) / maxOI) * 100 : 0;
                bodyHTML += `<td class="call-${callItm ? 'itm' : 'otm'} ce-oi-cell">
                    <div class="bar-container">
                        <div class="bar-fill bar-call" style="width: ${ceOiPct}%"></div>
                        <div class="bar-text">${formatNumber(data.ce_oi, 0)}</div>
                    </div>
                </td>`;
            }
            
            if (columnVisibility.volume) {
                bodyHTML += `<td class="call-${callItm ? 'itm' : 'otm'} ce-volume-cell">${formatNumber(data.ce_volume, 0)}</td>`;
            }
            
            if (columnVisibility.iv) {
                bodyHTML += `<td class="call-${callItm ? 'itm' : 'otm'} ce-iv-cell">${formatNumber(data.ce_iv, 1)}%</td>`;
            }
            
            if (columnVisibility.delta) {
                bodyHTML += `<td class="call-${callItm ? 'itm' : 'otm'} ce-delta-cell">${formatNumber(data.ce_delta, 3)}</td>`;
            }
            
            if (columnVisibility.gamma) {
                bodyHTML += `<td class="call-${callItm ? 'itm' : 'otm'} ce-gamma-cell">${formatNumber(data.ce_gamma, 4)}</td>`;
            }
            
            if (columnVisibility.theta) {
                bodyHTML += `<td class="call-${callItm ? 'itm' : 'otm'} ce-theta-cell">${formatNumber(data.ce_theta, 3)}</td>`;
            }
            
            if (columnVisibility.vega) {
                bodyHTML += `<td class="call-${callItm ? 'itm' : 'otm'} ce-vega-cell">${formatNumber(data.ce_vega, 3)}</td>`;
            }
            
            if (columnVisibility.change) {
                const ceChangeClass = getChangeClass(data.ce_change_pct);
                bodyHTML += `<td class="call-${callItm ? 'itm' : 'otm'} ce-change-cell ${ceChangeClass}">
                    ${data.ce_change_pct >= 0 ? '+' : ''}${formatNumber(data.ce_change_pct, 2)}%
                </td>`;
            }
            
            // Call LTP
            const ceChangeClass = getChangeClass(data.ce_change_pct);
            bodyHTML += `<td class="ltp-cell call-${callItm ? 'itm' : 'otm'} ce-ltp-cell ${ceChangeClass}" 
                           onclick="openOrderEntry(${strike}, 'CE', ${data.ce_ltp || 0}, '${data.ce_trading_symbol || ''}', ${data.ce_lot_size || 1}, event)">
                           ${formatNumber(data.ce_ltp, 2)}
                       </td>`;
            
            // Strike
            bodyHTML += `<td class="strike-cell">${formatNumber(strike, 0)}</td>`;
            
            // Put LTP
            const peChangeClass = getChangeClass(data.pe_change_pct);
            bodyHTML += `<td class="ltp-cell put-${putItm ? 'itm' : 'otm'} pe-ltp-cell ${peChangeClass}" 
                           onclick="openOrderEntry(${strike}, 'PE', ${data.pe_ltp || 0}, '${data.pe_trading_symbol || ''}', ${data.pe_lot_size || 1}, event)">
                           ${formatNumber(data.pe_ltp, 2)}
                       </td>`;
            
            // Put columns (reverse order)
            if (columnVisibility.change) {
                bodyHTML += `<td class="put-${putItm ? 'itm' : 'otm'} pe-change-cell ${peChangeClass}">
                    ${data.pe_change_pct >= 0 ? '+' : ''}${formatNumber(data.pe_change_pct, 2)}%
                </td>`;
            }
            
            if (columnVisibility.vega) {
                bodyHTML += `<td class="put-${putItm ? 'itm' : 'otm'} pe-vega-cell">${formatNumber(data.pe_vega, 3)}</td>`;
            }
            
            if (columnVisibility.theta) {
                bodyHTML += `<td class="put-${putItm ? 'itm' : 'otm'} pe-theta-cell">${formatNumber(data.pe_theta, 3)}</td>`;
            }
            
            if (columnVisibility.gamma) {
                bodyHTML += `<td class="put-${putItm ? 'itm' : 'otm'} pe-gamma-cell">${formatNumber(data.pe_gamma, 4)}</td>`;
            }
            
            if (columnVisibility.delta) {
                bodyHTML += `<td class="put-${putItm ? 'itm' : 'otm'} pe-delta-cell">${formatNumber(data.pe_delta, 3)}</td>`;
            }
            
            if (columnVisibility.iv) {
                bodyHTML += `<td class="put-${putItm ? 'itm' : 'otm'} pe-iv-cell">${formatNumber(data.pe_iv, 1)}%</td>`;
            }
            
            if (columnVisibility.volume) {
                bodyHTML += `<td class="put-${putItm ? 'itm' : 'otm'} pe-volume-cell">${formatNumber(data.pe_volume, 0)}</td>`;
            }
            
            if (columnVisibility.oi) {
                const peOiPct = maxOI > 0 ? ((data.pe_oi || 0) / maxOI) * 100 : 0;
                bodyHTML += `<td class="put-${putItm ? 'itm' : 'otm'} pe-oi-cell">
                    <div class="bar-container">
                        <div class="bar-fill bar-put" style="width: ${peOiPct}%"></div>
                        <div class="bar-text">${formatNumber(data.pe_oi, 0)}</div>
                    </div>
                </td>`;
            }
            
            bodyHTML += '</tr>';
        });
        
        elements.tableBody.innerHTML = bodyHTML;
    }
    
    function formatNumber(value, decimals = 2) {
        if (value === null || value === undefined || isNaN(value)) return '-';
        
        if (decimals === 0) {
            return Math.round(value).toLocaleString('en-IN');
        }
        
        return parseFloat(value).toFixed(decimals);
    }
    
    function getChangeClass(change) {
        if (change === null || change === undefined || isNaN(change)) return '';
        return change >= 0 ? 'positive' : 'negative';
    }
    
    // Order Entry Functions
    function openOrderEntry(strike, optionType, ltp, tradingSymbol, lotSize, event) {
        event.stopPropagation();
        
        currentOrderEntry = {
            strike,
            optionType,
            ltp,
            tradingSymbol,
            lotSize: parseInt(lotSize, 10) || 1,
            qtyLots: 1,
            qty: parseInt(lotSize, 10) || 1,
            side: 'BUY',
            product: 'MIS',
            priceType: 'LIMIT',
            price: ltp
        };
        
        elements.orderPopupTitle.textContent = tradingSymbol;
        elements.orderQty.value = 1;
        elements.orderPrice.value = ltp;
        
        setOrderSide('BUY');
        setOrderExecution('ENTRY');
        setOrderProduct('MIS');
        setOrderPriceType('LIMIT');
        
        const popup = elements.orderPopup;
        const rect = event.target.getBoundingClientRect();
        popup.style.left = `${rect.left}px`;
        popup.style.top = `${rect.bottom + 5}px`;
            // Show popup
            popup.classList.add('show');
        
        
        setTimeout(() => {
            const popupRect = popup.getBoundingClientRect();
            if (popupRect.right > window.innerWidth) {
                popup.style.left = `${window.innerWidth - popupRect.width - 10}px`;
            }
            if (popupRect.bottom > window.innerHeight) {
                popup.style.top = `${rect.top - popupRect.height - 5}px`;
            }
        }, 10);
    }
    
    function closeOrderPopup() {
        elements.orderPopup.classList.remove('show');
    }
    
    function setOrderSide(side) {
        currentOrderEntry.side = side;
        elements.orderSideBuy.style.opacity = side === 'BUY' ? '1' : '0.5';
        elements.orderSideSell.style.opacity = side === 'SELL' ? '1' : '0.5';
    }
    
    function setOrderProduct(product) {
        currentOrderEntry.product = product;
        elements.orderProductMIS.style.opacity = product === 'MIS' ? '1' : '0.5';
        elements.orderProductNRML.style.opacity = product === 'NRML' ? '1' : '0.5';
    }
    
    function setOrderExecution(execution) {
        currentOrderEntry.execution = execution;
        const entryBtn = document.getElementById('orderExecEntry');
        const exitBtn = document.getElementById('orderExecExit');
        if (entryBtn) entryBtn.style.opacity = execution === 'ENTRY' ? '1' : '0.5';
        if (exitBtn) exitBtn.style.opacity = execution === 'EXIT' ? '1' : '0.5';
    }
    
    function setOrderPriceType(priceType) {
        currentOrderEntry.priceType = priceType;
        elements.orderPriceTypeMKT.style.opacity = priceType === 'MARKET' ? '1' : '0.5';
        elements.orderPriceTypeLMT.style.opacity = priceType === 'LIMIT' ? '1' : '0.5';
        elements.orderPriceGroup.style.display = priceType === 'MARKET' ? 'none' : 'block';
    }
    
    function confirmOrderEntry() {
        const qtyLots = parseInt(elements.orderQty.value, 10);
        const price = parseFloat(elements.orderPrice.value);
        
        if (!qtyLots || qtyLots < 1) {
            showError('Invalid quantity');
            return;
        }
        
        if (currentOrderEntry.priceType === 'LIMIT' && (!price || price <= 0)) {
            showError('Invalid price for LIMIT order');
            return;
        }
        
        const lotSize = currentOrderEntry.lotSize || 1;
        const actualQty = qtyLots * lotSize;
        currentOrderEntry.qtyLots = qtyLots;
        currentOrderEntry.qty = actualQty;
        currentOrderEntry.price = currentOrderEntry.priceType === 'LIMIT' ? price : null;
        
        addToBasket(
            currentOrderEntry.strike,
            currentOrderEntry.optionType,
            currentOrderEntry.ltp,
            currentOrderEntry.tradingSymbol,
            currentOrderEntry.side,
            currentOrderEntry.qty,
            currentOrderEntry.qtyLots,
            currentOrderEntry.lotSize,
            currentOrderEntry.product,
            currentOrderEntry.priceType,
            currentOrderEntry.price
        );
        
        closeOrderPopup();
    }
    
    // Basket Functions
    function addToBasket(strike, optionType, ltp, tradingSymbol, side, qty, qtyLots, lotSize, product, orderType, price) {
        const exists = basket.find(item => item.strike === strike && item.optionType === optionType);
        
        if (exists) {
            showError(`${tradingSymbol} already in basket`);
            return;
        }
        
        basket.push({
            strike,
            optionType,
            ltp,
            tradingSymbol,
            side,
            qty,
            qtyLots,
            lotSize,
            execution: currentOrderEntry.execution,  // NEW: Capture execution type
            product,
            orderType,
            price
        });
        
        updateBasketUI();
        showBasketToast(`Added ${tradingSymbol} to basket`);
    }
    
    function removeFromBasket(index) {
        basket.splice(index, 1);
        updateBasketUI();
        renderBasketItems();
    }
    
    function updateBasketUI() {
        const count = basket.length;
        elements.basketCount.textContent = count;
        if (count > 0) {
            elements.basketCount.classList.add('show');
        } else {
            elements.basketCount.classList.remove('show');
        }
    }
    
    function showBasketToast(msg) {
        const toast = document.createElement('div');
        toast.textContent = msg;
        toast.style.cssText = `
            position: fixed;
            top: 70px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 10px 16px;
            border-radius: 6px;
            z-index: 1000;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 2000);
    }
    
    function openBasketModal() {
        if (basket.length === 0) {
            showError('Basket is empty');
            return;
        }
        renderBasketItems();
        elements.basketModal.style.display = 'flex';
    }
    
    function closeBasketModal() {
        elements.basketModal.style.display = 'none';
    }
    
    function renderBasketItems() {
        if (basket.length === 0) {
            elements.basketItems.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--muted)">Basket is empty</div>';
            return;
        }
        
        elements.basketItems.innerHTML = basket.map((item, idx) => `
            <div class="basket-item" style="background: #1c2333; padding: 12px; border-radius: 6px; margin-bottom: 8px; border: 1px solid var(--border)">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px">
                    <span style="font-weight: 700; font-size: 13px">${item.tradingSymbol}</span>
                    <button onclick="removeFromBasket(${idx})" style="background: var(--danger); padding: 3px 8px; font-size: 10px; border: none; border-radius: 3px; color: white; cursor: pointer">
                        Remove
                    </button>
                </div>
                <div style="font-size: 11px; color: var(--muted)">
                    ${item.side} ${item.execution || 'ENTRY'} | ${item.qtyLots} Lots (Qty ${item.qty}) | ${item.product} | ${item.orderType} ${item.orderType === 'LIMIT' ? '@ â‚¹' + item.price : ''}
                </div>
            </div>
        `).join('');
    }
    
    async function placeBasketOrders() {
        if (basket.length === 0) return;
        
        const confirmBtn = document.getElementById('confirmBasketBtn');
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'Placing...';
        
        try {
            const orders = basket.map(item => ({
                exchange: 'NFO',
                symbol: item.tradingSymbol,
                side: item.side,
                qty: item.qty,
                product: item.product,
                order_type: item.orderType,
                price: item.orderType === 'LIMIT' ? item.price : null,
                execution_type: item.execution || 'ENTRY',  // NEW: Use basket item execution type
                test_mode: null,
                triggered_order: 'NO',
                trigger_value: null,
                target: null,
                stoploss: null,
                trail_sl: null,
                trail_when: null,
                reason: 'OPTION_CHAIN_BASKET'
            }));
            
            const res = await fetch('/dashboard/intent/basket', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ orders, reason: 'OPTION_CHAIN_BASKET' })
            });
            
            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.detail || `HTTP ${res.status}`);
            }
            
            const data = await res.json();
            showBasketToast(`âœ“ Orders queued (${data.intent_id})`);
            basket = [];
            updateBasketUI();
            closeBasketModal();
        } catch (err) {
            showError('Order placement failed: ' + err.message);
        } finally {
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'Confirm & Place Orders';
        }
    }
    
    window.addEventListener('load', init);
</script>
</body>
</html>