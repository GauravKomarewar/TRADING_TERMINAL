<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Option Chain â€“ Shoonya OMS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        :root {
            --bg: #0a0e13;
            --panel: #151b26;
            --border: #2d3548;
            --text: #f1f5f9;
            --muted: #94a3b8;
            --primary: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --atm: #f59e0b;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.4;
            font-size: 12px;
        }
        
        /* Header */
        header {
            height: 56px;
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 16px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }
        
        .nav-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .brand {
            font-weight: 700;
            font-size: 18px;
            color: var(--primary);
            cursor: pointer;
        }
        
        .nav-link {
            color: var(--muted);
            font-size: 13px;
            text-decoration: none;
            padding: 6px 10px;
            border-radius: 4px;
            transition: all 0.2s;
            display: inline-block;
            border: 1px solid transparent;
        }
        
        .nav-link:hover {
            color: var(--text);
            background: rgba(28, 35, 51, 0.8);
            border-color: var(--primary);
        }
        
        .nav-link.active {
            color: var(--primary);
            background: rgba(59, 130, 246, 0.15);
            border-color: var(--primary);
            font-weight: 600;
        }
        
        /* Main Container */
        main {
            margin-top: 56px;
            padding: 12px;
        }
        
        /* Controls Bar */
        .controls-bar {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px 12px;
            margin-bottom: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        select {
            padding: 6px 10px;
            background: #1c2333;
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 4px;
            font-size: 12px;
            height: 32px;
            min-width: 120px;
        }
        
        .column-selector {
            position: relative;
        }
        
        .column-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 4px;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px;
            min-width: 200px;
            display: none;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .column-dropdown.show {
            display: block;
        }
        
        .column-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .column-option:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        
        .column-option input[type="checkbox"] {
            cursor: pointer;
        }
        
        .column-option label {
            cursor: pointer;
            flex: 1;
            font-size: 12px;
        }
        
        /* Info Bar */
        .info-bar {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px 12px;
            margin-bottom: 10px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .info-label {
            font-size: 10px;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .info-value {
            font-size: 14px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }
        
        .spot-price {
            color: var(--success);
        }
        
        .future-price {
            color: var(--primary);
        }
        
        .atm-price {
            color: var(--atm);
        }
        
        /* Option Chain Container */
        .chain-container {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
        }
        
        .table-wrapper {
            overflow-x: auto;
            max-height: calc(100vh - 220px);
        }
        
        /* Table Styles */
        .option-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            min-width: 900px;
        }
        
        .option-table th {
            padding: 8px 6px;
            text-align: center;
            font-weight: 700;
            color: var(--muted);
            text-transform: uppercase;
            font-size: 10px;
            letter-spacing: 0.3px;
            border-bottom: 1px solid var(--border);
            background: #1c2333;
            position: sticky;
            top: 0;
            z-index: 20;
            white-space: nowrap;
        }
        
        .option-table th.section-header {
            background: var(--panel);
            color: var(--text);
            font-size: 12px;
            padding: 10px 6px;
            font-weight: 800;
        }
        
        .option-table th.calls-header {
            background: linear-gradient(to bottom, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05));
            color: var(--success);
        }
        
        .option-table th.puts-header {
            background: linear-gradient(to bottom, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.05));
            color: var(--danger);
        }
        
        .option-table td {
            padding: 6px 6px;
            text-align: center;
            border-bottom: 1px solid rgba(45, 53, 72, 0.3);
            font-variant-numeric: tabular-nums;
            position: relative;
            height: 36px;
        }
        
        .option-table tbody tr {
            transition: background 0.2s;
            cursor: pointer;
        }
        
        .option-table tbody tr:hover {
            background: rgba(59, 130, 246, 0.08);
        }
        
        /* ATM Row - Enhanced Orange Highlighting */
        .atm-row {
            background: rgba(245, 158, 11, 0.2) !important;
            border-top: 2px solid var(--atm);
            border-bottom: 2px solid var(--atm);
        }
        
        .atm-row td {
            border-top: 2px solid rgba(245, 158, 11, 0.5);
            border-bottom: 2px solid rgba(245, 158, 11, 0.5);
        }
        
        .atm-row .strike-cell {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
            color: #000;
            font-weight: 900;
            position: relative;
            border-left: 2px solid var(--atm);
            border-right: 2px solid var(--atm);
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.3);
        }
        
        .atm-row .strike-cell::before {
            content: "ATM";
            position: absolute;
            top: 3px;
            right: 6px;
            font-size: 8px;
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        /* Strike Cell */
        .strike-cell {
            background: #1c2333;
            font-weight: 700;
            color: var(--primary);
            border-left: 1px solid var(--border);
            border-right: 1px solid var(--border);
            min-width: 80px;
            position: sticky;
            left: 0;
            z-index: 10;
            font-size: 12px;
        }
        
        /* ITM/OTM Styling - Enhanced Gradients */
        .call-itm {
            background: linear-gradient(90deg, 
                rgba(16, 185, 129, 0.18) 0%, 
                rgba(16, 185, 129, 0.12) 50%, 
                rgba(16, 185, 129, 0.05) 100%);
        }
        
        .call-otm {
            background: linear-gradient(90deg, 
                rgba(16, 185, 129, 0.06) 0%, 
                rgba(16, 185, 129, 0.03) 50%, 
                transparent 100%);
        }
        
        .put-itm {
            background: linear-gradient(270deg, 
                rgba(239, 68, 68, 0.18) 0%, 
                rgba(239, 68, 68, 0.12) 50%, 
                rgba(239, 68, 68, 0.05) 100%);
        }
        
        .put-otm {
            background: linear-gradient(270deg, 
                rgba(239, 68, 68, 0.06) 0%, 
                rgba(239, 68, 68, 0.03) 50%, 
                transparent 100%);
        }
        
        /* LTP Cells */
        .ltp-cell {
            font-weight: 700;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 3px;
            padding: 4px 0;
            min-width: 70px;
        }
        
        .ltp-cell:hover {
            background: rgba(59, 130, 246, 0.25);
            transform: scale(1.05);
        }
        
        .positive {
            color: var(--success);
        }
        
        .negative {
            color: var(--danger);
        }
        
        /* Bar Indicators */
        .bar-container {
            position: relative;
            height: 22px;
            margin: 2px 0;
            border-radius: 3px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.2);
        }
        
        .bar-fill {
            position: absolute;
            top: 0;
            bottom: 0;
            opacity: 0.25;
            transition: width 0.3s ease;
        }
        
        .bar-text {
            position: relative;
            z-index: 1;
            font-weight: 600;
            line-height: 22px;
        }
        
        .bar-call {
            background: var(--success);
            left: 0;
        }
        
        .bar-put {
            background: var(--danger);
            right: 0;
        }
        
        /* Hidden columns */
        .col-hidden {
            display: none;
        }
        
        /* Basket */
        .basket-indicator {
            position: relative;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 4px;
            transition: background 0.2s;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid var(--border);
        }
        
        .basket-indicator:hover {
            background: rgba(59, 130, 246, 0.2);
        }
        
        .basket-count {
            position: absolute;
            top: -6px;
            right: -6px;
            background: var(--danger);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
            display: none;
        }
        
        .basket-count.show {
            display: block;
        }
        
        /* Loading States */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--muted);
            font-size: 13px;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: var(--muted);
            font-size: 13px;
        }
        
        .error-msg {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            padding: 10px 12px;
            border-radius: 4px;
            margin-bottom: 10px;
            border: 1px solid rgba(239, 68, 68, 0.3);
            display: none;
        }
        
        /* Value change animation */
        @keyframes valueChange {
            0% { background-color: rgba(59, 130, 246, 0.4); }
            100% { background-color: transparent; }
        }
        
        .value-changed {
            animation: valueChange 0.5s ease-out;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            font-size: 14px;
        }
        
        .modal-body {
            padding: 16px;
        }
        
        .modal-footer {
            padding: 16px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        /* Order Entry Popup */
        .order-popup {
            position: absolute;
            background: var(--panel);
            border: 2px solid var(--primary);
            border-radius: 6px;
            padding: 12px;
            min-width: 250px;
            z-index: 1000;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            display: none;
        }
        
        .order-popup.show {
            display: block;
        }
        
        .order-popup-header {
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }
        
        .order-popup-close {
            cursor: pointer;
            color: var(--muted);
            font-size: 18px;
            line-height: 1;
        }
        
        .order-form-group {
            margin-bottom: 8px;
        }
        
        .order-form-label {
            font-size: 10px;
            color: var(--muted);
            display: block;
            margin-bottom: 3px;
        }
        
        .order-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .order-form-input {
            width: 100%;
            padding: 5px 6px;
            background: #1c2333;
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 4px;
            font-size: 12px;
        }
        
        .order-form-actions {
            display: flex;
            gap: 6px;
            margin-top: 10px;
        }
        
        .order-form-actions button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: background 0.2s;
            flex: 1;
        }
        
        .order-form-actions button:hover {
            background: #2563eb;
        }
        
        button {
            cursor: pointer;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            main {
                padding: 8px;
            }
            
            .controls-bar {
                padding: 8px;
                gap: 8px;
            }
            
            select {
                min-width: auto;
                flex: 1;
            }
            
            .info-bar {
                grid-template-columns: repeat(2, 1fr);
                padding: 8px;
            }
        }
    </style>
</head>
<body>
<header>
    <div class="nav-left">
        <div class="brand" onclick="window.location.href='/dashboard/web/dashboard.html'">âš¡ Shoonya OMS</div>
        <a class="nav-link" href="/dashboard/web/dashboard.html">Dashboard</a>
        <a class="nav-link" href="/dashboard/web/home.html">Home</a>
        <a class="nav-link active" href="/dashboard/web/option_chain_dashboard.html">Option Chain</a>
        <a class="nav-link" href="/dashboard/web/place_order.html">Place Order</a>
        <a class="nav-link" href="/dashboard/web/orderbook.html">Orderbook</a>
        <a class="nav-link" href="/dashboard/web/diagnostics.html">Diagnostics</a>
        <a class="nav-link" href="/dashboard/web/strategy_dnss.html">DNSS Strategy</a>
    </div>
    <div style="margin-left: auto;"><button onclick="logout()" style="background: transparent; border: 1px solid var(--danger); color: var(--danger); padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.2s;">Logout</button></div>
</header>

<main>
    <div id="errorMsg" class="error-msg"></div>
    
    <!-- Controls Bar -->
    <div class="controls-bar">
        <select id="symbol">
            <option value="NIFTY" selected>NIFTY</option>
            <option value="BANKNIFTY">BANKNIFTY</option>
            <option value="FINNIFTY">FINNIFTY</option>
            <option value="SENSEX">SENSEX</option>
        </select>
        
        <select id="expiry">
            <option>Loading...</option>
        </select>
        
        <div class="column-selector">
            <button id="columnSelectorBtn" style="padding: 6px 12px; background: #1c2333; border: 1px solid var(--border); color: var(--text); border-radius: 4px; font-size: 12px; height: 32px; cursor: pointer;">
                ðŸ“Š Columns
            </button>
            <div id="columnDropdown" class="column-dropdown">
                <div class="column-option">
                    <input type="checkbox" id="col-oi" checked>
                    <label for="col-oi">Open Interest (OI)</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="col-volume" checked>
                    <label for="col-volume">Volume</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="col-iv" checked>
                    <label for="col-iv">IV%</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="col-delta" checked>
                    <label for="col-delta">Delta (Î”)</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="col-gamma" checked>
                    <label for="col-gamma">Gamma (Î“)</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="col-theta" checked>
                    <label for="col-theta">Theta (Î˜)</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="col-vega" checked>
                    <label for="col-vega">Vega (Î½)</label>
                </div>
                <div class="column-option">
                    <input type="checkbox" id="col-change" checked>
                    <label for="col-change">Change %</label>
                </div>
            </div>
        </div>
        
        <div style="margin-left: auto; display: flex; align-items: center; gap: 12px;">
            <div class="basket-indicator" onclick="openBasketModal()">
                ðŸ›’ Basket
                <span id="basketCount" class="basket-count"></span>
            </div>
        </div>
    </div>
    
    <!-- Info Bar -->
    <div class="info-bar" id="infoBar">
        <div class="info-item">
            <div class="info-label">Spot LTP</div>
            <div class="info-value spot-price" id="spotPrice">â‚¹0.00</div>
        </div>
        <div class="info-item">
            <div class="info-label">Future LTP</div>
            <div class="info-value future-price" id="futurePrice">â‚¹0.00</div>
        </div>
        <div class="info-item">
            <div class="info-label">ATM Strike</div>
            <div class="info-value atm-price" id="atmStrike">0</div>
        </div>
        <div class="info-item">
            <div class="info-label">CE OI</div>
            <div class="info-value" id="ceOi">0</div>
        </div>
        <div class="info-item">
            <div class="info-label">PE OI</div>
            <div class="info-value" id="peOi">0</div>
        </div>
        <div class="info-item">
            <div class="info-label">Total OI</div>
            <div class="info-value" id="totalOI">0</div>
        </div>
        <div class="info-item">
            <div class="info-label">PCR</div>
            <div class="info-value" id="pcr">0.00</div>
        </div>
        <div class="info-item">
            <div class="info-label">Updated</div>
            <div class="info-value" id="lastUpdated">--:--:--</div>
        </div>
    </div>
    
    <!-- Option Chain Table -->
    <div class="chain-container">
        <div class="table-wrapper">
            <table class="option-table" id="optionTable">
                <thead id="tableHeader">
                    <!-- Headers will be generated here -->
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="100" class="loading">Loading option chain data...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Order Entry Popup -->
    <div id="orderPopup" class="order-popup">
        <div class="order-popup-header">
            <span id="orderPopupTitle">Place Order</span>
            <span class="order-popup-close" onclick="closeOrderPopup()">&times;</span>
        </div>
        <div class="order-form-group">
            <label class="order-form-label">Side</label>
            <div class="order-form-row">
                <button id="orderSideBuy" class="order-form-input" style="background:var(--success)" onclick="setOrderSide('BUY')">BUY</button>
                <button id="orderSideSell" class="order-form-input" style="background:var(--danger)" onclick="setOrderSide('SELL')">SELL</button>
            </div>
        </div>
        <div class="order-form-group">
            <label class="order-form-label">Quantity (Lots)</label>
            <input type="number" id="orderQty" class="order-form-input" value="1" min="1">
        </div>
        <div class="order-form-group">
            <label class="order-form-label">Product Type</label>
            <div class="order-form-row">
                <button id="orderProductMIS" class="order-form-input" onclick="setOrderProduct('MIS')">MIS</button>
                <button id="orderProductNRML" class="order-form-input" onclick="setOrderProduct('NRML')">NRML</button>
            </div>
        </div>
        <div class="order-form-group">
            <label class="order-form-label">Price Type</label>
            <div class="order-form-row">
                <button id="orderPriceTypeMKT" class="order-form-input" onclick="setOrderPriceType('MARKET')">MARKET</button>
                <button id="orderPriceTypeLMT" class="order-form-input" onclick="setOrderPriceType('LIMIT')">LIMIT</button>
            </div>
        </div>
        <div class="order-form-group" id="orderPriceGroup">
            <label class="order-form-label">Price</label>
            <input type="number" id="orderPrice" class="order-form-input" step="0.05">
        </div>
        <div class="order-form-actions">
            <button onclick="closeOrderPopup()" style="background:var(--muted)">Cancel</button>
            <button onclick="confirmOrderEntry()" style="background:var(--success)">Add to Basket</button>
        </div>
    </div>
    
    <!-- Basket Modal -->
    <div id="basketModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>ðŸ›’ Order Basket</span>
                <button onclick="closeBasketModal()" style="background:transparent;border:none;color:var(--muted);font-size:20px;cursor:pointer;padding:0">&times;</button>
            </div>
            <div class="modal-body">
                <div id="basketItems"></div>
            </div>
            <div class="modal-footer">
                <button onclick="closeBasketModal()" style="background:var(--muted);padding:8px 16px;border:none;border-radius:4px;color:white;font-size:12px">Cancel</button>
                <button id="confirmBasketBtn" onclick="placeBasketOrders()" style="background:var(--success);padding:8px 16px;border:none;border-radius:4px;color:white;font-size:12px">Confirm & Place Orders</button>
            </div>
        </div>
    </div>
</main>

<script>
    // Configuration
    const config = {
        autoRefreshInterval: 100,
        lastChainData: {}
    };
    
    // Column visibility state
    const columnVisibility = {
        oi: true,
        volume: true,
        iv: true,
        delta: true,
        gamma: true,
        theta: true,
        vega: true,
        change: true
    };
    
    // State
    let chainData = {};
    let currentSpotPrice = 0;
    let currentFuturePrice = 0;
    let atmStrike = 0;
    let autoRefreshTimer = null;
    let selectedStrike = null;
    let basket = [];
    let isFirstLoad = true;
    let currentStrikes = [];
    let totalCeOi = 0;
    let totalPeOi = 0;
    
    // DOM Elements
    const elements = {
        symbol: document.getElementById('symbol'),
        expiry: document.getElementById('expiry'),
        tableHeader: document.getElementById('tableHeader'),
        tableBody: document.getElementById('tableBody'),
        errorMsg: document.getElementById('errorMsg'),
        spotPrice: document.getElementById('spotPrice'),
        futurePrice: document.getElementById('futurePrice'),
        atmStrikeEl: document.getElementById('atmStrike'),
        ceOi: document.getElementById('ceOi'),
        peOi: document.getElementById('peOi'),
        totalOI: document.getElementById('totalOI'),
        pcr: document.getElementById('pcr'),
        lastUpdated: document.getElementById('lastUpdated'),
        basketCount: document.getElementById('basketCount'),
        basketModal: document.getElementById('basketModal'),
        basketItems: document.getElementById('basketItems'),
        orderPopup: document.getElementById('orderPopup'),
        orderPopupTitle: document.getElementById('orderPopupTitle'),
        orderQty: document.getElementById('orderQty'),
        orderPrice: document.getElementById('orderPrice'),
        orderSideBuy: document.getElementById('orderSideBuy'),
        orderSideSell: document.getElementById('orderSideSell'),
        orderProductMIS: document.getElementById('orderProductMIS'),
        orderProductNRML: document.getElementById('orderProductNRML'),
        orderPriceTypeMKT: document.getElementById('orderPriceTypeMKT'),
        orderPriceTypeLMT: document.getElementById('orderPriceTypeLMT'),
        orderPriceGroup: document.getElementById('orderPriceGroup'),
        columnSelectorBtn: document.getElementById('columnSelectorBtn'),
        columnDropdown: document.getElementById('columnDropdown')
    };
    
    // Current order entry
    let currentOrderEntry = {
        strike: null,
        optionType: null,
        ltp: null,
        tradingSymbol: null,
        side: 'BUY',
        qty: 1,
        product: 'MIS',
        priceType: 'LIMIT',
        price: null
    };
    
    // Initialize
    function init() {
        setupEventListeners();
        loadExpiries();
        startAutoRefresh();
        updateBasketUI();
    }
    
    // Event Listeners
    function setupEventListeners() {
        elements.symbol.addEventListener('change', () => {
            stopAutoRefresh();
            loadExpiries();
        });
        
        elements.expiry.addEventListener('change', () => {
            stopAutoRefresh();
            loadOptionChain();
            startAutoRefresh();
        });
        
        // Column selector
        elements.columnSelectorBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            elements.columnDropdown.classList.toggle('show');
        });
        
        // Column checkboxes
        Object.keys(columnVisibility).forEach(col => {
            const checkbox = document.getElementById(`col-${col}`);
            if (checkbox) {
                checkbox.addEventListener('change', () => {
                    columnVisibility[col] = checkbox.checked;
                    renderTable();
                });
            }
        });
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!elements.columnDropdown.contains(e.target) && e.target !== elements.columnSelectorBtn) {
                elements.columnDropdown.classList.remove('show');
            }
            
            if (e.target === elements.basketModal) {
                closeBasketModal();
            }
            
            const popup = document.getElementById('orderPopup');
            if (popup.classList.contains('show') && !popup.contains(e.target)) {
                closeOrderPopup();
            }
        });
    }
    
    // Auto Refresh
    function startAutoRefresh() {
        stopAutoRefresh();
        
        autoRefreshTimer = setInterval(() => {
            if (elements.symbol.value && elements.expiry.value) {
                loadOptionChain(true);
            }
        }, config.autoRefreshInterval);
    }
    
    function stopAutoRefresh() {
        if (autoRefreshTimer) {
            clearInterval(autoRefreshTimer);
            autoRefreshTimer = null;
        }
    }
    
    // Error Handling
    function showError(message) {
        elements.errorMsg.textContent = message;
        elements.errorMsg.style.display = 'block';
        setTimeout(() => {
            elements.errorMsg.style.display = 'none';
        }, 5000);
    }
    
    // Load Expiries
    async function loadExpiries() {
        try {
            elements.expiry.innerHTML = '<option>Loading...</option>';
            elements.expiry.disabled = true;
            
            const res = await fetch(
                `/dashboard/option-chain/active-expiries?exchange=NFO&symbol=${elements.symbol.value}`,
                { credentials: 'include' }
            );
            
            if (!res.ok) throw new Error(`Failed to load expiries: ${res.status}`);
            
            const expiries = await res.json();
            
            if (!Array.isArray(expiries) || expiries.length === 0) {
                elements.expiry.innerHTML = '<option>No expiries</option>';
                elements.tableBody.innerHTML = '<tr><td colspan="100" class="no-data">No data available</td></tr>';
                return;
            }
            
            elements.expiry.innerHTML = expiries.map(e => {
                const expiryValue = typeof e === 'string' ? e : e.expiry;
                return `<option value="${expiryValue}">${expiryValue}</option>`;
            }).join('');
            
            elements.expiry.disabled = false;
            
            if (expiries.length > 0) {
                const firstExpiry = typeof expiries[0] === 'string' ? expiries[0] : expiries[0].expiry;
                elements.expiry.value = firstExpiry;
                await loadOptionChain();
            }
            
        } catch (error) {
            console.error('Error loading expiries:', error);
            showError(error.message);
            elements.expiry.innerHTML = '<option>Error</option>';
            elements.expiry.disabled = false;
        }
    }
    
    // Load Option Chain
    async function loadOptionChain(isAutoRefresh = false) {
        try {
            const res = await fetch(
                `/dashboard/option-chain?exchange=NFO&symbol=${elements.symbol.value}&expiry=${elements.expiry.value}&max_age=5`,
                { credentials: 'include' }
            );
            
            if (!res.ok) {
                const errorData = await res.json().catch(() => ({ detail: 'Unknown error' }));
                throw new Error(errorData.detail || `HTTP ${res.status}`);
            }
            
            const data = await res.json();
            
            if (!data.rows || data.rows.length === 0) {
                elements.tableBody.innerHTML = '<tr><td colspan="100" class="no-data">No data available</td></tr>';
                return;
            }
            
            const newStrikes = Object.keys(processChainData(data.rows)).map(Number).sort((a, b) => a - b);
            const strikeListChanged = JSON.stringify(newStrikes) !== JSON.stringify(currentStrikes);
            
            if (strikeListChanged || isFirstLoad) {
                isFirstLoad = false;
                currentStrikes = newStrikes;
                renderTable();
            } else {
                smartUpdateValues(data.rows);
            }
            
            updateInfoBar(data.meta || {});
            
        } catch (error) {
            console.error('Error loading option chain:', error);
            if (!isAutoRefresh) {
                showError(error.message);
            }
        }
    }
    
    function processChainData(rows) {
        const strikeMap = {};
        totalCeOi = 0;
        totalPeOi = 0;
        
        rows.forEach(row => {
            const strike = row.strike;
            if (!strikeMap[strike]) {
                strikeMap[strike] = { strike };
            }
            
            const prefix = row.option_type === 'CE' ? 'ce' : 'pe';
            strikeMap[strike][`${prefix}_ltp`] = parseFloat(row.ltp) || 0;
            strikeMap[strike][`${prefix}_change_pct`] = parseFloat(row.change_pct) || 0;
            strikeMap[strike][`${prefix}_volume`] = parseFloat(row.volume) || 0;
            strikeMap[strike][`${prefix}_oi`] = parseFloat(row.oi) || 0;
            strikeMap[strike][`${prefix}_iv`] = parseFloat(row.iv) || 0;
            strikeMap[strike][`${prefix}_trading_symbol`] = row.trading_symbol;
            strikeMap[strike][`${prefix}_delta`] = parseFloat(row.delta) || 0;
            strikeMap[strike][`${prefix}_gamma`] = parseFloat(row.gamma) || 0;
            strikeMap[strike][`${prefix}_theta`] = parseFloat(row.theta) || 0;
            strikeMap[strike][`${prefix}_vega`] = parseFloat(row.vega) || 0;
            
            if (row.option_type === 'CE') {
                totalCeOi += parseFloat(row.oi) || 0;
            } else {
                totalPeOi += parseFloat(row.oi) || 0;
            }
        });
        
        chainData = strikeMap;
        
        elements.ceOi.textContent = formatNumber(totalCeOi, 0);
        elements.peOi.textContent = formatNumber(totalPeOi, 0);
        elements.totalOI.textContent = formatNumber(totalCeOi + totalPeOi, 0);
        elements.pcr.textContent = totalCeOi > 0 ? (totalPeOi / totalCeOi).toFixed(2) : '0.00';
        
        return strikeMap;
    }
    
    function smartUpdateValues(rows) {
        const newStrikeMap = {};
        
        rows.forEach(row => {
            const strike = row.strike;
            if (!newStrikeMap[strike]) {
                newStrikeMap[strike] = {};
            }
            
            const prefix = row.option_type === 'CE' ? 'ce' : 'pe';
            newStrikeMap[strike][`${prefix}_ltp`] = parseFloat(row.ltp) || 0;
            newStrikeMap[strike][`${prefix}_change_pct`] = parseFloat(row.change_pct) || 0;
            newStrikeMap[strike][`${prefix}_volume`] = parseFloat(row.volume) || 0;
            newStrikeMap[strike][`${prefix}_oi`] = parseFloat(row.oi) || 0;
            newStrikeMap[strike][`${prefix}_iv`] = parseFloat(row.iv) || 0;
            newStrikeMap[strike][`${prefix}_delta`] = parseFloat(row.delta) || 0;
            newStrikeMap[strike][`${prefix}_gamma`] = parseFloat(row.gamma) || 0;
            newStrikeMap[strike][`${prefix}_theta`] = parseFloat(row.theta) || 0;
            newStrikeMap[strike][`${prefix}_vega`] = parseFloat(row.vega) || 0;
        });
        
        Object.keys(newStrikeMap).forEach(strike => {
            const newData = newStrikeMap[strike];
            const oldData = chainData[strike] || {};
            
            updateStrikeRow(strike, newData, oldData);
            chainData[strike] = { ...chainData[strike], ...newData };
        });
    }
    
    function updateStrikeRow(strike, newData, oldData) {
        const row = document.querySelector(`tr[data-strike="${strike}"]`);
        if (!row) return;
        
        updateCellGroup(row, newData, oldData, 'ce');
        updateCellGroup(row, newData, oldData, 'pe');
    }
    
    function updateCellGroup(row, newData, oldData, prefix) {
        const ltpCell = row.querySelector(`.${prefix}-ltp-cell`);
        if (ltpCell) {
            updateCellValue(ltpCell, newData[`${prefix}_ltp`], oldData[`${prefix}_ltp`], 'ltp');
        }
        
        if (columnVisibility.change) {
            const changeCell = row.querySelector(`.${prefix}-change-cell`);
            if (changeCell) {
                updateCellValue(changeCell, newData[`${prefix}_change_pct`], oldData[`${prefix}_change_pct`], 'change');
            }
        }
        
        if (columnVisibility.oi) {
            const oiCell = row.querySelector(`.${prefix}-oi-cell`);
            if (oiCell) {
                updateOiCell(oiCell, newData[`${prefix}_oi`], oldData[`${prefix}_oi`]);
            }
        }
        
        if (columnVisibility.volume) {
            const volumeCell = row.querySelector(`.${prefix}-volume-cell`);
            if (volumeCell) {
                updateCellValue(volumeCell, newData[`${prefix}_volume`], oldData[`${prefix}_volume`], 'volume');
            }
        }
        
        if (columnVisibility.iv) {
            const ivCell = row.querySelector(`.${prefix}-iv-cell`);
            if (ivCell) {
                updateCellValue(ivCell, newData[`${prefix}_iv`], oldData[`${prefix}_iv`], 'iv');
            }
        }
        
        if (columnVisibility.delta) {
            const deltaCell = row.querySelector(`.${prefix}-delta-cell`);
            if (deltaCell) {
                updateCellValue(deltaCell, newData[`${prefix}_delta`], oldData[`${prefix}_delta`], 'delta');
            }
        }
        
        if (columnVisibility.gamma) {
            const gammaCell = row.querySelector(`.${prefix}-gamma-cell`);
            if (gammaCell) {
                updateCellValue(gammaCell, newData[`${prefix}_gamma`], oldData[`${prefix}_gamma`], 'gamma');
            }
        }
        
        if (columnVisibility.theta) {
            const thetaCell = row.querySelector(`.${prefix}-theta-cell`);
            if (thetaCell) {
                updateCellValue(thetaCell, newData[`${prefix}_theta`], oldData[`${prefix}_theta`], 'theta');
            }
        }
        
        if (columnVisibility.vega) {
            const vegaCell = row.querySelector(`.${prefix}-vega-cell`);
            if (vegaCell) {
                updateCellValue(vegaCell, newData[`${prefix}_vega`], oldData[`${prefix}_vega`], 'vega');
            }
        }
    }
    
    function updateCellValue(cell, newValue, oldValue, column) {
        const hasChanged = Math.abs((newValue || 0) - (oldValue || 0)) > 0.0001;
        
        if (hasChanged) {
            let displayValue;
            if (column === 'change') {
                const changeClass = newValue >= 0 ? 'positive' : 'negative';
                displayValue = `<span class="${changeClass}">${newValue >= 0 ? '+' : ''}${formatNumber(newValue, 2)}%</span>`;
                cell.innerHTML = displayValue;
            } else if (column === 'iv') {
                cell.textContent = formatNumber(newValue, 1) + '%';
            } else if (column === 'delta' || column === 'gamma' || column === 'theta' || column === 'vega') {
                cell.textContent = formatNumber(newValue, Math.abs(newValue) < 0.01 ? 4 : 3);
            } else if (column === 'volume' || column === 'oi') {
                cell.textContent = formatNumber(newValue, 0);
            } else {
                cell.textContent = formatNumber(newValue, 2);
            }
            
            cell.classList.remove('value-changed');
            void cell.offsetWidth;
            cell.classList.add('value-changed');
        }
    }
    
    function updateOiCell(cell, newValue, oldValue) {
        const hasChanged = Math.abs((newValue || 0) - (oldValue || 0)) > 0.0001;
        
        if (hasChanged) {
            const barText = cell.querySelector('.bar-text');
            
            if (barText) {
                barText.textContent = formatNumber(newValue, 0);
            }
            
            cell.classList.remove('value-changed');
            void cell.offsetWidth;
            cell.classList.add('value-changed');
        }
    }
    
    function updateInfoBar(meta) {
        currentSpotPrice = parseFloat(meta.spot_price) || parseFloat(meta.spot_ltp) || 0;
        currentFuturePrice = parseFloat(meta.future_price) || parseFloat(meta.fut_ltp) || 0;
        
        elements.spotPrice.textContent = `â‚¹${formatNumber(currentSpotPrice, 2)}`;
        elements.futurePrice.textContent = `â‚¹${formatNumber(currentFuturePrice, 2)}`;
        
        const strikes = Object.keys(chainData).map(Number).sort((a, b) => a - b);
        if (strikes.length > 0 && currentSpotPrice > 0) {
            atmStrike = findATMStrike(strikes, currentSpotPrice);
            elements.atmStrikeEl.textContent = atmStrike;
        }
        
        elements.lastUpdated.textContent = new Date().toLocaleTimeString('en-IN', {
            hour12: false,
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }
    
    function findATMStrike(strikes, spotPrice) {
        if (!spotPrice || strikes.length === 0) return 0;
        return strikes.reduce((prev, curr) => 
            Math.abs(curr - spotPrice) < Math.abs(prev - spotPrice) ? curr : prev
        );
    }
    
    // Table rendering
    function renderTable() {
        renderTableHeaders();
        renderTableBody();
    }
    
    function renderTableHeaders() {
        const columnLabels = {
            oi: 'OI',
            volume: 'Volume',
            iv: 'IV%',
            delta: 'Delta',
            gamma: 'Gamma',
            theta: 'Theta',
            vega: 'Vega',
            change: 'Change%',
            ltp: 'LTP'
        };
        
        const visibleColumns = Object.keys(columnVisibility).filter(col => columnVisibility[col]);
        const colCount = visibleColumns.length + 1; // +1 for LTP
        
        let headerHTML = '';
        
        headerHTML += `<th colspan="${colCount}" class="section-header calls-header">CALLS</th>`;
        headerHTML += `<th class="section-header">STRIKE</th>`;
        headerHTML += `<th colspan="${colCount}" class="section-header puts-header">PUTS</th>`;
        headerHTML = `<tr>${headerHTML}</tr><tr>`;
        
        // Call columns
        visibleColumns.forEach(col => {
            headerHTML += `<th>${columnLabels[col]}</th>`;
        });
        headerHTML += `<th>${columnLabels.ltp}</th>`;
        
        // Strike
        headerHTML += `<th>STRIKE</th>`;
        
        // Put columns (reverse order)
        headerHTML += `<th>${columnLabels.ltp}</th>`;
        visibleColumns.slice().reverse().forEach(col => {
            headerHTML += `<th>${columnLabels[col]}</th>`;
        });
        
        headerHTML += '</tr>';
        elements.tableHeader.innerHTML = headerHTML;
    }
    
    function renderTableBody() {
        const strikes = Object.keys(chainData).map(Number).sort((a, b) => a - b);
        let maxOI = 0;
        
        strikes.forEach(strike => {
            maxOI = Math.max(maxOI, chainData[strike].ce_oi || 0, chainData[strike].pe_oi || 0);
        });
        
        let bodyHTML = '';
        
        strikes.forEach(strike => {
            const data = chainData[strike];
            const isATM = strike === atmStrike;
            const callItm = strike < currentSpotPrice;
            const putItm = strike > currentSpotPrice;
            
            bodyHTML += `<tr class="${isATM ? 'atm-row' : ''}" data-strike="${strike}">`;
            
            // Call columns
            if (columnVisibility.oi) {
                const ceOiPct = maxOI > 0 ? ((data.ce_oi || 0) / maxOI) * 100 : 0;
                bodyHTML += `<td class="call-${callItm ? 'itm' : 'otm'} ce-oi-cell">
                    <div class="bar-container">
                        <div class="bar-fill bar-call" style="width: ${ceOiPct}%"></div>
                        <div class="bar-text">${formatNumber(data.ce_oi, 0)}</div>
                    </div>
                </td>`;
            }
            
            if (columnVisibility.volume) {
                bodyHTML += `<td class="call-${callItm ? 'itm' : 'otm'} ce-volume-cell">${formatNumber(data.ce_volume, 0)}</td>`;
            }
            
            if (columnVisibility.iv) {
                bodyHTML += `<td class="call-${callItm ? 'itm' : 'otm'} ce-iv-cell">${formatNumber(data.ce_iv, 1)}%</td>`;
            }
            
            if (columnVisibility.delta) {
                bodyHTML += `<td class="call-${callItm ? 'itm' : 'otm'} ce-delta-cell">${formatNumber(data.ce_delta, 3)}</td>`;
            }
            
            if (columnVisibility.gamma) {
                bodyHTML += `<td class="call-${callItm ? 'itm' : 'otm'} ce-gamma-cell">${formatNumber(data.ce_gamma, 4)}</td>`;
            }
            
            if (columnVisibility.theta) {
                bodyHTML += `<td class="call-${callItm ? 'itm' : 'otm'} ce-theta-cell">${formatNumber(data.ce_theta, 3)}</td>`;
            }
            
            if (columnVisibility.vega) {
                bodyHTML += `<td class="call-${callItm ? 'itm' : 'otm'} ce-vega-cell">${formatNumber(data.ce_vega, 3)}</td>`;
            }
            
            if (columnVisibility.change) {
                const ceChangeClass = getChangeClass(data.ce_change_pct);
                bodyHTML += `<td class="call-${callItm ? 'itm' : 'otm'} ce-change-cell ${ceChangeClass}">
                    ${data.ce_change_pct >= 0 ? '+' : ''}${formatNumber(data.ce_change_pct, 2)}%
                </td>`;
            }
            
            // Call LTP
            const ceChangeClass = getChangeClass(data.ce_change_pct);
            bodyHTML += `<td class="ltp-cell call-${callItm ? 'itm' : 'otm'} ce-ltp-cell ${ceChangeClass}" 
                           onclick="openOrderEntry(${strike}, 'CE', ${data.ce_ltp || 0}, '${data.ce_trading_symbol || ''}', event)">
                           ${formatNumber(data.ce_ltp, 2)}
                       </td>`;
            
            // Strike
            bodyHTML += `<td class="strike-cell">${formatNumber(strike, 0)}</td>`;
            
            // Put LTP
            const peChangeClass = getChangeClass(data.pe_change_pct);
            bodyHTML += `<td class="ltp-cell put-${putItm ? 'itm' : 'otm'} pe-ltp-cell ${peChangeClass}" 
                           onclick="openOrderEntry(${strike}, 'PE', ${data.pe_ltp || 0}, '${data.pe_trading_symbol || ''}', event)">
                           ${formatNumber(data.pe_ltp, 2)}
                       </td>`;
            
            // Put columns (reverse order)
            if (columnVisibility.change) {
                bodyHTML += `<td class="put-${putItm ? 'itm' : 'otm'} pe-change-cell ${peChangeClass}">
                    ${data.pe_change_pct >= 0 ? '+' : ''}${formatNumber(data.pe_change_pct, 2)}%
                </td>`;
            }
            
            if (columnVisibility.vega) {
                bodyHTML += `<td class="put-${putItm ? 'itm' : 'otm'} pe-vega-cell">${formatNumber(data.pe_vega, 3)}</td>`;
            }
            
            if (columnVisibility.theta) {
                bodyHTML += `<td class="put-${putItm ? 'itm' : 'otm'} pe-theta-cell">${formatNumber(data.pe_theta, 3)}</td>`;
            }
            
            if (columnVisibility.gamma) {
                bodyHTML += `<td class="put-${putItm ? 'itm' : 'otm'} pe-gamma-cell">${formatNumber(data.pe_gamma, 4)}</td>`;
            }
            
            if (columnVisibility.delta) {
                bodyHTML += `<td class="put-${putItm ? 'itm' : 'otm'} pe-delta-cell">${formatNumber(data.pe_delta, 3)}</td>`;
            }
            
            if (columnVisibility.iv) {
                bodyHTML += `<td class="put-${putItm ? 'itm' : 'otm'} pe-iv-cell">${formatNumber(data.pe_iv, 1)}%</td>`;
            }
            
            if (columnVisibility.volume) {
                bodyHTML += `<td class="put-${putItm ? 'itm' : 'otm'} pe-volume-cell">${formatNumber(data.pe_volume, 0)}</td>`;
            }
            
            if (columnVisibility.oi) {
                const peOiPct = maxOI > 0 ? ((data.pe_oi || 0) / maxOI) * 100 : 0;
                bodyHTML += `<td class="put-${putItm ? 'itm' : 'otm'} pe-oi-cell">
                    <div class="bar-container">
                        <div class="bar-fill bar-put" style="width: ${peOiPct}%"></div>
                        <div class="bar-text">${formatNumber(data.pe_oi, 0)}</div>
                    </div>
                </td>`;
            }
            
            bodyHTML += '</tr>';
        });
        
        elements.tableBody.innerHTML = bodyHTML;
    }
    
    function formatNumber(value, decimals = 2) {
        if (value === null || value === undefined || isNaN(value)) return '-';
        
        if (decimals === 0) {
            return Math.round(value).toLocaleString('en-IN');
        }
        
        return parseFloat(value).toFixed(decimals);
    }
    
    function getChangeClass(change) {
        if (change === null || change === undefined || isNaN(change)) return '';
        return change >= 0 ? 'positive' : 'negative';
    }
    
    // Order Entry Functions
    function openOrderEntry(strike, optionType, ltp, tradingSymbol, event) {
        event.stopPropagation();
        
        currentOrderEntry = {
            strike,
            optionType,
            ltp,
            tradingSymbol,
            side: 'BUY',
            qty: 1,
            product: 'MIS',
            priceType: 'LIMIT',
            price: ltp
        };
        
        elements.orderPopupTitle.textContent = tradingSymbol;
        elements.orderQty.value = 1;
        elements.orderPrice.value = ltp;
        
        setOrderSide('BUY');
        setOrderProduct('MIS');
        setOrderPriceType('LIMIT');
        
        const popup = elements.orderPopup;
        const rect = event.target.getBoundingClientRect();
        popup.style.left = `${rect.left}px`;
        popup.style.top = `${rect.bottom + 5}px`;
        
        setTimeout(() => {
            const popupRect = popup.getBoundingClientRect();
            if (popupRect.right > window.innerWidth) {
                popup.style.left = `${window.innerWidth - popupRect.width - 10}px`;
            }
            if (popupRect.bottom > window.innerHeight) {
                popup.style.top = `${rect.top - popupRect.height - 5}px`;
            }
        }, 10);
        
        popup.classList.add('show');
    }
    
    function closeOrderPopup() {
        elements.orderPopup.classList.remove('show');
    }
    
    function setOrderSide(side) {
        currentOrderEntry.side = side;
        elements.orderSideBuy.style.opacity = side === 'BUY' ? '1' : '0.5';
        elements.orderSideSell.style.opacity = side === 'SELL' ? '1' : '0.5';
    }
    
    function setOrderProduct(product) {
        currentOrderEntry.product = product;
        elements.orderProductMIS.style.opacity = product === 'MIS' ? '1' : '0.5';
        elements.orderProductNRML.style.opacity = product === 'NRML' ? '1' : '0.5';
    }
    
    function setOrderPriceType(priceType) {
        currentOrderEntry.priceType = priceType;
        elements.orderPriceTypeMKT.style.opacity = priceType === 'MARKET' ? '1' : '0.5';
        elements.orderPriceTypeLMT.style.opacity = priceType === 'LIMIT' ? '1' : '0.5';
        elements.orderPriceGroup.style.display = priceType === 'MARKET' ? 'none' : 'block';
    }
    
    function confirmOrderEntry() {
        const qty = parseInt(elements.orderQty.value);
        const price = parseFloat(elements.orderPrice.value);
        
        if (!qty || qty < 1) {
            showError('Invalid quantity');
            return;
        }
        
        if (currentOrderEntry.priceType === 'LIMIT' && (!price || price <= 0)) {
            showError('Invalid price for LIMIT order');
            return;
        }
        
        currentOrderEntry.qty = qty;
        currentOrderEntry.price = currentOrderEntry.priceType === 'LIMIT' ? price : null;
        
        addToBasket(
            currentOrderEntry.strike,
            currentOrderEntry.optionType,
            currentOrderEntry.ltp,
            currentOrderEntry.tradingSymbol,
            currentOrderEntry.side,
            currentOrderEntry.qty,
            currentOrderEntry.product,
            currentOrderEntry.priceType,
            currentOrderEntry.price
        );
        
        closeOrderPopup();
    }
    
    // Basket Functions
    function addToBasket(strike, optionType, ltp, tradingSymbol, side, qty, product, orderType, price) {
        const exists = basket.find(item => item.strike === strike && item.optionType === optionType);
        
        if (exists) {
            showError(`${tradingSymbol} already in basket`);
            return;
        }
        
        basket.push({
            strike,
            optionType,
            ltp,
            tradingSymbol,
            side,
            qty,
            product,
            orderType,
            price
        });
        
        updateBasketUI();
        showBasketToast(`Added ${tradingSymbol} to basket`);
    }
    
    function removeFromBasket(index) {
        basket.splice(index, 1);
        updateBasketUI();
        renderBasketItems();
    }
    
    function updateBasketUI() {
        const count = basket.length;
        elements.basketCount.textContent = count;
        if (count > 0) {
            elements.basketCount.classList.add('show');
        } else {
            elements.basketCount.classList.remove('show');
        }
    }
    
    function showBasketToast(msg) {
        const toast = document.createElement('div');
        toast.textContent = msg;
        toast.style.cssText = `
            position: fixed;
            top: 70px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 10px 16px;
            border-radius: 6px;
            z-index: 1000;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 2000);
    }
    
    function openBasketModal() {
        if (basket.length === 0) {
            showError('Basket is empty');
            return;
        }
        renderBasketItems();
        elements.basketModal.style.display = 'flex';
    }
    
    function closeBasketModal() {
        elements.basketModal.style.display = 'none';
    }
    
    function renderBasketItems() {
        if (basket.length === 0) {
            elements.basketItems.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--muted)">Basket is empty</div>';
            return;
        }
        
        elements.basketItems.innerHTML = basket.map((item, idx) => `
            <div class="basket-item" style="background: #1c2333; padding: 12px; border-radius: 6px; margin-bottom: 8px; border: 1px solid var(--border)">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px">
                    <span style="font-weight: 700; font-size: 13px">${item.tradingSymbol}</span>
                    <button onclick="removeFromBasket(${idx})" style="background: var(--danger); padding: 3px 8px; font-size: 10px; border: none; border-radius: 3px; color: white; cursor: pointer">
                        Remove
                    </button>
                </div>
                <div style="font-size: 11px; color: var(--muted)">
                    ${item.side} | ${item.qty} Lots | ${item.product} | ${item.orderType} ${item.orderType === 'LIMIT' ? '@ â‚¹' + item.price : ''}
                </div>
            </div>
        `).join('');
    }
    
    async function placeBasketOrders() {
        if (basket.length === 0) return;
        
        const confirmBtn = document.getElementById('confirmBasketBtn');
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'Placing...';
        
        try {
            const orders = basket.map(item => ({
                exchange: 'NFO',
                symbol: item.tradingSymbol,
                side: item.side,
                qty: item.qty,
                product: item.product,
                order_type: item.orderType,
                price: item.orderType === 'LIMIT' ? item.price : null,
                execution_type: 'ENTRY',
                test_mode: null,
                triggered_order: 'NO',
                trigger_value: null,
                target: null,
                stoploss: null,
                trail_sl: null,
                trail_when: null,
                reason: 'OPTION_CHAIN_BASKET'
            }));
            
            const res = await fetch('/dashboard/intent/basket', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ orders, reason: 'OPTION_CHAIN_BASKET' })
            });
            
            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.detail || `HTTP ${res.status}`);
            }
            
            const data = await res.json();
            showBasketToast(`âœ“ Orders queued (${data.intent_id})`);
            basket = [];
            updateBasketUI();
            closeBasketModal();
        } catch (err) {
            showError('Order placement failed: ' + err.message);
        } finally {
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'Confirm & Place Orders';
        }
    }
    
    window.addEventListener('load', init);
</script>
</body>
</html>