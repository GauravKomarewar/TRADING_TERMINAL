<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard ‚Äì Shoonya Platform</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/dashboard/web/styles/common.css">
    <link rel="stylesheet" href="/dashboard/web/shared/layout.css">
    <script src="/dashboard/web/shared/layout.js" defer></script>
    <style>
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .overview-grid {
            display: grid;
            grid-template-columns: minmax(280px, 1.1fr) minmax(220px, 1fr) minmax(220px, 1fr);
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .stat-block {
            display: grid;
            gap: 6px;
        }

        .stat-block + .stat-block {
            margin-top: var(--spacing-md);
            padding-top: var(--spacing-md);
            border-top: 1px solid var(--border);
        }
        
        .stat-card {
            background: var(--panel);
            border: 1px solid var(--border);
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            transition: var(--transition);
        }
        
        .stat-card:hover {
            border-color: var(--border-light);
        }
        
        .stat-label {
            font-size: var(--font-xs);
            color: var(--muted);
            text-transform: uppercase;
            margin-bottom: var(--spacing-sm);
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .refresh-indicator {
            font-size: 11px;
            color: var(--muted);
            font-weight: 400;
        }
        
        /* Tables */
        .table-wrap {
            overflow-x: auto;
            max-height: 500px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        th {
            background: #1c2333;
            padding: 12px;
            text-align: left;
            color: var(--muted);
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }
        
        tr:hover {
            background: #1c2333;
        }
        
        /* Badges */
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            white-space: nowrap;
        }
        
        .badge.ok {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .badge.warn {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }
        
        .badge.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--muted);
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }
        
        /* Status Items */
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }
        
        .status-item:last-child {
            border-bottom: none;
        }
        
        .status-label {
            color: var(--muted);
            font-size: 13px;
        }
        
        .status-value {
            font-weight: 600;
            font-size: 13px;
        }
        
        /* Error Banner */
        .error-banner {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
            display: none;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .error-banner.show {
            display: block;
        }
        
        /* Value Change Animation */
        @keyframes valueChange {
            0% { background-color: rgba(59, 130, 246, 0.2); }
            100% { background-color: transparent; }
        }
        
        .value-changed {
            animation: valueChange 0.4s ease-out;
        }
        
        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Auto-refresh indicator */
        .auto-refresh-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--success);
        }
        
        .refresh-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .mini-card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px;
        }

        .mini-title {
            font-size: 11px;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.6px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .mini-value {
            font-size: 18px;
            font-weight: 700;
        }

        .mini-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            padding: 6px 0;
            border-bottom: 1px solid var(--border);
        }

        .mini-row:last-child {
            border-bottom: none;
        }

        .message-list {
            max-height: 320px;
            overflow-y: auto;
            padding: 8px;
        }

        .message-item {
            border: 1px solid var(--border);
            background: #1c2333;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
        }

        .message-meta {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--muted);
            margin-bottom: 6px;
        }

        .message-text {
            font-size: 12px;
            line-height: 1.4;
            white-space: pre-wrap;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .grid-main {
                grid-template-columns: 1fr;
            }

            .overview-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body data-page="dashboard">
<div id="app-header"></div>

<main>
    <div id="errorBanner" class="error-banner"></div>

    <!-- Top Overview -->
    <div class="overview-grid">
        <div class="card">
            <div class="card-header">Account Limits</div>
            <div style="padding: 20px">
                <div class="status-item">
                    <span class="status-label">Cash Available</span>
                    <span id="cashAvail" class="status-value">‚Çπ0.00</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Collateral</span>
                    <span id="collateral" class="status-value">‚Çπ0.00</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Used Margin</span>
                    <span id="usedMargin" class="status-value">‚Çπ0.00</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Available Margin</span>
                    <span id="availMargin" class="status-value">‚Çπ0.00</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Net Available</span>
                    <span id="netAvail" class="status-value" style="font-weight: 700">‚Çπ0.00</span>
                </div>
            </div>
        </div>

        <div style="display: grid; gap: var(--spacing-lg)">
            <div class="stat-card">
                <div class="stat-label">Net PnL</div>
                <div id="netPnl" class="stat-value neutral">‚Çπ0.00</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Open Positions</div>
                <div id="openPositions" class="stat-value neutral">0</div>
            </div>
        </div>

        <div class="mini-card">
            <div class="mini-title">Risk Manager</div>
            <div class="mini-value" id="riskStatusBadge">SAFE</div>
            <div class="mini-row">
                <span>Trailing SL</span>
                <span id="riskTrailingSl">--</span>
            </div>
            <div class="mini-row">
                <span>Peak Profit</span>
                <span id="riskPeakProfit">--</span>
            </div>
            <div class="mini-row">
                <span>Daily Loss Hit</span>
                <span id="riskDailyLoss">--</span>
            </div>
            <div class="mini-row">
                <span>Human Violation</span>
                <span id="riskHumanViolation">--</span>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Pending Orders</div>
            <div id="pendingOrders" class="stat-value neutral">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">System Signal</div>
            <div id="systemSignal" class="stat-value neutral">IDLE</div>
        </div>
    </div>

    <!-- System Analytics -->
    <div class="analytics-grid">

        <div class="mini-card">
            <div class="mini-title">Alerts Summary</div>
            <div class="mini-value" id="alertTotal">0</div>
            <div class="mini-row">
                <span>Success</span>
                <span id="alertSuccess">0</span>
            </div>
            <div class="mini-row">
                <span>Failed</span>
                <span id="alertFailed">0</span>
            </div>
            <div class="mini-row">
                <span>Alerts Received</span>
                <span id="alertReceived">0</span>
            </div>
            <div class="mini-row">
                <span>Risk Alerts</span>
                <span id="alertRisk">0</span>
            </div>
        </div>

        <div class="mini-card">
            <div class="mini-title">Market Data</div>
            <div class="mini-value" id="heartbeatAgeMini">--</div>
            <div class="mini-row">
                <span>Chains</span>
                <span id="heartbeatChains">--</span>
            </div>
            <div class="mini-row">
                <span>Login</span>
                <span id="heartbeatLogin">--</span>
            </div>
            <div class="mini-row">
                <span>Last Update</span>
                <span id="heartbeatLast">--</span>
            </div>
        </div>

        <div class="mini-card">
            <div class="mini-title">System Signals</div>
            <div class="mini-value" id="signalStatusMini">IDLE</div>
            <div class="mini-row">
                <span>Open Orders</span>
                <span id="openOrdersMini">0</span>
            </div>
            <div class="mini-row">
                <span>Last Order</span>
                <span id="lastOrderTime">--</span>
            </div>
            <div class="mini-row">
                <span>Messages</span>
                <span id="telegramMessageCount">0</span>
            </div>
        </div>
    </div>
    
    <!-- Main Grid -->
    <div class="grid-main">
        <!-- Left Column -->
        <div style="display: grid; grid-template-columns: 1fr; gap: 24px">
            <!-- Positions Table -->
            <div class="card">
                <div class="card-header">
                    <span>Active Positions</span>
                    <span class="refresh-indicator" id="posRefresh">Updated just now</span>
                </div>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>LTP</th>
                                <th>Net PnL</th>
                                <th>Realized PnL</th>
                                <th>Unrealized PnL</th>
                                <th>Exchange</th>
                                <th>Product</th>
                                <th>Qty</th>
                                <th>Avg Price</th>
                            </tr>
                        </thead>
                        <tbody id="positionRows">
                            <tr>
                                <td colspan="9" class="empty-state">
                                    <div class="empty-state-icon">üìä</div>
                                    Loading positions...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Holdings Table -->
            <div class="card">
                <div class="card-header">Holdings</div>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>LTP</th>
                                <th>Net PnL</th>
                                <th>Realized PnL</th>
                                <th>Unrealized PnL</th>
                                <th>Exchange</th>
                                <th>Product</th>
                                <th>Qty</th>
                                <th>Avg Price</th>
                            </tr>
                        </thead>
                        <tbody id="holdingsRows">
                            <tr>
                                <td colspan="9" class="empty-state">
                                    <div class="empty-state-icon">üìà</div>
                                    Loading holdings...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- System Messages -->
            <div class="card">
                <div class="card-header">
                    <span>System Messages (Telegram)</span>
                    <span class="badge ok" id="telegramMessageBadge">0</span>
                </div>
                <div class="message-list" id="telegramMessages">
                    <div class="empty-state">
                        <div class="empty-state-icon">üí¨</div>
                        Waiting for messages...
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Column -->
        <div style="display: grid; grid-template-columns: 1fr; gap: 24px; grid-template-rows: auto">
            <!-- System Status -->
            <div class="card">
                <div class="card-header">System Status</div>
                <div style="padding: 20px">
                    <div class="status-item">
                        <span class="status-label">Broker Connection</span>
                        <span id="loginStatus" class="badge ok">CHECKING</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Last Heartbeat</span>
                        <span id="heartbeatAge" class="status-value">--</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Risk Status</span>
                        <span id="riskStatus" class="badge ok">SAFE</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Daily High</span>
                        <span id="dailyHigh" class="status-value">‚Çπ0.00</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Daily Low</span>
                        <span id="dailyLow" class="status-value">‚Çπ0.00</span>
                    </div>
                    <div id="forceExitAlert" style="display: none; padding: 12px; background: rgba(239, 68, 68, 0.15); color: var(--danger); border-radius: 8px; font-size: 12px; font-weight: 600; text-align: center; margin-top: 16px; border: 1px solid rgba(239, 68, 68, 0.3)">
                        ‚ö†Ô∏è FORCE EXIT IN PROGRESS
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    // Logout handler
    async function logout() {
        try {
            await fetch('/auth/logout', {
                method: 'POST',
                credentials: 'include'
            });
        } catch (e) {
            console.log('Logout completed');
        }
        window.location.href = '/';
    }
    
    // Check authentication on page load
    window.addEventListener('DOMContentLoaded', function(){
        checkAuth();
        try { g_exchange.value = 'NFO'; g_symbol.value = 'NIFTY'; } catch(e){}
        // Start auto-refresh on load
        startAutoRefresh();
        // Initial immediate update
        updateDashboard(false);
    });
    async function checkAuth() {
        try {
            const res = await fetch('/dashboard/home/status', {
                credentials: 'include'
            });
            if (res.status === 401) {
                window.location.href = '/';
            }
        } catch (e) {
            console.log('Auth check completed');
        }
    }
    
    // Configuration
    const config = {
        autoRefreshInterval: 1000, // 1 second (real-time)
        maxRetries: 3,
        retryDelay: 2000
    };
    
    // State
    let lastUpdate = Date.now();
    let autoRefreshTimer = null;
    let isRefreshing = false;
    let retryCount = 0;
    
    // Error Handling
    function showError(msg) {
        console.error('Dashboard Error:', msg);
        const banner = document.getElementById('errorBanner');
        banner.textContent = '‚ö†Ô∏è ' + msg;
        banner.classList.add('show');
        setTimeout(() => banner.classList.remove('show'), 5000);
    }
    
    // Formatting Utilities
    function formatCurrency(val) {
        if (val === null || val === undefined || isNaN(val)) return '‚Çπ0.00';
        return '‚Çπ' + parseFloat(val).toLocaleString('en-IN', { 
            minimumFractionDigits: 2, 
            maximumFractionDigits: 2 
        });
    }
    
    function formatNumber(val, decimals = 0) {
        if (val === null || val === undefined || isNaN(val)) return '0';
        return parseFloat(val).toLocaleString('en-IN', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        });
    }
    
    function getTimeSince(seconds) {
        if (!seconds || seconds < 0) return '--';
        if (seconds < 60) return `${Math.floor(seconds)}s ago`;
        if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
        return `${Math.floor(seconds / 3600)}h ago`;
    }
    
    // Cell Update with Animation
    function updateCellValue(cell, newValue, isColored = false, decimals = 2) {
        if (!cell) return;
        
        const formatted = typeof newValue === 'string' ? newValue : 
                         (decimals === 0 ? formatNumber(newValue, 0) : formatCurrency(newValue));
        
        if (cell.textContent !== formatted) {
            cell.textContent = formatted;
            
            // Flash animation
            cell.classList.remove('value-changed');
            void cell.offsetWidth; // Force reflow
            cell.classList.add('value-changed');
        }
        
        if (isColored) {
            const value = parseFloat(newValue) || 0;
            cell.style.color = value >= 0 ? 'var(--success)' : 'var(--danger)';
        }
    }
    
    // Stat Update with Animation
    function updateStatValue(elementId, newValue, className = 'neutral') {
        const el = document.getElementById(elementId);
        if (!el) return;
        
        const formatted = typeof newValue === 'string' ? newValue : formatCurrency(newValue);
        
        if (el.textContent !== formatted) {
            el.textContent = formatted;
            el.classList.remove('value-changed');
            void el.offsetWidth;
            el.classList.add('value-changed');
        }
        
        el.className = `stat-value ${className}`;
    }
    
    // Logout
    async function logout() {
        try {
            await fetch('/auth/logout', { 
                method: 'POST', 
                credentials: 'include' 
            });
            window.location.href = '/';
        } catch (err) {
            console.error('Logout failed:', err);
            showError('Logout failed. Please try again.');
        }
    }
    
    // Auto-refresh control
    function startAutoRefresh() {
        if (autoRefreshTimer) return;
        autoRefreshTimer = setInterval(() => updateDashboard(true), config.autoRefreshInterval);
        const autoRefreshStatus = document.getElementById('autoRefreshStatus');
        if (autoRefreshStatus) {
            autoRefreshStatus.classList.add('active');
            const dot = autoRefreshStatus.querySelector('.refresh-dot');
            if (dot) dot.classList.add('active');
            const ri = document.getElementById('refreshInterval'); if (ri) ri.textContent = (config.autoRefreshInterval/1000)+'s';
        }
    }

    function stopAutoRefresh() {
        if (!autoRefreshTimer) return;
        clearInterval(autoRefreshTimer);
        autoRefreshTimer = null;
        const autoRefreshStatus = document.getElementById('autoRefreshStatus');
        if (autoRefreshStatus) {
            autoRefreshStatus.classList.remove('active');
            const dot = autoRefreshStatus.querySelector('.refresh-dot');
            if (dot) dot.classList.remove('active');
        }
    }
    
    // Main Dashboard Update
    async function updateDashboard(isAutoRefresh = true) {
        if (isRefreshing) return;
        
        isRefreshing = true;
        const refreshBtn = document.getElementById('refreshBtn');
        const originalText = refreshBtn ? refreshBtn.innerHTML : null;
        if (refreshBtn) {
            refreshBtn.innerHTML = '<span class="spinner"></span> Refreshing...';
        }
        
        try {
            const res = await fetch('/dashboard/home/status', { 
                credentials: 'include',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            });
            
            if (!res.ok) {
                if (res.status === 401) {
                    window.location.href = '/';
                    return;
                }
                
                let errorDetail = `HTTP ${res.status}`;
                try {
                    const errorData = await res.json();
                    errorDetail = errorData.detail || errorDetail;
                } catch (e) {
                    // Response is not JSON
                }
                throw new Error(errorDetail);
            }
            
            const data = await res.json();
            console.log('Dashboard API Response:', data);
            
            // Extract data with fallbacks
            const broker = data.broker || {};
            const system = data.system || {};
            
            // Update Stats
            updateStats(broker, system);
            
            // Update Tables
            updatePositionsTable(broker.positions || []);
            updateHoldingsTable(broker.holdings || []);
            
            // Update System Status
            updateSystemStatus(system);

            // Update Risk / Alerts / Messages
            updateRiskWidgets(system.risk || null);
            updateAlertSummary(system.telegram_stats || null);
            updateTelegramMessages(system.telegram_messages || []);
            updateHeartbeatMini(system.heartbeat || null);
            updateSignalMini(system.signal || null, system.open_orders || 0, system.orders || []);
            
            // Update Limits
            updateLimits(broker.limits || {});
            
            // Update refresh indicator
            lastUpdate = Date.now();
            const posRefreshEl = document.getElementById('posRefresh');
            if (posRefreshEl) posRefreshEl.textContent = 'Updated just now';
            
            // Update auto-refresh status
            const autoRefreshStatus = document.getElementById('autoRefreshStatus');
            if (autoRefreshStatus) {
                const refreshDot = autoRefreshStatus.querySelector('.refresh-dot');
                autoRefreshStatus.classList.add('active');
                if (refreshDot) refreshDot.classList.add('active');
            }
            
            // Reset retry count on success
            retryCount = 0;
            
        } catch (err) {
            console.error('Dashboard update error:', err);
            
            if (!isAutoRefresh) {
                showError('Failed to update dashboard: ' + err.message);
            }
            
            // Retry logic for auto-refresh
            if (isAutoRefresh && retryCount < config.maxRetries) {
                retryCount++;
                console.log(`Retry attempt ${retryCount}/${config.maxRetries}`);
                setTimeout(() => updateDashboard(true), config.retryDelay);
            }
            
        } finally {
            isRefreshing = false;
            if (refreshBtn && originalText !== null) {
                refreshBtn.innerHTML = originalText;
            }
        }
    }

    function updateRiskWidgets(risk) {
        const riskStatusEl = document.getElementById('riskStatusBadge');
        const trailingEl = document.getElementById('riskTrailingSl');
        const peakEl = document.getElementById('riskPeakProfit');
        const dailyLossEl = document.getElementById('riskDailyLoss');
        const humanEl = document.getElementById('riskHumanViolation');

        if (!risk || Object.keys(risk).length === 0) {
            riskStatusEl.textContent = 'UNKNOWN';
            trailingEl.textContent = '--';
            peakEl.textContent = '--';
            dailyLossEl.textContent = '--';
            humanEl.textContent = '--';
            return;
        }

        const dailyLossHit = !!risk.daily_loss_hit;
        const humanViolation = !!risk.human_violation_detected;
        const status = dailyLossHit || humanViolation ? 'ALERT' : 'SAFE';

        riskStatusEl.textContent = status;
        riskStatusEl.style.color = status === 'SAFE' ? 'var(--success)' : 'var(--danger)';
        trailingEl.textContent = formatCurrency(risk.dynamic_max_loss || 0);
        peakEl.textContent = formatCurrency(risk.highest_profit || 0);
        dailyLossEl.textContent = dailyLossHit ? 'YES' : 'NO';
        humanEl.textContent = humanViolation ? 'YES' : 'NO';
    }

    function updateAlertSummary(stats) {
        const totalEl = document.getElementById('alertTotal');
        const successEl = document.getElementById('alertSuccess');
        const failedEl = document.getElementById('alertFailed');
        const receivedEl = document.getElementById('alertReceived');
        const riskEl = document.getElementById('alertRisk');

        if (!stats) {
            totalEl.textContent = '0';
            successEl.textContent = '0';
            failedEl.textContent = '0';
            receivedEl.textContent = '0';
            riskEl.textContent = '0';
            return;
        }

        totalEl.textContent = formatNumber(stats.total || 0);
        successEl.textContent = formatNumber(stats.success || 0);
        failedEl.textContent = formatNumber(stats.failed || 0);
        receivedEl.textContent = formatNumber(stats.alerts || 0);
        riskEl.textContent = formatNumber(stats.risk || 0);

        const msgCount = document.getElementById('telegramMessageCount');
        const msgBadge = document.getElementById('telegramMessageBadge');
        if (msgCount) msgCount.textContent = formatNumber(stats.total || 0);
        if (msgBadge) msgBadge.textContent = formatNumber(stats.total || 0);
    }

    function updateTelegramMessages(messages) {
        const container = document.getElementById('telegramMessages');
        if (!container) return;

        if (!messages || messages.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üí¨</div>
                    No messages yet
                </div>
            `;
            return;
        }

        const recent = messages.slice(-50).reverse();
        container.innerHTML = recent.map(item => {
            const ts = item.ts ? new Date(item.ts * 1000) : null;
            const timeStr = ts ? ts.toLocaleTimeString('en-IN') : '--';
            const dateStr = ts ? ts.toLocaleDateString('en-IN') : '--';
            const raw = (item.message || '').replace(/<[^>]*>/g, '');
            return `
                <div class="message-item">
                    <div class="message-meta">
                        <span>${dateStr} ${timeStr}</span>
                        <span>Telegram</span>
                    </div>
                    <div class="message-text">${raw}</div>
                </div>
            `;
        }).join('');
    }

    function updateHeartbeatMini(heartbeat) {
        const ageEl = document.getElementById('heartbeatAgeMini');
        const chainsEl = document.getElementById('heartbeatChains');
        const loginEl = document.getElementById('heartbeatLogin');
        const lastEl = document.getElementById('heartbeatLast');

        if (!heartbeat) {
            ageEl.textContent = '--';
            chainsEl.textContent = '--';
            loginEl.textContent = '--';
            lastEl.textContent = '--';
            return;
        }

        ageEl.textContent = `${heartbeat.age_sec || 0}s`;
        chainsEl.textContent = formatNumber(heartbeat.chains || 0);
        loginEl.textContent = heartbeat.login || '--';
        lastEl.textContent = heartbeat.timestamp ? new Date(heartbeat.timestamp * 1000).toLocaleTimeString('en-IN') : '--';
    }

    function updateSignalMini(signal, openOrders, orders) {
        const statusEl = document.getElementById('signalStatusMini');
        const openOrdersEl = document.getElementById('openOrdersMini');
        const lastOrderEl = document.getElementById('lastOrderTime');

        const status = (signal && signal.status) || 'IDLE';
        statusEl.textContent = status;
        openOrdersEl.textContent = formatNumber(openOrders || 0);

        const lastOrder = (orders && orders.length) ? orders[0] : null;
        const lastTs = lastOrder && lastOrder.updated_at ? new Date(lastOrder.updated_at).toLocaleTimeString('en-IN') : '--';
        lastOrderEl.textContent = lastTs;
    }
    
    // Update Stats Cards
    function updateStats(broker, system) {
        const positionsSummary = broker.positions_summary || {};
        const netPnl = parseFloat(positionsSummary.net_pnl || positionsSummary.rpnl || 0);
        const netPnlClass = netPnl > 0 ? 'up' : netPnl < 0 ? 'down' : 'neutral';
        updateStatValue('netPnl', netPnl, netPnlClass);
        
        const openPosCount = positionsSummary.open_count || (broker.positions || []).length || 0;
        updateStatValue('openPositions', openPosCount, 'neutral');
        
        const pendingCount = system.open_orders || 0;
        updateStatValue('pendingOrders', pendingCount, 'neutral');
        
        const signalStatus = (system.signal && system.signal.status) || 'IDLE';
        updateStatValue('systemSignal', signalStatus, 'neutral');
    }
    
    // Update Positions Table
    function updatePositionsTable(positions) {
        const tbody = document.getElementById('positionRows');
        
        if (!positions || positions.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        No open positions
                    </td>
                </tr>
            `;
            return;
        }
        
        // Check if we need full rebuild
        const currentSymbols = Array.from(tbody.querySelectorAll('tr[data-symbol]')).map(tr => tr.dataset.symbol);
        const newSymbols = positions.map(p => p.tsym || p.symbol || '');
        const needsRebuild = currentSymbols.length !== newSymbols.length || 
                             !newSymbols.every((s, i) => s === currentSymbols[i]);
        
        if (needsRebuild) {
            // Full rebuild
            tbody.innerHTML = positions.map(p => {
                const netPnl = parseFloat(p.rpnl || 0) + parseFloat(p.urmtom || 0);
                const netPnlClass = netPnl >= 0 ? 'success' : 'danger';
                const rpnlClass = parseFloat(p.rpnl || 0) >= 0 ? 'success' : 'danger';
                const urmtomClass = parseFloat(p.urmtom || 0) >= 0 ? 'success' : 'danger';
                const product = p.prd || p.product || '';
                const productCell = product ? `<span class="badge ok">${product}</span>` : '-';
                
                return `
                    <tr data-symbol="${p.tsym || p.symbol || ''}">
                        <td style="font-weight: 700">${p.tsym || p.symbol || '-'}</td>
                        <td data-field="ltp">${formatCurrency(p.lp || p.ltp || 0)}</td>
                        <td data-field="netpnl" style="color: var(--${netPnlClass}); font-weight: 700">${formatCurrency(netPnl)}</td>
                        <td data-field="rpnl" style="color: var(--${rpnlClass})">${formatCurrency(p.rpnl || 0)}</td>
                        <td data-field="urmtom" style="color: var(--${urmtomClass})">${formatCurrency(p.urmtom || 0)}</td>
                        <td>${p.exch || p.exchange || '-'}</td>
                        <td>${productCell}</td>
                        <td data-field="netqty">${p.netqty || 0}</td>
                        <td data-field="avgprc">${formatCurrency(p.avgprc || p.avg_price || 0)}</td>
                    </tr>
                `;
            }).join('');
        } else {
            // Smart update
            positions.forEach(p => {
                const symbol = p.tsym || p.symbol || '';
                const row = tbody.querySelector(`tr[data-symbol="${symbol}"]`);
                if (!row) return;
                
                const netPnl = parseFloat(p.rpnl || 0) + parseFloat(p.urmtom || 0);
                
                updateCellValue(row.querySelector('[data-field="netqty"]'), p.netqty || 0, false, 0);
                updateCellValue(row.querySelector('[data-field="avgprc"]'), p.avgprc || p.avg_price || 0);
                updateCellValue(row.querySelector('[data-field="ltp"]'), p.lp || p.ltp || 0);
                updateCellValue(row.querySelector('[data-field="rpnl"]'), p.rpnl || 0, true);
                updateCellValue(row.querySelector('[data-field="urmtom"]'), p.urmtom || 0, true);
                updateCellValue(row.querySelector('[data-field="netpnl"]'), netPnl, true);
            });
        }
    }
    
    // Update Holdings Table
    function updateHoldingsTable(holdings) {
        const tbody = document.getElementById('holdingsRows');
        
        if (!holdings || holdings.length === 0) {
            console.log('[Dashboard] No holdings data received');
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="empty-state">
                        <div class="empty-state-icon">üìà</div>
                        No holdings
                    </td>
                </tr>
            `;
            return;
        }
        
        console.log('[Dashboard] Processing', holdings.length, 'holdings');
        
        // Check if we need full rebuild
        const currentSymbols = Array.from(tbody.querySelectorAll('tr[data-symbol]')).map(tr => tr.dataset.symbol);
        const newSymbols = holdings.map(h => h.tsym || h.symbol || h.tradingsymbol || h.itemcode || h.prtname || h.name || '');
        const needsRebuild = currentSymbols.length !== newSymbols.length || 
                             !newSymbols.every((s, i) => s === currentSymbols[i]);
        
        if (needsRebuild) {
            console.log('[Dashboard] Rebuilding holdings table');
            // Full rebuild
            tbody.innerHTML = holdings.map(h => {
                // Symbol: Try all possible field names from broker response
                const symbol = h.tsym || h.symbol || h.tradingsymbol || h.itemcode || h.prtname || h.name || '-';
                
                // Quantity: Try all possible quantity field names
                const qty = parseInt(h.holdqty || h.quantity || h.qty || h.netqty || h.net_qty || h.netQuantity || 0, 10);
                
                // Average Price: Try all possible price field names
                const avgPrice = parseFloat(h.upldprc || h.avg_price || h.avgprc || h.avgPrice || h.avgprice || h.untilprc || h.price || 0);
                
                // LTP: Latest Trade Price (includes 'c' field from broker)
                const ltp = parseFloat(h.c || h.lp || h.ltp || h.last_price || h.lastprice || h.clp || 0);
                
                // Calculate PnL values
                const realized = parseFloat(h.rpnl || h.realized_pnl || h.realised_pnl || h.bookprofit || 0);
                const unrealizedRaw = parseFloat(h.urmtom || h.unrealized_pnl || h.unrealised_pnl || h.markettomarketpl || NaN);
                const unrealized = Number.isFinite(unrealizedRaw) ? unrealizedRaw : (ltp - avgPrice) * qty;
                const netPnl = realized + unrealized;
                
                const netPnlClass = netPnl >= 0 ? 'success' : 'danger';
                const rpnlClass = realized >= 0 ? 'success' : 'danger';
                const urmtomClass = unrealized >= 0 ? 'success' : 'danger';
                
                // Product: Try all possible product field names
                const product = h.prd || h.product || h.producttype || '';
                const productCell = product ? `<span class="badge ok">${product}</span>` : '-';
                
                // Exchange: Try all possible exchange field names
                const exchange = h.exch || h.exchange || h.exchangetype || '-';
                
                return `
                    <tr data-symbol="${symbol}">
                        <td style="font-weight: 700" title="${symbol}" data-field="symbol">${symbol}</td>
                        <td data-field="ltp">${formatCurrency(ltp)}</td>
                        <td data-field="netpnl" style="color: var(--${netPnlClass}); font-weight: 700">${formatCurrency(netPnl)}</td>
                        <td data-field="rpnl" style="color: var(--${rpnlClass})">${formatCurrency(realized)}</td>
                        <td data-field="urmtom" style="color: var(--${urmtomClass})">${formatCurrency(unrealized)}</td>
                        <td>${exchange}</td>
                        <td>${productCell}</td>
                        <td data-field="qty">${qty}</td>
                        <td data-field="avgprc">${formatCurrency(avgPrice)}</td>
                    </tr>
                `;
            }).join('');
        } else {
            console.log('[Dashboard] Smart update for holdings');
            // Smart update - only update values that changed
            holdings.forEach(h => {
                const symbol = h.tsym || h.symbol || h.tradingsymbol || h.itemcode || h.prtname || h.name || '';
                const row = tbody.querySelector(`tr[data-symbol="${symbol}"]`);
                if (!row) return;
                
                const qty = parseInt(h.holdqty || h.quantity || h.qty || h.netqty || h.net_qty || h.netQuantity || 0, 10);
                const avgPrice = parseFloat(h.upldprc || h.avg_price || h.avgprc || h.avgPrice || h.avgprice || h.untilprc || h.price || 0);
                const ltp = parseFloat(h.lp || h.ltp || h.last_price || h.lastprice || h.clp || 0);
                const realized = parseFloat(h.rpnl || h.realized_pnl || h.realised_pnl || h.bookprofit || 0);
                const unrealizedRaw = parseFloat(h.urmtom || h.unrealized_pnl || h.unrealised_pnl || h.markettomarketpl || NaN);
                const unrealized = Number.isFinite(unrealizedRaw) ? unrealizedRaw : (ltp - avgPrice) * qty;
                const netPnl = realized + unrealized;
                
                updateCellValue(row.querySelector('[data-field="qty"]'), qty, false, 0);
                updateCellValue(row.querySelector('[data-field="avgprc"]'), avgPrice);
                updateCellValue(row.querySelector('[data-field="ltp"]'), ltp);
                updateCellValue(row.querySelector('[data-field="rpnl"]'), realized, true);
                updateCellValue(row.querySelector('[data-field="urmtom"]'), unrealized, true);
                updateCellValue(row.querySelector('[data-field="netpnl"]'), netPnl, true);
            });
        }
    }
    
    // Update System Status
    function updateSystemStatus(system) {
        const heartbeat = system.heartbeat || {};
        const risk = system.risk || {};
        
        // Login Status
        const loginEl = document.getElementById('loginStatus');
        const loginStatus = heartbeat.login || heartbeat.status || 'UNKNOWN';
        loginEl.textContent = loginStatus;
        loginEl.className = `badge ${loginStatus === 'OK' || loginStatus === 'CONNECTED' ? 'ok' : 'error'}`;
        
        // Heartbeat Age
        const heartbeatAge = heartbeat.age_sec || heartbeat.age || 0;
        document.getElementById('heartbeatAge').textContent = getTimeSince(heartbeatAge);
        
        // Risk Status
        const riskEl = document.getElementById('riskStatus');
        if (risk.daily_loss_hit) {
            riskEl.textContent = 'LIMIT HIT';
            riskEl.className = 'badge error';
        } else if (risk.cooldown_until) {
            riskEl.textContent = 'COOLDOWN';
            riskEl.className = 'badge warn';
        } else {
            riskEl.textContent = 'SAFE';
            riskEl.className = 'badge ok';
        }
        
        document.getElementById('dailyHigh').textContent = formatCurrency(risk.today_high || 0);
        document.getElementById('dailyLow').textContent = formatCurrency(risk.today_low || 0);
        
        // Force Exit Alert
        const forceExitAlert = document.getElementById('forceExitAlert');
        forceExitAlert.style.display = risk.force_exit_in_progress ? 'block' : 'none';
    }
    
    // Update Limits
    function updateLimits(limits) {
        document.getElementById('cashAvail').textContent = formatCurrency(limits.cash || limits.cashmrgnavail || 0);
        document.getElementById('collateral').textContent = formatCurrency(limits.collateral || limits.collateralvalue || 0);
        document.getElementById('usedMargin').textContent = formatCurrency(limits.marginused || limits.marginUsed || 0);
        document.getElementById('availMargin').textContent = formatCurrency(limits.marginAvailable || limits.marginavailable || 0);
        document.getElementById('netAvail').textContent = formatCurrency(limits.net || limits.payin || 0);
    }
    
    // Start Auto-Refresh
    function startAutoRefresh() {
        stopAutoRefresh();
        autoRefreshTimer = setInterval(() => {
            updateDashboard(true);
        }, config.autoRefreshInterval);
    }
    
    // Stop Auto-Refresh
    function stopAutoRefresh() {
        if (autoRefreshTimer) {
            clearInterval(autoRefreshTimer);
            autoRefreshTimer = null;
        }
    }
    
    // Update "last updated" text every second
    setInterval(() => {
        const seconds = Math.floor((Date.now() - lastUpdate) / 1000);
        const posRefresh = document.getElementById('posRefresh');
        
        if (seconds === 0) {
            posRefresh.textContent = 'Updated just now';
        } else if (seconds < 60) {
            posRefresh.textContent = `Updated ${seconds}s ago`;
        } else {
            posRefresh.textContent = `Updated ${Math.floor(seconds / 60)}m ago`;
        }
    }, 1000);
    
    // Initialize on load
    window.addEventListener('load', () => {
        updateDashboard(false);
        startAutoRefresh();
    });
    
    // Cleanup on unload
    window.addEventListener('beforeunload', () => {
        if (autoRefreshTimer) {
            clearInterval(autoRefreshTimer);
        }
    });
    
    // Mobile Navigation Toggle
    function toggleMobileNav() {
        document.getElementById('navLinks').classList.toggle('mobile-open');
    }
</script>
</body>
</html>