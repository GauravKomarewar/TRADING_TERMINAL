<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategy Management | Shoonya Platform</title>
    <link rel="stylesheet" href="/dashboard/web/styles/common.css">
    <link rel="stylesheet" href="/dashboard/web/shared/layout.css">
    <script src="/dashboard/web/shared/layout.js" defer></script>
    <style>
        /* Professional Grid Layout */
        .page-container { display: grid; grid-template-columns: 400px 1fr; gap: 24px; }
        @media(max-width: 1400px) { .page-container { grid-template-columns: 1fr; } }

        /* Left Sidebar - Strategy Builder */
        .builder-panel { background: linear-gradient(135deg, var(--panel-2) 0%, var(--panel) 100%); border: 1px solid var(--border); border-radius: 8px; padding: 20px; position: sticky; top: 20px; max-height: calc(100vh - 100px); overflow-y: auto; }
        .builder-panel h2 { margin-top: 0; font-size: 16px; margin-bottom: 16px; border-bottom: 2px solid var(--border); padding-bottom: 12px; }
        .builder-panel form { display: flex; flex-direction: column; gap: 20px; }
        
        .builder-section { }
        .builder-section h3 { font-size: 12px; font-weight: 700; text-transform: uppercase; color: var(--primary); margin-bottom: 12px; letter-spacing: 0.5px; }
        .field { display: flex; flex-direction: column; gap: 4px; margin-bottom: 12px; }
        .field label { font-size: 11px; font-weight: 600; color: var(--text); }
        .field input, .field select, .field textarea { padding: 8px 10px; font-size: 12px; border: 1px solid var(--border); border-radius: 4px; background: var(--panel-2); color: var(--text); transition: all .2s; }
        .field input:focus, .field select:focus, .field textarea:focus { border-color: var(--primary); background: var(--panel); outline: none; box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1); }
        
        .btn-save { width: 100%; padding: 10px; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; transition: all .2s; }
        .btn-save:hover { box-shadow: 0 4px 12px rgba(34,197,94,.3); }
        .btn-save:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Result Card */
        .result-card { background: linear-gradient(135deg, rgba(34,197,94,.1) 0%, rgba(34,197,94,.05) 100%); border: 2px solid #22c55e; border-radius: 8px; padding: 16px; margin-bottom: 16px; display: none; }
        .result-card.error { background: linear-gradient(135deg, rgba(239,68,68,.1) 0%, rgba(239,68,68,.05) 100%); border-color: #ef4444; }
        .result-card.show { display: block; animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .result-title { font-weight: 700; margin-bottom: 6px; }
        .result-message { font-size: 12px; line-height: 1.5; font-family: monospace; white-space: pre-wrap; }

        /* Strategy Items - Production Grade */
        .strategy-item {
            background: linear-gradient(135deg, var(--panel-2) 0%, var(--panel) 100%);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all .3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .strategy-item:hover { border-color: var(--primary); box-shadow: 0 8px 24px rgba(0,0,0,0.15); }
        .strategy-item.running { border-color: #22c55e; background: linear-gradient(135deg, rgba(34,197,94,.05) 0%, rgba(34,197,94,.02) 100%); }

        .strategy-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; gap: 12px; }
        .strategy-title { flex: 1; }
        .strategy-name { font-size: 14px; font-weight: 700; color: var(--text); }
        .strategy-meta { font-size: 10px; color: var(--muted); margin-top: 3px; }
        
        .status-badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: 700; white-space: nowrap;  }
        .status-idle { background: rgba(107,114,128,.15); color: #6b7280; }
        .status-running { background: rgba(34,197,94,.15); color: #22c55e; border: 1px solid #22c55e; }
        .status-paused { background: rgba(234,179,8,.15); color: #eab308; border: 1px solid #eab308; }

        .strategy-config { background: var(--panel-2); border-radius: 4px; padding: 10px; margin: 12px 0; font-size: 10px; }
        .config-row { display: flex; justify-content: space-between; padding: 4px 0; }
        .config-label { color: var(--muted); font-weight: 600; }
        .config-value { color: var(--text); font-family: monospace; font-weight: 500; }

        .strategy-actions { display: flex; gap: 6px; margin-top: 12px; }
        .btn-sm { padding: 6px 12px; font-size: 10px; font-weight: 600; border: none; border-radius: 4px; cursor: pointer; transition: all .2s; }
        .btn-success { background: #22c55e; color: white; }
        .btn-success:hover:not(:disabled) { background: #16a34a; }
        .btn-warning { background: #eab308; color: #1a1a1a; }
        .btn-warning:hover:not(:disabled) { background: #ca8a04; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover:not(:disabled) { background: #dc2626; }
        .btn-sm:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Right Panel - Strategies Control & Monitoring */
        .control-panel { display: flex; flex-direction: column; gap: 0; }

        /* Tabs */
        .tabs { display: flex; gap: 0; border-bottom: 2px solid var(--border); margin-bottom: 0; background: linear-gradient(180deg, var(--panel-2) 0%, var(--panel) 100%)); }
        .tab { padding: 12px 20px; cursor: pointer; border-bottom: 3px solid transparent; color: var(--muted); font-weight: 600; transition: all .2s; position: relative; font-size: 13px; }
        .tab:hover { color: var(--text); }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); margin-bottom: -2px; }
        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }

        .section-header { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            padding: 16px; 
            background: linear-gradient(135deg, var(--panel-2) 0%, var(--panel) 100%);
            border: 1px solid var(--border); 
            border-radius: 6px; 
            cursor: pointer; 
            user-select: none;
            transition: all .2s;
            margin-bottom: 12px;
        }
        .section-header:hover { background: var(--panel); border-color: var(--primary); }
        .section-toggle { display: inline-block; width: 14px; text-align: center; transition: transform .3s; font-weight: bold; color: var(--primary); }
        .section-toggle.open { transform: rotate(90deg); }
        .section-title { font-weight: 700; color: var(--text); flex: 1; font-size: 13px; }
        .section-content { display: none; padding: 16px; background: var(--panel); border: 1px solid var(--border); border-top: none; border-radius: 0 0 6px 6px; margin-bottom: 12px; }
        .section-content.open { display: block; }

        .table-compact { width: 100%; border-collapse: collapse; font-size: 10px; margin-top: 12px; }
        .table-compact th { background: var(--panel-2); padding: 8px; text-align: left; font-weight: 700; border-bottom: 2px solid var(--border); }
        .table-compact td { padding: 6px 8px; border-bottom: 1px solid var(--border); }
        .table-compact tr:hover { background: var(--panel-2); }

        .empty-state { text-align: center; padding: 40px 20px; color: var(--muted); }
        .empty-state-icon { font-size: 48px; margin-bottom: 12px; }

        .status-banner { background: linear-gradient(135deg, rgba(34,197,94,.15) 0%, rgba(34,197,94,.05) 100%); border: 2px solid #22c55e; border-radius: 8px; padding: 16px; margin-bottom: 20px; display: none; animation: slideDown 0.3s ease-out; }
        .banner-title { font-weight: 700; color: #22c55e; font-size: 13px; margin-bottom: 6px; }
        .banner-text { font-size: 11px; color: var(--text); font-family: monospace; }

        .info-msg { background: var(--panel); border-left: 4px solid var(--primary); padding: 12px; border-radius: 4px; font-size: 11px; margin-bottom: 16px; }
    </style>
</head>
<body data-page="strategy">
    <div id="app-header"></div>

    <main>
        <div class="page-header">
            <h1>üéØ Strategy Management System</h1>
            <p class="muted">Production-grade strategy builder, execution & real-time monitoring</p>
        </div>

        <!-- STATUS BANNER -->
        <div id="statusBanner" class="status-banner">
             <div class="banner-title">‚ö° ACTIVE EXECUTION</div>
            <div id="statusText" class="banner-text"></div>
        </div>

        <div class="page-container">
            <!-- LEFT PANEL: STRATEGY BUILDER -->
            <div class="builder-panel">
                <h2>üìù Strategy Configuration</h2>
                
                <div id="resultCard" class="result-card">
                    <div class="result-title" id="resultTitle">‚úÖ Success</div>
                    <div class="result-message" id="resultMessage"></div>
                </div>

                <form id="strategyForm" onsubmit="submitStrategy(event)">
                    <div class="builder-section">
                        <h3>üìã Identity</h3>
                        <div class="field">
                            <label>Strategy Name *</label>
                            <input type="text" id="stratName" placeholder="DNSS NIFTY Weekly" required>
                        </div>
                        <div class="field">
                            <label>Type *</label>
                            <select id="stratType" onchange="updateStrategyType()">
                                <option value="dnss">DNSS (Delta Neutral)</option>
                                <option value="iron_condor">Iron Condor</option>
                                <option value="butterfly">Butterfly</option>
                            </select>
                        </div>
                        <div class="field">
                            <label>Underlying</label>
                            <select id="underlying">
                                <option>NIFTY</option>
                                <option>BANKNIFTY</option>
                                <option>FINNIFTY</option>
                            </select>
                        </div>
                    </div>

                    <div class="builder-section">
                        <h3>‚è∞ Schedule</h3>
                        <div class="field">
                            <label>Frequency *</label>
                            <select id="schedule" required>
                                <option value="">-- Select --</option>
                                <option value="daily">üìÖ Daily</option>
                                <option value="weekly">üìÜ Weekly</option>
                                <option value="manual">‚ö° Manual</option>
                            </select>
                        </div>
                        <div class="field">
                            <label>Entry Time</label>
                            <input type="time" id="entryTime" value="09:20">
                        </div>
                        <div class="field">
                            <label>Exit Time</label>
                            <input type="time" id="exitTime" value="15:15">
                        </div>
                    </div>

                    <div class="builder-section">
                        <h3>üí∞ Risk Parameters</h3>
                        <div class="field">
                            <label>Target Profit (‚Çπ)</label>
                            <input type="number" id="targetProfit" placeholder="5000" step="100">
                        </div>
                        <div class="field">
                            <label>Stop Loss (‚Çπ)</label>
                            <input type="number" id="stopLoss" placeholder="3000" step="100">
                        </div>
                        <div class="field">
                            <label>Max Positions</label>
                            <input type="number" id="maxPositions" value="1" min="1">
                        </div>
                    </div>

                    <div class="builder-section" id="legFields"></div>

                    <button type="submit" class="btn-save">üíæ Save & Deploy</button>
                </form>
            </div>

            <!-- RIGHT PANEL: CONTROL & MONITORING -->
            <div class="control-panel">
                <!-- Tabs -->
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('control')">üéõÔ∏è Control</div>
                    <div class="tab" onclick="switchTab('monitor')">üìä Monitor</div>
                    <div class="tab" onclick="switchTab('audit')">üîç Audit</div>
                </div>

                <!-- CONTROL TAB -->
                <div id="control" class="tab-content active">
                    <div id="strategyList"></div>
                </div>

                <!-- MONITOR TAB -->
                <div id="monitor" class="tab-content">
                    <div id="monitorContent"></div>
                </div>

                <!-- AUDIT TAB -->
                <div id="audit" class="tab-content">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 20px;">
                        <div class="info-msg" style="border-left-color: #22c55e; text-align: center;">
                            <div style="font-size: 9px; color: var(--muted); text-transform: uppercase;">Running</div>
                            <div id="stat-running" style="font-size: 24px; font-weight: 700; color: #22c55e; margin-top: 4px;">0</div>
                        </div>
                        <div class="info-msg" style="border-left-color: #eab308; text-align: center;">
                            <div style="font-size: 9px; color: var(--muted); text-transform: uppercase;">Paused</div>
                            <div id="stat-paused" style="font-size: 24px; font-weight: 700; color: #eab308; margin-top: 4px;">0</div>
                        </div>
                        <div class="info-msg" style="border-left-color: #3b82f6; text-align: center;">
                            <div style="font-size: 9px; color: var(--muted); text-transform: uppercase;">Intents</div>
                            <div id="stat-intents" style="font-size: 24px; font-weight: 700; color: #3b82f6; margin-top: 4px;">0</div>
                        </div>
                        <div class="info-msg" style="border-left-color: #8b5cf6; text-align: center;">
                            <div style="font-size: 9px; color: var(--muted); text-transform: uppercase;">Positions</div>
                            <div id="stat-positions" style="font-size: 24px; font-weight: 700; color: #8b5cf6; margin-top: 4px;">0</div>
                        </div>
                    </div>

                    <div id="auditTableContainer"></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const API = '/dashboard';
        let strategies = [];
        let activeIntents = new Map();

        function updateStrategyType() {
            const type = document.getElementById('stratType').value;
            const container = document.getElementById('legFields');
            let html = '<h3 style="margin-bottom: 12px;">Strategy Parameters</h3>';
            
            if (type === 'dnss') {
                html += `
                    <div class="field">
                        <label>CE Offset (pts)</label>
                        <input type="number" value="100" step="50">
                    </div>
                    <div class="field">
                        <label>PE Offset (pts)</label>
                        <input type="number" value="100" step="50">
                    </div>
                    <div class="field">
                        <label>Entry Delta</label>
                        <input type="number" value="0.20" step="0.05" min="0" max="1">
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        function submitStrategy(event) {
            event.preventDefault();

            const name = document.getElementById('stratName').value.trim();
            const schedule = document.getElementById('schedule').value;

            if (!name || !schedule) {
                showResult(false, '‚ö†Ô∏è Fill all required fields');
                return;
            }

            const data = {
                name: name,
                schedule: schedule,
                identity: {
                    underlying: document.getElementById('underlying').value,
                    strategy_type: document.getElementById('stratType').value,
                },
                timing: {
                    entry_time: document.getElementById('entryTime').value,
                    exit_time: document.getElementById('exitTime').value,
                },
                risk: {
                    target_profit: parseFloat(document.getElementById('targetProfit').value) || 0,
                    stop_loss: parseFloat(document.getElementById('stopLoss').value) || 0,
                    max_positions: parseInt(document.getElementById('maxPositions').value) || 1,
                },
                status: 'IDLE',
                created_at: new Date().toISOString(),
            };

            console.log('üíæ Saving strategy:', data);

            fetch(`${API}/strategy/config/save-all`, {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(result => {
                console.log('‚úÖ Saved:', result);
                showResult(true, `‚úÖ SAVED\n\n${name}\nSchedule: ${schedule}\nStatus: IDLE\n\nReady for execution`);
                document.getElementById('strategyForm').reset();
                updateStrategyType();
                setTimeout(() => {
                    loadStrategies();
                    switchTab('control');
                }, 1500);
            })
            .catch(e => {
                console.error('‚ùå Error:', e);
                showResult(false, `‚ùå Save Failed\n\n${e.message}`);
            });
        }

        function showResult(success, msg) {
            const card = document.getElementById('resultCard');
            const title = document.getElementById('resultTitle');
            const message = document.getElementById('resultMessage');
            
            card.className = 'result-card ' + (success ? '' : 'error') + ' show';
            title.textContent = success ? '‚úÖ SUCCESS' : '‚ùå ERROR';
            message.textContent = msg;
            
            if (!success) setTimeout(() => card.classList.remove('show'), 5000);
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'control') {
                loadStrategies();
            } else if (tabName === 'monitor') {
                refreshMonitor();
            } else if (tabName === 'audit') {
                loadAudit();
            }
        }

        async function loadStrategies() {
            try {
                const r = await fetch(`${API}/strategy/configs`, { credentials: 'include' });
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                
                const data = await r.json();
                strategies = data.configs || [];
                console.log(`‚úÖ Loaded ${strategies.length} strategies`);
                renderStrategies();
            } catch (e) {
                console.error('‚ùå Load error:', e);
                document.getElementById('strategyList').innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><div>Failed to load</div></div>`;
            }
        }

        function renderStrategies() {
            const container = document.getElementById('strategyList');
            
            if (!strategies.length) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üì≠</div><div>No strategies saved<br><small>Create one using builder ‚Üê</small></div></div>`;
                return;
            }

            let html = '';
            for (const s of strategies) {
                const status = s.status || 'IDLE';
                const isRunning = status === 'RUNNING';
                const btnKey = `${s.name}-start`;
                const isLoading = activeIntents.has(btnKey);
                
                html += `<div class="strategy-item ${isRunning ? 'running' : ''}">
                    <div class="strategy-header">
                        <div class="strategy-title">
                            <div class="strategy-name">${s.name}</div>
                            <div class="strategy-meta">${s.identity?.underlying} ¬∑ ${s.identity?.strategy_type?.toUpperCase()} ¬∑ ${s.schedule || 'Manual'}</div>
                        </div>
                        <span class="status-badge status-${status.toLowerCase()}">‚óè ${status}</span>
                    </div>

                    <div class="strategy-config">
                        <div class="config-row">
                            <span class="config-label">Entry:</span>
                            <span class="config-value">${s.timing?.entry_time || '--:--'}</span>
                        </div>
                        <div class="config-row">
                            <span class="config-label">Exit:</span>
                            <span class="config-value">${s.timing?.exit_time || '--:--'}</span>
                        </div>
                        <div class="config-row">
                            <span class="config-label">Target / SL:</span>
                            <span class="config-value">‚Çπ${s.risk?.target_profit || 0} / ‚Çπ${s.risk?.stop_loss || 0}</span>
                        </div>
                    </div>

                    <div class="strategy-actions">
                        <button class="btn-sm btn-success" 
                                onclick="startStrategy('${s.name}')" 
                                ${isRunning || isLoading ? 'disabled' : ''}>
                            ${isLoading ? '‚è≥' : '‚ñ∂'} Start
                        </button>
                        <button class="btn-sm btn-warning" 
                                onclick="pauseStrategy('${s.name}')" 
                                ${status !== 'RUNNING' ? 'disabled' : ''}>
                            ‚è∏ Pause
                        </button>
                        <button class="btn-sm btn-danger" 
                                onclick="stopStrategy('${s.name}')" 
                                ${status === 'IDLE' ? 'disabled' : ''}>
                            ‚èπ Stop
                        </button>
                    </div>
                </div>`;
            }
            
            container.innerHTML = html;
            updateStatusBanner();
        }

        async function startStrategy(name) {
            if (!confirm(`Start "${name}" with DAILY schedule?\n\nAutomated execution will begin.`)) return;

            const key = `${name}-start`;
            if (activeIntents.has(key)) return;

            activeIntents.set(key, true);
            renderStrategies();

            try {
                const r = await fetch(`${API}/intent/strategy`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ strategy_name: name, action: 'ENTRY', reason: 'DASHBOARD' })
                });

                if (!r.ok) throw new Error(`HTTP ${r.status}`);

                const result = await r.json();
                
                // Update status
                await fetch(`${API}/strategy/config/${name}/status`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'RUNNING' })
                });

                console.log('‚úÖ Started:', result);
                showResult(true, `‚úÖ EXECUTION STARTED\n\n${name}\nIntent: ${result.intent_id}\n\nüîÑ Status: RUNNING\nMonitor in Monitor tab ‚Üí`);
                
                setTimeout(() => { loadStrategies(); loadAudit(); }, 1000);
            } catch (e) {
                console.error('‚ùå Error:', e);
                showResult(false, `‚ùå FAILED\n\n${e.message}`);
            } finally {
                activeIntents.delete(key);
               renderStrategies();
            }
        }

        async function pauseStrategy(name) {
            if (!confirm(`Pause "${name}"?`)) return;
            try {
                await fetch(`${API}/intent/strategy`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ strategy_name: name, action: 'ADJUST' })
                });
                await fetch(`${API}/strategy/config/${name}/status`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'PAUSED' })
                });
                showResult(true, `‚è∏ PAUSED\n\n${name}\nPositions: OPEN`);
                setTimeout(() => loadStrategies(), 800);
            } catch (e) {
                showResult(false, `‚ùå Error: ${e.message}`);
            }
        }

        async function stopStrategy(name) {
            if (!confirm(`STOP "${name}"?\n\n‚ö†Ô∏è All positions will exit!`)) return;
            try {
                await fetch(`${API}/intent/strategy`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ strategy_name: name, action: 'FORCE_EXIT' })
                });
                await fetch(`${API}/strategy/config/${name}/status`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'STOPPED' })
                });
                showResult(true, `üõë STOPPED\n\n${name}\n‚ö†Ô∏è Positions exited`);
                setTimeout(() => loadStrategies(), 800);
            } catch (e) {
                showResult(false, `‚ùå Error: ${e.message}`);
            }
        }

        async function refreshMonitor() {
            try {
                const r = await fetch(`${API}/monitoring/strategy-positions`, { credentials: 'include' });
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                
                const data = await r.json();
                const strats = data.strategy_positions || [];

                let html = '';
                if (!strats.length) {
                    html = `<div class="empty-state"><div class="empty-state-icon">üì≠</div><div>No running strategies</div></div>`;
                } else {
                    for (const s of strats) {
                        const pnl = s.total_pnl || 0;
                        const pnlColor = pnl >= 0 ? '#22c55e' : '#ef4444';
                        const posCount = (s.positions || []).reduce((sum, p) => sum + (p.legs || []).length, 0);
                        
                        html += `<div class="section-header" onclick="toggleSection(event)">
                            <span class="section-toggle">‚ñ∂</span>
                            <span class="section-title">${s.strategy_name}</span>
                            <div style="margin-left: auto; font-size: 10px;">
                                <span style="color: ${pnlColor}; font-weight: 700; margin-right: 12px;">PnL: ‚Çπ${pnl.toFixed(0)}</span>
                                <span style="color: var(--muted);">Legs: ${posCount}</span>
                            </div>
                        </div>
                        <div class="section-content">
                            <table class="table-compact">
                                <thead><tr><th>Symbol</th><th>Qty</th><th>LTP</th><th>P&L</th></tr></thead>
                                <tbody>`;
                        
                        for (const p of (s.positions || [])) {
                            for (const l of (p.legs || [])) {
                                const lpnl = l.pnl || 0;
                                html += `<tr>
                                    <td><strong>${l.symbol}</strong></td>
                                    <td>${l.qty}</td>
                                    <td>${parseFloat(l.ltp || 0).toFixed(2)}</td>
                                    <td style="color: ${lpnl >= 0 ? '#22c55e' : '#ef4444'}; font-weight: 600;">‚Çπ${lpnl.toFixed(0)}</td>
                                </tr>`;
                            }
                        }
                        
                        html += `</tbody></table></div>`;
                    }
                }
                
                document.getElementById('monitorContent').innerHTML = html;
            } catch (e) {
                console.error('‚ùå Monitor error:', e);
            }
        }

        async function loadAudit() {
            try {
                const r = await fetch(`${API}/monitoring/all-strategies-status`, { credentials: 'include' });
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                
                const data = await r.json();
                const audit = data.audit || {};
                const strats = data.strategies || [];

                document.getElementById('stat-running').textContent = audit.strategies_running || 0;
                document.getElementById('stat-paused').textContent = audit.strategies_paused || 0;
                document.getElementById('stat-intents').textContent = audit.pending_intents_in_queue || 0;
                document.getElementById('stat-positions').textContent = audit.active_positions_total || 0;

                let tableHtml = '<table class="table-compact" style="margin-top: 20px;"><thead><tr><th>Strategy</th><th>Status</th><th>Pending</th><th>Positions</th></tr></thead><tbody>';
                
                for (const s of strats) {
                    tableHtml += `<tr>
                        <td><strong>${s.name}</strong></td>
                        <td><span class="status-badge status-${s.status.toLowerCase()}">‚óè ${s.status}</span></td>
                        <td>${s.intent_count}</td>
                        <td>${s.position_count}</td>
                    </tr>`;
                }
                
                tableHtml += '</tbody></table>';
                document.getElementById('auditTableContainer').innerHTML = tableHtml;
                
                updateStatusBanner();
            } catch (e) {
                console.error('‚ùå Audit error:', e);
            }
        }

        function toggleSection(e) {
            const content = e.currentTarget.nextElementSibling;
            const toggle = e.currentTarget.querySelector('.section-toggle');
            content.classList.toggle('open');
            toggle.classList.toggle('open');
        }

        function updateStatusBanner() {
            const running = strategies.filter(s => s.status === 'RUNNING').length;
            const banner = document.getElementById('statusBanner');
            
            if (running > 0) {
                banner.style.display = 'block';
                document.getElementById('statusText').textContent = `${running} strateg${running > 1 ? 'ies' : 'y'} executing | Monitor active positions`;
            } else {
                banner.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Strategy Manager initialized');
            updateStrategyType();
        });
    </script>
</body>
</html>
