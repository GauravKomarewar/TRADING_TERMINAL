<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Strategy Manager | Shoonya Platform</title>
<link rel="stylesheet" href="/dashboard/web/styles/common.css">
<link rel="stylesheet" href="/dashboard/web/shared/layout.css">
<script src="/dashboard/web/shared/pages-config.js" defer></script>
<script src="/dashboard/web/shared/layout.js" defer></script>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #66e4ff; --primary-dark: #23b6ff;
  --success: #4ade80; --warning: #fbcb5c; --danger: #fb7185;
  --panel: rgba(13,18,41,0.8); --panel-2: rgba(6,10,26,0.95);
  --text: #f8fbff; --muted: rgba(248,251,255,0.65);
  --border: rgba(255,255,255,0.08);
  --font-mono: 'IBM Plex Mono', monospace;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { 
  background:radial-gradient(circle at top,#0f1a3c 0%,#050815 55%,#020308 100%); 
  color:var(--text); 
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto; 
  font-size:13px; 
  overflow-x:hidden; 
}
main { padding:20px; max-width:1800px; margin:0 auto; }
.header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
.header h1 { font-size:24px; font-weight:700; }
.tabs { display:flex; gap:12px; margin-bottom:20px; border-bottom:1px solid var(--border); padding-bottom:12px; }
.tab-btn { 
  padding:8px 16px; 
  background:none; 
  border:none; 
  color:var(--muted); 
  cursor:pointer; 
  transition:all 0.3s; 
  border-bottom:2px solid transparent; 
  font-weight:600; 
}
.tab-btn.active { color:var(--primary); border-bottom-color:var(--primary); }
.tab-content { display:none; animation:fadeIn 0.3s; }
.tab-content.active { display:block; }
@keyframes fadeIn { from{opacity:0} to{opacity:1} }
.widget { 
  background:var(--panel); 
  border:1px solid var(--border); 
  border-radius:12px; 
  padding:16px; 
  margin-bottom:16px; 
  backdrop-filter:blur(20px); 
}
.widget-title { 
  font-size:14px; 
  font-weight:700; 
  margin-bottom:12px; 
  display:flex; 
  align-items:center; 
  gap:8px; 
  justify-content:space-between;
}
.live-indicator { width:8px; height:8px; background:var(--muted); border-radius:50%; }
.live-indicator.online { background:var(--success); animation:pulse 2s infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
.btn { 
  padding:8px 16px; 
  border:none; 
  border-radius:6px; 
  font-weight:600; 
  cursor:pointer; 
  transition:all 0.2s; 
  font-size:12px; 
}
.btn-primary { background:linear-gradient(120deg,var(--primary),var(--primary-dark)); color:#04060f; }
.btn-primary:hover { transform:translateY(-2px); box-shadow:0 12px 24px rgba(35,182,255,0.4); }
.btn-success { background:var(--success); color:#000; }
.btn-danger { background:var(--danger); color:#fff; }
.btn-warning { background:var(--warning); color:#000; }
.btn-secondary { background:rgba(255,255,255,0.1); color:var(--text); border:1px solid var(--border); }
.btn-sm { padding:4px 10px; font-size:11px; }
.table { width:100%; border-collapse:collapse; font-size:12px; }
.table thead { background:rgba(0,0,0,0.3); border-bottom:1px solid var(--border); }
.table th { padding:10px; text-align:left; font-weight:700; color:var(--primary); }
.table td { padding:10px; border-bottom:1px solid rgba(255,255,255,0.03); }
.table tbody tr:hover { background:rgba(255,255,255,0.03); }
.badge { display:inline-block; padding:3px 8px; border-radius:3px; font-size:11px; font-weight:600; }
.badge-idle { background:rgba(255,255,255,0.1); color:var(--muted); }
.badge-running { background:rgba(74,222,128,0.2); color:var(--success); border:1px solid var(--success); }
.badge-stopped { background:rgba(251,113,133,0.2); color:var(--danger); border:1px solid var(--danger); }
.badge-paused { background:rgba(251,203,92,0.2); color:var(--warning); border:1px solid var(--warning); }
.badge-enabled { background:rgba(74,222,128,0.2); color:var(--success); }
.badge-disabled { background:rgba(255,255,255,0.1); color:var(--muted); }
.strat-card { 
  border:1px solid var(--border); 
  border-radius:8px; 
  padding:14px; 
  margin-bottom:10px; 
  background:rgba(0,0,0,0.15); 
  transition:all 0.2s; 
}
.strat-card:hover { border-color:rgba(102,228,255,0.3); }
.strat-card-header { 
  display:flex; 
  justify-content:space-between; 
  align-items:center; 
  margin-bottom:8px; 
}
.strat-card-name { 
  font-size:14px; 
  font-weight:700; 
  color:var(--primary); 
  font-family:var(--font-mono); 
  display:flex;
  align-items:center;
  gap:8px;
}
.strat-card-meta { 
  display:flex; 
  gap:16px; 
  font-size:11px; 
  color:var(--muted); 
  margin-top:8px;
}
.strat-card-actions { 
  display:flex; 
  gap:6px; 
  align-items:center; 
}
.search-box { display:flex; gap:8px; margin-bottom:12px; }
.search-box input { 
  flex:1; 
  padding:8px; 
  background:rgba(0,0,0,0.2); 
  border:1px solid var(--border); 
  border-radius:4px; 
  color:var(--text); 
}
.toast { 
  position:fixed; 
  top:20px; 
  right:20px; 
  padding:12px 20px; 
  border-radius:8px; 
  font-size:12px; 
  z-index:9999; 
  animation:slideIn 0.3s; 
  box-shadow:0 8px 24px rgba(0,0,0,0.4);
}
.toast-success { background:var(--success); color:#000; }
.toast-error { background:var(--danger); color:#fff; }
.toast-info { background:var(--primary); color:#000; }
@keyframes slideIn { from{transform:translateX(100px);opacity:0} to{transform:translateX(0);opacity:1} }
.modal { 
  display:none; 
  position:fixed; 
  top:0; 
  left:0; 
  width:100%; 
  height:100%; 
  background:rgba(0,0,0,0.8); 
  z-index:1000; 
  align-items:center; 
  justify-content:center;
}
.modal.show { display:flex; }
.modal-content { 
  background:var(--panel-2); 
  border:1px solid var(--border); 
  border-radius:12px; 
  padding:24px; 
  max-width:500px; 
  width:90%;
  max-height:80vh;
  overflow-y:auto;
}
.modal-header { 
  font-size:18px; 
  font-weight:700; 
  margin-bottom:20px; 
  padding-bottom:12px; 
  border-bottom:1px solid var(--border);
}
.modal-footer { 
  display:flex; 
  gap:8px; 
  justify-content:flex-end; 
  margin-top:20px; 
  padding-top:16px; 
  border-top:1px solid var(--border);
}
.form-group { margin-bottom:14px; }
.form-group label { 
  display:block; 
  font-size:11px; 
  font-weight:600; 
  margin-bottom:4px; 
  color:var(--muted); 
}
.form-control { 
  width:100%; 
  padding:8px 10px; 
  background:rgba(0,0,0,0.3); 
  border:1px solid var(--border); 
  border-radius:4px; 
  color:var(--text); 
  font-family:var(--font-mono); 
  font-size:12px; 
}
.form-control:focus { 
  outline:none; 
  border-color:var(--primary); 
  box-shadow:0 0 12px rgba(102,228,255,0.1); 
}
select.form-control { appearance:auto; }
textarea.form-control { 
  min-height:80px; 
  font-family:inherit; 
  resize:vertical;
}
.toggle-switch { 
  position:relative; 
  display:inline-block; 
  width:44px; 
  height:22px; 
}
.toggle-switch input { opacity:0; width:0; height:0; }
.toggle-slider { 
  position:absolute; 
  cursor:pointer; 
  top:0; 
  left:0; 
  right:0; 
  bottom:0; 
  background:rgba(255,255,255,0.1); 
  transition:0.3s; 
  border-radius:22px;
}
.toggle-slider:before { 
  position:absolute; 
  content:""; 
  height:16px; 
  width:16px; 
  left:3px; 
  bottom:3px; 
  background:var(--muted); 
  transition:0.3s; 
  border-radius:50%;
}
input:checked + .toggle-slider { background:var(--success); }
input:checked + .toggle-slider:before { 
  transform:translateX(22px); 
  background:#fff; 
}
.empty-state { 
  text-align:center; 
  padding:60px 20px; 
  color:var(--muted);
}
.empty-state-icon { 
  font-size:48px; 
  margin-bottom:16px; 
  opacity:0.5;
}
.empty-state-text { 
  font-size:14px; 
  margin-bottom:20px;
}
.filters { 
  display:flex; 
  gap:8px; 
  margin-bottom:12px; 
  flex-wrap:wrap;
}
.filter-btn { 
  padding:6px 12px; 
  background:rgba(0,0,0,0.2); 
  border:1px solid var(--border); 
  border-radius:4px; 
  color:var(--muted); 
  cursor:pointer; 
  font-size:11px; 
  transition:all 0.2s;
}
.filter-btn.active { 
  background:var(--primary); 
  color:#000; 
  border-color:var(--primary);
}
.status-dot { 
  width:6px; 
  height:6px; 
  border-radius:50%; 
  display:inline-block; 
  margin-right:4px;
}
.status-dot.idle { background:var(--muted); }
.status-dot.running { background:var(--success); animation:pulse 2s infinite; }
.status-dot.stopped { background:var(--danger); }
.status-dot.paused { background:var(--warning); }
</style>
</head>
<body>
<main>
  <div class="header">
    <h1>üìä Strategy Manager</h1>
    <div style="display:flex;align-items:center;gap:8px;font-size:12px;">
      <span class="live-indicator" id="runner-indicator"></span>
      <span id="runner-status">Loading...</span>
      <button class="btn btn-secondary btn-sm" onclick="refreshStatus()" style="margin-left:8px;">Refresh</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('list')">üìã All Strategies</button>
    <button class="tab-btn" onclick="switchTab('running')">‚ñ∂Ô∏è Running</button>
    <button class="tab-btn" onclick="switchTab('builder')">üîß Builder</button>
  </div>

  <!-- ====== TAB 1: ALL STRATEGIES ====== -->
  <div id="list-tab" class="tab-content active">
    <div class="widget">
      <div class="widget-title">
        <span>Saved Strategies</span>
        <div style="display:flex;gap:8px;">
          <button class="btn btn-primary btn-sm" onclick="openBuilder()">+ New Strategy</button>
          <button class="btn btn-secondary btn-sm" onclick="importStrategy()">Import</button>
        </div>
      </div>
      
      <div class="search-box">
        <input type="text" id="search-input" placeholder="Search strategies..." oninput="filterStrategies()">
        <select id="type-filter" class="form-control" style="width:auto;" onchange="filterStrategies()">
          <option value="">All Types</option>
          <option value="dnss">DNSS</option>
          <option value="iron_condor">Iron Condor</option>
          <option value="strangle">Strangle</option>
        </select>
        <button class="btn btn-secondary btn-sm" onclick="loadStrategies()">‚ü≥ Reload</button>
      </div>

      <div class="filters">
        <button class="filter-btn active" data-filter="all" onclick="setFilter(this, 'all')">All</button>
        <button class="filter-btn" data-filter="enabled" onclick="setFilter(this, 'enabled')">Enabled</button>
        <button class="filter-btn" data-filter="disabled" onclick="setFilter(this, 'disabled')">Disabled</button>
        <button class="filter-btn" data-filter="running" onclick="setFilter(this, 'running')">Running</button>
        <button class="filter-btn" data-filter="idle" onclick="setFilter(this, 'idle')">Idle</button>
      </div>

      <div id="strategies-list"></div>
    </div>
  </div>

  <!-- ====== TAB 2: RUNNING STRATEGIES ====== -->
  <div id="running-tab" class="tab-content">
    <div class="widget">
      <div class="widget-title">
        <span>Active Strategies</span>
        <button class="btn btn-danger btn-sm" onclick="stopAllStrategies()">‚èπ Stop All</button>
      </div>
      <div id="running-list"></div>
    </div>
  </div>

  <!-- ====== TAB 3: STRATEGY BUILDER ====== -->
  <div id="builder-tab" class="tab-content">
    <div class="widget">
      <div class="widget-title">
        <span id="builder-title">Create New Strategy</span>
        <button class="btn btn-secondary btn-sm" onclick="openBuilderPage()">Advanced Builder ‚Üí</button>
      </div>
      <p style="color:var(--muted);margin-bottom:16px;font-size:12px;">
        Use the Advanced Builder for full rule-based configuration. This form is for quick basic setup.
      </p>
      
      <div class="form-group">
        <label>Strategy Name *</label>
        <input type="text" id="new-name" class="form-control" placeholder="e.g., NIFTY DNSS Weekly">
      </div>
      
      <div class="form-group">
        <label>Strategy Type *</label>
        <select id="new-type" class="form-control">
          <option value="">Select...</option>
          <option value="dnss">DNSS (Delta Neutral Short Strangle)</option>
          <option value="iron_condor">Iron Condor</option>
          <option value="strangle">Short Strangle</option>
        </select>
      </div>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <div class="form-group">
          <label>Underlying *</label>
          <input type="text" id="new-symbol" class="form-control" placeholder="NIFTY" value="NIFTY">
        </div>
        <div class="form-group">
          <label>Exchange *</label>
          <select id="new-exchange" class="form-control">
            <option value="NFO">NFO</option>
            <option value="MCX">MCX</option>
            <option value="BFO">BFO</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label>Description</label>
        <textarea id="new-description" class="form-control" placeholder="Strategy description..."></textarea>
      </div>

      <div class="modal-footer" style="margin-top:20px;padding-top:16px;border-top:1px solid var(--border);">
        <button class="btn btn-secondary" onclick="resetBuilder()">Reset</button>
        <button class="btn btn-primary" onclick="createQuickStrategy()">Create Strategy</button>
      </div>
    </div>
  </div>
</main>

<!-- ====== MODALS ====== -->
<!-- Enable/Disable Confirm Modal -->
<div id="toggle-modal" class="modal">
  <div class="modal-content" style="max-width:400px;">
    <div class="modal-header" id="toggle-modal-title">Confirm Action</div>
    <p id="toggle-modal-message" style="margin-bottom:20px;color:var(--muted);font-size:13px;"></p>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('toggle-modal')">Cancel</button>
      <button class="btn btn-primary" id="toggle-modal-confirm" onclick="confirmToggle()">Confirm</button>
    </div>
  </div>
</div>

<!-- Delete Confirm Modal -->
<div id="delete-modal" class="modal">
  <div class="modal-content" style="max-width:400px;">
    <div class="modal-header">Delete Strategy</div>
    <p style="margin-bottom:20px;color:var(--muted);font-size:13px;">
      Are you sure you want to delete strategy <strong id="delete-strategy-name" style="color:var(--danger);"></strong>?
      This action cannot be undone.
    </p>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('delete-modal')">Cancel</button>
      <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
    </div>
  </div>
</div>

<!-- View Details Modal -->
<div id="details-modal" class="modal">
  <div class="modal-content" style="max-width:600px;">
    <div class="modal-header">Strategy Details</div>
    <div id="details-content" style="font-size:12px;font-family:var(--font-mono);"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('details-modal')">Close</button>
      <button class="btn btn-primary" onclick="editCurrentStrategy()">Edit</button>
    </div>
  </div>
</div>

<script>
// ====== GLOBALS ======
const API_BASE = '/dashboard';
let allStrategies = [];
let currentFilter = 'all';
let currentToggleStrategy = null;
let currentDeleteStrategy = null;
let currentDetailsStrategy = null;

// ====== UTILS ======
const $ = id => document.getElementById(id);
const toast = (msg, type='success') => {
  const t = document.createElement('div');
  t.className = `toast toast-${type}`;
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3000);
};

const api = async (method, path, body=null) => {
  const opts = { 
    method, 
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include' 
  };
  if (body) opts.body = JSON.stringify(body);
  const r = await fetch(API_BASE + path, opts);
  if (!r.ok) throw new Error(await r.text());
  return r.json();
};

const escHtml = str => String(str||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

// ====== TAB SWITCHING ======
function switchTab(name) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  
  const tabMap = {
    'list': 'list-tab',
    'running': 'running-tab',
    'builder': 'builder-tab'
  };
  
  event.target.classList.add('active');
  $(tabMap[name]).classList.add('active');
  
  if (name === 'list') loadStrategies();
  if (name === 'running') loadRunningStrategies();
}

// ====== LOAD STRATEGIES ======
async function loadStrategies() {
  try {
    const r = await api('GET', '/strategy/configs');
    allStrategies = r.strategies || [];
    renderStrategies();
  } catch(e) {
    toast('Failed to load strategies: ' + e.message, 'error');
  }
}

function renderStrategies() {
  const list = $('strategies-list');
  
  let filtered = allStrategies.filter(s => {
    if (currentFilter === 'all') return true;
    if (currentFilter === 'enabled') return s.enabled !== false;
    if (currentFilter === 'disabled') return s.enabled === false;
    if (currentFilter === 'running') return s.status === 'RUNNING';
    if (currentFilter === 'idle') return s.status === 'IDLE' || !s.status;
    return true;
  });

  const search = $('search-input')?.value.toLowerCase();
  if (search) {
    filtered = filtered.filter(s => 
      s.name.toLowerCase().includes(search) || 
      (s.description||'').toLowerCase().includes(search)
    );
  }

  const typeFilter = $('type-filter')?.value;
  if (typeFilter) {
    filtered = filtered.filter(s => s.strategy_type === typeFilter);
  }

  if (!filtered.length) {
    list.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üìã</div>
        <div class="empty-state-text">No strategies found</div>
        <button class="btn btn-primary btn-sm" onclick="openBuilder()">Create First Strategy</button>
      </div>
    `;
    return;
  }

  list.innerHTML = filtered.map(s => {
    const enabled = s.enabled !== false;
    const status = s.status || 'IDLE';
    const isRunning = status === 'RUNNING';
    
    return `
      <div class="strat-card">
        <div class="strat-card-header">
          <div class="strat-card-name">
            <span class="status-dot ${status.toLowerCase()}"></span>
            ${escHtml(s.name)}
            ${enabled ? '<span class="badge badge-enabled">Enabled</span>' : '<span class="badge badge-disabled">Disabled</span>'}
            ${status !== 'IDLE' ? `<span class="badge badge-${status.toLowerCase()}">${status}</span>` : ''}
          </div>
          <div class="strat-card-actions">
            ${!isRunning ? `<button class="btn btn-success btn-sm" onclick="startStrategy('${escHtml(s.name)}')">‚ñ∂ Start</button>` : ''}
            ${isRunning ? `<button class="btn btn-danger btn-sm" onclick="stopStrategy('${escHtml(s.name)}')">‚èπ Stop</button>` : ''}
            <button class="btn btn-secondary btn-sm" onclick="viewDetails('${escHtml(s.name)}')">üëÅ</button>
            <button class="btn btn-secondary btn-sm" onclick="toggleEnabled('${escHtml(s.name)}', ${enabled})">${enabled ? 'üî¥' : 'üü¢'}</button>
            <button class="btn btn-warning btn-sm" onclick="cloneStrategy('${escHtml(s.name)}')">üìã</button>
            <button class="btn btn-danger btn-sm" onclick="deleteStrategy('${escHtml(s.name)}')">üóë</button>
          </div>
        </div>
        <div class="strat-card-meta">
          <span><strong>Type:</strong> ${escHtml(s.strategy_type||'N/A')}</span>
          <span><strong>Symbol:</strong> ${escHtml(s.basic?.underlying||'N/A')}</span>
          <span><strong>Exchange:</strong> ${escHtml(s.basic?.exchange||'N/A')}</span>
          <span><strong>Updated:</strong> ${formatDate(s.updated_at)}</span>
        </div>
        ${s.description ? `<p style="margin-top:8px;font-size:11px;color:var(--muted);">${escHtml(s.description)}</p>` : ''}
      </div>
    `;
  }).join('');
}

function formatDate(dateStr) {
  if (!dateStr) return 'Never';
  const d = new Date(dateStr);
  return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
}

// ====== FILTERS ======
function setFilter(btn, filter) {
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentFilter = filter;
  renderStrategies();
}

function filterStrategies() {
  renderStrategies();
}

// ====== START/STOP ======
async function startStrategy(name) {
  try {
    await api('POST', '/strategy/start', { strategy_name: name });
    toast(`Strategy "${name}" started`);
    setTimeout(loadStrategies, 1000);
  } catch(e) {
    toast('Failed to start: ' + e.message, 'error');
  }
}

async function stopStrategy(name) {
  try {
    await api('POST', '/strategy/stop', { strategy_name: name });
    toast(`Strategy "${name}" stopped`);
    setTimeout(loadStrategies, 1000);
  } catch(e) {
    toast('Failed to stop: ' + e.message, 'error');
  }
}

async function stopAllStrategies() {
  if (!confirm('Stop all running strategies?')) return;
  const running = allStrategies.filter(s => s.status === 'RUNNING');
  for (const s of running) {
    try {
      await stopStrategy(s.name);
    } catch(e) {
      console.error('Failed to stop ' + s.name, e);
    }
  }
}

// ====== ENABLE/DISABLE ======
function toggleEnabled(name, currentlyEnabled) {
  currentToggleStrategy = { name, currentlyEnabled };
  const modal = $('toggle-modal');
  const title = $('toggle-modal-title');
  const message = $('toggle-modal-message');
  
  if (currentlyEnabled) {
    title.textContent = 'Disable Strategy';
    message.innerHTML = `Disable strategy <strong>${escHtml(name)}</strong>? It will not auto-start on bot restart.`;
  } else {
    title.textContent = 'Enable Strategy';
    message.innerHTML = `Enable strategy <strong>${escHtml(name)}</strong>?`;
  }
  
  modal.classList.add('show');
}

async function confirmToggle() {
  if (!currentToggleStrategy) return;
  
  try {
    const newEnabled = !currentToggleStrategy.currentlyEnabled;
    await api('PUT', `/strategy/${currentToggleStrategy.name}`, { enabled: newEnabled });
    toast(`Strategy ${newEnabled ? 'enabled' : 'disabled'}`);
    closeModal('toggle-modal');
    loadStrategies();
  } catch(e) {
    toast('Failed to toggle: ' + e.message, 'error');
  }
}

// ====== DELETE ======
function deleteStrategy(name) {
  currentDeleteStrategy = name;
  $('delete-strategy-name').textContent = name;
  $('delete-modal').classList.add('show');
}

async function confirmDelete() {
  if (!currentDeleteStrategy) return;
  
  try {
    await api('DELETE', `/strategy/config/${currentDeleteStrategy}`);
    toast('Strategy deleted');
    closeModal('delete-modal');
    loadStrategies();
  } catch(e) {
    toast('Failed to delete: ' + e.message, 'error');
  }
}

// ====== VIEW DETAILS ======
async function viewDetails(name) {
  try {
    const r = await api('GET', `/strategy/config/${name}`);
    currentDetailsStrategy = r;
    
    const content = $('details-content');
    content.innerHTML = `
      <div style="background:rgba(0,0,0,0.3);padding:12px;border-radius:6px;overflow-x:auto;">
        <pre style="margin:0;white-space:pre-wrap;word-wrap:break-word;">${JSON.stringify(r, null, 2)}</pre>
      </div>
    `;
    
    $('details-modal').classList.add('show');
  } catch(e) {
    toast('Failed to load details: ' + e.message, 'error');
  }
}

function editCurrentStrategy() {
  if (!currentDetailsStrategy) return;
  closeModal('details-modal');
  openBuilderPage(); // Opens advanced builder in new tab
}

// ====== CLONE ======
async function cloneStrategy(name) {
  try {
    const r = await api('POST', `/strategy/config/${name}/clone`);
    toast('Strategy cloned as: ' + r.name);
    loadStrategies();
  } catch(e) {
    toast('Failed to clone: ' + e.message, 'error');
  }
}

// ====== QUICK CREATE ======
async function createQuickStrategy() {
  const name = $('new-name').value.trim();
  const type = $('new-type').value;
  const symbol = $('new-symbol').value.trim();
  const exchange = $('new-exchange').value;
  const description = $('new-description').value.trim();
  
  if (!name) { toast('Name required', 'error'); return; }
  if (!type) { toast('Type required', 'error'); return; }
  if (!symbol) { toast('Symbol required', 'error'); return; }
  
  const config = {
    name,
    strategy_type: type,
    description,
    enabled: true,
    basic: {
      exchange,
      underlying: symbol,
      lots: 1,
      instrument_type: 'OPTIDX'
    },
    timing: {
      entry_time: '09:20',
      exit_time: '15:20'
    },
    entry: {
      conditions: {},
      action: { type: 'short_both' }
    },
    risk: {
      target: { pct: 50 },
      stoploss: { pct: 100 }
    },
    rms: {
      position: { max_lots: 10 },
      daily: { loss_limit: null },
      circuit: { amount: null }
    }
  };
  
  try {
    await api('POST', '/strategy/config/save-all', config);
    toast('Strategy created');
    resetBuilder();
    switchTab('list');
  } catch(e) {
    toast('Failed to create: ' + e.message, 'error');
  }
}

function resetBuilder() {
  $('new-name').value = '';
  $('new-type').value = '';
  $('new-symbol').value = 'NIFTY';
  $('new-exchange').value = 'NFO';
  $('new-description').value = '';
}

// ====== RUNNER STATUS ======
async function refreshStatus() {
  try {
    const r = await api('GET', '/runner/status');
    const indicator = $('runner-indicator');
    const status = $('runner-status');
    
    if (r.runner_active && r.strategies_active > 0) {
      indicator.classList.add('online');
      status.textContent = `${r.strategies_active} active`;
    } else {
      indicator.classList.remove('online');
      status.textContent = 'Idle';
    }
  } catch(e) {
    console.error('Status check failed', e);
  }
}

// ====== RUNNING STRATEGIES ======
async function loadRunningStrategies() {
  const list = $('running-list');
  const running = allStrategies.filter(s => s.status === 'RUNNING');
  
  if (!running.length) {
    list.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">‚è∏Ô∏è</div>
        <div class="empty-state-text">No strategies currently running</div>
      </div>
    `;
    return;
  }
  
  list.innerHTML = running.map(s => `
    <div class="strat-card">
      <div class="strat-card-header">
        <div class="strat-card-name">
          <span class="status-dot running"></span>
          ${escHtml(s.name)}
          <span class="badge badge-running">RUNNING</span>
        </div>
        <div class="strat-card-actions">
          <button class="btn btn-danger btn-sm" onclick="stopStrategy('${escHtml(s.name)}')">‚èπ Stop</button>
          <button class="btn btn-warning btn-sm" onclick="forceExit('${escHtml(s.name)}')">‚ö†Ô∏è Force Exit</button>
        </div>
      </div>
      <div class="strat-card-meta">
        <span><strong>Type:</strong> ${escHtml(s.strategy_type||'N/A')}</span>
        <span><strong>Symbol:</strong> ${escHtml(s.basic?.underlying||'N/A')}</span>
        <span><strong>Exchange:</strong> ${escHtml(s.basic?.exchange||'N/A')}</span>
      </div>
    </div>
  `).join('');
}

async function forceExit(name) {
  if (!confirm(`Force EXIT all positions for ${name}?`)) return;
  try {
    await api('POST', '/system/force-exit', { strategy_name: name });
    toast('Force exit initiated');
  } catch(e) {
    toast('Failed to force exit: ' + e.message, 'error');
  }
}

// ====== MISC ======
function closeModal(id) {
  $(id).classList.remove('show');
}

function openBuilder() {
  switchTab('builder');
}

function openBuilderPage() {
  window.open('/dashboard/web/strategy_builder.html', '_blank');
}

function importStrategy() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    try {
      const text = await file.text();
      const config = JSON.parse(text);
      await api('POST', '/strategy/config/save-all', config);
      toast('Strategy imported');
      loadStrategies();
    } catch(err) {
      toast('Import failed: ' + err.message, 'error');
    }
  };
  input.click();
}

// ====== INIT ======
window.addEventListener('load', () => {
  loadStrategies();
  refreshStatus();
  setInterval(refreshStatus, 5000);
  setInterval(() => {
    if (document.querySelector('.tab-btn.active').textContent.includes('Running')) {
      loadRunningStrategies();
    }
  }, 3000);
});
</script>
</body>
</html>
