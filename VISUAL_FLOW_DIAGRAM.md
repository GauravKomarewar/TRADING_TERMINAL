# VISUAL FLOW DIAGRAM: 6-STEP DESIRED ORDER EXECUTION FLOW

## High-Level Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                              â”‚
â”‚  EXTERNAL ORDER SOURCE (Webhook / Dashboard / System)                       â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                          COMMAND SERVICE                     â”‚
        â”‚                                                              â”‚
        â”‚  1ï¸âƒ£ STEP 1: REGISTER TO DB                                 â”‚
        â”‚     â””â”€> status = CREATED                                   â”‚
        â”‚     â””â”€> command_id generated                               â”‚
        â”‚     â””â”€> DB record persisted                                â”‚
        â”‚                                                              â”‚
        â”‚  âœ… Order now exists in database                            â”‚
        â”‚                                                              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                       TRADING BOT                            â”‚
        â”‚                    (execute_command)                         â”‚
        â”‚                                                              â”‚
        â”‚  2ï¸âƒ£ STEP 2: SYSTEM BLOCKERS CHECK                          â”‚
        â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
        â”‚     â”‚ 2A: RISK MANAGER BLOCKER            â”‚                â”‚
        â”‚     â”‚  â€¢ Daily loss limits               â”‚                â”‚
        â”‚     â”‚  â€¢ Cooldown periods                â”‚                â”‚
        â”‚     â”‚  â€¢ Max loss threshold              â”‚                â”‚
        â”‚     â”‚ âŒ If blocked: status=FAILED       â”‚                â”‚
        â”‚     â”‚               tag=RISK_LIMITS_...  â”‚                â”‚
        â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
        â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
        â”‚     â”‚ 2B: EXECUTION GUARD BLOCKER         â”‚                â”‚
        â”‚     â”‚  â€¢ Prevents duplicate ENTRY        â”‚                â”‚
        â”‚     â”‚  â€¢ Checks strategy positions       â”‚                â”‚
        â”‚     â”‚  â€¢ Allows EXIT (no block)          â”‚                â”‚
        â”‚     â”‚ âŒ If blocked: status=FAILED       â”‚                â”‚
        â”‚     â”‚               tag=EXEC_GUARD_...   â”‚                â”‚
        â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
        â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
        â”‚     â”‚ 2C: DUPLICATE DETECTION BLOCKER     â”‚                â”‚
        â”‚     â”‚  â€¢ Checks open orders by strategy  â”‚                â”‚
        â”‚     â”‚  â€¢ Blocks same symbol              â”‚                â”‚
        â”‚     â”‚  â€¢ Prevents collision              â”‚                â”‚
        â”‚     â”‚ âŒ If blocked: status=FAILED       â”‚                â”‚
        â”‚     â”‚               tag=DUPLICATE_...    â”‚                â”‚
        â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
        â”‚                                                              â”‚
        â”‚  âœ… All blockers PASSED (or one FAILED)                    â”‚
        â”‚                                                              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                                      â”‚
      BLOCKED   â”‚                                      â”‚  PASSED
                â–¼                                      â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   ORDER FAILED   â”‚        â”‚                                      â”‚
        â”‚                  â”‚        â”‚  3ï¸âƒ£ STEP 3: SEND TO BROKER          â”‚
        â”‚ status=FAILED    â”‚        â”‚     â””â”€> Update DB status            â”‚
        â”‚ tag=<REASON>     â”‚        â”‚            status = SENT_TO_BROKER  â”‚
        â”‚                  â”‚        â”‚     â””â”€> DB: updated_at = <now>      â”‚
        â”‚ âœ… END (FAILED)  â”‚        â”‚                                      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚     âœ… Status mark set              â”‚
                                    â”‚                                      â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                                             â–¼
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚   4ï¸âƒ£ STEP 4: EXECUTE ON BROKER        â”‚
                                    â”‚                                          â”‚
                                    â”‚   â€¢ Serialize API call (via proxy)     â”‚
                                    â”‚   â€¢ Convert command â†’ broker params    â”‚
                                    â”‚   â€¢ Call: api.place_order()           â”‚
                                    â”‚   â€¢ Get result: success/failure       â”‚
                                    â”‚                                          â”‚
                                    â”‚   âœ… Order submission complete        â”‚
                                    â”‚                                          â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚                                                     â”‚
        BROKER    â–¼                                                    â–¼
        SUCCESS   â”‚                                           BROKER
                  â”‚                                           FAILURE
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  5ï¸âƒ£ STEP 5A: BROKER ACCEPTED â”‚     â”‚ 5ï¸âƒ£ STEP 5B: BROKER REJECTED  â”‚
        â”‚                               â”‚     â”‚                                 â”‚
        â”‚  â€¢ Get broker_order_id        â”‚     â”‚ â€¢ Broker returned error        â”‚
        â”‚  â€¢ Update DB with broker_id   â”‚     â”‚ â€¢ Mark as FAILED              â”‚
        â”‚  â€¢ status = SENT_TO_BROKER    â”‚     â”‚ â€¢ status = FAILED             â”‚
        â”‚  â€¢ Updated_at = <now>         â”‚     â”‚ â€¢ tag = BROKER_REJECTED       â”‚
        â”‚                               â”‚     â”‚                                 â”‚
        â”‚  âœ… Ready for polling         â”‚     â”‚ âŒ Order failed               â”‚
        â”‚                               â”‚     â”‚                                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚    âœ… END (FAILED)            â”‚
                   â”‚                          â”‚                                 â”‚
                   â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                        ORDERWATCH THREAD (POLLING)                       â”‚
    â”‚                                                                          â”‚
    â”‚  ğŸ”„ Runs every 1 second continuously                                    â”‚
    â”‚  ğŸ”„ Polls: api.get_order_book()                                        â”‚
    â”‚  ğŸ”„ Matches brokerid order_id                                           â”‚
    â”‚  ğŸ”„ Skips already-resolved (EXECUTED/FAILED)                           â”‚
    â”‚                                                                          â”‚
    â”‚  6ï¸âƒ£ STEP 6A: BROKER FAILURE                                            â”‚
    â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
    â”‚     â”‚ If Broker Status = REJECTED / CANCELLED / EXPIRED      â”‚         â”‚
    â”‚     â”‚                                                         â”‚         â”‚
    â”‚     â”‚ Action:                                                â”‚         â”‚
    â”‚     â”‚  â€¢ Update DB: status = FAILED                         â”‚         â”‚
    â”‚     â”‚  â€¢ Update DB: tag = BROKER_<STATUS>                   â”‚         â”‚
    â”‚     â”‚  â€¢ Clear Guard: force_clear_symbol()                  â”‚         â”‚
    â”‚     â”‚  â€¢ Prevent stale state                                â”‚         â”‚
    â”‚     â”‚                                                         â”‚         â”‚
    â”‚     â”‚ âœ… Order marked FAILED in DB                          â”‚         â”‚
    â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
    â”‚                                                                          â”‚
    â”‚  6ï¸âƒ£ STEP 6B: BROKER EXECUTED (FINAL TRUTH)                            â”‚
    â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
    â”‚     â”‚ If Broker Status = COMPLETE                            â”‚         â”‚
    â”‚     â”‚                                                         â”‚         â”‚
    â”‚     â”‚ Action:                                                â”‚         â”‚
    â”‚     â”‚  â€¢ Update DB: status = EXECUTED                        â”‚         â”‚
    â”‚     â”‚  â€¢ Reconcile Guard State                              â”‚         â”‚
    â”‚     â”‚    - Get broker positions                             â”‚         â”‚
    â”‚     â”‚    - Reconcile with ExecutionGuard                    â”‚         â”‚
    â”‚     â”‚    - Cleanup if strategy is flat                      â”‚         â”‚
    â”‚     â”‚                                                         â”‚         â”‚
    â”‚     â”‚ âœ… Order marked EXECUTED, Guard synched              â”‚         â”‚
    â”‚     â”‚ âœ… END (SUCCESS)                                      â”‚         â”‚
    â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
    â”‚                                                                          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

---

## Status State Machine

```
                           â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                           â•‘                  CREATED                           â•‘
                           â•‘  (Step 1: Registered to DB)                       â•‘
                           â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                             â”‚
                                             â–¼
                     â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
                     â”‚   Step 2: BLOCKERS CHECK                        â”‚
                     â”‚                                                 â”‚
                     â”‚  Check 2A: Risk Manager                        â”‚
                     â”‚  Check 2B: Execution Guard                     â”‚
                     â”‚  Check 2C: Duplicate Detection                 â”‚
                     â”‚                                                 â”‚
                     â”‚  Any one blocks?                               â”‚
                     â•°â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
                            â”‚
                â•”â•â•â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•—
                â–¼                       â–¼
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘  YES: BLOCKED   â•‘    â•‘  NO: CONTINUE   â•‘
        â•‘                 â•‘    â•‘                 â•‘
        â•‘  status=FAILED  â•‘    â•‘  â†’ Step 3       â•‘
        â•‘  tag=<REASON>   â•‘    â•‘                 â•‘
        â•‘  âœ… END         â•‘    â•‘                 â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â•šâ•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•
                                    â”‚
                                    â–¼
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘   SENT_TO_BROKER                                          â•‘
        â•‘   (Step 3: Status marked before broker submission)        â•‘
        â•‘   (Step 4: Order submitted to broker)                     â•‘
        â•šâ•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•
             â”‚                                               â”‚
         Success                                        Failure
             â”‚                                               â”‚
             â–¼                                               â–¼
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—                      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”
    â”‚ SENT_TO_BROKER     â”‚                      â”‚ FAILED             â”‚
    â”‚ + broker_order_id  â”‚                      â”‚ tag=BROKER_REJECTEDâ”‚
    â”‚ (Step 5a)          â”‚                      â”‚ (Step 5b)          â”‚
    â”‚ âœ… Ready for poll  â”‚                      â”‚ âœ… END             â”‚
    â•šâ•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
       Polling Loop (Step 6)
       Every 1 second
              â”‚
              â–¼
    â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”®
    â”‚ Check broker status:    â”‚
    â”‚ COMPLETE / REJECTED ... â”‚
    â•°â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
           â”‚
    â•”â•â•â•â•â•â•â•§â•â•â•â•â•â•â•—
    â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ COMPLETE â”‚  â”‚ REJECTED/etc â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚             â”‚
     â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  EXECUTED    â”‚  â”‚    FAILED    â”‚
â”‚              â”‚  â”‚              â”‚
â”‚ Guard synced â”‚  â”‚ Guard clearedâ”‚
â”‚ Strategy OK  â”‚  â”‚              â”‚
â”‚              â”‚  â”‚              â”‚
â”‚ âœ… END       â”‚  â”‚ âœ… END       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Database State Transitions

```
Time         Event                           Status              Tag                  broker_id
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

T0:          Command Registered              CREATED             NULL                 NULL
             (Step 1)

T0+1:        Risk Blocker Failed             FAILED              RISK_LIMITS_EXC...   NULL
             (Step 2A - BLOCKED)

OR

T0+2:        Guard Blocker Failed            FAILED              EXECUTION_GUARD...   NULL
             (Step 2B - BLOCKED)

OR

T0+3:        Duplicate Blocker Failed        FAILED              DUPLICATE_ORDER...   NULL
             (Step 2C - BLOCKED)

OR

T0+4:        All Blockers Passed             SENT_TO_BROKER      NULL                 NULL
             (Step 3)

T0+5:        Broker Accepted                 SENT_TO_BROKER      NULL                 123456789
             (Step 5a)

T0+6:        Polling Found COMPLETE          EXECUTED            NULL                 123456789
             (Step 6b - SUCCESS)

OR

T0+6:        Broker Rejected                 FAILED              BROKER_REJECTED      NULL
             (Step 5b)

OR

T0+6:        Polling Found REJECTED/etc      FAILED              BROKER_REJECTED...   123456789
             (Step 6a - FAILURE)
```

---

## Component Responsibility Matrix

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Component    â”‚ Responsibility   â”‚ What It Does                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Strategy/    â”‚ Generate Intent  â”‚ â€¢ Create order intent                â”‚
â”‚ Dashboard    â”‚                  â”‚ â€¢ Validate intent basics             â”‚
â”‚              â”‚                  â”‚ â€¢ Submit via CommandService          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ CommandSvc   â”‚ Register Intent  â”‚ â€¢ Validate order                     â”‚
â”‚              â”‚                  â”‚ â€¢ Persist to DB (CREATED)            â”‚
â”‚              â”‚                  â”‚ â€¢ Call execute_command()             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ TradingBot   â”‚ Execute Order    â”‚ â€¢ Check blockers (Step 2)            â”‚
â”‚              â”‚                  â”‚ â€¢ Mark SENT_TO_BROKER (Step 3)       â”‚
â”‚              â”‚                  â”‚ â€¢ Submit to broker (Step 4)          â”‚
â”‚              â”‚                  â”‚ â€¢ Update DB on result (Step 5)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Broker       â”‚ Authority        â”‚ â€¢ Accept/reject order                â”‚
â”‚ (Shoonya)    â”‚                  â”‚ â€¢ Process order                      â”‚
â”‚              â”‚                  â”‚ â€¢ Provide order status               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ OrderWatcher â”‚ Poll & Sync      â”‚ â€¢ Poll broker order book (Step 6)   â”‚
â”‚              â”‚                  â”‚ â€¢ Update DB to EXECUTED/FAILED      â”‚
â”‚              â”‚                  â”‚ â€¢ Reconcile ExecutionGuard          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ RiskManager  â”‚ Risk Guard       â”‚ â€¢ Check daily losses                â”‚
â”‚              â”‚                  â”‚ â€¢ Check cooldowns                    â”‚
â”‚              â”‚                  â”‚ â€¢ Block if unsafe                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ExecGuard    â”‚ State Guard      â”‚ â€¢ Track strategy positions          â”‚
â”‚              â”‚                  â”‚ â€¢ Prevent duplicate entries         â”‚
â”‚              â”‚                  â”‚ â€¢ Reconcile with broker             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ OrderRepo    â”‚ Persistence      â”‚ â€¢ Store orders                       â”‚
â”‚              â”‚                  â”‚ â€¢ Update status/tags                 â”‚
â”‚              â”‚                  â”‚ â€¢ Retrieve for processing            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Error Handling Flow

```
At Each Step:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Try Operation                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚          â”‚
Success       Exception
    â”‚          â”‚
    â–¼          â–¼
Continue   Catch & Log
         â”‚
         â”œâ”€â†’ Log full error context
         â”‚
         â”œâ”€â†’ Update DB status to FAILED
         â”‚
         â”œâ”€â†’ Update DB tag with reason
         â”‚
         â”œâ”€â†’ If critical: Send Telegram
         â”‚
         â””â”€â†’ Return OrderResult(success=False)
```

---

**Version**: v1.0  
**Date**: 2026-02-10  
**Status**: âœ… COMPLETE
